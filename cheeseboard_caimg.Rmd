---
title: "Cheeseboard task analysis of caimg data"
output:
  html_document:
    df_print: paged
---


```{r}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(DT)

library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=18), axis.text = element_text(size=15))
```

```{r}
ca_img_result_dir = '/mnt/DATA/Prez/cheeseboard/2019-02-learning/joined_caimg/'
gen_imgs_dir = '/tmp/'
traces_file = paste0(ca_img_result_dir, 'traces_and_positions.csv')
data = read.csv(traces_file)
```

```{r}
data = data %>%
  gather('cell', 'nevents', starts_with('events_')) %>%
  gather('trace_cell', 'norm_trace', starts_with('normTrace_')) 
data$cell = str_replace(data$cell,'events_[.]?','')
data$trace_cell = str_replace(data$trace_cell,'normTrace_[.]?','')
data = filter(data, cell == trace_cell) %>%
  select(-trace_cell)
data = data %>%
  gather('trace_cell', 'trace', starts_with('trace_')) 
data$trace_cell = str_replace(data$trace_cell,'trace_[.]?','')
data = filter(data, cell == trace_cell) %>%
  select(-trace_cell)
data$trace = as.double(data$trace)

data$cell = as.integer(data$cell)
data$inside_roi = data$inside_roi > 0
```

```{r}
ncells = unique(events_total.df$cell) %>% length

first_learning_day = min(as.Date(data$date))
last_day = max(as.Date(data$date))
max_trial = max(data$trial)
data = mutate(data, 
              learning_day = as.integer(as.Date(date) - first_learning_day + 1),
              trial_no = (learning_day - 1) * max_trial + trial)
```

# Calcium events

Events per cell per day and trial
```{r}
events_total.df = data %>% 
  group_by(date, trial, cell, trial_no, learning_day) %>%
  summarise(total_events = sum(nevents), 
            duration_sec = max(timestamp) / 1000,
            mer = total_events / duration_sec) %>%
  arrange(cell, date, trial)

datatable(select(events_total.df, trial_no, cell, total_events, duration_sec, mer))
```
Correlation between trial no and no events
```{r}
events_total.df %>%
  group_by(date, cell) %>%
  summarise(mean.event.rate = sum(total_events) / ncells / mean(duration_sec)) %>%
  ggplot() +
  geom_line(aes(x=date, y=mean.event.rate, group=cell))
```



```{r}
events.df = filter(data, nevents > 0)
```

Events during run vs during stationary
```{r}
run.threshold = 1
events.df %>% 
  mutate(running = velocity > run.threshold) %>%
  group_by(cell, running) %>%
  summarise(nnevents=n()) %>%
  ggplot(aes(cell,nnevents)) +
    geom_bar(stat='identity', aes(fill=running), position='dodge')
  
```


## Place cells


```{r}
get_place_field_centre = function(events.df) {
  #x = weighted.mean(events.df$smooth_trans_x, events.df$norm_trace)
  #y = weighted.mean(events.df$smooth_trans_y, events.df$norm_trace)
  x = mean(events.df$smooth_trans_x)
  y = mean(events.df$smooth_trans_y)
  return(c(x, y))
}

get_dist = function(pt1, pt2_x, pt2_y) {
  dist = sqrt((pt1[1] - pt2_x)^2 + (pt1[2] - pt2_y)^2)
}
```

```{r warning=FALSE}
source('place_field.R')
cells = unique(data$cell) %>% sort
pci.df = data.frame(cell_id=numeric(), day=character(), pci=numeric())

standard.distance = function(pt_centre, x, y) {
  n = length(x)
  y = 0.6 * y  # keep ratio between x and y
  d = sqrt(sum((x - pt_centre[1])**2) / (n - 1) +
           sum((y - pt_centre[2])**2) / (n - 1))
  return(d)
}

days = seq(first_learning_day, last_day, by=1)
for (i in 1:length(days)) {
  for (cell_id in cells) {
    day.str = as.character(days[i])
    cell.df = filter(data, cell == cell_id, date == day.str) 
    cell.df$trial = as.factor(cell.df$trial)
    cell.events = filter(cell.df, nevents > 0) 
    field_centre = get_place_field_centre(cell.events)
    if (nrow(cell.events) > 5) {
      cell.df.run = filter(cell.df, velocity >= run.threshold)
      if (nrow(cell.df.run) > 5) {
        pf = getPlaceField(cell.df.run)
        pci = pf$pci
      } else {
        pci = 0
      }
      entropy = getPlaceField(cell.df.run)$entropy
      cell.events = mutate(cell.events, sd.dist = standard.distance(field_centre, smooth_trans_x, smooth_trans_y))
      pci.df = bind_rows(pci.df, data.frame(cell_id=cell_id, day=day.str, 
                                            pci=pci, entropy=entropy,
                                            event_spread=cell.events$sd.dist[1],
                                            field_centre.x=field_centre[1],
                                            field_centre.y=field_centre[2]))
    }
  }
}

pci.df = arrange(pci.df, desc(pci))
datatable(pci.df) %>% 
  formatRound(c('pci', 'entropy', 'event_spread'),digits = 2) %>%
  formatRound(c('field_centre.x', 'field_centre.y'),digits = 0)
```
```{r}
for (cell_id in unique(data$cell)) {
  single_trial = filter(events.df, cell==cell_id & velocity > run.threshold)
  trial_name = sprintf('Cell_%d', cell_id)
  g = ggplot(single_trial) +
    geom_point(aes(x=smooth_trans_x, y=smooth_trans_y, color=date, size=norm_trace)) +
    xlab(trial_name) +
    theme_void()
  out.path = paste0('/tmp/', trial_name, '.jpg')
  ggsave(filename=out.path, plot=g, height=4, width=7)
}
```

```{r}
geom_trace = function(df, alpha=0.1) {
  ndata = nrow(df)
  start_row=2
  df = arrange(df, trial_id, timestamp)
  newdata = df[start_row:ndata-1,]
  newdata$next_smooth_trans_x = df$smooth_trans_x[start_row:ndata]
  newdata$next_smooth_trans_y = df$smooth_trans_y[start_row:ndata]
 
  p = geom_segment(data=newdata, aes(x=smooth_trans_x, y=-smooth_trans_y, 
                                   xend=next_smooth_trans_x, yend=-next_smooth_trans_y,
                                   group=trial_id),
                   alpha=alpha)
}
```

```{r}
pci.df = mutate(pci.df, cell_desc=paste0(#'Cell ', cell_id, 
                                        #' PCI=', round(pci,1), 
                                        'sd dist.=', round(event_spread, 1), ' (cm)'))
                                        #' entropy=', round(entropy, 1)))

day.str = '2019-02-28'
cells.selected = 1:31
data.day.df = filter(data, date==day.str, cell %in% cells.selected)
events.day.df = filter(data.day.df, nevents > 0, velocity > run.threshold)
events.day.joined = left_join(events.day.df, pci.df, by=c('date'='day', 'cell'='cell_id')) 

day.trace.df = filter(data.day.df, cell == cells.selected[1])

events.day.joined$cell_desc = as.factor(events.day.joined$cell_desc)
ggplot(events.day.joined) +
  geom_point(aes(x=smooth_trans_x, y=-smooth_trans_y, color=cell_desc, size=norm_trace), alpha=0.6) +
  geom_trace(day.trace.df, alpha=0.1) 
  #theme_void()
```



Calculate event concentration
```{r warning=FALSE}
arrange(pci.df, event_spread) %>%
  filter(day %in% c('2018-10-29','2018-10-30'))

```

Standard distance histogram
```{r}
spread.th = 11
g = pci.df %>%
  filter(day %in% c('2018-10-30', '2018-10-29')) %>%
  ggplot() +
  geom_histogram(aes(x=event_spread), binwidth = 2, fill='white',colour='blue') +
  #geom_vline(xintercept=spread.th, colour='red', linetype='dashed', size=2) +
  gtheme +
  xlab('Standard distance (cm)') + 
  scale_y_continuous(breaks=seq(2,8,2)) +
  scale_x_continuous(breaks=c(6, 10, 14, 18)) +
  ylab('# Cells')
g
ggsave(paste0(gen_imgs_dir, 'standard_distance.svg'), plot=g, width=3, height=3)
```

Centroids of spatially restricted cells
```{r}
spacial.cells = pci.df %>%
  filter(event_spread <= spread.th) %>%
  filter(day %in% c('2018-10-30')) 

spacial.cells$cell_id = as.factor(spacial.cells$cell_id)

ggplot() +
  geom_point(data=data.frame(x=4,y=box.width.cm/2), aes(x=x,y=y), shape=0,color='blue', fill='white', size=7, stroke=5) +
  geom_point(data=spacial.cells, aes(x=field_centre.x, y=field_centre.y, 
                                     size=2*(spread.th-0.5*event_spread), 
             colour=cell_id), alpha=0.6) +
  theme_void() +
  theme(text = element_text(size=18)) +
  xlim(c(0, box.length.cm)) + ylim(c(0,box.width.cm)) +
  scale_size(guide = FALSE) 

```


```{r}
cells.selected = c(22, 8, 17)
cells.selected = c(8,9,26)
cells.selected = c(8,9,26)

day.str = '2018-10-30'
data.day.df = filter(data, date==day.str, cell %in% cells.selected)
events.day.df = filter(data.day.df, nevents > 0)
events.day.joined = left_join(events.day.df, pci.df, by=c('date'='day', 'cell'='cell_id')) 

events.day.joined$cell_desc = as.factor(events.day.joined$cell_desc)

g = ggplot() +
  geom_path(data=data.day.df, aes(x=smooth_trans_x, y=smooth_trans_y, group=trial_id), alpha=0.1) +
  geom_point(data=data.frame(x=4,y=box.width.cm/2-5), aes(x=x,y=y), shape=0,color='blue', fill='white', size=7, stroke=5) +
  geom_point(data=events.day.joined, aes(x=smooth_trans_x, y=smooth_trans_y, color=cell_desc, size=7), alpha=0.6) +
  theme(text = element_text(size=18), legend.position = 'top') +
  xlim(c(0, box.length.cm - 5)) + ylim(c(0, box.width.cm - 3)) +
  scale_size(guide = FALSE) +
  xlab('X position (cm)') + ylab('Y position (cm)') +
  labs(color='Cells')  

ggsave(paste0(gen_imgs_dir, 'paths.svg'), plot=g, width=5, height=4)
g
```
Reward distance
```{r}

```


##Plot trial with marked events 
Place cells have given day, however the place field is different on other days

Cells 8 and 16 are possibly a goal cell firing around the reward location.
```{r}
cell_id = 8
day.str = '2018-10-30'

gs = list()
day.df = filter(data, cell == cell_id & date == day.str) 
trials = unique(day.df$trial)
for (trial_no in trials) {
  trial.df = filter(day.df, trial == trial_no) 
  trial.events = filter(trial.df, velocity >= run.threshold & nevents > 0)
  g = ggplot() +
    geom_jitter(data=trial.events, aes(x=smooth_trans_x, y=smooth_trans_y, size=norm_trace)) +
    geom_path(data=trial.df, aes(x=smooth_trans_x, y=smooth_trans_y), colour='blue', size=0.5, alpha = 0.75) +
    theme_void() +
    theme(legend.position='None')
  gs[[trial_no]] = g
}

plot_grid(gs[[1]], gs[[2]], gs[[3]], ncol=3)
#plot_grid(gs[[1]], gs[[2]], ncol=3)
```
TODO: figure: Location firing vs PCI for several cells

Raster plot for events

```{r}
events.df = filter(data, nevents>0)
events.df$trial_id_num = as.integer(events.df$trial_id)
timestamp.max.df = events.df %>%
  group_by(trial_id_num) %>%
  summarise(timestamp.max=max(timestamp)) %>%
  arrange(trial_id_num) 
timestamp.max.df$timestamp.offset=cumsum(timestamp.max.df$timestamp.max)-timestamp.max.df$timestamp.max

events.df.abs = left_join(events.df, timestamp.max.df, by='trial_id_num') %>%
  mutate(timestamp.abs=timestamp.offset+timestamp)
  
#x = rep(0, sum(events.df$nevents))
#y = rep(0, max(data$cell))
#start.index = 1
#for (cell in 1:max(events.df$cell)) {
#  x[cell] = 
#}

ncell = max(events.df$cell)
raster.frame = select(events.df.abs, timestamp.abs, cell)
ggplot() +
  geom_vline(data=timestamp.max.df, aes(xintercept=timestamp.offset/1000), linetype='dashed', colour='red') +
  geom_tile(data=raster.frame, aes(timestamp.abs / 1000, cell), width=5) +
  xlab('Time [s]') + 
  ylab('Cell')


```

MFR
```{r}
events.df.abs %>%
  filter(date %in% c('2018-10-29','2018-10-30')) %>%
  group_by(cell) %>%
  summarise(nevents=n() , n=n(), dur_sec=max(timestamp.abs)/1000) %>%
  summarise(mfr=mean(nevents/dur_sec), sdfr=sd(nevents/dur_sec)) %>%
  arrange(desc(mfr))
```

Show cell filter
```{r}
library(R.matlab)
library(magick)  
library(reshape2)
library(scales)
mat_file = paste0(ca_img_result_dir, 'F/jointExtraction/sorted/PCAICAsorted.mat')
ca.mat = readMat(mat_file)
filters = ca.mat[['filters']]
filters.selected = filters[,,cells.selected]
ncells = dim(filters)[3]
filters.thresholded = filters[,,] > 0.029
centroids = data.frame(cell=1:ncells, x=rep(0, ncells), y=rep(0,ncells), row.names = 1)
for (cell in 1:ncells) {
  dims = dim(filters[,,cell])
  pos = which.max(filters[,,cell])
  pos_x = pos %% dims[1]
  pos_y = floor(pos / dims[1]) + 1
  centroids[cell,] = c(pos_x, pos_y)
}
centroids$name = as.factor(rownames(centroids))

filters.projection = rowSums(filters.thresholded, dims=2)
#image(filters.projection, col = grey(seq(0, 1, length = 256)))

g=ggplot(centroids) +
  #geom_point(aes(x=x, y=y)) +
  geom_raster(data=melt(filters.projection), aes(x=Var1, y=Var2,fill=value), show.legend=FALSE,
              colour="grey50") +
  geom_text(aes(x, y, label=name), size=5) +
  scale_fill_gradient2(low='white', high='yellow') +
  xlim(c(1,dims[1])) + ylim(c(1,dims[2])) +
  theme_void()
ggsave(paste0(gen_imgs_dir, 'centroids.svg'), g)
g

```
```{r}
day.str = '2018-10-30'
trial.df = filter(data, cell %in% cells.selected, date==day.str)
trial.df$cell_name=as.factor(trial.df$cell) %>% as.integer
trial.events.df = filter(trial.df, nevents > 0)
g = ggplot(trial.df) +
  geom_line(aes(x=timestamp/1000, y=norm_trace, group=1)) +
  geom_point(data=trial.events.df, aes(x=timestamp/1000, y=norm_trace + 1), shape=8, colour='red') +
  facet_grid(cell_name ~ .) +
  gtheme +
  xlab('Time (sec)') +
  ylab('z-scored dF/F') 

ggsave(paste0(gen_imgs_dir, 'traces.svg'), g)
g

```


```{r}
cell_id = 22
cell.df = filter(data, cell == cell_id, date == day.str) 
cell.events = filter(cell.df, nevents > 0) 
cell.df$trial = as.factor(cell.df$trial)

source('place_field.R')
place.df = getPlaceField(cell.df)
col.pallette = RColorBrewer::brewer.pal(9,"Blues")
image(place.df[['field']], col=col.pallette)
image(place.df[['occupancy']], col=col.pallette)
```

```{r}
field_centre = get_place_field_centre(cell.events)
trial.df = mutate(cell.df, field_dist = get_dist(field_centre, smooth_trans_x, smooth_trans_y))
g=ggplot(trial.df ) +
  geom_line(aes(x=timestamp/1000, y=norm_trace, group=1)) +
  geom_line(aes(x=timestamp/1000, y=field_dist/10 + 4, group=1), colour='blue') +
  geom_point(data=cell.events, aes(x=timestamp/1000, y=norm_trace + 1), shape=8, colour='red') +
  facet_grid(trial ~ .) +
  xlab('Time (sec)') +
  ylab('z-scored dF/F')  + gtheme
g
ggsave(paste0(gen_imgs_dir, 'dist_reward_trace.svg'), g)
```


