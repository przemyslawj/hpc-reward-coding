---
title: "Cond box analysis"
output:
  html_document:
    df_print: paged
---


```{r}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(DT)

library(ggplot2)
library(cowplot)
```

```{r}
ca_img_result_dir = '/mnt/DATA/Prez/conditioning/results_all_caimg/'
traces_file = paste0(ca_img_result_dir, 'traces_and_positions.csv')
data = read.csv(traces_file)
```

```{r}
data = data %>%
  gather('cell', 'nevents', starts_with('events_')) %>%
  gather('trace_cell', 'norm_trace', starts_with('normTrace_')) 
data$cell = str_replace(data$cell,'events_[.]?','')
data$trace_cell = str_replace(data$trace_cell,'normTrace_[.]?','')
data = filter(data, cell == trace_cell) %>%
  select(-trace_cell)
data = data %>%
  gather('trace_cell', 'trace', starts_with('trace_')) 
data$trace_cell = str_replace(data$trace_cell,'trace_[.]?','')
data = filter(data, cell == trace_cell) %>%
  select(-trace_cell)
data$trace = as.double(data$trace)

data$cell = as.integer(data$cell)
data$inside_roi = data$inside_roi > 0
```

Scale Y to be in ratio with the real box size
```{r}
data$smooth_trans_y = data$smooth_trans_y * 0.625
```


# Assess behaviour
```{r}
data %>%
  group_by(date, inside_roi)  %>%
  summarise(ntime=n()) ->
inside_roi.time.df

ggplot(data=inside_roi.time.df, aes(date, ntime)) +
  geom_bar(stat='identity', aes(fill=inside_roi), position='dodge')
```


# Calcium events

Events per cell per day and trial
```{r}
events_total.df = data %>% 
  group_by(date, trial, cell) %>%
  summarise(total_events = sum(nevents), 
            duration_sec = max(timestamp) / 1000,
            mer = total_events / duration_sec) %>%
  arrange(cell, date, trial)

datatable(events_total.df)
```

```{r}
events.df = filter(data, nevents > 0)
```

Events during run vs during stationary
```{r}
run.threshold = 1
events.df %>% 
  mutate(running = velocity > run.threshold) %>%
  group_by(cell, running) %>%
  summarise(nnevents=n()) %>%
  ggplot(aes(cell,nnevents)) +
    geom_bar(stat='identity', aes(fill=running), position='dodge')
  
```


Cells responsive to positive stimulus
```{r}
pos_data = filter(data, date == '2018-11-01') %>%
  group_by(cell, trial, inside_roi) %>%
  summarise(total_events = sum(nevents)) %>%
  spread(inside_roi, total_events) %>%
  rename(nevents_inside='TRUE', nevents_outside='FALSE') %>%
  arrange(cell, trial) 
```

```{r}
days = seq(as.Date('2018-10-29'), as.Date('2018-11-02'), by=1)
for (cell_id in unique(data$cell)) {
  #for (i in 1:length(days)) {
    #day = days[i]
    #date.str = format(day, format='%Y-%m-%d')
    #single_trial = filter(events.df, date==date.str & cell==cell_id)
    single_trial = filter(events.df, cell==cell_id & velocity > run.threshold)
    #trial_name = sprintf('Cell_%d_on_%s', cell_id, date.str)
    trial_name = sprintf('Cell_%d', cell_id)
    g = ggplot(single_trial) +
      geom_point(aes(x=smooth_trans_x, y=smooth_trans_y, color=date, size=norm_trace)) +
      xlab(trial_name) +
      theme_void()
    out.path = paste0('/tmp/', trial_name, '.jpg')
    ggsave(filename=out.path, plot=g, device='jpeg', height=4, width=7)
  #}
}
```

##Plot trial with marked events 
Place cells have given day, however the place field is different on other days

Cells 8 and 16 are possibly a goal cell firing around the reward location.
```{r}
cell_id = 8
trial_no = 1
day.str = '2018-10-30'


gs = list()
for (trial_no in 1:3) {
  trial.df = filter(data, cell == cell_id & trial == trial_no & date == day.str) 
  trial.events = filter(trial.df, velocity >= run.threshold & nevents > 0)
  g = ggplot() +
    geom_point(data=trial.events, aes(x=smooth_trans_x, y=smooth_trans_y, size=norm_trace)) +
    geom_path(data=trial.df, aes(x=smooth_trans_x, y=smooth_trans_y), colour='blue', size=0.5, alpha = 0.75) +
    theme_void() +
    theme(legend.position='None')
  gs[[trial_no]] = g
}

plot_grid(gs[[1]], gs[[2]], gs[[3]], ncol=3)
```

Show cell filter
```{r}
library(R.matlab)
mat_file = paste0(ca_img_result_dir, 'F/jointExtraction/sorted/PCAICAsorted.mat')
ca.mat = readMat(mat_file)
image(ca.mat[['filters']][,,cell_id])
```

```{r}
get_place_field_centre = function(events.df) {
  x = weighted.mean(events.df$smooth_trans_x, events.df$norm_trace)
  y = weighted.mean(events.df$smooth_trans_y, events.df$norm_trace)
  return(c(x, y))
}

get_dist = function(pt1, pt2_x, pt2_y) {
  dist = sqrt((pt1[1] - pt2_x)^2 + (pt1[2] - pt2_y)^2)
}

day.str = '2018-10-30'
cell_id = 8
cell.df = filter(data, cell == cell_id & date == day.str) 
cell.events = filter(cell.df, nevents > 0) 
cell.df$trial = as.factor(cell.df$trial)

source('place_field.R')
place.df = getPlaceField(cell.df)
col.pallette = RColorBrewer::brewer.pal(9,"Blues")
image(place.df[['field']], col=col.pallette)
image(place.df[['occupancy']], col=col.pallette)
```

```{r}
field_centre = get_place_field_centre(cell.events)
trial.df = mutate(cell.df, field_dist = get_dist(field_centre, smooth_trans_x, smooth_trans_y))
ggplot(trial.df ) +
  geom_line(aes(x=timestamp/1000, y=norm_trace, group=1)) +
  geom_line(aes(x=timestamp/1000, y=field_dist/10 + 4, group=1), colour='blue') +
  geom_point(data=cell.events, aes(x=timestamp/1000, y=norm_trace + 1), shape=8, colour='red') +
  facet_grid(trial ~ .) +
  xlab('Time (sec)') +
  ylab('z-scored dF/F') 
```


