---
title: "R Notebook"
output: html_notebook
---

```{r}
library(plyr)
library(dplyr)
library(permute)
library(raster)
library(smoothie)
library(tidyr)
library(data.table)
library(datatrace)
library(DT)

# Testing
library(lmerTest)
library(BayesFactor)
options(BFprogress = FALSE)

# Plotting
library(ggplot2)
library(cowplot)
library(plotly)
gtheme = theme_minimal() + theme_cowplot() +
  theme(text = element_text(size=10), axis.text = element_text(size=8))

summarise = dplyr::summarise
summarize = dplyr::summarize
select = dplyr::select

source('distances.R')
source('fixed_effects.R')
source('locations.R')
source('place_field_utils.R')
source('utils.R')
source('simulations/sim_rew_distances.R')
source('plotting_params.R')
```

The code assumes data frames with place fields information are loaded in the environment.

Prepare data frames
```{r}
mouse.meta.df = read.mouse.meta(rootdirs)
trials.meta.df = read.trials.meta(rootdirs)

run.trials.si$date = char2date(run.trials.si$date)
beforetest.trials.si$date = char2date(beforetest.trials.si$date)
run.trials.si = run.trials.si %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('date', 'animal'))
```


Pct of significant place cells
```{r}
g = run.trials.si %>%
  group_by(date, day_desc, implant, animal) %>%
  dplyr::summarise(pct.mi.signif=sum(signif.mi, na.rm=TRUE)/n()*100,
                   pct.si.signif=sum(signif.si, na.rm=TRUE)/n()*100) %>%
  ggplot(aes(x=day_desc, group=animal)) +
  #geom_point(aes(y=pct.mi.signif, colour='Mutual Info')) +
  geom_point(aes(y=pct.si.signif, colour='Spatial Info')) +
  gtheme +
  geom_hline(yintercept=25, linetype='dashed') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(implant ~ .) +
  ylab('Significant spatial cells (%)')
library(plotly)
ggplotly(g)
```
Increase in mutual information due to higher spatial specificity or due to lower sampling of space.
Explanations not satisfied:
- a higher proportion o place cells
- the number of active cells did not increase?

```{r calculate early vs late correlations}
cell.cor = function(animal_name, day, cell_name) {
  early.pf = create.partial.df(early.fields, early.occupancies, animal_name, day, cell_name, 'Early')
  late.pf = create.partial.df(late.fields, late.occupancies, animal_name, day, cell_name, 'Late')
  if (nrow(late.pf) == 0 || nrow(early.pf) == 0) {
    return(0)
  }
  x = field.cor(early.pf, late.pf, nbins, make.cor.plot=FALSE)

  return(x$cor)
}

run.trials.si = run.trials.si %>%
  dplyr::rowwise() %>%
  dplyr::mutate(early.late.cor = cell.cor(animal, format(date), cell_id))
```

```{r classify place cells}
mi.thresh = -1.0
field.size.thresh.50 = 100
field.size.thresh.25 = 100
field.peak.thresh = 0
field.cor.min = 0.0

# Classification of place cells based on day SI
run.trials.pc = run.trials.si

place.cell.db = run.trials.si %>%
  dplyr::select(date, day_desc, exp, animal, cell_id, implant, 
                spatial.information, si.shuffle.mean, 
                mutual.info, mutual.info.bias,
                sparsity, field.size.50, field.size.25, 
                field.max, field.mean, trace.mean,
                early.late.cor, signif.mi, signif.si) %>%
  ungroup()


pc.test.df = beforetest.trials.si %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('date', 'animal')) %>%
  dplyr::mutate(beforetest_ordinal=location_set-1) %>%
  dplyr::select(-location_set)

beforetest.cell.db = pc.test.df %>%
  dplyr::select(date, day_desc, exp, animal, cell_id, implant, is.pc,
                spatial.information, si.shuffle.mean, mutual.info, mutual.info.bias,
                sparsity, field.size.50, field.size.25,
                signif.mi, signif.si)
```

```{r place_cell_summary}
place.cell.db %>%
  group_by(implant, animal, exp) %>%
  dplyr::summarise(si.signif.pct=sum(signif.si)/n() * 100) %>%
  group_by(implant, exp) %>%
  dplyr::summarise(mean(si.signif.pct),
                   sem(si.signif.pct))
```

## How many place cells per day
```{r}
run.trials.si %>%
  group_by(day_desc, animal, implant) %>%
  dplyr::summarise(pc.pct = sum(signif.si) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=day_desc, y=pc.pct, group=animal, color=animal, linetype=implant)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('Date') +
  ylab('Place cells (%)')
```


## Comparison of dCA1 and vCA1 place fields: pct of place cells, field size, early late corr
Sparsity not different between vCA1 and dCA1, possibly larger fields in vCA1

```{r}
compared.pcs.df = 
  bind_rows(
    filter(place.cell.db, exp=='habituation') %>% mutate(exp_title='habituation'),
    beforetest.cell.db %>% mutate(exp_title = 'test')
  ) %>%
  left_join(trials.meta.df) %>%
  left_join(mouse.meta.df) %>%
  mutate(aday = paste(animal, format(date), sep='_'),
         spatial.info.corrected = spatial.information - si.shuffle.mean)
compared.pcs.df$aday = as.factor(compared.pcs.df$aday) %>% as.integer() %>% as.factor()
    

plot.pc.stat = function(metric, facet.exp_title=FALSE) {
  metric = enexpr(metric)
  xvar = quo(implant)
  if (facet.exp_title) {
    xvar = quo(exp_title)
  }
  g = compared.pcs.df %>%
    ggplot(aes(x=!!xvar, y=!!metric)) +
    geom_violin(fill=single.colour, color=single.colour)+ 
    geom_violin(fill='transparent', colour='white', draw_quantiles=0.5, size=0.4) +
    geom_jitter(shape=16, width=0.4, height=0, size=0.1, alpha=0.15, color='#333333')+
    gtheme +
    xlab('') +
    theme(axis.title.x = element_blank(),
          legend.position = 'top')
  if (facet.exp_title) {
    g = g + facet_grid(. ~ implant)
  }
  g
}

summary.compared.pcs.df = compared.pcs.df %>%
  group_by(implant, animal, day_desc, exp_title) %>%
  dplyr::summarise(pc.pct = mean(signif.si) * 100)

compared.pcs.df = filter(compared.pcs.df, signif.si)

g.place.cell.count = summary.compared.pcs.df %>%
  ggplot(aes(x=exp_title, y=pc.pct, colour=implant)) +
  #geom_point(shape=1) +
  stat_summary(fun.data='mean_cl_boot', geom='crossbar') +
  geom_jitter(shape=1, width=0.2, height=0, size=0.5) +
  scale_color_manual(values=main.two.colours) +
  facet_grid(. ~ implant) +
  gtheme +
  ylab('Place cells (%)') + xlab('') + ylim(c(0,100)) +
  theme(axis.title.x = element_blank(),
        legend.position = 'none')
 
plot_grid(
  g.place.cell.count,
  plot.pc.stat(field.size.50 / nbins / nbins * 100, TRUE) +
    ylab('% of maze'),
  plot.pc.stat(spatial.information-si.shuffle.mean, TRUE) + ylab('bits per deconv activity'),
  plot.pc.stat(early.late.cor, TRUE) + ylab('correlation'),
  nrow = 1, rel_widths = c(0.95,1,1,1))

figure.ggsave('Figure_1DEGH.pdf', width=12.5, height=2.9)
```


```{r}
print('Field size signif larger in vCA1')
field.size.model = lmerTest::lmer(log(field.size.50 ) ~ implant + (1 | aday), 
                                  data=compared.pcs.df, REML=TRUE)
summary(field.size.model)
anova(field.size.model, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(field.size.model, 
                       compared.pcs.df$animal, 
                       compared.pcs.df$implant)
create.summary(mutate(compared.pcs.df, field.size=field.size.50/nbins/nbins*100), 
               field.size, implant)

models = create.bayes.lm.pair(mutate(compared.pcs.df, val=log(field.size.50)))
models$full/models$null
calc.pair.95CI(models$full, function(x) {exp(x) * 100})
```

```{r}
print('Percent of place cells not different')
pc.count.model = lmerTest::lmer(pc.pct ~ implant + (1 | animal), data=summary.compared.pcs.df, REML=TRUE)
summary(pc.count.model)
anova(pc.count.model, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(pc.count.model, 
                       summary.compared.pcs.df$animal, 
                       summary.compared.pcs.df$implant)
group_by(summary.compared.pcs.df, implant) %>%
  dplyr::summarise(mean(pc.pct), sem(pc.pct))
dplyr::summarise(ungroup(summary.compared.pcs.df), mean(pc.pct), sem(pc.pct))

models = create.bayes.lm.pair(summary.compared.pcs.df,
                              formula.full = pc.pct ~ 1 + implant + animal,
                              formula.null = pc.pct ~ 1 + animal,
                              whichRandom = 'animal')
models$full/models$null
calc.pair.95CI(models$full, show.percent.change = FALSE)
```

```{r}
print('Spatial information not statistically different')
spatial.info.model = lmerTest::lmer(log(0.2 + spatial.info.corrected) ~ implant + (1 + day_desc | animal), 
                                    data=compared.pcs.df, REML=TRUE)
summary(spatial.info.model)
anova(spatial.info.model, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(spatial.info.model, 
                       compared.pcs.df$animal, 
                       compared.pcs.df$implant)

models = create.bayes.lm.pair(mutate(compared.pcs.df, val=log(0.2 + spatial.info.corrected)))
models$full/models$null
calc.pair.95CI(models$full, function(x) {(exp(x) - 0.2)})
create.summary(compared.pcs.df, spatial.info.corrected, implant)

print('Day-stability not statistically different')
create.summary(compared.pcs.df, early.late.cor)
create.summary(compared.pcs.df, early.late.cor, implant)
early.late.cors.model = lmerTest::lmer(early.late.cor ~ implant + (1 | aday), 
                                       data=subset(compared.pcs.df, exp_title=='habituation'), 
                                       REML=TRUE)
summary(early.late.cors.model)
anova(early.late.cors.model, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(early.late.cors.model, 
                       subset(compared.pcs.df, !is.na(early.late.cor) & exp_title=='habituation')$animal, 
                       subset(compared.pcs.df, !is.na(early.late.cor) & exp_title=='habituation')$implant)
models = create.bayes.lm.pair(filter(compared.pcs.df, !is.na(early.late.cor)) %>% mutate(val=early.late.cor))
models$full/models$null
calc.pair.95CI(models$full, show.percent.change = FALSE)
```
    

# Pct of place cells within goal
Load reward locations
```{r}
all.locations.df = map_dfr(rootdirs, read_locations)
rewards.df =  all.locations.df %>%
  filter(!is_test) %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('date', 'animal', 'location_set'))

locations.df = rewards.df %>%
  dplyr::select(date, animal, location_set) %>%
  dplyr::distinct()

locations.df = data.table(locations.df)
setkey(locations.df, date, animal)

test.rewards.df = all.locations.df %>%
  filter(is_test) %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(dplyr::select(trials.meta.df, -location_set), by=c('date', 'animal'))
```


## Compare the locations of the highest field peaks

```{r}
beforetest.rewards.df = filter(test.rewards.df, exp_title == 'beforetest')
beforetest.rewards.df = data.table(beforetest.rewards.df)
merged.run.trials.pc = left_join(run.trials.si, locations.df, by=c('animal', 'date', 'location_set'))

run.trials.pc2rew.dist = merged.run.trials.pc %>%
  filter(signif.si) %>%
  left_join(beforetest.rewards.df, by=c('animal', 'implant'), suffix=c('.activity', '.reward')) %>%
  mutate(rew.dist = norm2(field.max.x - trans_x, field.max.y - trans_y)) %>%
  group_by(animal, date.activity, date.reward, cell_id) %>%
  dplyr::top_n(1, wt=desc(rew.dist)) %>% # choose closer reward
  dplyr::rename(min.rew.dist=rew.dist)

# calc dist to rew
pc.test.df = pc.test.df %>%
  dplyr::group_by(date, day_desc, animal) %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist,
        closer.rew.angle=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.angle,
        closest.location.ordinal=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                                   field.max.x, field.max.y)$location.ordinal,
        is.goal.cell = signif.si & (min.rew.dist <= goal.cell.max.dist))
  
# Pct of place cell during test runs
beforetest.pc.summary = pc.test.df %>%
  group_by(implant, date, day_desc, animal) %>%
  dplyr::summarise(nsignif=sum(signif.si),
                   signif.pct = mean(signif.si) * 100,
                   at.rew.n = sum(signif.si & min.rew.dist <= goal.cell.max.dist),
                   at.rew.pct = at.rew.n / max(1,sum(signif.si)) * 100)
beforetest.pc.summary %>%
  dplyr::group_by(implant) %>%
  dplyr::summarise(mean(nsignif), mean(signif.pct),  mean(at.rew.pct), mean(at.rew.n)) %>%
  dplyr::mutate_if(is.double, round, 0)

```

Compare with the test trials with habituation trials
```{r warning=FALSE}
baseline.trials.pc = filter(run.trials.pc2rew.dist, signif.si, day_desc.activity=='habituation day#3')
compared.test.trials.pc = filter(pc.test.df, signif.si) %>% dplyr::rename(day_desc.reward = day_desc)
uniform.fields.df = sim.fields.from.occupied(beforetest.fields)
uniform.pc.dist = calc.rew.distances.for.fields(filter(test.rewards.df, exp_title=='beforetest'),
                                                uniform.fields.df) %>%
  left_join(test.rewards.df, by=c('animal', 'location_set')) %>%
  dplyr::rename(day_desc.reward = day_desc) %>%
  dplyr::filter(exp_title == 'beforetest')

g.test.pf.shift = ggplot() +
  geom_density(data=baseline.trials.pc, aes(x=min.rew.dist * perc2dist), linetype='dashed') +
  geom_density(data=compared.test.trials.pc, aes(x=min.rew.dist * perc2dist)) +
  geom_density(data=uniform.pc.dist, aes(x=min.rew.dist * perc2dist), linetype='dotted') +
  #facet_wrap(animal ~ ., scales='free_x') +
  #facet_grid(implant ~ day_desc.reward) +
  facet_grid(. ~ implant) +
  geom_vline(xintercept = goal.cell.max.dist * perc2dist, linetype='dotted') +
  coord_flip() +
  gtheme +
  xlim(c(0,120)) +
  xlab('Place field distance to reward (cm)') + ylab('Density')
g.test.pf.shift
```


Plot location of the place field centres with regards to the rewards
```{r}
plot.field.locs = function(pc.df, rewards.day_desc, fields.list=run.fields, date.activity.var=date.activity) {
  date.activity.var = enquo(date.activity.var)
  animals.occupancy.df = map_dfr(pc.df$animal %>% unique, ~ {
            dates = filter(pc.df, animal==.x) %>% pull(!!date.activity.var)
            fields.list[[.x]][[format(dates[1])]][[1]] %>% 
              reshape2::melt() %>%
              filter(!is.na(value)) %>%
              mutate(Var1 = 100/nbins * (Var1 + 0.5),
                     Var2 = 100/nbins * (Var2 + 0.5),
                     animal=.x)
  })
  ggplot() +
    geom_raster(data=animals.occupancy.df, aes(x=Var1, y=100-Var2), fill='grey20', alpha=0.1) +
    geom_jitter(data=pc.df, aes(x=field.max.x, y=100-field.max.y, color=min.rew.dist <= goal.cell.max.dist),
                alpha=0.35, width=0.5, height=0.5, size=1) +
    geom_point(data=filter(beforetest.rewards.df, day_desc==rewards.day_desc),
               mapping=aes(trans_x, 100-trans_y),
               color='black', shape=2) +
    facet_wrap(. ~ animal, ncol=2) +
    scale_color_manual(values=rev(side.two.coulours)) +
    xlim(c(0,100)) + ylim(c(0,100)) +
    labs(size='Mutual info', colour='Goal cell', x='X position (a.u.)', y='Y position (a.u.)')
}

plot.field.locs(filter(pc.test.df, signif.si, day_desc=='learning2 day#1'), 
                'learning2 day#1',
                fields.list=beforetest.fields,
                date.activity.var=date) +
  labs(title='Test after first learning')
ggsave('/home/prez/tmp/cheeseboard/place_fields_test1.svg', units = 'cm', width=12, height=20) 

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == 'learning2 day#1'),
  'learning2 day#1') +
  labs(title='Last day habituation')
ggsave('/home/prez/tmp/cheeseboard/place_fields_habit3.svg', units = 'cm', width=12, height=20) 
```

```{r}
plot.field.locs(filter(pc.test.df, signif.si, day_desc=='learning3 day#1'), 
                'learning3 day#1',
                fields.list=beforetest.fields,
                date.activity.var=date) +
  labs(title='Test after second learning')

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == 'learning3 day#1'),
  'learning3 day#1') +
  labs(title='Last day habituation')
```

```{r}
plot.field.locs(filter(pc.test.df, signif.si, day_desc=='learning4 day#1'), 
                'learning4 day#1',
                fields.list=beforetest.fields,
                date.activity.var=date) +
  labs(title='Test after third learning')

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == 'learning4 day#1'),
  'learning4 day#1') +
  labs(title='Last day habituation')
```


```{r}
trial.learning.day = 'learning1 day#5'
reward.learning.day = 'learning2 day#1'
plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity==trial.learning.day, day_desc.reward==reward.learning.day),
  reward.learning.day) + labs(title='Trials at the end of first learning')

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == reward.learning.day),
  reward.learning.day) +
  labs(title='Third day habituation')
```


### Statistical tests for number of place cells at reward
Pct of place cells at reward: compared test day with habituation day
```{r}
# Summarizes percent of cells within the threshold distance
summarize.rew.pc.pct = function(df, dist.var=min.rew.dist, dist.threshold=goal.cell.max.dist) {
  dist.var = enquo(dist.var)
  df %>%
    group_by(date, day_desc, animal, implant) %>%
    dplyr::summarise(at.reward=sum(!!dist.var <= dist.threshold),
                     ncells = n(),
                     pct.reward=at.reward / ncells * 100)
}

summary.pc.test.df = summarize.rew.pc.pct(filter(pc.test.df, signif.si))

compared.habit.trials.df = run.trials.pc2rew.dist %>%
  filter(exp.activity=='habituation', signif.si) %>%
  dplyr::select(-ends_with('.activity')) %>%
  dplyr::rename(date=date.reward,
                day_desc=day_desc.reward)

merged.summary.df = bind_rows(
  summarize.rew.pc.pct(compared.habit.trials.df) %>% mutate(exp='habituation'),
  summary.pc.test.df %>% mutate(exp='test')) %>%
  dplyr::mutate(animal_beforetest_day = paste(animal, day_desc, sep='_'))

# Merge data about which test trials showed the animal learned
library(reshape2)
dca1.rew.pc.pct = subset(merged.summary.df, implant == 'dCA1')
vca1.rew.pc.pct = subset(merged.summary.df, implant == 'vCA1')
fem.dca1 = lmerTest::lmer(pct.reward ~  exp + (1 + day_desc | animal), data=dca1.rew.pc.pct)
print('Fraction of dCA1 place cells at reward increased')
summary(fem.dca1)
anova(fem.dca1, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(fem.dca1, dca1.rew.pc.pct$animal, dca1.rew.pc.pct$exp)

fem.vca1 = lmerTest::lmer(pct.reward ~  exp + (1 + day_desc | animal), data=vca1.rew.pc.pct)
print('Fraction of vCA1 place cells did not increase')
summary(fem.vca1)
anova(fem.vca1, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(fem.vca1, vca1.rew.pc.pct$animal, vca1.rew.pc.pct$exp)


g.pc.change.pct.test = merged.summary.df %>%
 ggplot(aes(x=exp, y=pct.reward, group=animal_beforetest_day)) +
  geom_point(aes(color=animal)) +
  geom_line() +
  facet_grid(. ~ implant, scales = 'free') +
  xlab('') +
  gtheme +
  ggtitle('Fraction of place cells at reward increased') +
  ylab('Place cells at reward (%)')
ggplotly(g.pc.change.pct.test)

g.pf.shift.fig = plot_grid(g.test.pf.shift,
                           g.pc.change.pct.test + theme(legend.position = 'top'),
                           nrow=1, rel_widths = c(1.0, 1.0))

```

```{r}
fst.learning.days = (char2date(beforetest.rewards.df$date))  %>% unique
fst.learning.day = filter(rewards.df, !is.na(location_set))$date %>% char2date %>% min
fst.learning.days = c(fst.learning.day, fst.learning.days)
```



# Place cells at previous reward location
```{r}
prev.locations.df = all.locations.df %>%
  filter(!is_test) %>%
  add_prev_locations(prev.loc.set.diff=1) %>%
  add_prev_locations(prev.loc.set.diff=2) %>%
  add_prev_locations(prev.loc.set.diff=3) %>%
  filter()
```

```{r}
fst.moved.location.df = all.locations.df %>%
  filter(!is_test) %>%
  add_prev_locations(prev.loc.set.diff=1) %>%
  filter(!current_loc, prev_loc_set==1) %>%
  ungroup() %>%
  dplyr::select(-date) %>%
  dplyr::distinct()
```


For each place field calculate the count of its peaks, and how many of them are in the reward zone or previous reward zone
```{r warning=FALSE}
trial.days.df = trials.meta.df %>%
  dplyr::select(date, animal, exp) %>%
  filter(animal != 'missing') %>%
  dplyr::distinct()

create.peaks.df.at.locs = function(fields, locs.df, trial.days, max.rew.dist.thr=goal.cell.max.dist, cell.db=place.cell.db) {
  res = map2_dfr(trial.days$date,
                 trial.days$animal,
                 ~ {
                    .x = format(.x)
                    .y = as.character(.y)
                     if ((.y %in% names(fields)) & (.x %in% names(fields[[.y]]))) {
                       calc.field.peaks.info(.x, .y, 
                                             fields[[.y]][[.x]], 
                                             rew.df=filter.rews.df(locs.df, .x, .y),
                                             max.rew.dist.thr)
                     } else {
                       warning('Not found animal=', .y, ' on day=', .x)
                       return(data.frame())
                     }
                   })
  res$date = char2date(res$date)
  res %>%
    left_join(trials.meta.df, by=c('animal', 'date')) %>%
    left_join(cell.db, by=c('animal', 'date', 'cell_id', 'day_desc', 'exp'))
}

trial.peaks.at.rew = create.peaks.df.at.locs(run.fields, prev.locations.df, trial.days.df)
trial.peaks.at.fst.moved = create.peaks.df.at.locs(run.fields, fst.moved.location.df, trial.days.df)
trial.peaks.at.current.rew = create.peaks.df.at.locs(run.fields, prev.locations.df[current_loc==TRUE,], trial.days.df)

beforetest.peaks.at.rew = create.peaks.df.at.locs(beforetest.fields, prev.locations.df, trial.days.df, 
                                                  cell.db=beforetest.cell.db)
beforetest.peaks.fst.moved = create.peaks.df.at.locs(beforetest.fields, fst.moved.location.df, trial.days.df,
                                                     cell.db=beforetest.cell.db)
beforetest.rewards.df$current_loc = FALSE
beforetest.peaks.at.current.rew = create.peaks.df.at.locs(beforetest.fields, beforetest.rewards.df, trial.days.df,
                                                          cell.db=beforetest.cell.db)

habituation.peaks.at.fst.moved = filter(trial.peaks.at.fst.moved, exp=='habituation')
```

Peaks in place fields from habituation with regards to first reward locations
```{r warning=FALSE}
habittest.daypair = filter(trials.meta.df, exp == 'habituation') %>%
  left_join(dplyr::select(beforetest.rewards.df, date, animal, location_set), 
            by=c('animal'), suffix=c('.habitday', '.testday'))
habit.fields.at.test.rews = map_dfr(1:nrow(habittest.daypair), ~ {
  animal_name = as.character(habittest.daypair$animal[.x])
  activity_date = as.Date(habittest.daypair$date.habitday[.x])
  test_date = as.Date(habittest.daypair$date.testday[.x])
  rew.df = beforetest.rewards.df[animal==animal_name & date == test_date,]
  calc.field.peaks.info(activity_date,
                        animal_name,
                        run.fields[[animal_name]][[format(activity_date)]], 
                        rew.df=rew.df,
                        max.rew.dist.thr=goal.cell.max.dist) %>%
    dplyr::mutate(date.active = activity_date,
                  day_desc.active = habittest.daypair$day_desc[.x],
                  date.reward = test_date)
})
habit.fields.at.test.rews = habit.fields.at.test.rews %>%
  dplyr::select(-date) %>%
  left_join(trials.meta.df, by=c('animal'='animal', 'date.reward'='date'), suffix=c('', '.reward')) %>%
  dplyr::select(-day_ordinal, -exp, -location_set, -current.rew.peaks.count) %>%
  dplyr::rename(day_desc.reward = day_desc) %>%
  left_join(place.cell.db, by=c('animal'='animal', 'date.active'='date', 'cell_id'='cell_id', 'day_desc.active'='day_desc'))
```

## Summary on multiple fields per cell

Fields per cell in dca1 and vCA1: fields have fewer multifields after learning
```{r}
npeaks.summary = bind_rows(
    filter(trial.peaks.at.fst.moved, exp == 'habituation'),
    beforetest.peaks.fst.moved) %>% 
  filter(signif.si, npeaks > 0) %>%
  #filter(day_desc == 'habituation day#3') %>% 
  group_by(implant, exp, animal, day_desc) %>%
  dplyr::summarise(create.hist.tibble(npeaks, hist.breaks=seq(0.5,6,1)), ncells=n()) %>%
  filter(ncells >= 5) # Only include samples with >= 5 cells

# Fraction of multifields
npeaks.summary %>%
  ungroup() %>%
  filter(mid == 1) %>%
  group_by(implant) %>%
  dplyr::summarise(mean.multi = mean(100-pct.count), sem.multi = sem(100-pct.count))

plotted.npeaks.summary = npeaks.summary %>%
  group_by(implant, exp, mid) %>%
  dplyr::summarise(pct.mean = mean(pct.count), pct.sem = sem(pct.count)) 

plotted.npeaks.summary %>%
  ggplot(aes(x=mid, color=exp, fill=exp)) +
  geom_errorbar(aes(ymin=pct.mean - pct.sem, ymax=pct.mean + pct.sem), width=0.3) +
  geom_step(aes(x=mid-0.5, y=pct.mean, group=exp), size=1) +
  facet_wrap(implant ~ .) +
  scale_color_manual(values=side.two.coulours) +
  xlab('# fields') + ylab('Place cells (%)') +
  xlim(c(0.5,4.5)) + ylim(c(0,100)) +
  gtheme

plotted.npeaks.summary %>% 
  filter(exp=='habituation') %>%
  ggplot(aes(x=mid, color=implant)) +
  geom_errorbar(aes(ymin=pct.mean - pct.sem, ymax=pct.mean + pct.sem), width=0.3) +
  geom_step(aes(x=mid-0.5, y=pct.mean)) +
  #scale_color_manual(values=c('#666666', '#52b6ff')) +
  scale_color_manual(values=main.two.colours) +
  xlab('# fields') + ylab('Place cells (%)') +
  xlim(c(0.5,4.5)) + 
  gtheme +
  labs(color='')

figure.ggsave('Figure_1F.pdf', width=6.1, height=3.6)
```

```{r}
npeaks.habituation = filter(trial.peaks.at.fst.moved, exp == 'habituation') %>%
  filter(signif.si, npeaks>0) %>%
  group_by(implant, exp, animal, day_desc) %>%
  dplyr::summarise(mean.peaks = mean(npeaks))

npeaks.habituation %>%
  create.summary(mean.peaks, implant)

lmer.test.print(npeaks.habituation, 
                var = mean.peaks,
                fixed.effects = implant,
                randef.str = '(1 | animal)',
                diagnostics.groupvar = implant)
models = create.bayes.lm.pair(npeaks.habituation,
                              formula.full = mean.peaks ~ 1 + implant + animal,
                              formula.null = mean.peaks ~ 1 + animal,
                              whichRandom = 'animal')
models$full / models$null
calc.pair.95CI(models$full)
```


# Distribution of ditances to the rewards
```{r}
compared.habit.fields.at.test.rews = habit.fields.at.test.rews %>%
  filter(signif.si, exp == 'habituation', day_desc.active == 'habituation day#3') %>%
  dplyr::select(-ends_with('.active')) %>%
  dplyr::rename(date=date.reward,
                day_desc=day_desc.reward)

plot.densities = function(df, xvar.expr, fill.var, ..., include.means=FALSE) {
  xvar.expr = enexpr(xvar.expr)
  fill.var = enquo(fill.var)
  group.vars = c(fill.var, enquos(...))
  
  df = unite(df, 'groups.concat', map_chr(group.vars, as_label), remove = FALSE) 
  xvar.mean.summary = group_by(df, implant, groups.concat, !!!group.vars) %>%
    dplyr::summarise(xvar.mean=mean(!!xvar.expr, na.rm=TRUE),
                     .groups='drop')
  
  g = df %>%
    ggplot(aes(x=!!xvar.expr, group=groups.concat)) +
    geom_density(aes(fill=!!fill.var), alpha=0.3, adjust=1, color='#333333') +
    scale_fill_manual(values=c('#999999', '#0098ff')) +
    scale_color_manual(values=c('#999999', '#0098ff')) +
    gtheme +
    ylab('Density')
  if (include.means) {
    g = g +
      geom_vline(data=xvar.mean.summary,
                 mapping=aes(xintercept=xvar.mean, color=!!fill.var),
                 linetype='longdash')
  }
  g
}

bind_rows(
  mutate(compared.habit.fields.at.test.rews, group.name='1_habituation'),
  filter(beforetest.peaks.at.current.rew, signif.si) %>% mutate(group.name='2_test')
) %>%
  plot.densities(min.rew.dist * perc2dist, group.name) +
  geom_vline(xintercept = goal.cell.max.dist, linetype='dotted') +
  xlim(c(0,100)) +
  facet_grid(. ~ implant) +
  coord_flip() +
  xlab('Distance (cm)')
figure.ggsave('Figure_2FH_Left.pdf', height=6, width=8)
```


## Multifield distance to the closest reward
```{r}
habit.summary.fields.pct.df = summarize.rew.pc.pct(
  filter(compared.habit.fields.at.test.rews),
  dist.var=min.rew.dist, 
  dist.threshold=goal.cell.max.dist) %>% dplyr::ungroup()

beforetest.summary.fields.pct.df = summarize.rew.pc.pct(
  filter(beforetest.peaks.at.current.rew, signif.si),
  dist.var=min.rew.dist, 
  dist.threshold=goal.cell.max.dist)

merged.summary.df = bind_rows(
  habit.summary.fields.pct.df %>% mutate(exp='habituation'),
  beforetest.summary.fields.pct.df %>% mutate(exp='test')) %>%
  mutate(animal_beforetest_day = paste(animal, day_desc, sep='_'))
  #filter(animal_beforetest_day %in% kept.testtrials$animal_beforetest_day)
merged.summary.df$exp = as.factor(merged.summary.df$exp)
merged.summary.df$aday = as.factor(merged.summary.df$animal_beforetest_day) %>% as.integer %>% as.factor

dca1.rew.pc.pct = subset(merged.summary.df, implant == 'dCA1')
vca1.rew.pc.pct = subset(merged.summary.df, implant == 'vCA1')

print('Fraction of dCA1 place cells at reward increased')
fem.model = lmerTest::lmer(pct.reward ~ exp*implant + (1 + exp + day_desc | animal), 
                           data=merged.summary.df, REML = TRUE)
plot.model.diagnostics(fem.model, merged.summary.df$implant, merged.summary.df$exp)
anova(fem.model, refit=FALSE, ddf='Satterthwaite')
pairwise.post.hoc(fem.model, factor.interaction=c('exp:implant'))
create.summary(merged.summary.df, pct.reward, implant, exp)

models = create.bayes.lm.pair(dca1.rew.pc.pct,
                     formula.full = pct.reward ~ 1 + exp + aday + animal,
                     formula.null = pct.reward ~ 1 + aday + animal,
                     whichRandom = c('aday', 'animal'))
models$full / models$null
calc.pair.95CI(models$full, pair.vars = c('exp-habituation', 'exp-test'))

models = create.bayes.lm.pair(vca1.rew.pc.pct,
                     formula.full = pct.reward ~ 1 + exp + aday + animal,
                     formula.null = pct.reward ~ 1 + aday + animal,
                     whichRandom = c('aday', 'animal'))
models$full / models$null
calc.pair.95CI(models$full, pair.vars = c('exp-habituation', 'exp-test'))

merged.summary.df %>%
  ggplot(aes(x=exp, y=pct.reward, group=animal_beforetest_day)) +
  #geom_point(aes(color=animal)) +
  geom_line(size=0.25) +
  facet_grid(. ~ implant, scales = 'free') +
  xlab('') +
  gtheme +
  ylab('Place cells at reward (%)') +
  ggtitle('Fraction of place cells at reward increased at test trial')


figure.ggsave('Figure_2FH_Right.pdf', height=6, width=5)
```

## Differences in place cells close and further from the reward
```{r}
beforetest.peaks.at.current.rew %>%
  filter(signif.si) %>%
  mutate(is.goal.cell = npeaks.at.rew > 0) %>%
  plot.densities(spatial.information - si.shuffle.mean, is.goal.cell, include.means = TRUE)  +
  facet_grid(implant ~ .) +
  xlim(c(0.06, 0.6))

beforetest.peaks.at.current.rew %>%
  filter(signif.si, npeaks > 0, npeaks <= 3) %>%
  mutate(is.goal.cell = npeaks.at.rew > 0) %>%
  plot.densities(field.size.50  / nbins / nbins * 100, is.goal.cell, npeaks, include.means = TRUE) + 
  facet_grid(npeaks ~ implant, scales='free_x') +
  coord_flip() + xlab('Field size (% of maze)')

beforetest.peaks.at.current.rew %>%
  filter(signif.si) %>%
  ggplot(aes(x=min.rew.dist, y=field.size.50)) +
  geom_point(shape=1, alpha=0.3, color='#333333') +
  facet_grid(. ~ implant) +
  gtheme
```



# Do cells have propoensity to be close to reward?

Model of cell randomly assigned at distances following observed distribution

```{r}
pc.ids = dplyr::group_by(beforetest.peaks.at.current.rew, implant, animal, cell_id) %>%
  dplyr::summarise(nsignif=sum(signif.si), 
                   n=n()) %>%
  dplyr::filter(n > 1) %>%
  dplyr::filter(nsignif/n >= 0.5) %>%
  dplyr::mutate(animal_cell = paste(animal, cell_id, sep='_')) 

cell.dist.df = beforetest.peaks.at.current.rew %>%
  dplyr::select(implant, animal, date, cell_id, min.rew.dist, rew.peaks.count) %>%
  dplyr::filter(paste(animal, cell_id, sep='_') %in% pc.ids$animal_cell) %>%
  dplyr::group_by(implant, animal, date)

nsamplings = 1000
set.seed(42)

shuffle.fun = function(v) {
  if (length(v) == 1) {
    return(v)
  }
  org.indecies = seq_along(v)
  shuffled.indecies = seq_along(v)
  # check no cell in the same order as current
  while (any((shuffled.indecies - org.indecies) == 0)) {
    shuffled.indecies = permute::shuffle(length(v))
  }
  v[shuffled.indecies]
}

shuffled.cell.dist.df = map_dfr(
  1:nsamplings, ~ dplyr::mutate(cell.dist.df, 
                                shuffle.id=.x,
                                shuffle.cell_id = shuffle.fun(cell_id))) %>%
  filter(!is.na(shuffle.cell_id))

shuffled.cell.dist.summary = shuffled.cell.dist.df %>%
  group_by(implant, animal, shuffle.cell_id, shuffle.id) %>%
  dplyr::summarise(m.dist = mean(min.rew.dist, na.rm=TRUE), 
                   n=sum(!is.na(min.rew.dist)), 
                   var.dist=var(min.rew.dist) / (n),
                   at.rew.times=sum(min.rew.dist <= goal.cell.max.dist),
                   rew.peaks.count=sum(rew.peaks.count)) %>%
  filter(n > 1) %>%  # only include cells present on at least two days
  dplyr::mutate(group='sampled', line_g=paste0(group, shuffle.id))
```

Number of fields at reward per cell compared to the number after the cell identities randomly shuffled 
```{r}
rew.peaks.pct.step = 20
few.fields.thr = 20
many.fields.thr = 50
shuffled.cell.dist.summary = mutate(shuffled.cell.dist.summary,
                                  rew.peaks.pct = rew.peaks.count / (n * 2) * 100)
shuffled.cell.dist.summary = as.data.table(shuffled.cell.dist.summary)

vca1.shuffle.ecdfs = map(unique(shuffled.cell.dist.summary$line_g), 
                         ~ ecdf(shuffled.cell.dist.summary[ line_g == .x & implant=='vCA1', rew.peaks.pct]))

vca1.ecdf.knots = map(vca1.shuffle.ecdfs, ~ knots(.x)) %>% unlist %>% sort %>% unique
vca1.shuffle.ecdf.summary.df = map_df(vca1.ecdf.knots, function(knot) {
  vals = map_dbl(seq_along(vca1.shuffle.ecdfs), ~ vca1.shuffle.ecdfs[[.x]](knot))
  list(knot=knot,
       mean.val=mean(vals),
       lower.val=quantile(vals, 0.05)[[1]],
       higher.val=quantile(vals, 0.95)[[1]])
})

dca1.shuffle.ecdfs = map(unique(shuffled.cell.dist.summary$line_g), 
                         ~ ecdf(shuffled.cell.dist.summary[ line_g == .x & implant=='dCA1', rew.peaks.pct]))

dca1.ecdf.knots = map(dca1.shuffle.ecdfs, ~ knots(.x)) %>% unlist %>% sort %>% unique
dca1.shuffle.ecdf.summary.df = map_df(dca1.ecdf.knots, function(knot) {
  vals = map_dbl(seq_along(dca1.shuffle.ecdfs), ~ dca1.shuffle.ecdfs[[.x]](knot))
  list(knot=knot,
       mean.val=mean(vals),
       lower.val=quantile(vals, 0.05)[[1]],
       higher.val=quantile(vals, 0.95)[[1]])
})

shuffled.cell.atrew.hist = shuffled.cell.dist.summary %>%
  group_by(implant, shuffle.id) %>%
  dplyr::summarise(create.hist.tibble(rew.peaks.pct, seq(0,100,rew.peaks.pct.step)))

# Percentile of cells in the shuffles with few and many fields
shuffled.pct.atrew.95p = shuffled.cell.atrew.hist %>%
  dplyr::mutate(few_fields = mid < few.fields.thr, many_fields = mid >= many.fields.thr) %>%
  dplyr::group_by(implant, shuffle.id, few_fields, many_fields) %>%
  dplyr::summarise(cell.pct=sum(pct.count)) %>% 
  dplyr::group_by(implant, few_fields, many_fields) %>%
  dplyr::summarise(cell.pct.05p = stats::quantile(cell.pct, 0.05)[1],
                   cell.pct.mean = mean(cell.pct),
                   cell.pct.95p = stats::quantile(cell.pct, 0.95)[1],
                   z=list(sort(cell.pct)))

shuffled.cell.atrew.hist.summary = shuffled.cell.atrew.hist %>%
  group_by(implant, mid) %>%
  dplyr::summarise(m.count=mean(pct.count), sem.count=sem(pct.count), sd.count=sd(pct.count))

                                                                                
cell.rew.distance.summary = beforetest.peaks.at.current.rew %>%                 
  filter(paste(animal, cell_id, sep='_') %in% pc.ids$animal_cell) %>%           
  dplyr::group_by(implant, animal, cell_id) %>%                                 
  dplyr::summarise(m.dist = mean(min.rew.dist),                                 
                   n=sum(!is.na(min.rew.dist)),                                 
                   nsignif=sum(signif.si, na.rm=TRUE),                          
                   var.dist=var(min.rew.dist) / (n),  # biased estimate for variance
                   at.rew.times=sum(min.rew.dist <= goal.cell.max.dist),        
                   rew.peaks.count=sum(rew.peaks.count)) %>%                    
  dplyr::mutate(group='actual', 
                line_g=group,
                rew.peaks.pct = rew.peaks.count / (n * 2) * 100)   

cell.rew.distance.summary.test = cell.rew.distance.summary


bind_rows(
  vca1.shuffle.ecdf.summary.df %>% mutate(implant='vCA1'),
  dca1.shuffle.ecdf.summary.df %>% mutate(implant='dCA1')) %>%
  ggplot() +
  geom_step(aes(x=knot,y=lower.val), color='#aaaaaa') +
  geom_step(aes(x=knot,y=higher.val), color='#aaaaaa') +
  stat_ecdf(data=cell.rew.distance.summary.test,
            aes(x=rew.peaks.pct), color=side.two.coulours[1], size=0.75) +
  xlab('Reward fields (%)') + ylab('Cells CDF') +
  facet_grid(. ~ implant) +
  gtheme
figure.ggsave('Figure_4E.pdf', height=4.0, width=6.5)

cell.rew.atrew.hist = cell.rew.distance.summary %>%
  group_by(implant) %>%
  dplyr::summarise(create.hist.tibble(rew.peaks.pct, seq(0,100,rew.peaks.pct.step)),
                   pct.count.cumsum = cumsum(pct.count))

vca1.freq.rew.fields = 100 - max(subset(cell.rew.atrew.hist, implant == 'vCA1' & mid < many.fields.thr)$pct.count.cumsum)
print('vCA1 Frequent rewards percentile')
mean(subset(shuffled.pct.atrew.95p, implant=='vCA1' & many_fields)$z[[1]] < vca1.freq.rew.fields)

dca1.freq.rew.fields = 100 - max(subset(cell.rew.atrew.hist, implant == 'dCA1' & mid < many.fields.thr)$pct.count.cumsum)
print('dCA1 Frequent rewards percentile')
mean(subset(shuffled.pct.atrew.95p, implant=='dCA1' & many_fields)$z[[1]] < dca1.freq.rew.fields)

cell.rew.atrew.hist.summary = cell.rew.distance.summary %>%
  group_by(implant) %>%
  dplyr::summarise(create.hist.tibble(rew.peaks.pct, seq(0,100,rew.peaks.pct.step)))

shuffled.cell.atrew.hist.summary %>%
  ggplot(aes(x=mid)) +
  geom_bar(aes(y=m.count),  stat='identity', position='dodge', width=rew.peaks.pct.step,
           fill='white', color='#666666', size=0.5) +
  geom_errorbar(aes(ymin=m.count-sd.count, ymax=m.count+sd.count), 
                width=rew.peaks.pct.step / 3, 
                color='#666666') +
  geom_step(data=cell.rew.atrew.hist.summary, aes(x=mid-rew.peaks.pct.step/2, y=pct.count), 
            color=side.two.coulours[1], size=0.75) +
  facet_wrap(. ~ implant) + ylab('Cells (%)') + xlab("Reward fields (%)") +
  labs(title="Count of cell's reward fields") +
  scale_x_continuous(breaks = seq(0, 100, rew.peaks.pct.step)) +
  gtheme
```


```{r}
shuffled.pct.atrew.95p
cell.rew.atrew.hist
```


## Cell recall
```{r}
beforetest.cell.recall = beforetest.peaks.at.current.rew %>%
  ungroup() %>%
  dplyr::select(animal, implant, exp_day_ordinal, cell_id, min.rew.dist) %>% 
  tidyr::pivot_wider(names_from=exp_day_ordinal, values_from=min.rew.dist, names_prefix='day') %>% 
  filter(!is.na(day9)) %>%
  tidyr::pivot_longer(-c(animal, implant, cell_id), names_to='exp_day_ordinal', names_prefix='day',
                      values_to='min.rew.dist') %>%
  filter(exp_day_ordinal != 15) %>%
  group_by(animal, implant, exp_day_ordinal) %>% 
  dplyr::summarise(ncells=n(),
                   recall.pct=sum(!is.na(min.rew.dist)) / ncells * 100) 

beforetest.cell.recall %>%
  dplyr::group_by(exp_day_ordinal) %>%
  dplyr::summarise(recall.mean = mean(recall.pct),
                   recall.sem = sem(recall.pct))

beforetest.cell.recall.summary = beforetest.cell.recall %>%
  dplyr::group_by(implant, exp_day_ordinal) %>%
  dplyr::summarise(recall.mean = mean(recall.pct),
                   recall.sem = sem(recall.pct))

beforetest.cell.recall.summary %>%
  ggplot(aes(x=as.integer(exp_day_ordinal), group=implant)) +
  geom_line(aes(y=recall.mean, color=implant)) +
  geom_ribbon(aes(ymin=recall.mean - recall.sem, 
                  ymax=recall.mean+recall.sem,
                  fill=implant), 
              alpha=0.3) +
  scale_fill_manual(values=main.two.colours) +
  scale_color_manual(values=main.two.colours) +
  scale_x_continuous(breaks=c(9,11,13)) +
  gtheme +
  ylim(c(0, 100)) +
  xlab('') + ylab('Recall (%)')

figure.ggsave('Figure_S4C.pdf', height=3.3, width=5.2)
```

