---
title: "R Notebook"
output: html_notebook
---

```{r}
library(plyr)
library(dplyr)
library(permute)
library(raster)
library(smoothie)
library(tidyr)
library(data.table)
library(datatrace)
library(DT)

# Plotting
library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() +
  theme(text = element_text(size=10), axis.text = element_text(size=8))

summarise = dplyr::summarise
summarize = dplyr::summarize
select = dplyr::select

source('distances.R')
source('fixed_effects.R')
source('locations.R')
source('utils.R')
source('simulations/sim_rew_distances.R')
```

The code assumes data frames with place fields information are loaded in the environment.

Prepare data frames
```{r}
mouse.meta.df = read.mouse.meta(rootdirs)
trials.meta.df = read.trials.meta(rootdirs)

run.trials.si = run.trials.si %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('date', 'animal'))
```


Stats for mutual information
```{r}
summary(run.trials.si$mutual.info - run.trials.si$mutual.info.bias)
```

```{r}
run.trials.si %>%
  ungroup() %>%
  dplyr::summarise(pct.mi.signif=sum(signif.mi, na.rm = TRUE)/n()*100,
                   pct.si.signif=sum(signif.si, na.rm = TRUE)/n()*100,)
```

Distribution of mutual information
```{r}
run.trials.si %>%
  ggplot() +
  #geom_boxplot(aes(x=day_desc, y=mutual.info-mutual.info.bias, color=implant)) +
  #geom_boxplot(aes(x=date, y=field.max, color=signif.si)) +
  geom_boxplot(aes(x=date, y=spatial.information, color=signif.si)) + ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
Pct of significant place cells
```{r}
run.trials.si %>%
  group_by(date, day_desc, implant, animal) %>%
  dplyr::summarise(pct.mi.signif=sum(signif.mi, na.rm=TRUE)/n()*100,
                   pct.si.signif=sum(signif.si, na.rm=TRUE)/n()*100) %>%
  ggplot(aes(x=day_desc)) +
  geom_point(aes(y=pct.mi.signif, colour='Mutual Info')) +
  geom_point(aes(y=pct.si.signif, colour='Spatial Info')) +
  gtheme +
  geom_hline(yintercept=25, linetype='dashed') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(implant ~ .) +
  ylab('Significant spatial cells (%)')
```
Increase in mutual information due to higher spatial specificity or due to lower sampling of space.
Explanations not satisfied:
- a higher proportion o place cells
- the number of active cells did not increase?


Place cells have not necessairly sparser fields than non-place cells
```{r}
run.trials.si %>%
  #filter(date == '2019-09-02' | date=='2019-09-01') %>%
  filter(date == '2019-07-22' | date=='2019-07-23') %>%
  ggplot() +
  #geom_point(aes(x=field.max, y=mutual.info-mutual.info.bias, color=signif.si), alpha=0.2)
  geom_point(aes(x=sparsity, y=spatial.information, color=signif.si), alpha=0.2) +
  facet_grid(date ~ animal)
```

```{r calculate early vs late correlations}
cell.cor = function(animal_name, day, cell_name) {
  early.pf = create.partial.df(early.fields, early.occupancies, animal_name, day, cell_name, 'Early')
  late.pf = create.partial.df(late.fields, late.occupancies,  animal_name, day, cell_name, 'Late')
  if (nrow(late.pf) == 0 || nrow(early.pf) == 0) {
    return(0)
  }
  x = field.cor(early.pf, late.pf, nbins, make.cor.plot=FALSE)

  return(x$cor)
}

run.trials.si = run.trials.si %>%
  dplyr::rowwise() %>%
  dplyr::mutate(early.late.cor = cell.cor(animal, date, cell_id))
```

```{r classify place cells}
sample.by.animal = function(df, nsamples=50, other.cols=c('date.fst', 'date.snd')) {
  #group_by(df, animal, date.fst, date.snd) %>%
  cols = c('animal', other.cols)
  group_by_at(df, dplyr::vars(cols)) %>%
    sample_n(nsamples, replace = TRUE) %>%
    ungroup()
}

mi.thresh = -1.0
#field.size.thresh.50 = 5
field.size.thresh.50 = 100
#field.size.thresh.25 = 10
field.size.thresh.25 = 100
#field.peak.thresh = 2
field.peak.thresh = 0
field.cor.min = 0.0

is.place.cell = function(is.signif, mutual.info.wo.bias, field.size.50, field.size.25, field.max, field.mean, field.cor) {
  is.pc = is.signif &
    mutual.info.wo.bias >= mi.thresh &
    field.size.50 <= field.size.thresh.50 &
    field.size.25 <= field.size.thresh.25 &
    field.max - field.mean >= field.peak.thresh &
    field.cor >= field.cor.min
  ifelse(is.na(is.pc), FALSE, is.pc)
}

# Classification of place cells based on day SI
run.trials.pc = run.trials.si %>%
  mutate(is.pc = is.place.cell(signif.si,
                               mutual.info - mutual.info.bias,
                               field.size.50, field.size.25, field.max,
                               field.mean, early.late.cor))

place.cell.db = run.trials.pc %>%
  dplyr::select(date, day_desc, exp, animal, cell_id, implant, is.pc,
                spatial.information, mutual.info, mutual.info.bias,
                sparsity, field.size.50, field.size.25,
                early.late.cor, signif.mi, signif.si) %>%
  ungroup()
```

```{r place_cell_summary}
place.cell.db %>%
  group_by(implant, animal, exp) %>%
  dplyr::summarise(pc.pct=sum(is.pc)/n() * 100,
                   si.signif.pct=sum(signif.si)/n() * 100) %>%
  group_by(implant, exp) %>%
  dplyr::summarise(mean(pc.pct),
                   sem(pc.pct),
                   mean(si.signif.pct),
                   sem(si.signif.pct))
```
Stability of place cells from early to late trials during habituation
```{r}
place.cell.db %>%
  filter(signif.si, day_desc == 'habituation day#3') %>%
  ggplot(aes(x=implant, y=early.late.cor)) +
  geom_violin() +
  geom_hline(yintercept = 0, linetype='dashed') +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  xlab('') + ylab('Early to late trials correlation') +
  gtheme
```


Sparsity of the selected cells
```{r}
run.trials.pc %>%
  #filter(date == '2019-09-02' | date=='2019-08-29') %>%
  filter(date == '2019-07-22' | date=='2019-07-29') %>%
  #ggplot(aes(x=sparsity, y=mutual.info-mutual.info.bias, color=is.pc)) +
  ggplot(aes(x=sparsity, y=spatial.information, color=is.pc)) +
  geom_point(alpha=0.2) +
  geom_rug(alpha=0.03) +
  facet_grid(date ~ animal) +
  xlim(c(1,6))
```


## How many place cells per day
```{r}
run.trials.pc %>%
  group_by(date, animal, implant) %>%
  dplyr::summarise(pc.pct = sum(signif.si) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=date, y=pc.pct, group=animal, color=animal, linetype=implant)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('Date') +
  ylab('Place cells (%)')
```


```{r}
run.trials.pc %>%
  filter(exp=='learning', day_desc != 'learning3 day#3') %>%
  sample.by.animal(n=50, other.cols = c('day_desc')) %>%
  group_by(animal, implant, day_desc) %>%
  dplyr::summarise(pc.pct=mean(is.pc),
                   pc.sem=sem(is.pc),
                   signif.pct=mean(signif.si)) %>%
  ggplot(aes(x=day_desc, y=pc.pct, group=implant, color=implant)) +
  geom_point(position=position_dodge(width=0.5)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('Date') +
  ylab('Place cells (%)')
```


Comparison dCA1 vs vCA1
```{r}
run.trials.pc %>%
  group_by(exp, implant, day_desc, animal) %>%
  dplyr::summarise(pc.pct = sum(is.pc) / n() * 100) %>%
  group_by(exp, implant) %>%
  dplyr::summarise(med.pct = median(pc.pct),
                   sem.pct = sem(pc.pct))


run.trials.pc %>%
  group_by(exp, implant, day_desc, animal) %>%
  dplyr::summarise(pc.pct = sum(is.pc) / n() * 100) %>%
  ggplot(aes(x=implant, y=pc.pct)) +
  geom_point(aes(color=animal)) +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  facet_grid(exp ~ .)
```

## Place field size and sparsity dCA1 vs vCA1
Sparsity not different between vCA1 and dCA1, possibly larger fields in vCA1

```{r}
cheeseboard.bin.cm = 9

plot.pc.stat = function(metric, exp_name='habituation') {
  metric = enquo(metric)
  place.cell.db %>%
    filter(signif.si) %>%
    left_join(trials.meta.df) %>%
    filter(exp==exp_name) %>%
    group_by(date,animal) %>%
    sample_n(50, replace=TRUE) %>%
    ungroup() %>%
    ggplot(aes(x=implant, y=!!metric)) +
    #geom_violin(aes(fill=implant)) +
    geom_violin() +
    stat_summary(fun.y=median, geom="point", shape=23, size=2) +
    gtheme +
    xlab('') +
    #gxaxis.blank +
    theme(axis.title.x = element_blank(),
          legend.position = 'top')
}

plot_grid(
  plot.pc.stat(field.size.25 / nbins / nbins * 100) +
    ylab('Field size\n(% of cheeseboard)')  + ylim(c(0,7)),
  plot.pc.stat(sparsity) + ylim(c(1,12)) +
    ylab('Sparsity'),
  plot.pc.stat(mutual.info - mutual.info.bias) +
    ylab('Mutual Info\n(bias subtracted)'),
  plot.pc.stat(spatial.information) + ylab('Spatial Info\n(bits / dF)'),
  nrow = 1)

ggsave('/tmp/pf_stats.svg', width=20, height=7.5, units='cm')
```


# Pct of place cells within goal
Load reward locations
```{r}
all.locations.df = map_dfr(rootdirs, read_locations)
rewards.df =  all.locations.df %>%
  filter(!is_test) %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('date', 'animal', 'location_set'))

locations.df = rewards.df %>%
  dplyr::select(date, animal, location_set) %>%
  dplyr::distinct()

locations.df = data.table(locations.df)
setkey(locations.df, date, animal)

test.rewards.df = all.locations.df %>%
  filter(is_test) %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(dplyr::select(trials.meta.df, -location_set), by=c('date', 'animal'))
```
Distance of place fields to goal
```{r}
merged.run.trials.pc = left_join(run.trials.pc, locations.df, by=c('animal', 'date', 'location_set'))

goal.cell.max.dist = 15
pc.rew.dist.df = merged.run.trials.pc %>%
  dplyr::group_by(date, day_desc, animal) %>%
  dplyr::mutate(
        closest.location.ordinal=calc.min.rew.dist(filter.rews.df(rewards.df, date[1], animal[1]),
                                                   field.max.x, field.max.y)$location.ordinal,
        min.rew.dist=calc.min.rew.dist(filter.rews.df(rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist) %>%
  dplyr::mutate(is.goal.cell = signif.si & (min.rew.dist <= goal.cell.max.dist)) %>%
  replace_na(is.goal.cell=FALSE)

pc.rew.dist.df %>%
  filter(exp != 'habituation', signif.si) %>% 
  sample.by.animal(nsamples=25, other.cols=c('day_desc')) %>% 
  ggplot(aes(x=day_desc, y=min.rew.dist, fill=implant)) +
  geom_violin() +
  geom_hline(yintercept = goal.cell.max.dist, linetype='dashed') +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('') + ylab('Place field distance\nto reward (%)')
```


##During the test trial vs during the habituation

```{r}
beforetest.rewards.df = filter(test.rewards.df, exp_title == 'beforetest')
beforetest.rewards.df = data.table(beforetest.rewards.df)

run.trials.pc2rew.dist = merged.run.trials.pc %>%
  filter(signif.si) %>%
  left_join(beforetest.rewards.df, by=c('animal', 'implant'), suffix=c('.activity', '.reward')) %>%
  mutate(rew.dist = norm2(field.max.x - trans_x, field.max.y - trans_y)) %>%
  group_by(animal, date.activity, date.reward, cell_id) %>%
  dplyr::top_n(1, wt=desc(rew.dist)) %>% # choose closer reward
  dplyr::rename(min.rew.dist=rew.dist)

pc.test.df = beforetest.trials.si %>%
  mutate(is.pc = is.place.cell(signif.si, mutual.info - mutual.info.bias, field.size.50, field.size.25, field.max, field.mean, 1.0))

pc.test.df = pc.test.df %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(select(trials.meta.df, -location_set), by=c('date', 'animal'))


# calc dist to rew
pc.test.df = pc.test.df %>%
  dplyr::group_by(date, day_desc, animal) %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist,
        closest.location.ordinal=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                                   field.max.x, field.max.y)$location.ordinal)


# Pct of place cell during test runs
pc.test.df %>%
  group_by(date, implant) %>%
  dplyr::summarise(nsignif=sum(signif.si),
                   signif.pct = mean(signif.si) * 100,
                   at.rew.n = sum(signif.si & min.rew.dist <= goal.cell.max.dist),
                   at.rew.pct = at.rew.n / sum(signif.si) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(implant) %>%
  dplyr::summarise(mean(nsignif), mean(signif.pct),  mean(at.rew.pct), mean(at.rew.n)) %>%
  dplyr::mutate_if(is.double, round, 0)
```

Compare with the test trials with habituation trials
```{r warning=FALSE}
baseline.trials.pc = filter(run.trials.pc2rew.dist, signif.si, day_desc.activity=='habituation day#3')
compared.test.trials.pc = filter(pc.test.df, signif.si) %>% dplyr::rename(day_desc.reward = day_desc)
uniform.fields.df = sim.fields.from.occupied(beforetest.fields)
uniform.pc.dist = calc.rew.distances.for.fields(filter(test.rewards.df, exp_title=='beforetest'),
                                                uniform.fields.df) %>%
  left_join(test.rewards.df, by=c('animal', 'location_set')) %>%
  dplyr::rename(day_desc.reward = day_desc) %>%
  dplyr::filter(exp_title == 'beforetest')

g.test.pf.shift = ggplot() +
  geom_density(data=baseline.trials.pc, aes(x=min.rew.dist), linetype='dashed') +
  geom_density(data=compared.test.trials.pc, aes(x=min.rew.dist)) +
  geom_density(data=uniform.pc.dist, aes(x=min.rew.dist), linetype='dotted') +
  #facet_wrap(animal ~ ., scales='free_x') +
  #facet_grid(implant ~ day_desc.reward) +
  facet_grid(. ~ implant) +
  geom_vline(xintercept = goal.cell.max.dist, linetype='dotted') +
  coord_flip() +
  gtheme +
  xlim(c(0,100)) +
  xlab('Place field distance from closer reward (%)') + ylab('Density')
g.test.pf.shift
```

Place cells not distributed uniformly across space, even durng habituation. Can I have some confidence intervals around these?
Idea: Check the distribution against the scaled by occupation probability.



Compare the last day trials with habituation trials:
Higher peak of number of cells in proximity around 25 % of cheeseboard
```{r}
baseline.trials.pc = filter(run.trials.pc2rew.dist, signif.si, day_desc.activity=='habituation day#3', animal!='A-BL')
compared.trials.pc = filter(run.trials.pc2rew.dist, signif.si, date.activity == format(as.Date(date.reward) - 1), animal!='A-BL')

beforetest.days = c('learning2 day#1', 'learning3 day#1', 'learning3 day#3')
ggplot() +
  geom_density(data=filter(baseline.trials.pc, day_desc.reward %in% beforetest.days),
               aes(x=min.rew.dist), linetype='dashed') +
  geom_density(data=filter(compared.trials.pc, day_desc.reward %in% beforetest.days),
               aes(x=min.rew.dist), alpha=0.2) +
  geom_density(data=filter(uniform.pc.dist, day_desc.reward %in% beforetest.days),
               aes(x=min.rew.dist), linetype='dotted') +
  geom_vline(xintercept = goal.cell.max.dist, linetype='dotted') +
  facet_grid(implant ~ day_desc.reward) +
  #facet_wrap(animal ~ day_desc.reward, scales='free') +
  #facet_grid(implant ~ date.reward , scales = 'free') +
  #facet_grid(. ~ implant) +
  coord_flip() +
  gtheme +
  xlim(c(0,100)) +
  xlab('Place field distance from reward (%)') + ylab('Density')
```

Plot location of the place field centres with regards to the rewards
```{r}
plot.field.locs = function(pc.df, rewards.day_desc, fields.list=run.fields, date.activity.var=date.activity) {
  date.activity.var = enquo(date.activity.var)
  animals.occupancy.df = map_dfr(pc.df$animal %>% unique, ~ {
            dates = filter(pc.df, animal==.x) %>% pull(!!date.activity.var)
            fields.list[[.x]][[dates[1]]][[1]] %>% 
              reshape2::melt() %>%
              filter(!is.na(value)) %>%
              mutate(Var1 = 100/nbins * (Var1 + 0.5),
                     Var2 = 100/nbins * (Var2 + 0.5),
                     animal=.x)
  })
  ggplot() +
    geom_raster(data=animals.occupancy.df, aes(x=Var1, y=100-Var2), fill='grey20', alpha=0.1) +
    geom_jitter(data=pc.df, aes(x=field.max.x, y=100-field.max.y, color=min.rew.dist <= goal.cell.max.dist),
                alpha=0.35, width=0.5, height=0.5, size=1) +
    geom_point(data=filter(beforetest.rewards.df, day_desc==rewards.day_desc),
               mapping=aes(trans_x, 100-trans_y),
               color='black', shape=2) +
    facet_wrap(. ~ animal, ncol=2) +
    xlim(c(0,100)) + ylim(c(0,100)) +
    labs(size='Mutual info', colour='Goal cell', x='X position (a.u.)', y='Y position (a.u.)')
}

plot.field.locs(filter(pc.test.df, signif.si, day_desc=='learning2 day#1'), 
                'learning2 day#1',
                fields.list=beforetest.fields,
                date.activity.var=date) +
  labs(title='Test after first learning')
ggsave('/home/prez/tmp/cheeseboard/place_fields_test1.svg', units = 'cm', width=12, height=20) 

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == 'learning2 day#1'),
  'learning2 day#1') +
  labs(title='Last day habituation')
ggsave('/home/prez/tmp/cheeseboard/place_fields_habit3.svg', units = 'cm', width=12, height=20) 
```

```{r}
plot.field.locs(filter(pc.test.df, signif.si, day_desc=='learning3 day#1'), 
                'learning3 day#1',
                fields.list=beforetest.fields,
                date.activity.var=date) +
  labs(title='Test after second learning')

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == 'learning3 day#1'),
  'learning3 day#1') +
  labs(title='Last day habituation')
```

```{r}
plot.field.locs(filter(pc.test.df, signif.si, day_desc=='learning3 day#3'), 
                'learning3 day#3',
                fields.list=beforetest.fields,
                date.activity.var=date) +
  labs(title='Test after third learning')

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == 'learning3 day#3'),
  'learning3 day#3') +
  labs(title='Last day habituation')
```


```{r}
trial.learning.day = 'learning1 day#5'
reward.learning.day = 'learning2 day#1'
plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity==trial.learning.day, day_desc.reward==reward.learning.day),
  reward.learning.day) + labs(title='Trials at the end of first learning')

plot.field.locs(
  filter(run.trials.pc2rew.dist, signif.si, day_desc.activity =='habituation day#3', day_desc.reward == reward.learning.day),
  reward.learning.day) +
  labs(title='Third day habituation')
```


### Statistical tests for number of place cells at reward
Pct of place cells at reward: compared test day with habituation day
```{r}
# Summarizes percent of cells within the threshold distance
summarize.rew.pc.pct = function(df, dist.var=min.rew.dist, dist.threshold=goal.cell.max.dist) {
  dist.var = enquo(dist.var)
  df %>%
    group_by(date, day_desc, animal, implant) %>%
    dplyr::summarise(at.reward=sum(!!dist.var <= dist.threshold),
                     ncells = n(),
                     pct.reward=at.reward / ncells * 100)
}

summary.pc.test.df = summarize.rew.pc.pct(filter(pc.test.df, signif.si))

compared.habit.trials.df = run.trials.pc2rew.dist %>%
  filter(exp.activity=='habituation', signif.si) %>%
  #filter(day_desc.activity=='habituation day#3') %>%
  dplyr::select(-ends_with('.activity')) %>%
  dplyr::rename(date=date.reward,
                day_desc=day_desc.reward)

merged.summary.df = bind_rows(
  summarize.rew.pc.pct(compared.habit.trials.df) %>% mutate(exp='habituation'),
  summary.pc.test.df %>% mutate(exp='test')) %>%
  filter(animal != 'L-TL') %>% # remove animal with few cells during test 
  #filter(animal != 'C-1R') %>%
  dplyr::mutate(animal_beforetest_day = paste(animal, day_desc, sep='_'))

# Merge data about which test trials showed the animal learned
library(reshape2)
merged.summary.wide.df = reshape2::dcast(merged.summary.df, day_desc + animal + implant ~ exp, value.var = 'pct.reward') %>% 
  dplyr::mutate(pc.pct.change = `test` - `habituation`) %>%
  left_join(dplyr::select(crossings.change.df, -date, -location_set, -habituation, -test), 
            by=c('animal', 'day_desc', 'implant'))

learned.threshold = 0.1
kept.testtrials = merged.summary.wide.df %>% 
  dplyr::mutate(animal_beforetest_day = paste(animal, day_desc, sep='_')) %>%
  filter(norm_crossings_change > learned.threshold) 
  
merged.summary.df = filter(merged.summary.df, animal_beforetest_day %in% kept.testtrials$animal_beforetest_day)
dca1.rew.pc.pct = subset(merged.summary.df, implant == 'dCA1')
vca1.rew.pc.pct = subset(merged.summary.df, implant == 'vCA1')
fem.dca1 = lmerTest::lmer(pct.reward ~  exp + (1 + day_desc | animal), data=dca1.rew.pc.pct)
print('Fraction of dCA1 place cells at reward increased')
summary(fem.dca1)
plot.model.diagnostics(fem.dca1, dca1.rew.pc.pct$animal, dca1.rew.pc.pct$exp)

fem.vca1 = lmerTest::lmer(pct.reward ~  exp + (1 + day_desc | animal), data=vca1.rew.pc.pct)
print('Fraction of vCA1 place cells did not increase')
summary(fem.vca1)
plot.model.diagnostics(fem.vca1, vca1.rew.pc.pct$animal, vca1.rew.pc.pct$exp)

#g.pc.change.pct.test = plot.val.change.between.groups(
#    create.animal.summary(merged.summary.df, pct.reward, exp),
#    pct.reward, exp) +
g.pc.change.pct.test = merged.summary.df %>%
 ggplot(aes(x=exp, y=pct.reward, group=animal_beforetest_day)) +
  #geom_point(aes(color=animal)) +
  geom_line() +
  facet_grid(. ~ implant, scales = 'free') +
  xlab('') +
  gtheme +
  ggtitle('Fraction of place cells at reward increased at test trial') +
  ylab('Place cells at reward (%)')
g.pc.change.pct.test

g.pf.shift.fig = plot_grid(g.test.pf.shift,
                           g.pc.change.pct.test + theme(legend.position = 'top'),
                           nrow=1, rel_widths = c(0.6, 1.0))

ggsave('/tmp/test_pf_shift.svg', g.pf.shift.fig,
       width=15, height=8, units='cm')
```

When habituation compared to learning - using theshold of 25 where distribution of distances peak
```{r}
# summary.lastday.df = run.trials.pc2rew.dist %>%
#   filter(signif.si, date.activity == format(as.Date(date.reward) - 1)) %>%
#   dplyr::rename(date=date.reward,
#                 day_desc=day_desc.reward) %>%
#   summarize.rew.pc.pct(dist.threshold=25)
# 
# learning.pc.change.pct = create.df.with.paired.values(
#   summarize.rew.pc.pct(compared.habit.trials.df, dist.threshold=25), habituation, 
#   summary.lastday.df, learning) %>% filter(animal != 'A-BL') # No test trials for the animal
# 
# plot.pc.change.pct(learning.pc.change.pct) + ggtitle('Fraction of place cells at reward did not change on last day learning')
# wilcox.test(pct.reward ~ group, subset(learning.pc.change.pct, implant=='vCA1'), paired=TRUE)
# wilcox.test(pct.reward ~ group, subset(learning.pc.change.pct, implant=='dCA1'), paired=TRUE)
```

# Change of place fields and statistics across days
Calculate stats for changes between day combinations.
```{r}
calc.field.cor = function(fst.fields, snd.fields,
                          fst.occupanices, snd.occupanices) {
    if (is.null(fst.fields) | is.null(snd.fields)) {
      return(NA)
    }
    cor.res = field.cor(create.pf.df(fst.fields, fst.occupanices),
                        create.pf.df(snd.fields, snd.occupanices),
                        max.xy=nbins)
    cor.res$cor
}

daypair.diff = function(animal.daypair.df, days, include.cors=TRUE) {
  pc.change = animal.daypair.df %>%
    arrange(animal, cell_id, desc(date)) %>%
    group_by(animal, implant, cell_id) %>%
    dplyr::summarise(spatial.info.diff = pairdiff(spatial.information),
                     field.max.x.diff = pairdiff(field.max.x, 100),
                     field.max.y.diff = pairdiff(field.max.y, 100),
                     field.size.diff = pairdiff(field.size.50, 100),
                     field.max.diff = pairdiff(field.max, 0),
                     mean.signif.si = mean(signif.si, na.rm=TRUE),
                     mean.signif.mi = mean(signif.mi, na.rm=TRUE),
                     mean.mi=mean(mutual.info - mutual.info.bias, na.rm=TRUE),
                     signif.si.changed = !pairequal(signif.si),
                     mean.pc = mean(is.pc, na.rm=TRUE),
                     pc.fst = is.pc[1],
                     mean.goal.cells = mean(is.goal.cell, na.rm=TRUE),
                     goal.cell.fst = is.goal.cell[1],
                     same.rew.loc = pairequal(location_set),
                     same.closest.loc = pairequal(closest.location.ordinal),
                     days.diff = as.Date(days) %>% diff %>% as.integer,
                     date.diff=paste(format(days[2]), ' - ', format(days[1])),
                     date.fst = format(days[1]),
                     date.snd = format(days[2]),
                     day_desc.fst = min(day_desc),
                     day_desc.snd = max(day_desc),
                     n=n()) %>%
    mutate(field.xy.dist = norm2(field.max.x.diff, field.max.y.diff)) %>%
    select(-field.max.x.diff, -field.max.y.diff)

  # Calculate field correlation
  cells = unique(pc.change$cell_id)
  pc.change$field.cor = rep(0.0, length(cells))
  pc.change = data.table(pc.change)
  animal_name = animal.daypair.df$animal[1]
  if (include.cors) {
    setkey(pc.change, date.fst, date.snd, animal, cell_id)
    for (cell_name in cells) {
      cor.res = calc.field.cor(run.fields[[animal_name]][[format(days[1])]][[paste(cell_name)]],
                               run.fields[[animal_name]][[format(days[2])]][[paste(cell_name)]],
                               run.occupancies[[animal_name]][[format(days[1])]][[paste(cell_name)]],
                               run.occupancies[[animal_name]][[format(days[2])]][[paste(cell_name)]])
      pc.change[date.fst==days[1] & date.snd==days[2] & animal==animal_name & cell_id==cell_name,]$field.cor = cor.res
    }
  }

  return(pc.change)
}
```

```{r}
pc.rew.dist.df = data.table(pc.rew.dist.df)
max.days.diff = 5
pc.change.df = data.frame()
for (animal_name in unique(pc.rew.dist.df$animal)) {
  all.days = unique(subset(pc.rew.dist.df, animal==animal_name)$date) %>% as.Date
  day.comb = combn(1:length(all.days), 2)
  for (i in 1:ncol(day.comb)) {
    days_i = day.comb[,i]
    days = all.days[days_i]
    if (diff(days) <= max.days.diff) {
      animal.daypair.df = pc.rew.dist.df[animal == animal_name & (date == days[1] | date == days[2]),]
      pc.change = daypair.diff(animal.daypair.df, days)

      pc.change.df = bind_rows(pc.change.df, pc.change)
    }
  }
}
```

Shuffle cell identities to see if the remapping different than random
- but this will not be informative: cells accumulate at reward location, so there will a close by field.
```{r}
# pc.change.df = data.table(pc.change.df)
# setkey(pc.change.df, animal, date.fst, date.snd, cell_id)
# nshuffles=100
# field.xy.dist.thr.df = data.frame()
# for (animal_name in unique(pc.rew.dist.df$animal)) {
#   all.days = unique(subset(pc.rew.dist.df, animal==animal_name)$date) %>% as.Date
#   for (i in 1:(length(all.days)-1)) {
#     day.fst = all.days[i]
#     day.snd = all.days[i+1]
#     animal.fstday.df = pc.rew.dist.df[animal == animal_name & date == day.fst,]
#     setorder(animal.fstday.df, cell_id)
#     animal.sndday.df = pc.rew.dist.df[animal == animal_name & date == day.snd,]
#     days = c(day.fst, day.snd)
#     shuffled.field.cor = data.frame()
#     shuffled.field.xy.dist = data.frame()
#     for (j in 1:nshuffles) {
#       animal.sndday.df$cell_id = shuffle(animal.sndday.df$cell_id)
#       shuffled.change = daypair.diff(bind_rows(animal.fstday.df, animal.sndday.df), days, include.cors=FALSE) %>%
#           arrange(cell_id)
#       #shuffled.field.cor = bind_rows(shuffled.field.cor, select(shuffled.change, animal, cell_id, field.cor))
#       shuffled.field.xy.dist = bind_rows(shuffled.field.xy.dist,
#                                          select(shuffled.change, implant, animal, cell_id, field.xy.dist))
#     }
#
#     dist.thrs = ddply(shuffled.field.xy.dist, .(cell_id), summarise,
#           field.xy.dist.thr = quantile(field.xy.dist, 0.05)[[1]] %>% unname)
#     dist.thrs$date.fst = format(day.fst)
#     dist.thrs$date.snd = format(day.snd)
#     dist.thrs$animal = animal_name
#     field.xy.dist.thr.df = bind_rows(field.xy.dist.thr.df, dist.thrs)
#
#
#     #ddply(shuffled.field.cor, cell_id, summarise,
#     #      field.cor.thr = quantile(field.cor, 0.95)[[1]] %>% unname)
#   }
# }
```

Distance between place field centre on consecutive days
```{r}
# pc.change.df2 = pc.change.df %>% left_join(field.xy.dist.thr.df, by=c('animal', 'date.fst', 'date.snd', 'cell_id'))
# pc.change.df2 %>%
#   filter(n>1) %>%
#   filter(days.diff == 1) %>%
#   sample.by.animal() %>%
#   mutate(signif.xy.dist = field.xy.dist <= field.xy.dist.thr) %>%
#   group_by(date.fst) %>%
#   dplyr::summarise(pct.field.signif.dist=sum(signif.xy.dist, na.rm = TRUE)/sum(!is.na(signif.xy.dist))*100)
```

```{r}
fst.learning.days = (as.Date(beforetest.rewards.df$date))  %>% unique
fst.learning.day = filter(rewards.df, !is.na(location_set))$date %>% as.Date %>% min
fst.learning.days = c(fst.learning.day, fst.learning.days)
```


How many place cells have their field at the same place
```{r}
pc.change.df$days.diff = as.factor(pc.change.df$days.diff)
pc.change.df %>%
  filter(pc.fst, n>1) %>%
  filter(mean.pc>=0.5) %>%
  sample.by.animal() %>%
  ggplot(aes(x=days.diff, y=field.xy.dist, color=same.rew.loc)) +
  geom_violin() +
  facet_grid(. ~ implant)
```
How a place field on a reference day changes the following day
```{r}
pc.change.df$date.fst = as.factor(pc.change.df$date.fst)

pc.change.df %>%
  filter(days.diff==1) %>%
  filter(pc.fst, n > 1) %>%
  sample.by.animal() %>%
  ggplot(aes(x=day_desc.fst, y=field.xy.dist)) +
  geom_violin() +
  facet_grid(implant ~ .) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(fill='Place cell\non both days', x='Reference day', y='Field centre moved distance (%)') +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(aes(yintercept=goal.cell.max.dist), linetype='dashed')
```
```{r}
g.pf.day2day.cor =  pc.change.df %>%
  filter(days.diff==1) %>%
  filter(pc.fst, n > 1) %>%
  sample.by.animal() %>%
  ggplot(aes(x=day_desc.fst, y=field.cor)) +
  geom_violin() +
  facet_grid(implant ~ .) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(fill='Place cell\non both days', x='Reference day', y='Field correlation') +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(yintercept=field.cor.min, linetype='dashed')

g.pf.day2day.cor
```

How many place cells kept their place field during the same reward location set.
Includes cells that were detected on both days
```{r}
field.cor.min = 0.3

g.kept.pf = pc.change.df %>%
  filter(pc.fst, n==2) %>%
  filter(same.rew.loc) %>%
  filter(startsWith(day_desc.fst, 'learning1')) %>%
  filter(as.integer(days.diff) < max.days.diff) %>%
  dplyr::mutate(kept.field = field.cor >= field.cor.min) %>%
  group_by(animal, implant, date.fst, days.diff) %>%
  dplyr::summarise(kept.field.pct=mean(kept.field)*100) %>%
  dplyr::group_by(implant, days.diff) %>%
  dplyr::summarise(mean.kept.field.pct=mean(kept.field.pct),
                   sem.kept.field.pct=sem(kept.field.pct)) %>%
  #dplyr::summarise(pct.unchanged=sum(mean.pc == 1.0 & n > 1) / n() * 100) %>%
  ggplot(aes(x=days.diff, group=implant, linetype=implant)) +
  geom_line(aes(y=mean.kept.field.pct)) +
  geom_ribbon(aes(ymin=mean.kept.field.pct - sem.kept.field.pct, ymax=mean.kept.field.pct + sem.kept.field.pct),
              alpha=0.1) +
  #facet_grid(. ~  implant) +
  labs(x='Days later', y='Kept the place field\nduring learning1(%)', linetype='') +
  gtheme +
  theme(legend.position = 'top')

g.kept.pf
```

```{r}
ggsave(
  '/tmp/day2day_field.svg',
  plot_grid(
    g.pf.day2day.cor,
    g.kept.pf,
    nrow=1, rel_widths = c(1.0, 0.7)),
  width=21, height=10, units='cm')
```


# How many goal cells active during the next beforetest trial

There are few place cells during the beforetest (87), so few cells are matched between days.

Amongst the cells matched: (but problem that the goal cell not necessairly moved)
```{r}
pc.test.df %>%
  dplyr::select(implant, animal, day_desc, cell_id, signif.si, min.rew.dist) %>%
  dplyr::mutate(is.reward.zone = min.rew.dist < goal.cell.max.dist,
                is.goal.cell = signif.si & is.reward.zone) %>%
  filter((day_desc == 'learning2 day#1' & is.goal.cell) | day_desc == 'learning3 day#1') %>%
  reshape2::dcast(implant + animal + cell_id  ~ day_desc,
                  value.var='is.reward.zone') %>%
  filter(!is.na(`learning2 day#1`)) %>%
  dplyr::group_by(implant) %>%
  dplyr::summarise(both.goal.cells=mean(`learning3 day#1`, na.rm=TRUE), n=n(),
                   matched.cells=n-sum(is.na(`learning3 day#1`)))
```



# Place field correlation between trials and test sessions
```{r}
day.cors.df = place.cell.db %>%
  rowwise() %>%
  dplyr::mutate(
    aftertest2trial.cor = calc.field.cor(
        aftertest.fields[[animal]][[date]][[paste(cell_id)]],
        late.fields[[animal]][[date]][[paste(cell_id)]],
        aftertest.occupancies[[animal]][[date]][[paste(cell_id)]],
        late.occupancies[[animal]][[date]][[paste(cell_id)]]),
    beforetest2trial.cor = calc.field.cor(
        beforetest.fields[[animal]][[date]][[paste(cell_id)]],
        early.fields[[animal]][[date]][[paste(cell_id)]],
        beforetest.occupancies[[animal]][[date]][[paste(cell_id)]],
        early.occupancies[[animal]][[date]][[paste(cell_id)]]
    )
  )
```

```{r}
day.cors.df %>%
  filter(!is.na(aftertest2trial.cor)) %>%
  group_by(date, animal, implant, signif.si) %>%
  dplyr::summarise(med.cor=median(aftertest2trial.cor)) %>%
  group_by(signif.si, implant) %>%
  dplyr::summarise(median(med.cor))

day.cors.df %>%
  filter(!is.na(aftertest2trial.cor)) %>%
  ggplot(aes(x=day_desc, y=aftertest2trial.cor, fill=is.pc)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  facet_grid(implant ~ .) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
```{r}
day.cors.df %>%
  filter(!is.na(beforetest2trial.cor)) %>%
  group_by(date, animal, is.pc, implant) %>%
  dplyr::summarise(med.cor=median(beforetest2trial.cor)) %>%
  group_by(is.pc, implant) %>%
  dplyr::summarise(median(med.cor))

day.cors.df %>%
  filter(!is.na(beforetest2trial.cor)) %>%
  sample.by.animal(n=100, other.cols=c('date')) %>%
  ggplot(aes(x=day_desc, y=beforetest2trial.cor, fill=is.pc)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  #facet_wrap(. ~ animal, ncol=4) +
  facet_grid(. ~ implant) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
Early vs late trial cors
```{r}
day.cors.df %>%
  filter(!is.na(early.late.cor), exp=='learning') %>%
  group_by(date, animal, signif.si, implant) %>%
  dplyr::summarise(med.cor=median(early.late.cor)) %>%
  group_by(signif.si, implant) %>%
  dplyr::summarise(median(med.cor),
                   sem(med.cor))

day.cors.df %>%
  filter(day_desc != 'learning3 day#3') %>%
  filter(!is.na(early.late.cor)) %>%
  #sample.by.animal(other.cols=c('date')) %>%
  ggplot(aes(x=day_desc, y=early.late.cor, fill=signif.si)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(yintercept = 0.3, linetype='dashed') +
  #facet_wrap(. ~ animal, ncol=4) +
  facet_grid(implant ~ .) +
  ylab('Place field correlation:\nearly vs late trials') +
  xlab('') +
  labs(fill='Significant\nSpatial Info') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = 'right')

ggsave('/tmp/field_cors_earlylate.svg', height=11, width=23, units = 'cm')
```

Early vs late correlations are higher than late vs after
```{r}
day.cors.df %>%
  filter(!is.na(aftertest2trial.cor)) %>%
  dplyr::mutate(late.after.cor.diff = early.late.cor - aftertest2trial.cor) %>%
  sample.by.animal(nsamples=100, other.cols=c('date')) %>%
  ggplot(aes(x=implant, y=late.after.cor.diff, fill=signif.si)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  #facet_wrap(. ~ animal, ncol=4) +
  #facet_grid(implant ~ .) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = 'top')
```
Median Early vs late correlations are about the same as the before test vs early
TODO: interesting to look at cells which remapped during the learning. They would have one place field
in the before and early trials and another after. Therefore, look at cells significant in the late trials, and quantify
if they moved.
```{r}
day.cors.df %>%
  filter(!is.na(beforetest2trial.cor)) %>%
  dplyr::mutate(early.before.cor.diff = early.late.cor - beforetest2trial.cor) %>%
  sample.by.animal(nsamples=100,  other.cols=c('date')) %>%
  ggplot(aes(x=implant, y=early.before.cor.diff, fill=signif.si)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  #facet_wrap(. ~ animal, ncol=4) +
  #facet_grid(implant ~ .) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = 'top')
```

Split for habituation and learning
```{r}
pc.nextday.unchanged = pc.change.df %>%
  filter(days.diff==1, n > 1) %>%
  filter(pc.fst) %>%
  #filter(mean.pc == 1.0) %>%
  sample.by.animal() %>%
  mutate(stage=ifelse(startsWith(day_desc.fst, 'habituation'), 'Habituation', 'Learning') ) %>%
  filter(stage == 'Habituation' || same.rew.loc)

pc.nextday.unchanged %>%
  ggplot(aes(x=stage, y=field.xy.dist, color=mean.pc==1.0)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  facet_grid(. ~ implant) +
  labs(y='Field moved distance', x='', colour='Place cell\non both days')
```
No dfference in changes in place field median distance shift during learning vs during habituation
Stats issue: n=cell count sampled equally by animal
```{r}
wilcox.test(field.xy.dist ~ stage, data=subset(pc.nextday.unchanged, mean.pc==1.0))
```

Field correlations
```{r}
pc.change.df %>%
  filter(days.diff==1, n > 1) %>%
  filter(mean.pc >= 0.5) %>%
  #filter(mean.pc == 1.0) %>%
  sample.by.animal() %>%
  filter(pc.fst) %>%
  ggplot(aes(x=day_desc.fst, y=field.cor, fill=mean.pc==1)) +
  geom_violin() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  facet_grid(implant ~ .) +
  labs(fill='Place cell\non both days', x='Reference day', y='Field correlation') +
  geom_hline(aes(yintercept=0), linetype='dashed')
```

```{r}
pc.nextday.unchanged %>%
  sample.by.animal() %>%
  ggplot(aes(x=stage, y=field.cor, color=mean.pc==1)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  facet_grid(implant ~ .) +
  labs(y='Field correlation', x='', color='Place cell\non both days')
```

```{r}
wilcox.test(field.cor ~ stage, data=pc.nextday.unchanged)
```
How does it compare to change from one set of locations to another?
No difference in median...
```{r}
pc.nextday.changed = pc.change.df %>%
  filter(days.diff==1, n > 1, pc.fst) %>%
  #filter(mean.pc >= 0.5) %>%
  #filter(mean.pc == 1.0) %>%
  sample.by.animal()
  #filter(!same.rew.loc)

pc.nextday.changed %>%
 #ggplot(aes(y=field.xy.dist, x=same.rew.loc)) +
  ggplot(aes(y=field.cor, x=same.rew.loc)) +
  geom_violin() +
  facet_grid(implant ~ .) +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  labs(y='Field cor', x='Same reward location', color='Place cell\non both days')
```
Conclusion: moving reward causes remapping to a higher degree in vCA1


Goal cell field shifting between days
```{r}
gc.nextday.unchanged = pc.change.df %>%
  filter(days.diff==1, n>1) %>%
  filter(goal.cell.fst)

gc.nextday.unchanged %>%
  ggplot(aes(x=day_desc.fst, y=field.xy.dist, color=mean.pc==1.0)) +
  geom_point() +
  #stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(implant ~ .) +
  labs(color='Place cell\non both days', x='Reference day', y='Field moved (%)')
```

Field correlation
```{r}
gc.nextday.unchanged %>%
  ggplot(aes(x=day_desc.fst, y=field.cor, color=mean.pc==1)) +
  geom_point() +
  facet_grid(implant ~ .) +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y='Field correlation', x='', color='Place cell\non both days')
```
For the goal cells which don't move around,are they stable when the reward location is moved?
Can't answer - have about 2 cells per day pair which are goal cells on both days.

TODO:
is the shift in the place fields random? compare with shuffled cell identities of place fields.


# Place cells at previous reward location
```{r}
prev.locations.df = all.locations.df %>%
  filter(!is_test) %>%
  add_prev_locations(prev.loc.set.diff=1) %>%
  add_prev_locations(prev.loc.set.diff=2) %>%
  filter()
```

```{r}
fst.moved.location.df = all.locations.df %>%
  filter(!is_test) %>%
  add_prev_locations(prev.loc.set.diff=1) %>%
  filter(!current_loc, prev_loc_set==1) %>%
  ungroup() %>%
  dplyr::select(-date) %>%
  dplyr::distinct()
```


```{r}
prev.locations.df = data.table(prev.locations.df)
setkey(prev.locations.df, date, animal)

get.prev.loc.ordinal = function(date_str, animal_name) {
  x = prev.locations.df[date==date_str & animal==animal_name & !current_loc, location_ordinal]
  if (length(x) == 0) {
    return(-1)
  }
  print(x)
  return(x)
}

pc.prev.rew = merged.run.trials.pc %>%
  dplyr::group_by(date, day_desc, animal) %>%
  dplyr::mutate(
        closest.location.ordinal=calc.min.rew.dist(filter.rews.df(prev.locations.df, date[1], animal[1]),
                                                   field.max.x, field.max.y)$location.ordinal,
        min.rew.dist=calc.min.rew.dist(filter.rews.df(prev.locations.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist,
        is.prev.loc=closest.location.ordinal == get.prev.loc.ordinal(date[1], animal[1])) %>%
  dplyr::mutate(is.prev.rew.closest = is.prev.loc,
                is.new.rew.closest =  !is.prev.loc)

pc.prev.rew %>%
  filter(exp != 'habituation') %>%
  filter(is.pc) %>%
  filter(implant == 'dCA1') %>%
  ggplot(aes(x=day_desc, y=min.rew.dist, color=is.prev.rew.closest)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", shape=23, size=2) +
  facet_grid(animal ~ .) +
  geom_hline(yintercept = 5, linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('') + ylab('Field dist from reward')
```

For each place field calculate the count of its peaks, and how many of them are in the rew or prev rew zone
```{r warning=FALSE}
source('place_field_utils.R')

calc.field.peaks.info = function(day,
                                 animal_name,
                                 field.list,
                                 rew.df,
                                 max.rew.dist.thr=goal.cell.max.dist) {
  if (nrow(rew.df) == 0) {
    #print(paste0('No rewards to compare for animal=', animal_name, ' date=', day))
    return(data.frame())
  }
  bin.size = 100 / nbins
  cell_names = names(field.list[[animal_name]][[day]])
  if (length(cell_names) == 0) {
    #print(paste0('Empty list of fields for animal=', animal_name, ' date=', day))
    return(data.frame())
  }
  
  map_dfr(cell_names, ~ {
      field.info = cell.field.peaks.info(field.list[[animal_name]][[day]][[.x]], rew.df, bin.size, max.rew.dist.thr)
      meta = list(animal=animal_name, date=day, cell_id=as.integer(.x))
      return(append(meta, field.info))
  })
}

cell.field.peaks.info = function(field,
                                 day.rew.df,
                                 bin.size=100/nbins,
                                 max.rew.dist.thr=goal.cell.max.dist) {
  #peaks.rowcol = fieldPeaks(field)
  peaks.rowcol = fieldPeaks(field, min.peakheight=0.5, sigma=1.4)
  peaks.rowcol = peaks.rowcol * bin.size

  if (nrow(peaks.rowcol) > 0) {
    min.rew.dist.res = calc.min.rew.dist(day.rew.df, peaks.rowcol[,'row'], peaks.rowcol[,'col'])
  } else {
    min.rew.dist.res = list(rew.dist=100, location.ordinal=-1)
  }
  peak.atrew.index = which(min.rew.dist.res$rew.dist <= max.rew.dist.thr)
  closer.reward.index = which.min(min.rew.dist.res$rew.dist)

  loc.ordinals.with.peaks = unique(min.rew.dist.res$location.ordinal[peak.atrew.index])
  return(list(
    maxpeakval = max(field, na.rm=TRUE),
    npeaks = nrow(peaks.rowcol),
    npeaks.at.rew = length(peak.atrew.index),
    rew.peaks.count = length(loc.ordinals.with.peaks),
    current.rew.peaks.count = sum(day.rew.df[location_ordinal %in% loc.ordinals.with.peaks, current_loc], na.rm = TRUE),
    peak2rew.mindist = min.rew.dist.res$rew.dist[closer.reward.index],
    closer.rew.ordinal = min.rew.dist.res$location.ordinal[closer.reward.index]
  ))
}

trial.days.df = trials.meta.df %>%
  dplyr::select(date, animal, exp) %>%
  dplyr::distinct()

create.peaks.df.at.locs = function(fields, locs.df, trial.days=trial.days.df) {
  res = map2_dfr(trial.days$date,
                 trial.days$animal,
                 ~ calc.field.peaks.info(.x, .y, fields, rew.df=filter.rews.df(locs.df, .x, .y)))
  res %>%
    left_join(trials.meta.df, by=c('animal', 'date')) %>%
    left_join(place.cell.db, by=c('animal', 'date', 'cell_id', 'day_desc', 'exp'))
}
```


```{r warning=FALSE}
trial.peaks.at.rew = create.peaks.df.at.locs(run.fields, prev.locations.df)
trial.peaks.at.fst.moved = create.peaks.df.at.locs(run.fields, fst.moved.location.df)
trial.peaks.at.current.rew = create.peaks.df.at.locs(run.fields, prev.locations.df[current_loc==TRUE,])

beforetest.peaks.at.rew = create.peaks.df.at.locs(beforetest.fields, prev.locations.df)
beforetest.peaks.fst.moved = create.peaks.df.at.locs(beforetest.fields, fst.moved.location.df)
beforetest.rewards.df$current_loc = FALSE
beforetest.peaks.at.current.rew = create.peaks.df.at.locs(beforetest.fields, beforetest.rewards.df)

aftertest.peaks.at.rew = create.peaks.df.at.locs(aftertest.fields, prev.locations.df)
aftertest.peaks.fst.moved = create.peaks.df.at.locs(aftertest.fields, fst.moved.location.df)

habituation.peaks.at.fst.moved = filter(trial.peaks.at.fst.moved, exp=='habituation')
```

Peaks in place fields from habituation with regards to first reward locations
```{r warning=FALSE}
habittest.daypair = filter(trials.meta.df, exp == 'habituation', animal != 'A-BL') %>%
  left_join(dplyr::select(beforetest.rewards.df, date, animal, location_set), 
            by=c('animal'), suffix=c('.habitday', '.testday'))
beforetest.rewards.df$current_loc = FALSE
habit.fields.at.test.rews = map_dfr(1:nrow(habittest.daypair), ~ {
  animal_name = habittest.daypair$animal[.x]
  activity_date = habittest.daypair$date.habitday[.x]
  test_date = habittest.daypair$date.testday[.x]
  rew.df = beforetest.rewards.df[animal==animal_name & date == test_date,]
  calc.field.peaks.info(activity_date,
                        animal_name,
                        run.fields, 
                        rew.df=rew.df) %>%
    dplyr::mutate(date.active = activity_date,
                  day_desc.active = habittest.daypair$day_desc[.x],
                  date.reward = test_date)
})
habit.fields.at.test.rews = habit.fields.at.test.rews %>%
  dplyr::select(-date) %>%
  left_join(trials.meta.df, by=c('animal'='animal', 'date.reward'='date'), suffix=c('', '.reward')) %>%
  dplyr::select(-day_ordinal, -exp, -location_set, -current.rew.peaks.count) %>%
  dplyr::rename(day_desc.reward = day_desc) %>%
  left_join(place.cell.db, by=c('animal'='animal', 'date.active'='date', 'cell_id'='cell_id', 'day_desc.active'='day_desc'))
```

## Summary on multiple fields per cell

Changes in the number of fields from habituation to learning by number of peaks
```{r}
bind_rows(
  filter(trial.peaks.at.fst.moved, signif.si, day_desc %in% c('habituation day#3')),
  filter(beforetest.peaks.fst.moved, signif.si) %>% 
    mutate(day_desc=paste0(day_desc, 't'))) %>%
  filter(npeaks > 0 & npeaks < 5, animal != 'L-TL') %>%
  dplyr::add_count(implant, animal, day_desc, name='ncells') %>%
  dplyr::group_by(implant, animal, day_desc, npeaks) %>%
  dplyr::summarise(peak.pct=n() / mean(ncells) * 100) %>%
  ggplot(aes(x=day_desc, y=peak.pct, group=animal)) +
  geom_jitter(width=0.1, height = 5) +
  geom_line() +
  facet_grid(implant ~ npeaks) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


TODO:
[x] Show fraction of cells with fields at reward for all days.
[x] distribution of distances to the closest reward during test
[] distribution of distances to the closest reward during learning
Distribution of ditances to the rewards
```{r}
compared.habit.fields.at.test.rews = habit.fields.at.test.rews %>%
  filter(signif.si, exp == 'habituation', day_desc.active == 'habituation day#3') %>%
  dplyr::select(-ends_with('.active')) %>%
  dplyr::rename(date=date.reward,
                day_desc=day_desc.reward)

bind_rows(
  mutate(compared.habit.fields.at.test.rews, group.name='2_habituation'),
  filter(beforetest.peaks.at.current.rew, signif.si) %>% mutate(group.name='1_test')
) %>%
  ggplot(aes(x=peak2rew.mindist, group=group.name)) +
  geom_density(aes(linetype=group.name)) +
  #facet_grid(animal ~ day_desc, scales='free') +
  facet_grid(. ~ implant) +
  geom_vline(xintercept = goal.cell.max.dist, linetype='dotted') +
  coord_flip() +
  gtheme +
  xlim(c(0,100)) +
  xlab('Field distance from closer reward (%)') + ylab('Density')
```


Multifield distance to the closest reward
```{r}
habit.summary.fields.pct.df = summarize.rew.pc.pct(
  compared.habit.fields.at.test.rews,
  dist.var=peak2rew.mindist, 
  dist.threshold=goal.cell.max.dist) %>% dplyr::ungroup()

beforetest.summary.fields.pct.df = summarize.rew.pc.pct(
  filter(beforetest.peaks.at.current.rew, signif.si),
  dist.var=peak2rew.mindist, 
  dist.threshold=goal.cell.max.dist)

merged.summary.df = bind_rows(
  habit.summary.fields.pct.df %>% mutate(exp='habituation'),
  beforetest.summary.fields.pct.df %>% mutate(exp='test')) %>%
  filter(animal != 'L-TL') %>% # remove animal with few cells during test
  mutate(animal_beforetest_day = paste(animal, day_desc, sep='_')) %>%
  filter(animal_beforetest_day %in% kept.testtrials$animal_beforetest_day)

dca1.rew.pc.pct = subset(merged.summary.df, implant == 'dCA1')
vca1.rew.pc.pct = subset(merged.summary.df, implant == 'vCA1')
fem.dca1 = lmerTest::lmer(pct.reward ~  exp + (1 + day_desc | animal), data=dca1.rew.pc.pct)
print('Fraction of dCA1 place cells at reward increased')
summary(fem.dca1)
plot.model.diagnostics(fem.dca1, dca1.rew.pc.pct$animal, dca1.rew.pc.pct$exp)

fem.vca1 = lmerTest::lmer(pct.reward ~  exp + (1 + day_desc | animal), data=vca1.rew.pc.pct)
print('Fraction of vCA1 place cells did not increase')
summary(fem.vca1)
plot.model.diagnostics(fem.vca1, vca1.rew.pc.pct$animal, vca1.rew.pc.pct$exp)

#g.fields.change.pct.test = plot.val.change.between.groups(
#    create.animal.summary(merged.summary.df, pct.reward, exp), 
#    pct.reward, exp) +
#  ylab('Fields at reward (%)')
#  ggtitle('Fraction of cells with one of the fields at reward during test')
g.fields.change.pct.test = merged.summary.df %>%
  #filter(animal_beforetest_day %in% kept.testtrials$animal_beforetest_day) %>%
  ggplot(aes(x=exp, y=pct.reward, group=animal_beforetest_day)) +
  geom_point(aes(color=animal)) +
  geom_line() +
  facet_grid(. ~ implant, scales = 'free') +
  xlab('') +
  gtheme +
  ylab('Place cells at reward (%)') +
  ggtitle('Fraction of place cells at reward increased at test trial')

g.fields.change.pct.test
```

# vCA1 has higher count of multi fields, not different between of habituation vs learning trials
```{r}
animal.fields.count = bind_rows(
  mutate(filter(beforetest.peaks.fst.moved, signif.si, npeaks>0), exp='test'),
  #filter(trial.peaks.at.fst.moved, signif.si, exp=='learning', npeaks>0),
  filter(trial.peaks.at.fst.moved, signif.si, exp=='habituation')) %>% 
  dplyr::add_count(implant, animal, day_desc, exp, name='day_ncells') %>%
  filter(day_ncells > 10) %>% 
  dplyr::group_by(implant, animal, day_desc, exp, npeaks) %>%
  dplyr::summarise(ncells=n(), peak.pct=n() / mean(day_ncells) * 100, day_ncells = mean(day_ncells))

animal.fields.count %>%
  ggplot(aes(x=npeaks, y=peak.pct)) +
  geom_jitter(width=0.1, height = 5) +
  facet_grid(exp ~ implant) +
  gtheme

animal.multifields.count = animal.fields.count %>%
  dplyr::group_by(implant, animal, day_desc, exp, is.multi=npeaks > 1) %>%
  dplyr::summarise(multi.pct = sum(ncells) / mean(day_ncells) * 100) 

library(lmerTest)
peak.count.model = lmerTest::lmer(
                                  multi.pct ~ implant + exp + (1 + exp | animal),
                                  #multi.pct ~ implant + (1 | animal),
                                  #multi.pct ~ exp + (1 + exp | animal),
                                  data=animal.multifields.count, 
                                  #subset=is.multi & exp == 'test', # & implant=='vCA1', 
                                  subset = is.multi,
                                  REML=TRUE)
summary(peak.count.model)
plot.model.diagnostics(peak.count.model, 
                       subset(animal.multifields.count, is.multi)$animal, 
                       subset(animal.multifields.count, is.multi)$implant)
```


Count of field peaks at current reward
```{r}
trial.peaks.at.rew %>%
  filter(signif.si) %>%
  ggplot() +
  geom_violin(aes(x=day_desc, y=current.rew.peaks.count, color=implant)) +
  gtheme +
  facet_grid(implant ~ .) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Summary about peaks at rewards for different trial days
```{r}
day.peak.summary = trial.peaks.at.rew %>%
  #filter(animal == 'K-BR') %>%
  #filter(day_desc == 'learning1 day#5') %>%
  filter(signif.si) %>%
  group_by(implant, animal, day_desc) %>%
  dplyr::summarise(ncells=n(),
                   signif.pct=sum(signif.si)/ncells,
                   hasrew.peak.pct=sum(current.rew.peaks.count > 0) / ncells,
                   multipeak.rew.pct = sum((npeaks.at.rew > 1) & (rew.peaks.count > 0)) / ncells,
                   multireward.pct = sum(rew.peaks.count > 1) / ncells,
                   current.multireward.pct = sum(current.rew.peaks.count > 1) / ncells,
                   singleprev.reward.peak = sum((rew.peaks.count==1) & (rew.peaks.count - current.rew.peaks.count > 0)) / ncells,
                   hasprev.reward = sum((rew.peaks.count - current.rew.peaks.count > 0)) / ncells)

day.peak.summary %>%
  filter(ncells >= 5, day_desc=='learning2 day#1') %>%
  dplyr::mutate_if(is.numeric, round, 2) %>%
  DT::datatable()

day.peak.summary %>%
  filter(day_desc=='learning3 day#2') %>%
  #filter(ncells >= 5) %>%
  dplyr::group_by(day_desc, implant) %>%
  dplyr::summarise(nsignif.cells.mean=mean(ncells),
                   nanimals=n(),
                   mean(hasrew.peak.pct),
                   sem(hasrew.peak.pct),
                   mean(multipeak.rew.pct),
                   mean(multireward.pct),
                   sem(multireward.pct),
                   mean(current.multireward.pct),
                   sem(current.multireward.pct),
                   mean(singleprev.reward.peak),
                   mean(hasprev.reward),
                   sem(hasprev.reward)) %>%
  dplyr::mutate_if(is.numeric, round, 2) %>%
  DT::datatable()

print('Stats on fraction of cells with fields at both rewards')
t.test(current.multireward.pct ~ implant, day.peak.summary, subset=day_desc == 'learning1 day#5')
t.test(current.multireward.pct ~ implant, day.peak.summary, subset=day_desc == 'learning2 day#1')

```

Comparison with peaks at rewards two days after translocation.
Stats calculated per animal and grouped by implant
```{r}
trial.peaks.at.rew %>%
  filter(day_desc=='learning1 day#5') %>%
  filter(signif.si) %>%
  #filter( current.rew.peaks.count > 0) %>%
  left_join(subset(trial.peaks.at.rew, day_desc=='learning2 day#2'), by=c('implant','animal', 'cell_id'), suffix=c('.fst', '.snd')) %>%
  dplyr::mutate(at.rew.fst = current.rew.peaks.count.fst>0,
                two.rews.fst = current.rew.peaks.count.fst==2,
                both.rews.both.days = two.rews.fst & current.rew.peaks.count.snd==2,
                single.rew.both.days = current.rew.peaks.count.fst==1 & current.rew.peaks.count.snd>0,
                at.rew.both.days = at.rew.fst & current.rew.peaks.count.snd>0) %>%
  filter(at.rew.fst) %>%
  dplyr::group_by(implant, animal) %>%
  dplyr::summarise(nmatched=sum(!is.na(current.rew.peaks.count.snd)),
                   nmatched.pct = nmatched/n(),
                   at.rew.both.pct=mean(at.rew.both.days, na.rm = TRUE),
                   two.rews.pct=mean(both.rews.both.days, na.rm = TRUE),
                   )  %>%
  dplyr::group_by(implant) %>%
  dplyr::summarise(median(nmatched),
                   median(nmatched.pct),
                   mean(at.rew.both.pct, na.rm=T),
                   sem(at.rew.both.pct),
                   mean(nmatched, na.rm=T),
                   sem(two.rews.pct)) %>%
  dplyr::mutate_if(is.double, scales::percent, 1)
```

Comparison of peaks at rewards for two trial days after translocation.
Stats pooled for all cells from the same implant
```{r}
trial.peaks.at.rew %>%
  filter(day_desc=='learning1 day#5') %>%
  filter(signif.si) %>%
  #filter( current.rew.peaks.count > 0) %>%
  left_join(subset(trial.peaks.at.rew, day_desc=='learning2 day#2'), by=c('implant','animal', 'cell_id'), suffix=c('.fst', '.snd')) %>%
  dplyr::mutate(at.rew.fst = current.rew.peaks.count.fst>0,
                two.rews.fst = current.rew.peaks.count.fst==2,
                both.rews.both.days = two.rews.fst & current.rew.peaks.count.snd==2,
                single.rew.both.days = current.rew.peaks.count.fst==1 & current.rew.peaks.count.snd>0,
                at.rew.both.days = at.rew.fst & current.rew.peaks.count.snd>0) %>%
  filter(at.rew.fst) %>%
  dplyr::group_by(implant) %>%
  dplyr::summarise(nmatched=sum(!is.na(current.rew.peaks.count.snd)),
                   nmatched.pct = nmatched/n(),
                   #at.rew.fst.pct = mean(at.rew.fst),
                   at.rew.both.pct=mean(at.rew.both.days, na.rm = TRUE),
                   #sem(at.rew.both.days),
                   #two.rews.fst.pct = mean(two.rews.fst),
                   two.rews.pct=mean(both.rews.both.days, na.rm = TRUE),
                   #one.rews.pct=mean(single.rew.both.days, na.rm = TRUE)
                   )  %>%
  dplyr::mutate_if(is.double, scales::percent, 1)
```

How many cells active at the previous reward are still active at that reward after learning a new set?
Comparison between the beforetest and aftertest.
```{r}
beforetest.peaks.at.rew %>%
  filter(day_desc=='learning2 day#1') %>%
  #filter(animal=='G-BR') %>%
  left_join(pc.test.df) %>%
  #filter(signif.si) %>%
  dplyr::filter((rew.peaks.count - current.rew.peaks.count) > 0) %>%
  left_join(filter(aftertest.peaks.at.rew, day_desc=='learning2 day#1'), by=c('animal', 'cell_id'), suffix=c('.fst', '.snd')) %>%
  dplyr::mutate(old.present = (rew.peaks.count.snd - current.rew.peaks.count.snd) > 0,
                old.disappeared = !old.present,
                old.moved = !old.present & (current.rew.peaks.count.snd > 0),
                peaks.unmoved = old.present & (current.rew.peaks.count.fst == current.rew.peaks.count.snd),
                peaks.increased = old.present & (rew.peaks.count.snd > rew.peaks.count.fst)) %>%
  dplyr::group_by(animal) %>%
  dplyr::summarise(ncells=sum(!is.na(current.rew.peaks.count.snd)),
                   mean(old.present, na.rm=T),
                   mean(old.disappeared, na.rm=T),
                   mean(old.moved, na.rm=T),
                   mean(peaks.unmoved, na.rm=T),
                   mean(peaks.increased, na.rm=T)) %>%
  filter(ncells > 0) %>%
  dplyr::mutate_if(is.double, scales::percent, 1)
```
How many cells active at previous reward are still active at that reward during trial learning?
```{r}
transloc.rew.pf.change =
  filter(beforetest.peaks.at.rew, day_desc=='learning2 day#1') %>%
  #filter(field.peaks.df, day_desc=='learning2 day#1') %>%
  left_join(mouse.meta.df) %>%
  left_join(pc.test.df) %>%
  #filter(signif.si) %>%
  dplyr::filter((rew.peaks.count - current.rew.peaks.count) > 0) %>%
  left_join(filter(trial.peaks.at.rew, day_desc=='learning2 day#1'), by=c('implant', 'animal', 'cell_id'), suffix=c('.fst', '.snd')) %>%
  dplyr::mutate(old.present = (rew.peaks.count.snd - current.rew.peaks.count.snd) > 0,
                old.disappeared = !old.present,
                old.moved = !old.present & (current.rew.peaks.count.snd > 0),
                peaks.unmoved = old.present & (current.rew.peaks.count.fst == current.rew.peaks.count.snd),
                old.present.and.new.present = old.present & current.rew.peaks.count.snd > 0,
                peaks.increased = old.present & (rew.peaks.count.snd > rew.peaks.count.fst))

transloc.rew.pf.change %>%
  dplyr::group_by(implant, animal) %>%
  dplyr::summarise(ncells=sum(!is.na(current.rew.peaks.count.snd)),
                   old.present.mean=mean(old.present, na.rm=T),
                   old.disappeared.mean=mean(old.disappeared, na.rm=T),
                   old.moved.mean=mean(old.moved, na.rm=T),
                   old.and.new.present.mean=mean(old.present.and.new.present, na.rm=T),
                   peaks.unmoved.mean=mean(peaks.unmoved, na.rm=T),
                   peaks.increased.mean=mean(peaks.increased, na.rm=T)) %>%
  filter(ncells>0) %>%
  dplyr::mutate_if(is.double, scales::percent, 1)
```

How many of the cells present at prev reward were place cells at that spot.
Few cells at rews on L2D1 matching with the HD3. confirm with recall.

Expected about 30 % of place fields to be at reward, and this is lower...
```{r}
transloc.rew.pf.change %>%
  left_join(filter(habituation.peaks.at.fst.moved, day_desc == 'habituation day#3') %>% dplyr::select(-date, -day_desc),
            by=c('animal', 'cell_id')) %>%
  filter(!is.na(old.present)) %>%
  #filter(old.present) %>%
  dplyr::mutate(present.from.habit = old.present & rew.peaks.count > 0) %>%
  dplyr::group_by(animal) %>%
  dplyr::summarise(m.present.from.habit=sum(present.from.habit, na.rm=T)/n(),
                   ncells.matched=sum(!is.na(rew.peaks.count)),
                   m.present.from.habit.narm=mean(present.from.habit, na.rm=T))
```

Check what happened with the place fields which were at the reward from during habituation
```{r}
filter(habituation.peaks.at.fst.moved, day_desc=='habituation day#3') %>%
  left_join(filter(beforetest.peaks.at.rew, day_desc=='learning2 day#1'),
            by=c('animal', 'cell_id'),
            suffix=c('.habit', '.test')) %>%
  dplyr::mutate(loc.present.test=(rew.peaks.count.test - current.rew.peaks.count.test) > 0,
                loc.present.habit=rew.peaks.count.habit > 0,
                loc.moved.to = !loc.present.habit & loc.present.test,
                loc.stayed=loc.present.habit & loc.present.test) %>%
  #filter(loc.present.habit) %>%
  dplyr::group_by(animal) %>%
  dplyr::summarise(ncells.matched=sum(!is.na(loc.present.test)),
                   loc.present.habit.pct=mean(loc.present.habit),
                   loc.stayed.pct=mean(loc.stayed, na.rm=T) / loc.present.habit.pct,
                   loc.moved.to.pct=mean(loc.moved.to, na.rm=T),
                   loc.present.test.pct=mean(loc.present.test, na.rm=T))

```


