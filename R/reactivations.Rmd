---
title: "R Notebook"
output: html_notebook
---

```{r}
library(cowplot)
library(dplyr)
library(data.table)
library(datatrace)
library(ggplot2)
library(purrr)
library(raster)
library(stringr)
library(tidyr)

source('fixed_effects.R')
source('behav_analysis.R')
source('traces_input.R')
source('place_field_utils.R')
source('plotting_params.R')

pc.two.colours = rev(main.two.colours)
reactiv.colours = c('#999999', '#85b2e0')

gtheme.light.panel = gtheme +
    theme(
        panel.grid.major.y = element_line(color = '#dddddd', size=0.3),
        panel.grid.minor.y = element_line(color = '#dddddd', size=0.2),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.background = element_rect(fill = 'white'),
        strip.background = element_blank(),
        strip.text = element_text(size = 8))

trials.meta.df = read.trials.meta(rootdirs)
mouse.meta.df = read.mouse.meta(rootdirs)
```


```{r}
nbins=20
timebin.dur.msec=200
prepare.all.traces = function(caimg_result_dir, 
                              timebin.dur.msec=timebin.dur.msec,
                              # running speed avg > 4 cm/s in 0.5 s window
                              mean.run.velocity=3.3, 
                              event.deconv.threshold=0.2) {
  data.traces = read.data.trace(caimg_result_dir)
  data.traces = add.running.col(data.traces, mean.run.velocity, 10)
  data.traces$date = rep(char2date(data.traces$date[1]), nrow(data.traces))
  setorder(data.traces, exp_title, trial_id, cell_id, timestamp)
  detect.events(data.traces, deconv.threshold = event.deconv.threshold)

  data.traces = gauss.smooth.df.var(data.traces, filter.len=20, sigma=5.0)

  data.traces[, moved_distance := cumsum(c(0, norm2(diff(x), diff(y)))),
              by = .(animal, date, exp_title, trial_id, trial, cell_id)]

  binned.traces = timebin.traces(data.traces,
                                 timebin.dur.msec=timebin.dur.msec)
  binned.traces[, trial_time_bin := time_bin - min(time_bin), by=.(exp_title, trial)]
  binned.traces[, `:=` (zscored_deconv_trace = zscore(deconv_trace),
                        zscored_trace = zscore(trace),
                        zscored_smooth_deconv_trace = zscore(smoothed_deconv_trace)),
                by=.(exp_title, cell_id)]
   binned.traces = binned.traces %>% 
     stimbin.traces(x, nbins) %>% 
     stimbin.traces(y, nbins) %>%
     as.data.table()
   binned.traces = bin.responses(binned.traces, get.quantiles.fun(c(0.95, 1.0)), 
        binned.var = 'smoothed_deconv_trace')

  binned.traces[, atReward := pmin((atReward0 >= 0.5) + (atReward1 >= 0.5), 1)]

  return(binned.traces)
}
```


```{r}
root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2019-08/'
animal_name = 'F-BL'
# root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2020-10/'
# animal_name = 'M-BR'
# root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2020-10/'
# animal_name = 'E-BL'
exp_title='learning'
day_desc_name = 'learning2 day#1'

day = filter(trials.meta.df, animal == animal_name, day_desc == day_desc_name) %>% pull(date)
caimg_result_dir = find.caimg.dir(caimg_result_dirs, animal_name, day)

binned.traces = prepare.all.traces(caimg_result_dir, timebin.dur.msec=timebin.dur.msec, )[exp_title == 'trial',]
binned.traces[, atReward := pmin((atReward0 >= 0.5) + (atReward1 >= 0.5), 1)]
```
Activity change in the cells
```{r}
all.locations.df = map_dfr(rootdirs, read_locations)
new.locations.df = all.locations.df %>%
  group_by(animal, date) %>%
  filter(!is_test, location_set > 1) %>%
  filter(location_ordinal == max(location_ordinal)) %>%
  ungroup()


#filter(compared.early.late.df.trials.peaks.wide, animal == animal_name, day_desc == day_desc_name, signif.si, 
#       reactivated, fst.reactivated.trial >= 4) %>% View

#cell_names = c(3, 8, 38, 43) # M-BR, l2 d1
cell_names = c(#40, 44, 63, 101, 110, # reactivated,  F-BL, l2 d1
               44, 105, 109, # reactivated
               41, 68, 279) # not reactivated
#cell_names = c(39, 40, 63, 105, 146, 317)

first.reactivated.trial %>%
  filter(animal==animal_name, day_desc == day_desc_name) %>%
  filter(fst.reactivated.trial == 4, signif.si) %>%
  #filter(cell_id %in% cell_names) %>%
  View()
  identity()

cells.df = binned.traces[exp_title == 'trial' & cell_id %in% cell_names, ]
cells.df[, early.trial := ifelse(trial <= 4, 'trial 1-4', 'trial 5-8')]
animal.new.locations.df = filter(new.locations.df, animal == animal_name, date == cells.df$date[1], !is_test) %>%
  mutate(loc_id=paste(Well_row, Well_col, sep='x'))
plotted.locations.df = filter(locations.df, animal == animal_name, date == cells.df$date[1], !is_test) %>%
  mutate(loc_id=paste(Well_row, Well_col, sep='x'),
         is.new = loc_id %in% animal.new.locations.df$loc_id,
         current_loc=is.new) # Workaround for plotting in the right colour
plotted.locations.df = map_df(unique(cells.df$trial), ~ mutate(plotted.locations.df, trial=.x))
plotted.locations.df = map_df(cell_names, ~ mutate(plotted.locations.df, cell_id=.x))

g1 = plot.trace.events(cells.df[is_running > 0,], event.var=nevents, event.thr=0.5) +
  geom_rewards(plotted.locations.df, animal_name, cells.df$date[1], nbins = 100, 
               rew.colours = c('prev_rew'='gray30', 'current_rew'='grey30'),
               rew.shape = 1) +
  #geom_point(data=cells.df[atReward > 0 & nevents > 0], color='blue') +
  facet_grid(early.trial ~ cell_id) +
  theme(legend.position='none')

ggsave('~/tmp/tanjas/paths_examples.png', g1, units='cm',
       width=19, height=12)

g2 = map_df(cell_names, function(cell_name) {
  day = as.character(cells.df$date[1])
  bind_rows(
    create.pf.df(early.fields[[animal_name]][[day]][[as.character(cell_name)]],
               early.occupancies[[animal_name]][[day]][[as.character(cell_name)]],
               min.occupancy.sec = 0.5) %>% 
      mutate(trials_group = 'trial 1-4', cell_id = cell_name, animal = animal_name, date = day, day_desc = '1'),
    create.pf.df(late.fields[[animal_name]][[day]][[as.character(cell_name)]],
               late.occupancies[[animal_name]][[day]][[as.character(cell_name)]],
               min.occupancy.sec = 0.5) %>% 
      mutate(trials_group = 'trial 5-8', cell_id = cell_name, animal = animal_name, date = day, day_desc = '2'))
  }) %>%
  day.normalize.fields() %>%
  plot.pf(max.x=20, max.y=20) +
  geom_rewards(plotted.locations.df, animal_name, cells.df$date[1], nbins = 20, 
               rew.colours = c('prev_rew'='gray50', 'current_rew'='grey50'),
               rew.shape = 1) +
  facet_grid(trials_group ~ cell_id) +
  theme(legend.position = 'none')
cowplot::plot_grid(g1, g2, ncol = 1, rel_heights = 2, 2)
ggsave('~/tmp/tanjas/pcs_examples.svg', units='cm',
       width=17, height=15)
```


# Reactivations at reward
Reactivation only at moved reward

## Utility functions
```{r}
all.locations.df = map_dfr(rootdirs, read_locations)

cut.trace.until.reactiv = function(traces, reactivation.rew.loc='new') {
  reactiv.location.df = all.locations.df %>%
    filter(!is_test) %>%
    filter(animal == traces$animal[1], date == traces$date[1])
  location.dist.thr = goal.cell.max.dist
  
  if (reactivation.rew.loc == 'new') {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == max(location_ordinal))   
  } else if(reactivation.rew.loc == 'old') {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == min(location_ordinal))   
  } else {# else keep both locations
    location.dist.thr = 1000
  }
  behav.traces = traces[cell_id == traces$cell_id[1],] 
  max.timestamp.df = behav.traces[
    (atReward > 0) & norm2(reactiv.location.df$trans_x[1] - x, reactiv.location.df$trans_y[1] - y) < location.dist.thr, 
         .(cut.timestamp = max(timestamp)),
         by=.(animal, date, trial, trial_id)]
  x = traces[max.timestamp.df, on=.(animal, date, trial, trial_id)]
  res = x[timestamp <= cut.timestamp, ]
  res[, cut.timestamp := NULL]
  res
}

find.reactivation.events = function(traces, 
                                    reactivation.rew.loc='new') {
  reactiv.location.df = all.locations.df %>%
    filter(!is_test) %>%
    filter(animal == traces$animal[1], date == traces$date[1])
  location.dist.thr = goal.cell.max.dist
  
  if (reactivation.rew.loc == 'new') {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == max(location_ordinal)) 
  } else if (reactivation.rew.loc == 'old') {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == min(location_ordinal)) 
  } else {
    location.dist.thr = 1000
  }
  traces[,nevents_running := 0]
  traces[(x>0) & (y>0) & is_running,
         nevents_running := nevents]
  traces[,
         `:=` (running_cumsum_events = cumsum(nevents_running),
               cumsum_events = cumsum(nevents)),
         by=.(exp_title, trial_id, trial, cell)]
  traces[, atReactivatedReward := (atReward > 0) &  
           norm2(reactiv.location.df$trans_x[1] - x, reactiv.location.df$trans_y[1] - y) < location.dist.thr]
  traces[,
         reactivation_event := (atReward > 0) &
           # cell must have been active during running before the event
           (running_cumsum_events > 0) & 
           (nevents > 0) & 
           # only consider reactivations at new reward location
           norm2(reactiv.location.df$trans_x[1] - x, reactiv.location.df$trans_y[1] - y) < location.dist.thr]
}

find.reactivation.during.immobility = function(traces) {
  traces[, nevents_running := 0]
  traces[(x>0) & (y>0) & is_running,
         nevents_running := nevents]
  traces[,
         `:=` (running_cumsum_events = cumsum(nevents_running),
               cumsum_events = nevents),
         by=.(exp_title, trial_id, trial, cell_id)]
  traces[,
         reactivation_event := immobile &
           # cell must have been active during running before the event
           (running_cumsum_events > 0) & 
           (nevents > 0) ]
}


make.reactivated.cells.df = function(trial.events.count, all.active=FALSE) {
  trial1.reactivated.cells = trial.events.count[atReward > 0,]
  if (nrow(trial1.reactivated.cells) == 0) {
    trial1.reactivated.cells = trial.events.count
    trial1.reactivated.cells[, reactivated := FALSE]
  } else {
    trial1.reactivated.cells[, `:=` (reactivated = total_reactivation_events >= 1, 
                                 active = total_events_running >= 1)]
  }
  if (all.active) {
    trial1.reactivated.cells[, active := TRUE]
  }
  trial1.reactivated.cells[, .(animal, date, cell_id, reactivated, active)]
}

calculate.ratio.between.trials = function(trial.events.reactivated.df) {
  trial.nos = sort(unique(trial.events.reactivated.df$trial))
  trial.events.reactivated.df[, trial_ordinal := match(trial, trial.nos)]
  trial.events.reactivated.df[, total_reactivations_at_reward := max(total_reactivation_events),
                              by=.(animal, date, exp_title, trial, cell_id, active, reactivated)]
  active.df = trial.events.reactivated.df[atReward == 0 & active == 1,]
  if (length(unique(active.df$trial_ordinal)) < 2) {
    return(data.frame())
  }
  pivot_wider(
      active.df, 
      id_cols=c('animal', 'date', 'exp_title', 'cell_id', 'active', 'reactivated'),
      names_from=trial_ordinal,
      names_prefix='trial.',
      values_from=c('total_events', 'max.deconv', 'deconv.95p','mean.deconv', 'total_reactivations_at_reward')) %>%
      mutate(events.diff = total_events_trial.2 - total_events_trial.1,
             max.deconv.diff = max.deconv_trial.2 - max.deconv_trial.1,
             deconv.95p.diff = deconv.95p_trial.2 - deconv.95p_trial.1,
             max.deconv.ratio = max.deconv_trial.2 / max.deconv_trial.1,
             deconv.95p.ratio = deconv.95p_trial.2 / deconv.95p_trial.1,
             mean.deconv.diff = mean.deconv_trial.2 - mean.deconv_trial.1,
             mean.deconv.ratio = mean.deconv_trial.2 / mean.deconv_trial.1) %>%
    as.data.table()
}

```


# Example traces for some cells
Select cells to show
```{r}
example.for.compared.change.df = compared.change.df %>%
  filter(!reactivated_inbetween, active) %>% 
  filter(animal == animal_name, day_desc == day_desc_name) %>%
  filter(trials.diff == 1) %>%
  filter(trial.denominator == 3) %>%
  dplyr::select(-c(reactivated, fst.reactivated.trial)) %>%
  #left_join(first.reactivated.trial) 
  left_join(all.trial.events.run %>% filter(reactivation.rew.loc == 'both'),
            by=c('animal'='animal', 'date'='date', 'cell_id'='cell_id', 'exp_title'='exp_title',
                 'trial.denominator'='trial')) 

example.for.compared.change.df %>% 
  filter(reactivated == TRUE) %>% 
  filter(fst.reactivated.trial == 3) %>%
  arrange(desc(max.deconv.ratio)) %>%
  #filter(max.deconv_trial.1 > 0.5) %>%
  dplyr::select(cell_id, max.deconv_trial.1,max.deconv_trial.2, max.deconv.ratio, trial.numerator, trial.denominator)

example.for.compared.change.df %>% 
  filter(reactivated == FALSE) %>% 
  #filter(fst.reactivated.trial == Inf) %>%
  arrange((max.deconv.ratio)) %>%
  filter(max.deconv_trial.1 > 0.5) %>%
  dplyr::select(cell_id, max.deconv_trial.1,max.deconv_trial.2, max.deconv.ratio, trial.numerator, trial.denominator)
```


```{r}
#cell_names = c(181, 30, 96, 194, # reactivated F-BL
#              175, 35, 98, 146, 308)# not reactivate F-BL
# cell_names = c(316, 161, 149, 250, # reactivated F-BL
#               261, 308, 186, 41, 98)# not reactivated F-BL
cell_names = c(149, 159, 105, 44, 40, # reactivated F-BL
               309, 68, 279)# not reactivated F-BL
#cell_names = c(108, 72, 151, 157, # reactivated E-BL
#               133, 98, 110) # not reactivated E-BL
#cell_names = c(138, 56, 3, 59)
  #c(55, 165, 101, 91, 63 )# M-BR reactivated
               #157) # not reactivated
               
plotted.traces = binned.traces[exp_title == 'trial' & cell_id %in% cell_names , ]
example.traces = plotted.traces[atReward | (is_running > 0), ]
find.reactivation.events(example.traces)
example.traces = cut.trace.until.reactiv(example.traces, reactivation.rew.loc = 'both')
example.traces = example.traces[(is_running > 0) | atReactivatedReward]
#glimpse(example.traces)

trace.half.window.sec = 5
trace.half.window.len = trace.half.window.sec * 1000/timebin.dur.msec
max.deconv.windows.df = example.traces %>%
  arrange(date, animal, trial, trial_id, atReactivatedReward, cell_id, timestamp) %>%
  group_by(date, animal, trial, trial_id, atReactivatedReward, cell_id) %>%
  dplyr::summarise(max.index=which.max(trace),
                   max.timestamp=timestamp[which.max(trace)],
                   max.val=max(trace),
                   len=n(),
                   index_start = max(1, max.index - trace.half.window.len),
                   timestamp_start = timestamp[tail_while(index_start:max.index, ~ abs(max.timestamp - timestamp[.x]) < trace.half.window.sec * 1000)[1]],
                   timestamp_end = max.timestamp,
                   has.reactivation=max(reactivation_event), 
                   .groups='drop') %>%
  dplyr::select(-c(index_start, max.index)) %>%
  as.data.table()
max.deconv.windows.df[, `:=` (exp_title = 'trial', event_id = 1, rew_at_end = atReactivatedReward) ]
example.traces[, cell_id_tmp := cell_id]
plotted.traces[, cell_id_tmp := cell_id]

max.deconv.aligned.traces.running = plotted.traces[, 
  center.timestamps.around.events(.SD, 
                                  max.deconv.windows.df[atReactivatedReward==FALSE], 'trial',
                                  padding.after.event=trace.half.window.sec),
  by=.(date, animal, exp_title, trial_id, cell_id_tmp)][aligned_event_id >= 0,]

max.deconv.aligned.traces.reactivations = plotted.traces[,
  center.timestamps.around.events(.SD, 
                                  max.deconv.windows.df[atReactivatedReward==TRUE], 'trial',
                                  padding.after.event=trace.half.window.sec),
  by=.(date, animal, exp_title, trial_id, cell_id_tmp)][aligned_event_id >= 0,] %>%
  left_join(max.deconv.windows.df[, .(date, animal, trial, cell_id, has.reactivation)], 
            by=c('date', 'animal', 'trial', 'cell_id')) 
```

```{r}
bind_rows(
  max.deconv.aligned.traces.running %>% mutate(atRewardTrace = 0),
  max.deconv.aligned.traces.reactivations %>% mutate(atRewardTrace = 1)) %>%   
  left_join(all.trial.events.run %>% filter(reactivation.rew.loc == 'both')) %>%
  mutate(cell.reactivated = fst.reactivated.trial < Inf) %>%
  filter(timestamp_from_start >= 0, timestamp_from_end <= trace.half.window.sec * 1000) %>%
  ggplot(aes(x=timestamp_from_end / 1000, y=trace)) +
  geom_line(aes(colour=reactivated)) +
  facet_grid(cell.reactivated + cell_id ~ trial + atRewardTrace, scales='free_y') +
  gtheme

ggsave('~/tmp/tanjas/example_traces_M_BR_L2.svg', units = 'cm',
       width = 20, height = 9.1)
```

Plot all traces until 
```{r}
cell_ids = c(149, 159, 225, # reactivated
             68, 165, 119) # not reactivated

behav.traces = binned.traces[trial == 3 & cell_id == cell_ids[1], ]
bind_rows(
  binned.traces[trial == 3 & cell_id %in% cell_ids & timestamp >= 28000 & timestamp <= 76000, ] %>%
    mutate(metric='trace'),
   mutate(behav.traces[timestamp >= 28000 & timestamp <= 76000,], metric='velocity', trace=smooth_velocity) 
) %>%
  ggplot(aes(x=timestamp/1000)) +
  geom_line(aes(y=trace)) +
  facet_grid(metric + cell_id ~ ., scales = 'free_y') +
  gtheme
ggsave('~/tmp/tanjas/trial_traces.svg', units='cm',
       width = 7.9, height=5)
```

```{r}
ggplot(behav.traces) +
  geom_path(mapping=aes(x=x, y=100-y, group=trial_id), alpha=0.6) +
  geom_rewards(filter(locations.df, is_test==FALSE), animal_name, day, 100,
               rew.colours = c('current_rew'='red')) +
  geom_maze_contour(100) +
  theme_nothing()
ggsave('~/tmp/tanjas/trial_path.svg', units='cm',
       width = 1.5, height=1.5)
```


##Utility funs for calculating place fields
```{r}
add.meta.cols = function(df, animal, date) {
  df$animal = as.factor(rep(animal, nrow(df)))
  df$date = as.factor(rep(date, nrow(df)))
  return(df)
}


traces2pf.subset = function(subset.binned.traces, subset.name, shuffle.shift.sec = 10, nshuffles = 1000) {
    if (nrow(subset.binned.traces) == 0) {
      return(list())
    }

    subset.result = list()
    animal = subset.binned.traces$animal[1]
    date = subset.binned.traces$date[1]

    subset.result = calc.spatial.info(subset.binned.traces,
                                      generate.plots=FALSE,
                                      nshuffles=nshuffles,
                                      shuffle.shift.sec = shuffle.shift.sec,
                                      trace.var='deconv_trace',
                                      timebin.dur.msec=timebin.dur.msec,
                                      nbins=nbins,
                                      min.occupancy.sec=1,
                                      gaussian.var=2)
    subset.result$df = add.meta.cols(subset.result$df, animal, date)
    return(subset.result)
  }
```


## Process all trials
```{r}
last.days.df = test.days.df
last.days.df$date = last.days.df$date - 1

test.days.df.joined = bind_rows(
  test.days.df %>% mutate(day_ordinal_name='first'),
  #last.days.df %>% mutate(day_ordinal_name='last')
) %>%
  left_join(trials.meta.df, by=c('animal', 'date')) %>%
  left_join(mouse.meta.df) %>%
  filter(implant == 'dCA1') %>%
  filter(day_desc != 'learning3 day#3', day_desc != 'learning4 day#3') # Ignore days when only 4 trials performed

trial.change.list = list()
trial.events.list = list()
beforetest.change.list = list()
early.late.si.list = list()

for (i in 1:nrow(test.days.df.joined)) {
  caimg_result_dir = find.caimg.dir(caimg_result_dirs, test.days.df.joined$animal[i], test.days.df.joined$date[i])
  binned.traces = prepare.all.traces(caimg_result_dir, timebin.dur.msec=200, event.deconv.threshold = 0.2)
  
    # Reactivations at new reward
  all.trial.traces = binned.traces[exp_title == 'trial',]
  reactivations.rew.loc.vec = c('new', 'old', 'both')
  for (j in seq_along(reactivations.rew.loc.vec)) {
    reactivations.rew.loc = reactivations.rew.loc.vec[j]
    trial.traces = cut.trace.until.reactiv(all.trial.traces, reactivation.rew.loc = reactivations.rew.loc)
    find.reactivation.events(trial.traces, reactivation.rew.loc = reactivations.rew.loc)
    
    trial.events.count = trial.traces[atReward | ((x>0) & (y>0) & is_running), 
                                      .(total_events = sum(nevents),
                                        total_reactivation_events = sum(reactivation_event),
                                        total_reactivation_events_at_old = sum(reactivation_event),
                                        total_events_running = max(running_cumsum_events),
                                        max.zscored.deconv = max(zscored_deconv_trace),
                                        max.deconv = max(deconv_trace),
                                        deconv.95p = quantile(deconv_trace, 0.999)[[1]],
                                        mean.zscored.deconv = mean(zscored_deconv_trace),
                                        mean.deconv = mean(deconv_trace)), 
                                       by=.(animal, date, exp_title, trial_id, trial, cell_id, atReward)]
    trial.events.count[, reactivation.rew.loc := reactivations.rew.loc]
    trial.events.list[[length(reactivations.rew.loc.vec) * (i - 1) + j]] = trial.events.count
    trial.events.list[[length(reactivations.rew.loc.vec) * (i - 1) + j]]$day_ordinal_name = test.days.df.joined$day_ordinal_name[i]
    
    # 0. take data for two consecutive trials
    # 1. find reactivated cells in the first trial
    # 2. merge that with both trial info
    # 3. calculate ratio over the first trial activity?
    consecutive.trial.nos = unique(trial.events.count$trial) %>% sort
    #trial.pairs = combn(consecutive.trial.nos, 2) 
    trial.pairs = matrix(c(c(1:7, 1, 1:6), 
                           c(2:8, 8, 3:8)), nrow=2, byrow = TRUE)
    trial.change.joined = list()
    for (pair_index in 1:dim(trial.pairs)[2]) {
      compared.trials.event.count = trial.events.count[trial %in% trial.pairs[, pair_index], ]
      if (nrow(compared.trials.event.count[trial == trial.pairs[1, pair_index]]) == 0 |
          nrow(compared.trials.event.count[trial == trial.pairs[2, pair_index]]) == 0) {
        next
      }
      trial1.reactivated.cells = make.reactivated.cells.df(compared.trials.event.count[trial == trial.pairs[1, pair_index]])
      trial.events.reactivated = compared.trials.event.count[trial1.reactivated.cells, on=.(cell_id) ]
      trial.change = calculate.ratio.between.trials(trial.events.reactivated) %>% as.data.table()
      inbetween.reactivated.cells = trial.change[FALSE, .(animal, date, cell_id, exp_title)]
      inbetween.reactivated.cells$reactivated_inbetween = logical()
      if (trial.pairs[2, pair_index] - trial.pairs[1, pair_index] > 1) {
        inbetween.reactivated.cells = make.reactivated.cells.df(
          trial.events.count[trial > trial.pairs[1, pair_index] & trial < trial.pairs[2, pair_index], ],
          all.active = TRUE)
        inbetween.reactivated.cells[, active := NULL]
        # Take max value for reactivated from the two trials
        inbetween.reactivated.cells = inbetween.reactivated.cells[, .(reactivated = as.logical(max(reactivated))), 
                                                                  by=.(animal, date, cell_id)]
        setnames(inbetween.reactivated.cells, 'reactivated', 'reactivated_inbetween')
      }
      trial.change = merge(trial.change,
                           inbetween.reactivated.cells[, .(animal, date, cell_id, reactivated_inbetween)],
                           by=c('animal', 'date', 'cell_id'), 
                           all.x = TRUE)
      if (nrow(trial.change) > 0) {
        trial.change[is.na(reactivated_inbetween), reactivated_inbetween := FALSE]
        trial.change$trial.numerator = trial.pairs[2, pair_index]
        trial.change$trial.denominator = trial.pairs[1, pair_index]
        trial.change$trials.diff = trial.pairs[2, pair_index] - trial.pairs[1, pair_index]
      }
      trial.change.joined[[pair_index]] = trial.change
    }
    trial.change.list[[length(reactivations.rew.loc.vec) * (i - 1) + j]] = data.table::rbindlist(trial.change.joined, fill=TRUE)
    trial.change.list[[length(reactivations.rew.loc.vec) * (i - 1) + j]]$day_ordinal_name = test.days.df.joined$day_ordinal_name[i]
    trial.change.list[[length(reactivations.rew.loc.vec) * (i - 1) + j]]$reactivation.rew.loc = reactivations.rew.loc
  }
  
  # Early vs late trial place fields
  half.trial = 5
  running.trial.traces = all.trial.traces[is_running > 0]
  early.pf = traces2pf.subset(running.trial.traces[trial < half.trial,], 'early', nshuffles = 1000)
  late.pf = traces2pf.subset(running.trial.traces[trial >= half.trial,], 'late')
  if (length(late.pf) > 0) {
    early.late.si.list[[i]] = bind_rows(
      early.pf$df %>% mutate(trials_group = 'early'),
      late.pf$df %>% mutate(trials_group = 'late')) 
  } else {
    early.late.si.list[[i]] = NULL
  }
    
}

all.change.from.trial1 = data.table::rbindlist(trial.change.list)
#rm(trial.change.list)
# all.change.from.beforetest = data.table::rbindlist(beforetest.change.list)
# rm(beforetest.change.list)

all.change.from.trial1 = all.change.from.trial1 %>% 
  left_join(mouse.meta.df) %>% 
  left_join(trials.meta.df)
# 
# all.change.from.beforetest = all.change.from.beforetest %>%
#   left_join(mouse.meta.df) %>%
#   left_join(trials.meta.df)


all.trial.events = data.table::rbindlist(trial.events.list)
all.trial.events = all.trial.events %>%
  arrange(reactivation.rew.loc, day_ordinal_name, animal, date, exp_title, cell_id, atReward, trial_id, trial) %>%
  group_by(reactivation.rew.loc, day_ordinal_name, animal, date, exp_title, cell_id, atReward) %>%
  mutate(max.deconv.norm = max.deconv / max(max.deconv)) %>%
    #max.deconv.norm = max.deconv / max.deconv[1]) %>%
  ungroup() %>% as.data.table()

rm(trial.events.list)
all.day.events = merge.data.table(all.trial.events, trials.meta.df)[,
                 .(reactivation_events=sum(total_reactivation_events),
                   reactivation_events_at_old=sum(total_reactivation_events_at_old),
                   trials_with_reactivation = sum(total_reactivation_events > 0),
                   events_running = sum(total_events_running)),
                 by=.(animal, date, day_ordinal_name, location_set, exp_title, cell_id, atReward, reactivation.rew.loc)]
#trial.peaks.at.rew = as.data.table(trial.peaks.at.rew)
#reactivation.summary = all.day.events[atReward>0][trial.peaks.at.rew, on=.(animal, date, location_set, cell_id)]
place.cell.db = as.data.table(place.cell.db)
reactivation.summary = all.day.events[atReward>0][place.cell.db, on=.(animal, date, cell_id)]
early.late.si = data.table::rbindlist(early.late.si.list)
```


## Change in max deconv activity

```{r}
# aggregate info about activity during trial excluding reactivation
all.trial.events.run = all.trial.events %>% 
  arrange(reactivation.rew.loc, day_ordinal_name, animal, date, exp_title, trial_id, trial, cell_id, atReward) %>%
  group_by(reactivation.rew.loc, day_ordinal_name, animal, date, exp_title, trial_id, trial, cell_id) %>%
  dplyr::summarise(reactivation_events = total_reactivation_events[2],
                   total_events = total_events[1],
                   max.deconv = max.deconv[1],
                   max.deconv.norm = max.deconv.norm[1],
                    .groups='drop') %>%
  mutate(reactivated = (reactivation_events) > 0 & (total_events > 0))

all.trial.events.run = all.trial.events.run %>%
  group_by(reactivation.rew.loc, animal, date, exp_title, cell_id) %>%
  dplyr::mutate(fst.reactivated.trial = min(c(trial[which(reactivated)], Inf))) %>%
  ungroup()

compared.all.trial.events.run = all.trial.events.run %>%
  filter(reactivation.rew.loc=='both') %>%
  filter(max.deconv.norm > 0 & !is.infinite(max.deconv.norm)) 

compared.all.trial.events.run %>%
  filter(fst.reactivated.trial %in% c(1, 4) | is.infinite(fst.reactivated.trial)) %>%
  #filter(reactivation_events == 0 | fst.reactivated.trial == trial) %>%
  mutate(fst.reactivated.trial.noninf = ifelse(is.infinite(fst.reactivated.trial), 0, fst.reactivated.trial),
         fst.reactivated.trial.factor = as.factor(fst.reactivated.trial.noninf)) %>%
  group_by(exp_title, fst.reactivated.trial.factor, trial) %>%
  dplyr::summarise(mean.max.deconv.norm = mean((max.deconv.norm), na.rm=TRUE),
                   sem.max.deconv.norm = sem((max.deconv.norm)),
                   .groups='drop') %>%
  ggplot(aes(x=trial, 
             y=mean.max.deconv.norm, 
             group=fst.reactivated.trial.factor, 
             #fill=fst.reactivated.trial.factor,
             colour=fst.reactivated.trial.factor)) +
  geom_ribbon(aes(ymin=mean.max.deconv.norm-sem.max.deconv.norm,
                  ymax=mean.max.deconv.norm+sem.max.deconv.norm),
              alpha=0.2, fill = '#666666',
              color='transparent') +
  geom_line() +
  #scale_colour_gradient(low='#333333', high='#aaaaaa') +
  #scale_fill_gradient(low='#333333', high='#aaaaaa') +
  #scale_colour_viridis_b(direction=-1) +
  scale_color_manual(values=c(reactiv.colours, '#3580cc')) +
  xlab('Trial') +
  ylab('Activity peak (norm.)') +
  labs(color='First trial when\ncells reactivated') +
  gtheme
ggsave('~/tmp/tanjas/activity_peaks_norm_lines.svg', units = 'cm',
       width = 7.7, height = 4.4)
```

```{r}
# stat.compared.all.trial.events.run %>%
#   group_by(fst.reactivated.trial.factor, trial) %>%
#   mutate(max.deconv.norm)
binwidth = 0.1
stat.compared.all.trial.events.run.freq = compared.all.trial.events.run %>%
  mutate(fst.reactivated.trial.factor = as.factor(fst.reactivated.trial)) %>%
  #filter(fst.reactivated.trial %in% c(1, 4, Inf)) %>%
  group_by(trial, fst.reactivated.trial.factor) %>%
  dplyr::summarize(freq=hist(max.deconv.norm, plot=FALSE, breaks=seq(0, 1.0, binwidth))$counts / length(max.deconv.norm),
                   bins=seq(binwidth/2, 1.0, binwidth))
  
compared.all.trial.events.run %>%
  #filter(fst.reactivated.trial %in% c(1, 4, Inf)) %>%
  #filter(animal != 'N-BR') %>%
  filter(fst.reactivated.trial == 5) %>% 
  ggplot(aes(factor(trial), y=max.deconv.norm)) +
  stat_density(
    geom = 'raster',
    #aes(fill = after_stat(log10(10 + density))),
    aes(fill = after_stat(density)),
    position='identity',
    contour = FALSE
  ) + 
  scale_fill_distiller() +
  #scale_fill_gradient(high='#ffffff', low='#111111') +
  stat_summary(aes(x=trial), geom='line', fun=mean, 
               color='#333333') +
  geom_hline(data=data.frame(y=seq(0.1, 0.9, 0.1)),#c(0.25, 0.5, 0.75)),
             mapping=aes(yintercept=y),
             alpha=0.4,
             size=0.1, color='#333333') +
  facet_grid(. ~ fst.reactivated.trial, scales='free') + 
  labs(x='Trial', y='Activity peak (norm.)') +
  scale_x_discrete(breaks = c('', '2', '', '4', '', '6', '', '8')) +
  gtheme

ggsave('~/tmp/tanjas/activity_peak_density_5.svg', units = 'cm',
       width = 5.3, height = 4.0)
```
Problem: I'm taking a mean of non-gaussian distribution ot describe it
Solution - permutation tests on ANOVA
```{r}
library(permuco)
d = compared.all.trial.events.run %>%
  mutate(fst.reactivated.trial_factor = as.factor(fst.reactivated.trial),
         trial_factor = as.factor(trial),
         trial_centered = trial - 4.5,
         is_after_reactiv = trial >= fst.reactivated.trial, 
         animal_cell_identifier = paste(animal, date, cell_id, sep='_'),
         animal_trial = paste(animal, date, trial, sep='_'),
         animal_date = paste(animal, date, sep='_')) 

perm.reactiv.m = permuco::aovperm(
  #max.deconv.norm ~ trial_factor * is_after_reactiv,
  max.deconv.norm ~ trial_factor + is_after_reactiv + Error(animal_date / (trial_factor + is_after_reactiv)),
  data = d %>% 
    filter(is.infinite(fst.reactivated.trial) | trial == fst.reactivated.trial + 1) %>%
    # Balance the reactivated and non-reactivated data start with trial == 2
    filter(trial > 1) %>%    
    identity(),
  np = 5000)
summary(perm.reactiv.m)
plot(perm.reactiv.m)

d %>%
  filter(trial > 1) %>% 
  filter(is.infinite(fst.reactivated.trial) | trial == fst.reactivated.trial + 1) %>%
  group_by(is_after_reactiv) %>% summarize(mean(max.deconv.norm))

d %>%
  filter(trial > 1) %>%
   filter(is.infinite(fst.reactivated.trial) | trial == fst.reactivated.trial + 1) %>%
  group_by(is_after_reactiv) %>%
  dplyr::summarise(nobservations = n(),
    counts=hist(max.deconv.norm, plot=FALSE, breaks=seq(0, 1 + binwidth, binwidth))$counts,
    breaks=seq(binwidth/2, 1.0 + binwidth, binwidth)) %>%
  mutate(freqs = counts/nobservations) %>%
  ggplot(aes(y=freqs * 100,
             x=breaks,
             group=is_after_reactiv,
             fill=is_after_reactiv)) +
  geom_col(position='identity', alpha=0.4, color='#666666') +
  scale_fill_manual(values=reactiv.colours) +
  scale_color_manual(values=reactiv.colours) +
  labs(y='Cells (%)', x='Activity peak (norm.)', fill='') +
  gtheme
ggsave('~/tmp/tanjas/activity_peaks_norm_hist.svg', units = 'cm',
       width=7.1, height = 3.3)
  

d.wide = d %>%
  filter(fst.reactivated.trial %in% c(1, Inf)) %>%
  pivot_wider(
    id_cols=c('animal', 'date', 'cell_id', 'fst.reactivated.trial_factor'),
    values_from = max.deconv.norm,
    names_from = trial_factor)

rownames(d.wide) = paste(d.wide$animal, d.wide$date, d.wide$cell_id, sep='_')
d.obs.matrix = d.wide %>%
  dplyr::select(-c(animal, date, cell_id, fst.reactivated.trial_factor))

perm.reactiv.pairwise = permuco::clusterlm(
  d.obs.matrix ~ fst.reactivated.trial_factor,
  data = d.wide,
  np=5000,
  test='t',
  multcomp = 'benjamini_hochberg')
summary(perm.reactiv.pairwise)
plot(perm.reactiv.pairwise)
```



```{r}
all.change.combined = bind_rows(
  all.change.from.trial1 %>% mutate(group='learning'))

min.deconv.activity = 1e-5
max.trial = 8

all.change.combined = all.change.combined %>%
  mutate(group_desc = paste0('learning (', reactivation.rew.loc, ' reward)')) %>%
  arrange(trial.numerator) %>%
  ungroup() %>%
  group_by(group, group_desc, reactivation.rew.loc, implant, animal, date, exp_title, cell_id) %>%
  dplyr::mutate(fst.reactivated.trial = min(c(trial.denominator[which(reactivated)], Inf)),
                reactivated_later = fst.reactivated.trial < Inf) %>%
  group_by(group, group_desc, reactivation.rew.loc, implant, animal, date, exp_title, cell_id, trials.diff) %>%
  dplyr::mutate(reactivation.ordinal = ifelse(reactivated,
                                              map_dbl(trial.denominator, ~ sum(.x >= trial.denominator[which(reactivated)])),
                                              0)) %>%
  dplyr::ungroup() %>%
  filter(day_ordinal_name == 'first') %>%
    filter(trials.diff <= 7, trial.numerator <= max.trial) %>%
  filter(max.deconv_trial.1 > min.deconv.activity, max.deconv_trial.2 > min.deconv.activity) %>%
  filter(deconv.95p_trial.1 > 0, deconv.95p_trial.2 > 0)

all.change.combined$group_desc = factor(all.change.combined$group_desc, 
                                        levels=c('learning (new reward)', 'learning (old reward)', 'learning (both reward)'))

sd_summary <- function(x) {
  x = x[!is.na(x)]
  m <- mean(x)
  # percentiles = quantile(x, c(0.25, 0.75))
  # ymin <- percentiles[[1]]
  # ymax <- percentiles[[2]]
  ymin = m - sd(x)
  ymax = m + sd(x)
  return(c(y=m, ymin=ymin, ymax=ymax))
}

non.reactivated.align.trial = 3

x = bind_rows(
  all.change.combined %>%
    filter(trials.diff == 1) %>%
    mutate(fst.reactivated.trial < Inf) %>%
    filter(!reactivated | trial.denominator == fst.reactivated.trial) %>% # show cells reactivated only during a single trial in absence of other reactivations
    mutate(aligned.reactiv.trial = fst.reactivated.trial),
  map_dfr(c(1:7), function(aligned.i) {
    all.change.combined %>%
      filter(trials.diff == 1) %>%
      filter(is.infinite(fst.reactivated.trial)) %>%
      mutate(aligned.reactiv.trial = aligned.i)
  })
) %>%
  mutate(trial_n = trial.denominator - aligned.reactiv.trial + 1)

```


Trial-to-trial changes in the peak activity of reactivated cells equally variable as the other cells
Measured by coefficient of variation
```{r}
day.summary = all.change.combined %>%
  filter(trials.diff == 1) %>%
  mutate(reactivated_later = fst.reactivated.trial < Inf) %>%
  group_by(animal, date, day_desc, cell_id, reactivated_later, group, group_desc) %>%
  dplyr::summarise(ntrials = n(), 
                   mean.deconv = mean(max.deconv.ratio, na.rm=TRUE), 
                   deconv.sd = sd(max.deconv.ratio, na.rm = TRUE),
                   var.coef = deconv.sd / mean.deconv,
                   .groups='drop') 
day.summary %>% 
  ggplot(aes(x=reactivated_later, y=var.coef)) +
  geom_violin(draw_quantiles = 0.5) +
  #scale_y_log10(limits=c(0.1, 2)) +
  facet_grid(. ~ group_desc)
```


Reactivation at new vs old reward
```{r}
x.reactivated.location = all.change.combined %>%
  filter(trials.diff == 1) %>%
  filter(group == 'learning') %>% 
  filter(reactivation.rew.loc != 'both') %>%
  dplyr::select(animal, date, day_desc, trial.denominator , cell_id, reactivated, total_reactivations_at_reward_trial.1, reactivation.rew.loc ) %>%
  pivot_wider(id_cols = c(animal, date, day_desc, cell_id, trial.denominator ),
              names_from=reactivation.rew.loc,
              names_prefix='reactivation.loc.',
              values_from='reactivated')
  
x.reactivated.location.summary = x.reactivated.location %>%
  filter(!is.na(reactivation.loc.new), !is.na(reactivation.loc.old)) %>%
  dplyr::group_by(animal, date, day_desc, trial.denominator) %>%
  dplyr::summarise(ncells = n(), 
                   new = mean(reactivation.loc.new &!reactivation.loc.old),
                   previous = mean(reactivation.loc.old & !reactivation.loc.new),
                   both = mean(reactivation.loc.new & reactivation.loc.old),
                   neither = mean(!reactivation.loc.new & !reactivation.loc.old),
                   either = mean(reactivation.loc.new | reactivation.loc.old)) %>%
  pivot_longer(cols=c(new, previous, both, neither, either)) 

x.reactivated.location.summary$name = factor(x.reactivated.location.summary$name, 
                                             levels=c('neither', 'both', 'new', 'previous', 'either'))

x.reactivated.location.summary %>%
  group_by(name) %>%
  dplyr::summarise(mean(value), sem(value))
  
x.reactivated.location.summary %>%
  filter(name != 'either') %>%
  ggplot(aes(y=name, x=value)) +
  geom_jitter(aes(colour=name),
             width=0, height=0.33, shape=1, alpha=0.3, size=0.5) +
  geom_boxplot(fill='transparent', outlier.shape = NA, coef=1, color='#333333') +
  gtheme +
  scale_x_continuous(labels = scales::percent) +
  scale_colour_manual(values=c(reactiv.colours[1], reactiv.colours[2], reactiv.colours[2], reactiv.colours[2])) +
  #scale_y_discrete(labels=c('old', 'new', 'neither', 'both')) +
  labs(x='', y='')
ggsave('~/tmp/tanjas/reactivated_cells.svg', units = 'cm',
       width = 7.5, height = 3.1)
```


## Higher activity peaks in the first trial after reactivation for cells reactivated at the new location
```{r}
compared.var = quo(max.deconv.ratio)

x.next.trial.reactiv = filter(x, trial_n == 1) %>%
  left_join(x.reactivated.location) %>%
  replace_na(list(reactivation.loc.new=FALSE, reactivation.loc.old=FALSE)) %>%
  filter(!(reactivation.loc.new & reactivation.loc.old)) %>% # cells not reactivated at both the old and new location
  identity()

x.next.trial.reactiv$reactivated = as.factor(x.next.trial.reactiv$reactivated)
x.next.trial.reactiv$group = factor(x.next.trial.reactiv$group, levels= c('learning'))
x.next.trial.reactiv.summary = group_by(x.next.trial.reactiv, group, group_desc, reactivated, reactivated_later, trial_n, aligned.reactiv.trial) %>%
  dplyr::summarise(as_tibble(t(sd_summary(log(!!compared.var))) %>% exp),
                             ncells=n(), .groups='drop') 

x.fst.trial = filter(x, trial_n == 1) %>%
  filter(group_desc %in% c('learning (both reward)', 'exploration'))

x.fst.trial.summary = group_by(x.fst.trial, group, group_desc, reactivated, reactivated_later, trial_n, aligned.reactiv.trial) %>%
  dplyr::summarise(as_tibble(t(sd_summary(log(!!compared.var))) %>% exp),
                             ncells=n(), .groups='drop') 

x.fst.trial %>%
  filter(group_desc == 'learning (both reward)') %>%
  filter(!!compared.var > 0) %>%
  ggplot(aes(!!compared.var, group=reactivated_later, fill=reactivated_later)) +
  facet_wrap(. ~ aligned.reactiv.trial, scales='free', ncol = 3) +
  geom_histogram(aes(y=..density..),
                 position='identity', alpha=0.3) +
  geom_vline(data=filter(x.fst.trial.summary, group_desc == 'learning (both reward)'),
             mapping=aes(xintercept=y, color=reactivated_later), 
             linetype='dashed') +
  scale_fill_manual(values=reactiv.colours) +
  scale_color_manual(values=reactiv.colours) +
  scale_x_log10(limits=c(0.01, 10)) +
  gtheme
```

Effect size of the first vs subsequent reactivation
```{r}
all.change.combined %>%
  filter(trials.diff == 1,
         group_desc == 'learning (new reward)') %>% 
  filter(reactivation.ordinal %in% c(1, 2, 3, 4, 5, 6)) %>% #| (reactivated_later == FALSE)) %>%
  #filter(reactivated_later == FALSE) %>%
  mutate(reactivation.ordinal.char = as.character(reactivation.ordinal),
         trial.denominator.char = paste0('Trial ', as.character(trial.denominator))) %>%
  filter(trial.denominator > 1) %>%
  filter(trial.denominator %in% c(4, 5)) %>%
  ggplot(aes(x=reactivation.ordinal.char, y=max.deconv.ratio)) +
  geom_jitter(height=0, width=0.1, shape=1, alpha=0.4, color=reactiv.colours[2]) +
  #geom_violin(fill='transparent', draw_quantiles = 0.5) +
  stat_summary(geom='pointrange', fun.data='mean_sdl',
               size=0.5, shape=1, colour='#444444') +
  facet_wrap(trial.denominator.char ~ ., scales='free_x') +
  scale_y_log10() +
  xlab('Reactivation ordinal') +
  ylab('Activity peak ratio (1)') +
  gtheme.light.panel

ggsave('~/tmp/tanjas/subsequent_reactivation_effect.svg', units = 'cm',
       width = 12, height = 6.3)
```

```{r}
subsequent.reactiv.effect = all.change.combined %>%
  filter(trials.diff == 1,
         group_desc == 'learning (new reward)') %>% 
  filter(trial.denominator %in% c(2,3)) %>%
  filter(reactivation.ordinal %in% c(1, 3))

lmer.test.print(subsequent.reactiv.effect %>%
                  mutate(is.subsequent.reactivation = reactivation.ordinal > 1,
                         val = log(max.deconv.ratio)),
                var = val,
                fixed.effects = is.subsequent.reactivation,
                randef.str = '(1 + animal | day_desc)',
                diagnostics.groupvar = animal,
                print.mean.stats = TRUE)
```



## Correlation between activation and place cell stats
```{r}
reactivation.summary %>% 
  filter(day_ordinal_name == 'first') %>%
  filter(signif.si) %>%
  ggplot(aes(x=trials_with_reactivation, y=early.late.cor)) +
  geom_jitter(shape=1, alpha=0.5, height = 0, width=0.2) +
  facet_grid(. ~ implant) +
  #facet_wrap(. ~ animal) +
  geom_smooth(method='lm') +
  geom_hline(yintercept = 0, linetype='dashed') + 
  xlab('# trials when cell reactivated') +
  ylab('Early-late trials correlation')

reactivation.summary %>% 
  filter(day_ordinal_name == 'first') %>%
  filter(signif.si) %>%
  ggplot(aes(x=trials_with_reactivation, y=spatial.information)) +
  geom_jitter(shape=1, alpha=0.5, height = 0, width=0.2) +
  facet_grid(. ~ implant) +
  #facet_wrap(. ~ animal) +
  geom_smooth(method='lm') +
  geom_hline(yintercept = 0, linetype='dashed') + 
  xlab('# trials when cell reactivated') +
  ylab('Spatial information')
```



Early vs late metrics of the cells depending if the cell was reactivated during trial 4.
use spatial.info after subtracting random shuffles mean
```{r}
place.cell.db = as.data.table(place.cell.db)
first.reactivated.trial = all.change.from.trial1 %>%
  filter(reactivation.rew.loc == 'both') %>%
  filter(trials.diff == 1) %>%
  group_by(animal, date, day_desc, day_ordinal_name, cell_id) %>%
  arrange(trial.denominator) %>%
  dplyr::summarise(fst.reactivated.trial = min(c(trial.denominator[which(reactivated)], Inf)),
                   active = max(active),
                   .groups='drop') %>%
  left_join(place.cell.db[, .(animal, date, day_desc, cell_id, signif.si, early.late.cor)]) %>%
  mutate(exp='learning')

first.reactivated.trial %>%
  group_by(fst.reactivated.trial < Inf) %>%
  dplyr::summarise(mean(signif.si), n(), sum(signif.si))

early.late.si$date = as.Date(early.late.si$date)
compared.early.late.df.trials = early.late.si %>%
  mutate(exp='learning') %>%
  dplyr::select(-signif.si) %>%
  left_join(first.reactivated.trial) %>%
  filter(signif.si) %>%
  filter(day_ordinal_name == 'first') %>%
  identity()

compared.early.late.pc.df = compared.early.late.df.trials %>%
  filter(fst.reactivated.trial >= 4) %>%
  mutate(reactivated = fst.reactivated.trial < 2 * half.trial,
         spatial.info.corrected = spatial.information - si.shuffle.mean) %>%
  filter(!is.na(reactivated)) %>% # filter rows on last and first day of learning
  filter(active > 0)

compared.early.late.pc.df = compared.early.late.pc.df %>%
  dplyr::group_by(exp, animal, date, day_desc, day_ordinal_name, trials_group)  %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist)

compared.early.late.pc.wide = pivot_wider(
      compared.early.late.pc.df, 
      id_cols=c('animal', 'exp', 'date', 'day_desc', 'day_ordinal_name', 'cell_id', 'active', 'reactivated', 'early.late.cor'),
      names_from=trials_group,
      values_from=c('field.max', 'spatial.info.corrected', 'trace.mean', 'signif.si','field.max.x', 'field.max.y', 'min.rew.dist')) %>%
      mutate(field.max.diff = field.max_late - field.max_early,
             field.max.ratio = field.max_late / field.max_early,
             spatial.info.corrected.diff = spatial.info.corrected_late - spatial.info.corrected_early,
             min.rew.dist.diff = min.rew.dist_late - min.rew.dist_early,
             trace.mean.ratio = trace.mean_late / trace.mean_early,
             field.shift.distance.cm = perc2dist * norm2(field.max.x_late - field.max.x_early, 
                                                         field.max.y_late - field.max.y_early))

compared.early.late.pc.wide %>%
  group_by(reactivated) %>%
  dplyr::summarise(n())
```


Cumulative cells reactivated by trial
```{r}
fst.reactivated.trial_index_nos = c(1:7, Inf)
first.reactivated.trial %>%
  mutate(first.reactivated.trial_index = match(fst.reactivated.trial, fst.reactivated.trial_index_nos)) %>%
  filter(signif.si) %>%
  filter(day_ordinal_name == 'first') %>%
  ggplot(aes(first.reactivated.trial_index)) +
  stat_ecdf(color='#333333') +
  xlab('First trial when reactivated') +
  ylab('Cumulative % of\nreactivated cells') +
  scale_x_continuous(breaks=1:8+0.5, labels=c(1:7, 'Never'), limits = c(0.5, 8.5)) +
  scale_y_continuous(labels=scales::percent) +
  gtheme
  #geom_histogram()
ggsave('~/tmp/tanjas/ecdf_reactivations.svg', width=5.2, height=4.5, units='cm')
```

## Change in place map peaks
```{r}
compared.early.late.pc.wide.summary = compared.early.late.pc.wide %>%
  group_by(reactivated) %>%
  summarise(m.field.max.ratio = mean(field.max.ratio),
            sem.field.max.ratio = sem(field.max.ratio),
            m.spatial.info.corrected.diff = mean(spatial.info.corrected.diff), 
            sem.spatial.info.corrected.diff = sem(spatial.info.corrected.diff),
            m.early.late.cor = mean(early.late.cor),
            sem.early.late.cor = sem(early.late.cor))
compared.early.late.pc.wide.summary

log.breaks = seq(-1, 1, 0.1) %>% map_dbl(~ 10 ^ .x)
break.mids = seq(-0.95, 0.95, 0.1) %>% map_dbl(~ 10 ^ .x)
compared.early.late.pc.wide %>%
  group_by(reactivated) %>%
  dplyr::summarise(nobservations = n(),
                   counts=hist(field.max.ratio, plot=FALSE, breaks=log.breaks)$counts,
                   breaks=break.mids) %>%
  filter(counts > 0) %>%
  mutate(freqs = counts/nobservations) %>%
  ggplot(aes(y=freqs * 100,
             x=breaks,
             group=reactivated,
             fill=reactivated)) +
  geom_col(position='identity', alpha=0.4, color='#666666') +
  geom_vline(data=compared.early.late.pc.wide.summary,
             mapping=aes(xintercept=m.field.max.ratio, color=reactivated),
             linetype='dashed') +
  scale_fill_manual(values=reactiv.colours) +
  scale_color_manual(values=reactiv.colours) +
  scale_x_log10() +
  labs(y='Cells (%)', x='Field peaks ratio', fill='') +
  gtheme

ggsave('~/tmp/tanjas/pc_peaks_hist.svg', units = 'cm',
       width=7.1, height = 3.3)

pc.peak.reactiv.m = permuco::aovperm(
  field.max.ratio ~ reactivated + Error(animal_date / (reactivated)),
  data = compared.early.late.pc.wide %>%
    mutate(animal_date = paste(animal, date, sep='_')),
  np = 5000)
summary(pc.peak.reactiv.m)

```

## Change in spatial information
```{r}
seq.breaks = seq(-2, 2, 0.1) 
seq.mids = seq(-1.95, 1.95, 0.1)
compared.early.late.pc.wide %>%
  group_by(reactivated) %>%
  dplyr::summarise(nobservations = n(),
                   counts=hist(spatial.info.corrected.diff, plot=FALSE, breaks=seq.breaks)$counts,
                   breaks=seq.mids) %>%
  filter(counts > 0) %>%
  mutate(freqs = counts/nobservations) %>%
  ggplot(aes(y=freqs * 100,
             x=breaks,
             group=reactivated,
             fill=reactivated)) +
  geom_col(position='identity', alpha=0.4, color='#666666') +
  geom_vline(data=compared.early.late.pc.wide.summary,
           mapping=aes(xintercept=m.spatial.info.corrected.diff, color=reactivated),
           linetype='dashed') +
  scale_fill_manual(values=reactiv.colours) +
  scale_color_manual(values=reactiv.colours) +
  xlim(c(-1.0, 1.0)) +
  labs(y='Cells (%)', x='Spatial information', fill='') +
  gtheme

ggsave('~/tmp/tanjas/pc_si_hist.svg', units = 'cm',
       width=7.1, height = 3.3)

pc.si.reactiv.m = permuco::aovperm(
  spatial.info.corrected.diff ~ reactivated + Error(animal_date / (reactivated)),
  data = compared.early.late.pc.wide %>%
    mutate(animal_date = paste(animal, date, sep='_')),
  np = 5000)
summary(pc.si.reactiv.m)
```

## Change in place field stability
```{r}
seq.breaks = seq(-1, 1, 0.1) 
seq.mids = seq(-0.95, 0.95, 0.1)
compared.early.late.pc.wide %>%
  group_by(reactivated) %>%
  dplyr::summarise(nobservations = n(),
                   counts=hist(early.late.cor, plot=FALSE, breaks=seq.breaks)$counts,
                   breaks=seq.mids) %>%
  filter(counts > 0) %>%
  mutate(freqs = counts/nobservations) %>%
  ggplot(aes(y=freqs * 100,
             x=breaks,
             group=reactivated,
             fill=reactivated)) +
  geom_col(position='identity', alpha=0.4, color='#666666') +
  geom_vline(data=compared.early.late.pc.wide.summary,
           mapping=aes(xintercept=m.early.late.cor, color=reactivated),
           linetype='dashed') +
  scale_fill_manual(values=reactiv.colours) +
  scale_color_manual(values=reactiv.colours) +
  xlim(c(-1.0, 1.0)) +
  labs(y='Cells (%)', x='Early-late correlation', fill='') +
  gtheme

ggsave('~/tmp/tanjas/pc_cors_hist.svg', units = 'cm',
       width=7.1, height = 3.3)

pc.cor.reactiv.m = permuco::aovperm(
  early.late.cor ~ reactivated + Error(animal_date / (reactivated)),
  data = compared.early.late.pc.wide %>%
    mutate(animal_date = paste(animal, date, sep='_')),
  np = 5000)
summary(pc.cor.reactiv.m)
```



