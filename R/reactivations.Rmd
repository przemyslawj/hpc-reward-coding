---
title: "R Notebook"
output: html_notebook
---

```{r}
library(cowplot)
library(dplyr)
library(data.table)
library(datatrace)
library(ggplot2)
library(purrr)
library(raster)
library(stringr)
library(tidyr)

source('fixed_effects.R')
source('behav_analysis.R')
source('traces_input.R')
source('place_field_utils.R')
source('plotting_params.R')

pc.two.colours = rev(main.two.colours)
reactiv.colours = c('#999999', '#85b2e0')

gtheme.light.panel = gtheme +
    theme(
        panel.grid.major.y = element_line(color = '#dddddd', size=0.3),
        panel.grid.minor.y = element_line(color = '#dddddd', size=0.2),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.background = element_rect(fill = 'white'),
        strip.background = element_blank(),
        strip.text = element_text(size = 8))

trials.meta.df = read.trials.meta(rootdirs)
mouse.meta.df = read.mouse.meta(rootdirs)
```


```{r}
nbins=20
timebin.dur.msec=200
prepare.all.traces = function(caimg_result_dir, 
                              timebin.dur.msec=timebin.dur.msec,
                              # running speed avg > 4 cm/s in 0.5 s window
                              mean.run.velocity=3.3, 
                              event.deconv.threshold=0.2) {
  data.traces = read.data.trace(caimg_result_dir)
  data.traces = add.running.col(data.traces, mean.run.velocity, 10)
  data.traces$date = rep(char2date(data.traces$date[1]), nrow(data.traces))
  setorder(data.traces, exp_title, trial_id, cell_id, timestamp)
  detect.events(data.traces, deconv.threshold = event.deconv.threshold)

  data.traces = gauss.smooth.df.var(data.traces, filter.len=20, sigma=5.0)

  data.traces[, moved_distance := cumsum(c(0, norm2(diff(x), diff(y)))),
              by = .(animal, date, exp_title, trial_id, trial, cell_id)]

  binned.traces = timebin.traces(data.traces,
                                 timebin.dur.msec=timebin.dur.msec)
  binned.traces[, trial_time_bin := time_bin - min(time_bin), by=.(exp_title, trial)]
  binned.traces[, `:=` (zscored_deconv_trace = zscore(deconv_trace),
                        zscored_trace = zscore(trace),
                        zscored_smooth_deconv_trace = zscore(smoothed_deconv_trace)),
                by=.(exp_title, cell_id)]
   binned.traces = binned.traces %>% 
     stimbin.traces(x, nbins) %>% 
     stimbin.traces(y, nbins) %>%
     as.data.table()
   binned.traces = bin.responses(binned.traces, get.quantiles.fun(c(0.95, 1.0)), 
        binned.var = 'smoothed_deconv_trace')

  binned.traces[, atReward := pmin((atReward0 >= 0.5) + (atReward1 >= 0.5), 1)]

  return(binned.traces)
}
```


```{r}
# root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2019-08/'
# animal_name = 'F-BL'
#root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2020-10/'
#animal_name = 'M-BR'
root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2020-10/'
animal_name = 'E-BL'
exp_title='learning'
day_desc_name = 'learning2 day#1'

day = filter(trials.meta.df, animal == animal_name, day_desc == day_desc_name) %>% pull(date)
caimg_result_dir = find.caimg.dir(caimg_result_dirs, animal_name, day)

binned.traces = prepare.all.traces(caimg_result_dir, timebin.dur.msec=timebin.dur.msec, )[exp_title == 'trial',]
binned.traces[, atReward := pmin((atReward0 >= 0.5) + (atReward1 >= 0.5), 1)]
```
Activity change in the cells
```{r}
all.locations.df = map_dfr(rootdirs, read_locations)
new.locations.df = all.locations.df %>%
  group_by(animal, date) %>%
  filter(!is_test, location_set > 1) %>%
  filter(location_ordinal == max(location_ordinal)) %>%
  ungroup()

#filter(compared.early.late.df.trials.peaks.wide, animal == animal_name, day_desc == day_desc_name, signif.si, 
#       reactivated, fst.reactivated.trial >= 4) %>% View

#cell_names = c(3, 8, 38, 43) # M-BR, l2 d1
#cell_names = c(40, 44, 63, 101, 110) # F-BL, l2 d1
cell_names = c(39, 40, 63, 105, 146, 317)
cells.df = binned.traces[exp_title == 'trial' & cell_id %in% cell_names, ]
animal.new.locations.df = filter(new.locations.df, animal == animal_name, date == cells.df$date[1], !is_test) %>%
  mutate(loc_id=paste(Well_row, Well_col, sep='x'))
plotted.locations.df = filter(locations.df, animal == animal_name, date == cells.df$date[1], !is_test) %>%
  mutate(loc_id=paste(Well_row, Well_col, sep='x'),
         is.new = loc_id %in% animal.new.locations.df$loc_id,
         current_loc=is.new) # Workaround for plotting in the right colour
plotted.locations.df = map_df(unique(cells.df$trial), ~ mutate(plotted.locations.df, trial=.x))
plotted.locations.df = map_df(cell_names, ~ mutate(plotted.locations.df, cell_id=.x))

g1 = plot.trace.events(cells.df[is_running > 0,], event.var=nevents, event.thr=0.5) +
  geom_rewards(plotted.locations.df, animal_name, cells.df$date[1], nbins = 100, 
               rew.colours = c('prev_rew'='gray60', 'current_rew'='grey30')) +
  geom_point(data=cells.df[atReward > 0 & nevents > 0], color='blue') +
  facet_grid(cell_id ~ trial) +
  theme(legend.position='none')

ggsave('~/tmp/tanjas/paths_examples.png', g1, units='cm',
       width=19, height=12)

g2 = map_df(cell_names, function(cell_name) {
  day = as.character(cells.df$date[1])
  bind_rows(
    create.pf.df(early.fields[[animal_name]][[day]][[as.character(cell_name)]],
               early.occupancies[[animal_name]][[day]][[as.character(cell_name)]],
               min.occupancy.sec = 0.5) %>% 
      mutate(trials_group = 'trial 1-4', cell_id = cell_name, animal = animal_name, date = day, day_desc = '1'),
    create.pf.df(late.fields[[animal_name]][[day]][[as.character(cell_name)]],
               late.occupancies[[animal_name]][[day]][[as.character(cell_name)]],
               min.occupancy.sec = 0.5) %>% 
      mutate(trials_group = 'trial 5-8', cell_id = cell_name, animal = animal_name, date = day, day_desc = '2'))
  }) %>%
  day.normalize.fields() %>%
  plot.pf(max.x=20, max.y=20) +
  geom_rewards(plotted.locations.df, animal_name, cells.df$date[1], nbins = 20, 
               rew.colours = c('prev_rew'='gray60', 'current_rew'='grey30')) +
  facet_grid(cell_id ~ trials_group) 
cowplot::plot_grid(g1, g2, ncol = 2, rel_widths = c(2.2, 1))
ggsave('~/tmp/tanjas/pcs_examples.svg', units='cm',
       width=25, height=12)
```


# Reactivations at reward
Reactivation only at moved reward

## Utility functions
```{r}
all.locations.df = map_dfr(rootdirs, read_locations)

cut.trace.until.reactiv = function(traces, reactivation.at.new.rew=TRUE) {
  reactiv.location.df = all.locations.df %>%
    filter(!is_test) %>%
    filter(animal == traces$animal[1], date == traces$date[1])
  
  if (reactivation.at.new.rew) {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == max(location_ordinal))   
  } else {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == min(location_ordinal))   
  }
  behav.traces = traces[cell_id == traces$cell_id[1],] 
  max.timestamp.df = behav.traces[
    (atReward > 0) & norm2(reactiv.location.df$trans_x[1] - x, reactiv.location.df$trans_y[1] - y) < goal.cell.max.dist, 
         .(cut.timestamp = max(timestamp)),
         by=.(animal, date, trial, trial_id)]
  x = traces[max.timestamp.df, on=.(animal, date, trial, trial_id)]
  res = x[timestamp <= cut.timestamp, ]
  res[, cut.timestamp := NULL]
  res
}

find.reactivation.events = function(traces, 
                                    reactivation.at.new.rew=TRUE) {
  reactiv.location.df = all.locations.df %>%
    filter(!is_test) %>%
    filter(animal == traces$animal[1], date == traces$date[1])
  
  if (reactivation.at.new.rew) {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == max(location_ordinal)) 
  } else {
    reactiv.location.df = filter(reactiv.location.df, location_ordinal == min(location_ordinal)) 
  }
  traces[,nevents_running := 0]
  traces[(x>0) & (y>0) & is_running,
         nevents_running := nevents]
  traces[,
         running_cumsum_events := cumsum(nevents_running),
         by=.(exp_title, trial_id, trial, cell)]
  traces[, atReactivatedReward := (atReward > 0) &  
           norm2(reactiv.location.df$trans_x[1] - x, reactiv.location.df$trans_y[1] - y) < goal.cell.max.dist]
  traces[,
         reactivation_event := (atReward > 0) &
           # cell must have been active during running before the event
           (running_cumsum_events > 0) & 
           (nevents > 0) & 
           # only consider reactivations at new reward location
           norm2(reactiv.location.df$trans_x[1] - x, reactiv.location.df$trans_y[1] - y) < goal.cell.max.dist]
}

find.reactivation.during.immobility = function(traces) {
  traces[, nevents_running := 0]
  traces[(x>0) & (y>0) & is_running,
         nevents_running := nevents]
  traces[,
         running_cumsum_events := cumsum(nevents_running),
         by=.(exp_title, trial_id, trial, cell_id)]
  traces[,
         reactivation_event := immobile &
           # cell must have been active during running before the event
           (running_cumsum_events > 0) & 
           (nevents > 0) ]
}


make.reactivated.cells.df = function(trial.events.count, all.active=FALSE) {
  trial1.reactivated.cells = trial.events.count[atReward > 0,]
  if (nrow(trial1.reactivated.cells) == 0) {
    trial1.reactivated.cells = trial.events.count
    trial1.reactivated.cells[, reactivated := FALSE]
  } else {
    trial1.reactivated.cells[, `:=` (reactivated = total_reactivation_events >= 1, 
                                 active = total_events_running >= 1)]
  }
  if (all.active) {
    trial1.reactivated.cells[, active := TRUE]
  }
  trial1.reactivated.cells[, .(animal, date, cell_id, reactivated, active)]
}

calculate.ratio.between.trials = function(trial.events.reactivated.df) {
  trial.nos = sort(unique(trial.events.reactivated.df$trial))
  trial.events.reactivated.df[, trial_ordinal := match(trial, trial.nos)]
  trial.events.reactivated.df[, total_reactivations_at_reward := max(total_reactivation_events),
                              by=.(animal, date, exp_title, trial, cell_id, active, reactivated)]
  active.df = trial.events.reactivated.df[atReward == 0 & active == 1,]
  if (length(unique(active.df$trial_ordinal)) < 2) {
    return(data.frame())
  }
  pivot_wider(
      active.df, 
      id_cols=c('animal', 'date', 'exp_title', 'cell_id', 'active', 'reactivated'),
      names_from=trial_ordinal,
      names_prefix='trial.',
      values_from=c('total_events', 'max.deconv', 'deconv.95p','mean.deconv', 'total_reactivations_at_reward')) %>%
      mutate(events.diff = total_events_trial.2 - total_events_trial.1,
             max.deconv.diff = max.deconv_trial.2 - max.deconv_trial.1,
             deconv.95p.diff = deconv.95p_trial.2 - deconv.95p_trial.1,
             max.deconv.ratio = max.deconv_trial.2 / max.deconv_trial.1,
             deconv.95p.ratio = deconv.95p_trial.2 / deconv.95p_trial.1,
             mean.deconv.diff = mean.deconv_trial.2 - mean.deconv_trial.1,
             mean.deconv.ratio = mean.deconv_trial.2 / mean.deconv_trial.1) %>%
    as.data.table()
}

```


# Example traces for some cells
Select cells to show
```{r}
example.for.compared.change.df = compared.change.df %>%
  filter(!reactivated_inbetween, active) %>% 
  filter(animal == animal_name, day_desc == day_desc_name) %>%
  filter(trials.diff == 1) %>%
  filter(trial.denominator == 4) %>%
  left_join(first.reactivated.trial) 

example.for.compared.change.df %>% 
  filter(reactivated == TRUE) %>% 
  filter(fst.reactivated.trial >= 3) %>%
  arrange(desc(max.deconv.ratio)) %>%
  #filter(max.deconv_trial.1 > 0.5) %>%
  dplyr::select(cell_id, max.deconv_trial.1,max.deconv_trial.2, max.deconv.ratio, trial.numerator, trial.denominator)

example.for.compared.change.df %>% 
  filter(reactivated == FALSE) %>% 
  filter(fst.reactivated.trial == Inf) %>%
  arrange((max.deconv.ratio)) %>%
  filter(max.deconv_trial.1 > 1) %>%
  dplyr::select(cell_id, max.deconv_trial.1,max.deconv_trial.2, max.deconv.ratio, trial.numerator, trial.denominator)
```


```{r}
#cell_names = c(181, 30, 96, 194, # reactivated F-BL
#               175, 35, 98, 146, 308)# not reactivate F-BL
# cell_names = c(316, 161, 149, 250, # reactivated F-BL
#                261, 308, 186, 41, 98)# not reactivated F-BL
cell_names = c(108,72, 151, 157, # reactivated F-BL
               133, 98, 110) # not reactivated F-BL
               
example.traces = binned.traces[exp_title == 'trial' & cell_id %in% cell_names , ]
example.traces = example.traces[atReward | (is_running > 0), ]
find.reactivation.events(example.traces)
example.traces = cut.trace.until.reactiv(example.traces)
example.traces = example.traces[(is_running > 0) | atReactivatedReward]
#glimpse(example.traces)

trace.window.len = 25  # 10 sec window
max.deconv.windows.df = example.traces %>%
  arrange(date, animal, trial, trial_id, atReactivatedReward, cell_id, timestamp) %>%
  group_by(date, animal, trial, trial_id, atReactivatedReward, cell_id) %>%
  dplyr::summarise(max.index=which.max(deconv_trace),
                 max.timestamp=timestamp[max.index],
                 index_start = max(1, max.index - trace.window.len),
                 timestamp_start = timestamp[index_start],
                 index_end = min(n(), max.index + trace.window.len),
                 timestamp_end = timestamp[index_end],
                 max.val=max(deconv_trace),
                 has.reactivation=max(reactivation_event), 
                 .groups='drop') %>%
  as.data.table()
max.deconv.windows.df[, `:=` (exp_title = 'trial', event_id = 1, rew_at_end = atReactivatedReward) ]
example.traces[, cell_id_tmp := cell_id]

max.deconv.aligned.traces.running = example.traces[atReactivatedReward==FALSE, 
  center.timestamps.around.events(.SD, 
                                  max.deconv.windows.df[atReactivatedReward==FALSE], 'trial',
                                  padding.after.event=0),
  by=.(date, animal, exp_title, trial_id, cell_id_tmp)][aligned_event_id >= 0,]

max.deconv.aligned.traces.reactivations = example.traces[atReactivatedReward==TRUE, 
  center.timestamps.around.events(.SD, 
                                  max.deconv.windows.df[atReactivatedReward==TRUE], 'trial',
                                  padding.after.event=0),
  by=.(date, animal, exp_title, trial_id, cell_id_tmp)][aligned_event_id >= 0,] %>%
  left_join(max.deconv.windows.df[, .(date, animal, trial, cell_id, has.reactivation)], 
            by=c('date', 'animal', 'trial', 'cell_id')) 
```

```{r}
bind_rows(
  max.deconv.aligned.traces.running,
  max.deconv.aligned.traces.reactivations) %>% 
  left_join(first.reactivated.trial) %>%
  mutate(cell.reactivated = fst.reactivated.trial < Inf) %>%
  #filter(cell_id == 120, trial ==5) %>%
  filter(timestamp_from_start >= 0, timestamp_from_end <= 0, timestamp_from_start <= trace.window.len * 2 * 200) %>%
  ggplot(aes(x=timestamp_from_start / 1000, y=trace)) +
  geom_line(aes(colour=has.reactivation)) +
  facet_grid(cell.reactivated + cell_id ~ trial + atReward, scales='free_y') +
  gtheme

ggsave('~/tmp/tanjas/example_traces_E-BL_L2.svg', units = 'cm',
       width = 20, height = 9.1)
```



##Utility funs for calculating place fields
```{r}
add.meta.cols = function(df, animal, date) {
  df$animal = as.factor(rep(animal, nrow(df)))
  df$date = as.factor(rep(date, nrow(df)))
  return(df)
}


traces2pf.subset = function(subset.binned.traces, subset.name, shuffle.shift.sec = 10, nshuffles = 1000) {
    if (nrow(subset.binned.traces) == 0) {
      return(list())
    }

    subset.result = list()
    animal = subset.binned.traces$animal[1]
    date = subset.binned.traces$date[1]

    subset.result = calc.spatial.info(subset.binned.traces,
                                      generate.plots=FALSE,
                                      nshuffles=nshuffles,
                                      shuffle.shift.sec = shuffle.shift.sec,
                                      trace.var='deconv_trace',
                                      timebin.dur.msec=timebin.dur.msec,
                                      nbins=nbins,
                                      min.occupancy.sec=1,
                                      gaussian.var=2)
    subset.result$df = add.meta.cols(subset.result$df, animal, date)
    return(subset.result)
  }
```


## Process all trials
```{r}
last.days.df = test.days.df
last.days.df$date = last.days.df$date - 1

test.days.df.joined = bind_rows(
  test.days.df %>% mutate(day_ordinal_name='first'),
  #last.days.df %>% mutate(day_ordinal_name='last')
) %>%
  left_join(trials.meta.df, by=c('animal', 'date')) %>%
  left_join(mouse.meta.df) %>%
  filter(implant == 'dCA1') %>%
  filter(day_desc != 'learning3 day#3', day_desc != 'learning4 day#3') # Ignore days when only 4 trials performed

trial.change.list = list()
trial.events.list = list()
beforetest.change.list = list()
early.late.si.list = list()

for (i in 1:nrow(test.days.df.joined)) {
  caimg_result_dir = find.caimg.dir(caimg_result_dirs, test.days.df.joined$animal[i], test.days.df.joined$date[i])
  binned.traces = prepare.all.traces(caimg_result_dir, timebin.dur.msec=200, event.deconv.threshold = 0.2)
  
    # Reactivations at new reward
  all.trial.traces = binned.traces[exp_title == 'trial',]
  for (j in 1:2) {
    reactivations.at.new.rew = c(TRUE, FALSE)[j]
    trial.traces = cut.trace.until.reactiv(all.trial.traces, reactivation.at.new.rew = reactivations.at.new.rew)
    find.reactivation.events(trial.traces, reactivation.at.new.rew = reactivations.at.new.rew)
    
    trial.events.count = trial.traces[atReward | ((x>0) & (y>0) & is_running), 
                                      .(total_events = sum(nevents),
                                        total_reactivation_events = sum(reactivation_event),
                                        total_reactivation_events_at_old = sum(reactivation_event),
                                        total_events_running = max(running_cumsum_events),
                                        max.zscored.deconv = max(zscored_deconv_trace),
                                        max.deconv = max(deconv_trace),
                                        deconv.95p = quantile(deconv_trace, 0.999)[[1]],
                                        mean.zscored.deconv = mean(zscored_deconv_trace),
                                        mean.deconv = mean(deconv_trace)), 
                                       by=.(animal, date, exp_title, trial_id, trial, cell_id, atReward)]
    trial.events.count[, reactiv.at.new.rew := reactivations.at.new.rew]
    trial.events.list[[2 * (i - 1) + j]] = trial.events.count
    trial.events.list[[2 * (i - 1) + j]]$day_ordinal_name = test.days.df.joined$day_ordinal_name[i]
    
    # 0. take data for two consecutive trials
    # 1. find reactivated cells in the first trial
    # 2. merge that with both trial info
    # 3. calculate ratio over the first trial activity?
    consecutive.trial.nos = unique(trial.events.count$trial) %>% sort
    #trial.pairs = combn(consecutive.trial.nos, 2) 
    trial.pairs = matrix(c(c(1:7, 1), 
                           c(2:8, 8)), nrow=2, byrow = TRUE)
    trial.change.joined = list()
    for (pair_index in 1:dim(trial.pairs)[2]) {
      compared.trials.event.count = trial.events.count[trial %in% trial.pairs[, pair_index], ]
      if (nrow(compared.trials.event.count[trial == trial.pairs[1, pair_index]]) == 0 |
          nrow(compared.trials.event.count[trial == trial.pairs[2, pair_index]]) == 0) {
        next
      }
      trial1.reactivated.cells = make.reactivated.cells.df(compared.trials.event.count[trial == trial.pairs[1, pair_index]])
      trial.events.reactivated = compared.trials.event.count[trial1.reactivated.cells, on=.(cell_id) ]
      trial.change = calculate.ratio.between.trials(trial.events.reactivated) %>% as.data.table()
      inbetween.reactivated.cells = trial.change[FALSE, .(animal, date, cell_id, exp_title)]
      inbetween.reactivated.cells$reactivated_inbetween = logical()
      if (trial.pairs[2, pair_index] - trial.pairs[1, pair_index] > 1) {
        inbetween.reactivated.cells = make.reactivated.cells.df(
          trial.events.count[trial > trial.pairs[1, pair_index] & trial < trial.pairs[2, pair_index], ],
          all.active = TRUE)
        inbetween.reactivated.cells[, active := NULL]
        # Take max value for reactivated from the two trials
        inbetween.reactivated.cells = inbetween.reactivated.cells[, .(reactivated = as.logical(max(reactivated))), 
                                                                  by=.(animal, date, cell_id)]
        setnames(inbetween.reactivated.cells, 'reactivated', 'reactivated_inbetween')
      }
      trial.change = merge(trial.change,
                           inbetween.reactivated.cells[, .(animal, date, cell_id, reactivated_inbetween)],
                           by=c('animal', 'date', 'cell_id'), 
                           all.x = TRUE)
      if (nrow(trial.change) > 0) {
        trial.change[is.na(reactivated_inbetween), reactivated_inbetween := FALSE]
        trial.change$trial.numerator = trial.pairs[2, pair_index]
        trial.change$trial.denominator = trial.pairs[1, pair_index]
        trial.change$trials.diff = trial.pairs[2, pair_index] - trial.pairs[1, pair_index]
      }
      trial.change.joined[[pair_index]] = trial.change
    }
    trial.change.list[[2 * (i - 1) + j]] = data.table::rbindlist(trial.change.joined, fill=TRUE)
    trial.change.list[[2 * (i - 1) + j]]$day_ordinal_name = test.days.df.joined$day_ordinal_name[i]
    trial.change.list[[2 * (i - 1) + j]]$reactiv.at.new.rew = reactivations.at.new.rew
  }
  
  # Early vs late trial place fields
  half.trial = 5
  running.trial.traces = all.trial.traces[is_running > 0]
  early.pf = traces2pf.subset(running.trial.traces[trial < half.trial,], 'early', nshuffles = 1000)
  late.pf = traces2pf.subset(running.trial.traces[trial >= half.trial,], 'late')
  if (length(late.pf) > 0) {
    early.late.si.list[[i]] = bind_rows(
      early.pf$df %>% mutate(trials_group = 'early'),
      late.pf$df %>% mutate(trials_group = 'late')) 
  } else {
    early.late.si.list[[i]] = NULL
  }
    
}

all.change.from.trial1 = data.table::rbindlist(trial.change.list)
#rm(trial.change.list)
# all.change.from.beforetest = data.table::rbindlist(beforetest.change.list)
# rm(beforetest.change.list)

all.change.from.trial1 = all.change.from.trial1 %>% 
  left_join(mouse.meta.df) %>% 
  left_join(trials.meta.df)
# 
# all.change.from.beforetest = all.change.from.beforetest %>%
#   left_join(mouse.meta.df) %>%
#   left_join(trials.meta.df)


all.trial.events = data.table::rbindlist(trial.events.list)
rm(trial.events.list)
all.day.events = merge.data.table(all.trial.events, trials.meta.df)[,
                 .(reactivation_events=sum(total_reactivation_events),
                   reactivation_events_at_old=sum(total_reactivation_events_at_old),
                   trials_with_reactivation = sum(total_reactivation_events > 0),
                   events_running = sum(total_events_running)),
                 by=.(animal, date, day_ordinal_name, location_set, exp_title, cell_id, atReward, reactiv.at.new.rew)]
#trial.peaks.at.rew = as.data.table(trial.peaks.at.rew)
#reactivation.summary = all.day.events[atReward>0][trial.peaks.at.rew, on=.(animal, location_set, cell_id)]
early.late.si = data.table::rbindlist(early.late.si.list)
```


## Change in max deconv activity
```{r}
all.change.combined = bind_rows(
  all.foraging.trial1.change %>% 
    filter(trial.numerator <= 8) %>%
    mutate(group='foraging', day_ordinal_name = 'first') %>% 
    left_join(trials.meta.df),
  all.change.from.trial1 %>% mutate(group='learning'))

min.deconv.activity = 1e-5
max.trial = 8

all.change.combined = all.change.combined %>%
  arrange(trial.numerator) %>%
  ungroup() %>%
  group_by(group, reactiv.at.new.rew, implant, animal, date, exp_title, cell_id) %>%
  dplyr::mutate(fst.reactivated.trial = min(c(trial.denominator[which(reactivated)], Inf))) %>%
  #dplyr::mutate(fst.reactivated.trial = ifelse(fst.reactivated.trial <= max.trial, fst.reactivated.trial, Inf)) %>%
  dplyr::ungroup() %>%
  filter(day_ordinal_name == 'first') %>%
    filter(trials.diff <= 7, trial.numerator <= max.trial) %>%
  filter(max.deconv_trial.1 > min.deconv.activity, max.deconv_trial.2 > min.deconv.activity) %>%
  filter(deconv.95p_trial.1 > 0, deconv.95p_trial.2 > 0) %>%
  mutate(group_desc = ifelse(group == 'foraging', 'exploration', 
                             ifelse(reactiv.at.new.rew, 'learning (new reward)', 'learning (old reward)')))

all.change.combined$group = factor(all.change.combined$group, levels= c('learning', 'foraging'))
all.change.combined$group_desc = factor(all.change.combined$group_desc, 
                                        levels=c('learning (new reward)', 'learning (old reward)', 'exploration'))

sd_summary <- function(x) {
  x = x[!is.na(x)]
  m <- mean(x)
  # percentiles = quantile(x, c(0.25, 0.75))
  # ymin <- percentiles[[1]]
  # ymax <- percentiles[[2]]
  ymin = m - sd(x)
  ymax = m + sd(x)
  return(c(y=m, ymin=ymin, ymax=ymax))
}

non.reactivated.align.trial = 3
x = all.change.combined %>%
  filter(trials.diff == 1) %>%
  filter(!reactivated | trial.denominator == fst.reactivated.trial) %>% # show cells reactivated only during a single trial in absence of other reactivations
  mutate(reactivated_later = fst.reactivated.trial < Inf,
         aligned.reactiv.trial = ifelse(reactivated_later, fst.reactivated.trial, non.reactivated.align.trial),
         trial_n = trial.denominator - aligned.reactiv.trial + 1) %>%
  identity()
```


Trial-to-trial changes in the peak activity of reactivated cells equally variable as the other cells
Measured by coefficient of variation
```{r}
day.summary = all.change.combined %>%
  filter(trials.diff == 1) %>%
  mutate(reactivated_later = fst.reactivated.trial < Inf) %>%
  #filter(fst.reactivated.trial == 2 | !reactivated_later) %>% # Ensures compares equal number of trials
  #filter(trial.denominator >= 2) %>%
  group_by(animal, date, day_desc, cell_id, reactivated_later, group, group_desc) %>%
  dplyr::summarise(ntrials = n(), 
                   mean.deconv = mean(max.deconv.ratio, na.rm=TRUE), 
                   deconv.sd = sd(max.deconv.ratio, na.rm = TRUE),
                   var.coef = deconv.sd / mean.deconv,
                   .groups='drop') 
day.summary %>% 
  ggplot(aes(x=reactivated_later, y=var.coef)) +
  geom_violin(draw_quantiles = 0.5) +
  #scale_y_log10(limits=c(0.1, 2)) +
  facet_grid(. ~ group_desc)
```


Reactivation at new vs old reward
```{r}
x.reactivated.location = all.change.combined %>%
  filter(trials.diff == 1) %>%
  filter(group == 'learning') %>% 
  dplyr::select(animal, date, day_desc, trial.denominator , cell_id, reactivated, total_reactivations_at_reward_trial.1, reactiv.at.new.rew ) %>%
  pivot_wider(id_cols = c(animal, date, day_desc, cell_id, trial.denominator ),
              names_from=reactiv.at.new.rew,
              names_prefix='new.rew.reactivation.',
              values_from='reactivated')
  #glimpse
x.reactivated.location %>%
  filter(!is.na(new.rew.reactivation.TRUE), !is.na(new.rew.reactivation.FALSE)) %>%
  dplyr::summarise(ncells = n(), 
                   new = mean(new.rew.reactivation.TRUE),
                   previous = mean(new.rew.reactivation.FALSE),
                   both = mean(new.rew.reactivation.TRUE & new.rew.reactivation.FALSE),
                   neither = mean(!new.rew.reactivation.TRUE & !new.rew.reactivation.FALSE)) %>%
  pivot_longer(cols=c(new, previous, both, neither)) %>%
  ggplot(aes(y=name, x=value)) +
  geom_col(fill='transparent', color='#555555') +
  gtheme +
  scale_x_continuous(labels = scales::percent) +
  #scale_y_discrete(labels=c('old', 'new', 'neither', 'both')) +
  labs(x='', y='', title='Percent of cells reactivated during single-trial at either reward location')
ggsave('~/tmp/tanjas/reactivated_cells.svg', units = 'cm',
       width = 6, height = 4.5)
```


## Higher activity peaks in the first trial after reactivation for cells reactivated at the new location
```{r}
compared.var = quo(max.deconv.ratio)
#compared.var = quo(mean.deconv.ratio)

x.fst.trial = filter(x, trial_n == 1) %>%
  left_join(x.reactivated.location) %>%
  replace_na(list(new.rew.reactivation.TRUE=FALSE, new.rew.reactivation.FALSE=FALSE)) %>%
  filter(!(new.rew.reactivation.TRUE & new.rew.reactivation.FALSE)) %>% # cells not reactivated at both the old and new location
  identity()
x.fst.trial$group_desc = factor(x.fst.trial$group_desc, 
                                levels=c('learning (new reward)', 'learning (old reward)', 'exploration'))
x.fst.trial$reactivated = as.factor(x.fst.trial$reactivated)
x.fst.trial.summary = group_by(x.fst.trial, group, group_desc, reactivated_later, trial_n) %>%
  dplyr::summarise(as_tibble(t(sd_summary(log(!!compared.var))) %>% exp) , .groups='drop')
x.fst.trial.summary$group = factor(x.fst.trial.summary$group, levels= c('learning', 'foraging'))

x.fst.trial %>%
  ggplot(aes(x=reactivated_later, y=!!compared.var)) +
  geom_jitter(aes(colour=reactivated_later), width=0.3, height=0, shape=1, 
              alpha=0.25, size=0.2) +
  geom_pointrange(data=x.fst.trial.summary, mapping=aes(y=y, ymin=ymin, ymax=ymax),
                  size=0.5, shape=1, colour='#444444', alpha=0.5) +
  scale_color_manual(values=reactiv.colours) +
  scale_y_log10(limit=c(0.05, 9.0), breaks=c(0.1, 0.2, 0.4, 0.6, 1.0, 2.0, 4.0, 8.0)) +
  facet_grid(. ~ group_desc) +
  gtheme.light.panel +
  theme(axis.text.x = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank())
ggsave('~/tmp/tanjas/next_trial_change.svg', units = 'cm',
       width = 8, height = 5.3)
```

```{r}
t.test.exp.change = function(t.res.vals, digits=0) {
  format(100 - exp(t.res.vals) * 100, digits=digits)
}


# Increase in activtit 
m.deconv.ratio = lmer.test.print(x.fst.trial %>% 
                  mutate(#val=log(deconv.95p.ratio)),
                         val = log(0.0 + max.deconv.ratio)) %>%
                    filter(val < Inf, !is.na(val)),
                var = val,
                fixed.effects = reactivated * group_desc,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
t.res.deconv.ratio = lsmeansLT(m.deconv.ratio, pairwise = TRUE)
t.res.deconv.ratio[c(5, 14, 19),]

str_c(attributes(t.res.deconv.ratio)$row.names, 
      t.test.exp.change(t.res.deconv.ratio$Estimate), '% ', 
      'CI=[',
      t.test.exp.change(t.res.deconv.ratio$upper),  ', ',
      t.test.exp.change(t.res.deconv.ratio$lower),  ']',
      sep=' ')[c(5, 14, 19)]

# Increase in mean activity ratio
m.mean.ratio = lmer.test.print(x.fst.trial %>% 
                  mutate(val = log(0.1 + mean.deconv.ratio)) %>%
                    filter(val < Inf, !is.na(val)),
                var = val,
                fixed.effects = reactivated * group_desc,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
t.res.mean.ratio = lsmeansLT(m.mean.ratio, pairwise = TRUE)
t.res.mean.ratio[c(5, 14, 19),]
```


Persistent increase of activity peaks for reactivated cells
```{r}
x.compared = x %>%
  filter( group_desc == 'learning (new reward)') %>%
  #filter(!reactivated_later | fst.reactivated.trial >= 3) %>%
  identity()

x.summary = group_by(x.compared, group, group_desc, reactivated_later, trial_n) %>%
  dplyr::summarise(as_tibble(t(sd_summary(log(!!compared.var))) %>% exp) , .groups='drop') %>%
  identity()
#x.summary$group = factor(x.summary$group, levels= c('learning', 'foraging'))

x.compared %>%
  ggplot(aes(x=trial_n-0.2 + reactivated_later * 0.4, 
             y=!!compared.var, 
             group=reactivated_later)) +
  geom_jitter(aes(colour=reactivated_later), width=0.1, height=0, shape=1, 
              alpha=0.25, size=0.2) +
  geom_pointrange(data = x.summary, 
                  mapping = aes(y=y, ymin=ymin, ymax=ymax),
                  size=0.5, shape=1, colour='#444444', alpha=0.5) +
  #ylim(c(0.1, 10)) +
  #coord_trans(y='log10') +
  scale_y_log10(limit=c(0.1, 6.0), breaks=c(0.2, 0.4, 0.6, 1.0, 2.0, 4.0)) +
  scale_x_continuous(breaks=-1:5, limit=c(-1.5, 5.5)) +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(group_desc ~ .) +
  gtheme.light.panel +
  xlab('Trial from the first reactivation') + ylab('Activity peak relative to the preceeding trial') +
  ggtitle('Trial-to-trial change in activity peak')
ggsave('~/tmp/tanjas/trial2trial_change_epsp_like.svg', units = 'cm',
       width = 12, height = 5.3)
```



## Stats for persistent change in max deconv activity (trial_n > 1)
```{r}
x.compared$reactivated_later = as.factor(x.compared$reactivated_later)
m.deconv.ratio.persistent = lmer.test.print(x.compared %>% 
                  mutate(val=log(0.0 + max.deconv.ratio)) %>%
                    filter(trial_n > 1, trial_n <= 5),
                var = val,
                fixed.effects = reactivated_later,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
t.res = lsmeansLT(m.deconv.ratio.persistent, pairwise=TRUE) 
t.res

str_c(attributes(t.res)$row.names, 
      t.test.exp.change(t.res$Estimate), '% ', 
      'CI=[',
      t.test.exp.change(t.res$upper),  ', ',
      t.test.exp.change(t.res$lower),  ']',
      sep=' ')


# Reactivated cells already more active
lmer.test.print(x.compared %>% 
                  mutate(val=log(0.0 + max.deconv.ratio)) %>%
                    filter(trial_n == -1),
                var = val,
                fixed.effects = reactivated_later,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```

## Correlation between reactivations and max deonv ratio
```{r}
reactivations.activity.change.joined = filter(compared.change.df, trials.diff == 7) %>%
  left_join(bind_rows(filter(all.day.events, atReward > 0), 
                      filter(summary.foraging.trial1.events, atReward > 0)) %>% 
              dplyr::select(animal, date, cell_id, trials_with_reactivation, reactivation_events,), 
            by=c('animal', 'date', 'cell_id'))

reactivations.activity.change.joined %>%
  #filter(group == 'learning') %>%
  filter(reactivation_events > 0) %>%
  ggplot(aes(y=max.deconv.ratio, #deconv.95p.ratio, 
             x=trials_with_reactivation)) +
             #x=reactivation_events)) +
  geom_hline(yintercept = 1.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, alpha=0.4, size=0.4, colour=reactiv.colours[2], width=0.3, height=0.0) +
  stat_smooth(method='lm', colour='#999999') +
  #scale_y_log10() +
  scale_y_log10(limits=c(0.02,10)) +
  #scale_x_log10() +
  facet_grid(.~ group) +
  gtheme.light.panel +
  xlab('#Trials when reactivated') + ylab('Relative activity peak')

ggsave('~/tmp/tanjas/trial8to1activity_change_trials_with_reactivation_cors.svg', units = 'cm',
       width=9, #width = 8, 
       height = 5.1)


# m.reactiv.cors = lmer.test.print(reactivations.activity.change.joined %>%
#                   mutate(val=log(1 + deconv.95p.ratio)) %>%
#                   filter(val > 0 & val < Inf),
#                 var=val,
#                 fixed.effects = trials_with_reactivation * group,
#                 #fixed.effects = reactivation_events * group,
#                 randef.str = '(1 + day_desc | animal)',
#                 diagnostics.groupvar = animal)
# # 
# m.reactiv.cors = lmer.test.print(reactivations.activity.change.joined %>%
#                   mutate(val=log(1 + deconv.95p.ratio)) %>%
#                   filter(val > 0 & val < Inf, reactivation_events > 0),
#                 var=val,
#                 fixed.effects = log(reactivation_events) * group,
#                 #fixed.effects = reactivation_events * group,
#                 randef.str = '(1 + day_desc | animal)',
#                 diagnostics.groupvar = animal)

m.reactiv.cors = lmer.test.print(reactivations.activity.change.joined %>%
                  #mutate(val=log(deconv.95p.ratio)) %>%
                    mutate(val=log(0.0 + max.deconv.ratio)) %>%
                  filter(group=='learning',
                         reactivation_events > 0),
                var=val,
                #fixed.effects = log(reactivation_events),
                fixed.effects = trials_with_reactivation,
                #randef.str = '(1 | animal)',
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```

Reactivations in a single trial vs increase just after
```{r}
subsequent.reactivations.activity.change.joined = filter(compared.change.df, trials.diff == 1) %>%
  left_join(bind_rows(filter(all.day.events, atReward > 0), 
                      filter(summary.foraging.trial1.events, atReward > 0)) %>% 
              dplyr::select(animal, date, cell_id, trials_with_reactivation, reactivation_events,), 
            by=c('animal', 'date', 'cell_id'))

subsequent.reactivations.activity.change.joined %>%
  filter(total_reactivations_at_reward_trial.1 > 0) %>%
  #filter(trials.diff==1) %>%
  filter(total_reactivations_at_reward_trial.1 <= 8) %>%
  ggplot(aes(x=total_reactivations_at_reward_trial.1, 
             y=max.deconv.ratio)) +
  geom_jitter(shape=1, size=0.5, alpha=0.3, width=0.2, height=0, color=reactiv.colours[2]) +
  stat_smooth(method='lm', color='#999999') +
  scale_y_log10(limits=c(0.02, 10)) +
  #scale_x_log10() +
  facet_grid(. ~ group) +
  xlab('Reactivations during trial n') + ylab('Relative activity peak in trial n+1') +
  gtheme.light.panel

ggsave('~/tmp/tanjas/trial8to1activity_next_trials_change_with_reactivation_cors.svg', units = 'cm',
       width=9, #width = 8, 
       height = 5.8)

m.reactiv.cors = lmer.test.print(subsequent.reactivations.activity.change.joined %>%
                  mutate(val=log(0.0+max.deconv.ratio)) %>%
                    filter(group == 'learning') %>%
                    filter(total_reactivations_at_reward_trial.1 <= 8) %>%
                    mutate(total_reactivations_at_reward_trial1_multiple = total_reactivations_at_reward_trial.1 > 1) %>%
                  filter(val > 0 & val < Inf, total_reactivations_at_reward_trial.1 > 0),
                var=val,
                fixed.effects = total_reactivations_at_reward_trial.1,
                #fixed.effects = total_reactivations_at_reward_trial1_multiple,
                #fixed.effects = reactivation_events,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```

## Correlation with performance
```{r}
library(readr)
df = read.csv(file.path('/mnt/DATA/Prez/cheeseboard', 'trial_stats.csv'))
df$date = as.Date(df$date)

d = filter(df, exp_title == 'trial') %>%
  mutate(logdist = log(total_dist*perc2dist/100))
d.day = d %>%
  group_by(animal, date, exp, exp_title, day_ordinal, day_desc) %>%
  dplyr::summarise(mean.logdist = mean(logdist))
glimpse(d.day)
```


```{r}
library(plotly)
# Performance: day-mean of log(distance)
#Effect sizes per mouse calculated as 
# 1) diff between peak activity ratios in the reactivated vs non-reactivated cells

day.reactivated.effect.deconv.ratio = reactivations.activity.change.joined %>%
    #filter(!reactivated_inbetween) %>%
  filter(group == 'learning') %>%
  #filter(date != '2020-10-18' | animal != 'M-BR' ) %>%
  group_by(exp_title, date, animal, day_desc, reactivated) %>%
  dplyr::summarise(mean.deconv.ratio = mean(max.deconv.ratio), ncells=n()) %>% 
  pivot_wider(id_cols=c('exp_title', 'date', 'animal', 'day_desc'),
              values_from = 'mean.deconv.ratio', 
              names_from='reactivated', names_prefix='reactivated_') %>% 
  mutate(deconv.ratio.diff = reactivated_TRUE - reactivated_FALSE) %>% 
  filter(!is.na(deconv.ratio.diff))

lmer.test.print(left_join(day.reactivated.effect.deconv.ratio, d.day),
                var=deconv.ratio.diff,
                fixed.effects = mean.logdist,
                randef.str = '(1 | animal)',
                diagnostics.groupvar = animal)

cor.test(~ mean.logdist + deconv.ratio.diff, 
         data=left_join(day.reactivated.effect.deconv.ratio, d.day),
         method='spearman')

left_join(day.reactivated.effect.deconv.ratio, d.day) %>% 
  ggplot(aes(x=-mean.logdist, y=deconv.ratio.diff,#)) +
             text=paste(animal, day_desc))) +
  geom_point() +
  geom_hline(yintercept = 0, linetype='dashed', color='#333333') +
  stat_smooth(method='lm', colour='#444444') +
  xlab('Trial performance (-log mean run distance (m))') +
  ylab('Relative peak activity difference') +
  gtheme
ggsave('~/tmp/tanjas/relative_peak_cor_with_performance.svg', units = 'cm',
       width=8, height = 5.8)
ggplotly()


trial.reactivated.effect.deconv.ratio = subsequent.reactivations.activity.change.joined %>%
    #filter(!reactivated_inbetween) %>%
  filter(group == 'learning') %>%
  group_by(exp_title, date, animal, day_desc, trial.numerator, reactivated) %>%
  dplyr::summarise(mean.deconv.ratio = mean(max.deconv.ratio), 
                   ncells=n(), 
                   mean.reactivations = mean(total_reactivations_at_reward_trial.1))%>% 
  pivot_wider(id_cols=c('exp_title', 'date', 'animal', 'day_desc', 'trial.numerator'),
              values_from = 'mean.deconv.ratio', 
              #values_from = 'mean.reactivations',
              names_from='reactivated', names_prefix='reactivated_') %>% 
  mutate(deconv.ratio.diff = reactivated_TRUE - reactivated_FALSE) %>% 
  filter(!is.na(deconv.ratio.diff))

left_join(trial.reactivated.effect.deconv.ratio %>% mutate(trial_n=trial.numerator), d) %>% 
  filter(-logdist > -2.5) %>%
  ggplot(aes(x=-logdist, y=deconv.ratio.diff)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype='dashed', color='#333333') +
  stat_smooth(method='lm', colour='#444444') +
  xlab('Trial performance (-log run distance (m))') +
  ylab('Relative peak activity difference') +
  gtheme

ggsave('~/tmp/tanjas/next_trial_performance.svg', units = 'cm',
       width=9, #width = 8, 
       height = 5.8)

lmer.test.print(left_join(trial.reactivated.effect.deconv.ratio %>% mutate(trial_n=trial.numerator), d),
                fixed.effects = logdist,
                var = deconv.ratio.diff,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)

# # Performance on trial 8
# g = left_join(day.reactivated.effect.deconv.ratio, filter(d, trial_n==8)) %>%
#   ggplot(aes(x=log(total_dist*perc2dist/100), y=deconv.ratio.diff, text=paste(animal, day_desc))) +
#   geom_point() +
#   geom_hline(yintercept = 0, linetype='dashed', color='#333333') +
#   #stat_smooth(method='lm') +
#   gtheme
# ggplotly(g)
# 
# lmer.test.print(left_join(day.reactivated.effect.deconv.ratio, filter(d, trial_n==8)),
#                 var=deconv.ratio.diff,
#                 fixed.effects = log(total_dist*perc2dist/100),
#                 randef.str = '(1 | animal)',
#                 diagnostics.groupvar = animal)

#Performance on the following trial
# 1) As the function of change in the peak activity

# 2) Number of reactivations
# 3) Fraction of reactivated cells?


```


## Correlation between activation and place cell stats
```{r}
reactivation.summary %>% 
  filter(day_ordinal_name == 'first') %>%
  filter(signif.si) %>%
  ggplot(aes(x=trials_with_reactivation, y=early.late.cor)) +
  geom_jitter(shape=1, alpha=0.5, height = 0, width=0.2) +
  facet_grid(. ~ implant) +
  #facet_wrap(. ~ animal) +
  geom_smooth(method='lm') +
  geom_hline(yintercept = 0, linetype='dashed') + 
  xlab('# trials when cell reactivated') +
  ylab('Early-late trials correlation')

reactivation.summary %>% 
  filter(day_ordinal_name == 'first') %>%
  filter(signif.si) %>%
  ggplot(aes(x=trials_with_reactivation, y=spatial.information)) +
  geom_jitter(shape=1, alpha=0.5, height = 0, width=0.2) +
  facet_grid(. ~ implant) +
  #facet_wrap(. ~ animal) +
  geom_smooth(method='lm') +
  geom_hline(yintercept = 0, linetype='dashed') + 
  xlab('# trials when cell reactivated') +
  ylab('Spatial information')
```

TODO: restrict to only cells that were sigificant in the trials after reactivations?
```{r}
lmer.test.print(reactivation.summary %>% 
                  filter(implant=='dCA1', !is.na(early.late.cor), !is.na(trials_with_reactivation)),
                var = early.late.cor,
                fixed.effects = trials_with_reactivation,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)

lmer.test.print(reactivation.summary %>% 
                  filter(implant=='dCA1', !is.na(trials_with_reactivation)),
                var = spatial.information,
                fixed.effects = trials_with_reactivation,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```


# Reactivation of reward cells on last day of learning
```{r}
# trial.events.list = list()
# #last.days.df = trials.meta.df %>%
# #  filter(day_ordinal == 1, location_set > 0)
# last.days.df = test.days.df
# last.days.df$date = last.days.df$date - 1
# 
# for (i in 1:nrow(last.days.df)) {
#   caimg_result_dir = find.caimg.dir(caimg_result_dirs, last.days.df$animal[i], last.days.df$date[i])
#   binned.traces = prepare.all.traces(caimg_result_dir, timebin.dur.msec=200, event.deconv.threshold = 0.2)
#   binned.traces[, atReward := pmin((atReward0 >= 0.5) + (atReward1 >= 0.5), 1)]
#   trial.traces = binned.traces[exp_title == 'trial',] 
#   find.reactivation.events(trial.traces, reactivation.at.new.rew=FALSE)
#   
#   trial.events.count = trial.traces[atReward | ((x>0) & (y>0) & is_running), 
#                                   .(total_events = sum(nevents),
#                                     total_reactivation_events = sum(reactivation_event),
#                                     total_events_running = max(running_cumsum_events),
#                                     max.deconv = max(zscored_deconv_trace),
#                                     mean.deconv = mean(zscored_deconv_trace)), 
#                                    by=.(animal, date, exp_title, trial, trial_id, cell_id, atReward)]
#   trial.events.list[[i]] = trial.events.count
# }
# 
# all.trial.events = data.table::rbindlist(trial.events.list)
# rm(trial.events.list)
# #all.trial.events = all.trial.events[as.data.table(trials.meta.df)[exp=='learning', .(animal, date, location_set, day_desc)],
# #                                    on=.(animal, date)]
# all.trial.events = merge.data.table(all.trial.events, trials.meta.df, by=c('animal', 'date'))
```

```{r}
# reactivation.summary %>%
#   filter(signif.si) %>%
#   filter(implant == 'dCA1') %>%
#   filter(day_ordinal_name == 'last') %>%
#   ggplot(aes(x=trials_with_reactivation, y=min.rew.dist)) +
#   geom_violin(aes(group=trials_with_reactivation), 
#               fill='transparent', colour='#333333', draw_quantiles=0.5) +
#   #geom_smooth(method='lm') + 
#   facet_grid(. ~ implant) +
#   xlab('#trials cell reactivated') + ylab('Place field distance to reward')
```

```{r}
# lmer.test.print(reactivation.summary %>% filter(implant == 'dCA1', signif.si, 
#                                                 day_ordinal_name == 'last',
#                                                 !is.na(trials_with_reactivation),
#                                                 !is.na(min.rew.dist)),
#                 var = min.rew.dist,
#                 fixed.effects = trials_with_reactivation,
#                 randef.str = '(1 + day_desc | animal)',
#                 diagnostics.groupvar = animal)
```


#Controls during foraging


Foraging reactivations?
search for immobility periods of duration Xsec.
```{r}

last.day.habit.df = trials.meta.df %>% 
  filter(day_desc == 'habituation day#3') %>%
  left_join(mouse.meta.df) %>%
  filter(implant == 'dCA1') %>%
  filter(animal != 'C-1R', animal != 'P-BR')

foraging.trial.events.list = list()
foraging.trial1.events.list = list()
foraging.trial1.change.list = list()
foraging.trial1.pcs.list = list()
foraging.early.late.si.list = list()

for (i in 1:nrow(last.day.habit.df)) {
  caimg_result_dir = find.caimg.dir(habit_caimg_dirs, last.day.habit.df$animal[i], last.day.habit.df$date[i])
  binned.traces = prepare.all.traces(caimg_result_dir, timebin.dur.msec=200, event.deconv.threshold = 0.2)
  binned.traces = binned.traces[exp_title == 'trial']
  binned.traces[, atReward := pmin((atReward0 >= 0.5) + (atReward1 >= 0.5), 1)]
  behav.traces = binned.traces[cell_id == binned.traces$cell_id[1],] 
  immobility.bouts = group_by(behav.traces, date, animal, exp_title, trial, trial_id) %>%
    dplyr::summarise(mobility.bouts.tibble(timestamp, -as.vector(smooth_velocity), atReward, 
                                           smooth_velocity,
                                           atReward,
                                           mobility.threshold = -3.0,
                                           window.len = ceiling(2000/timebin.dur.msec),
                                           min.bout.len=2000/timebin.dur.msec),
                     .groups='drop') %>%
    as.data.table()

  immobility.aligned.traces = binned.traces[, 
                                            center.timestamps.around.events(.SD, immobility.bouts, 'trial',
                                                                        padding.after.event=0),
                                      by=.(date, animal, exp_title, trial_id, cell_id)][aligned_event_id >= 0,]
  immobility.aligned.traces[, immobile := timestamp_from_start >=0 ]
  find.reactivation.during.immobility(immobility.aligned.traces)
  
  immobile.or.running.traces = immobility.aligned.traces[immobile | ((x>0) & (y>0) & is_running), ]
  immobile.or.running.traces[, trial_minute := floor(timestamp / 1000 / 60)]
  trial.events.count = immobile.or.running.traces[, 
                                  .(total_events = sum(nevents),
                                    total_reactivation_events = sum(reactivation_event),
                                    total_events_running = max(running_cumsum_events),
                                    max.deconv = max(zscored_deconv_trace),
                                    mean.deconv = mean(zscored_deconv_trace)), 
                                   by=.(animal, date, exp_title, trial, trial_id, cell_id, immobile)]
  foraging.trial.events.list[[i]] = trial.events.count
  
  trial1.events.count = immobile.or.running.traces[trial == 1,
                                .(total_events = sum(nevents),
                                  total_reactivation_events = sum(reactivation_event),
                                  total_events_running = max(running_cumsum_events),
                                  max.deconv = max(zscored_deconv_trace),
                                  deconv.95p = quantile(deconv_trace, 0.999)[[1]],
                                  mean.deconv = mean(zscored_deconv_trace)), 
                                  by=.(animal, date, exp_title, trial_minute, cell_id, immobile)]
  
  # Workaround to make the code converge with calculation for trials
  trial1.events.count[, atReward := immobile]
  trial.events.count[, atReward := immobile]
  
  # 0. take data for two consecutive trials
  # 1. find reactivated cells in the first trial
  # 2. merge that with both trial info
  # 3. calculate ratio over the first trial activity?
  consecutive.minutes = seq(trial1.events.count[, max(trial_minute)])
  trial.pairs = combn(consecutive.minutes, 2)
  trial.change.joined = list()
  for (pair_index in 1:dim(trial.pairs)[2]) {
    compared.trials.event.count = trial1.events.count[trial_minute %in% trial.pairs[, pair_index], ]
    
    trial1.reactivated.cells = make.reactivated.cells.df(trial1.events.count[trial_minute == trial.pairs[1, pair_index]])
    trial.events.reactivated = compared.trials.event.count[trial1.reactivated.cells, on=.(cell_id) ]
    trial.events.reactivated[, trial := trial_minute]
    trial.change = calculate.ratio.between.trials(trial.events.reactivated) 
    if (nrow(trial.change) > 0) {
      inbetween.reactivated.cells = trial.change[FALSE, .(animal, date, cell_id, exp_title)]
      inbetween.reactivated.cells$reactivated_inbetween = logical()
    }
    if (trial.pairs[2, pair_index] - trial.pairs[1, pair_index] > 1) {
      inbetween.reactivated.cells = make.reactivated.cells.df(
        trial.events.count[trial > trial.pairs[1, pair_index] & trial < trial.pairs[2, pair_index], ],
        all.active = TRUE)
      inbetween.reactivated.cells[, active := NULL]
      # Take max value for reactivated from the two trials
      inbetween.reactivated.cells = inbetween.reactivated.cells[, .(reactivated = as.logical(max(reactivated))), 
                                                                by=.(animal, date, cell_id)]
      setnames(inbetween.reactivated.cells, 'reactivated', 'reactivated_inbetween')
    }
    if (nrow(trial.change) > 0) {
      trial.change = merge(trial.change,
                         inbetween.reactivated.cells[, .(animal, date, cell_id, reactivated_inbetween)],
                         by=c('animal', 'date', 'cell_id'), 
                         all.x = TRUE)
      trial.change[is.na(reactivated_inbetween), reactivated_inbetween := FALSE]
      trial.change$trial.numerator = trial.pairs[2, pair_index]
      trial.change$trial.denominator = trial.pairs[1, pair_index]
      trial.change$trials.diff = trial.pairs[2, pair_index] - trial.pairs[1, pair_index]
    }
    trial.change.joined[[pair_index]] = trial.change
  }

  foraging.trial1.change.list[[i]] = data.table::rbindlist(trial.change.joined, fill=TRUE)
  foraging.trial1.change.list[[i]]$day_ordinal_name = 'last'
  
  foraging.trial1.events.list[[i]] = trial1.events.count
  half.minute = 4
  running.trial.traces = immobile.or.running.traces[trial == 1 & is_running > 0]
  early.pf = traces2pf.subset(running.trial.traces[trial_minute < half.minute,], 'early', nshuffles = 1000)
  late.pf = traces2pf.subset(running.trial.traces[trial_minute >= half.minute & trial_minute < 2 * half.minute,], 'late')
  foraging.early.late.si.list[[i]] = bind_rows(
    early.pf$df %>% mutate(trials_group = 'early'),
    late.pf$df %>% mutate(trials_group = 'late'))
}

all.foraging.trial.events = data.table::rbindlist(foraging.trial.events.list)
all.foraging.trial.events = all.foraging.trial.events[as.data.table(trials.meta.df)[exp=='habituation', .(animal, date, day_desc)],
                                    on=.(animal, date)]
all.foraging.trial1.events = data.table::rbindlist(foraging.trial1.events.list)
all.foraging.trial1.change = data.table::rbindlist(foraging.trial1.change.list)
foraging.early.late.si = data.table::rbindlist(foraging.early.late.si.list)
```

```{r}
data.table::setorder(all.foraging.trial.events, animal, date, day_desc, cell_id, trial)
all.foraging.trial.events[, reactivated := total_reactivation_events > 0]
all.foraging.day.events = all.foraging.trial.events[,
                 .(reactivation_events=sum(total_reactivation_events),
                   trials_with_reactivation = sum(total_reactivation_events > 0),
                   events_running = sum(total_events_running),
                   fst.reactivated.trial = min(c(which(reactivated), Inf))),
                 by=.(animal, date, day_desc, exp_title, cell_id, immobile)]
all.foraging.day.events[, exp := 'habituation']

all.foraging.trial1.events[, reactivated := total_reactivation_events > 0]
summary.foraging.trial1.events = all.foraging.trial1.events[trial_minute < 8,
                 .(reactivation_events=sum(total_reactivation_events),
                   trials_with_reactivation = sum(total_reactivation_events > 0),
                   events_running = sum(total_events_running),
                   fst.reactivated.trial = min(c(which(reactivated), Inf))),
                 by=.(animal, date, cell_id, atReward)]
summary.foraging.trial1.events[, exp := 'habituation']
```

```{r}
place.cell.db = as.data.table(place.cell.db)
habit.pcs.info = all.foraging.day.events %>%
  #filter(day_desc == 'habituation day#3') %>%
  left_join(place.cell.db) %>%
  filter(signif.si) %>%
  dplyr::select(exp, date, animal, implant, day_desc, cell_id, 
                spatial.information, early.late.cor, 
                field.max, field.mean, trace.mean,
                trials_with_reactivation)

learning.pcs.info = reactivation.summary %>%
  left_join(mouse.meta.df) %>%
  filter(day_ordinal_name == 'first') %>%
  filter(signif.si) %>%
  mutate(exp = 'learning') %>%
  dplyr::select(exp, date, animal, implant, day_desc, cell_id, 
                spatial.information, early.late.cor, 
                field.max, field.mean, trace.mean, 
                trials_with_reactivation)

all.pcs.info = bind_rows(habit.pcs.info, learning.pcs.info) %>%
  mutate(field.max.ratio = field.max / trace.mean,
         field.mean.ratio = field.mean / trace.mean)

g2 = all.pcs.info %>%
  filter(implant == 'dCA1') %>%
  ggplot(aes(x=trials_with_reactivation, y=field.max)) +
  geom_violin(aes(group=trials_with_reactivation), 
              fill='transparent', colour='#333333', draw_quantiles=0.5) +
  #geom_smooth(method='lm') + 
  facet_wrap(implant ~ exp) +
  xlab('#trials cell reactivated') + ylab('Place field peak')

g1 = all.pcs.info %>%
  filter(implant == 'dCA1') %>%
  ggplot(aes(x=trials_with_reactivation, y=spatial.information)) +
  geom_violin(aes(group=trials_with_reactivation), 
              fill='transparent', colour='#333333', draw_quantiles=0.5) +
  #geom_smooth(method='lm') + 
  facet_wrap(implant ~ exp) +
  xlab('#trials cell reactivated') + ylab('Spatial information')

plot_grid(g1, g2)
```

```{r}
# all.pcs.info$exp = as.factor(all.pcs.info$exp)
# m.si = lmer.test.print(
#   all.pcs.info %>% filter(implant == 'dCA1', !is.na(spatial.information), !is.na(trials_with_reactivation)),
#   var = spatial.information,
#   fixed.effects = trials_with_reactivation * exp,
#   randef.str = '(1 + day_desc | animal)',
#   diagnostics.groupvar = animal)
# #lsmeansLT(m.si)
```

```{r}
# m.field.max = lmer.test.print(all.pcs.info %>% 
#                   filter(implant == 'dCA1', !is.na(field.max),  !is.na(trials_with_reactivation)) %>%
#                   mutate(val=log(0.01+field.max)),
#                 var = val,
#                 fixed.effects = trials_with_reactivation * exp,
#                 randef.str = '(1 + day_desc | animal)',
#                 diagnostics.groupvar = animal)
```

Early vs late metrics of the cells depending if the cell was reactivated during trial 4.
use spatial.info after subtracting random shuffles mean
```{r}
first.reactivated.trial = all.change.from.trial1 %>%
  filter(trials.diff == 1) %>%
  group_by(animal, date, day_desc, day_ordinal_name, cell_id) %>%
  arrange(trial.denominator) %>%
  dplyr::summarise(fst.reactivated.trial = min(c(which(reactivated), Inf)),
                   active = max(active),
                   .groups='drop') %>%
  left_join(place.cell.db[, .(animal, date, day_desc, cell_id, signif.si, early.late.cor)]) %>%
  filter(signif.si) %>%
  mutate(exp='learning')

first.reactivated.habit.minute = all.foraging.trial1.events %>%
  #mutate(reactivated = total_reactivation_events > 0) %>%
  group_by(animal, date, cell_id) %>%
  dplyr::summarise(active=max(total_events) > 0,
                   fst.reactivated.trial=min(c(which(reactivated), Inf)),
                   .groups ='drop') %>%
  left_join(place.cell.db[, .(animal, date, day_desc, cell_id, signif.si, early.late.cor)])  %>%
  filter(signif.si) %>%
  identity()


foraging.early.late.si$date = as.Date(foraging.early.late.si$date)
compared.early.late.df.habit = foraging.early.late.si %>% 
  mutate(exp='habituation') %>%
  dplyr::select(-signif.si) %>%
  left_join(first.reactivated.habit.minute) 

# Few cells not reactivated during habituation!
filter(compared.early.late.df.habit, signif.si) %>% count(fst.reactivated.trial)

early.late.si$date = as.Date(early.late.si$date)
compared.early.late.df.trials = early.late.si %>%
  mutate(exp='learning') %>%
  dplyr::select(-signif.si) %>%
  left_join(first.reactivated.trial) %>%
  filter(day_ordinal_name == 'first') %>%
  identity()
#early.trials.si$date = as.Date(early.trials.si$date)
#late.trials.si$date = as.Date(late.trials.si$date)
# compared.early.late.df.trials = bind_rows(
#   early.trials.si %>% mutate(trials_group='early'),
#   late.trials.si %>% mutate(trials_group='late')) %>%
#   left_join(mouse.meta.df) %>%
#   #left_join(mutate(trials.meta.df, date=as.Date(date) )) %>%
#   #filter(exp == 'learning') %>%
#   filter(implant == 'dCA1') %>%
#   filter(as.character(date) %in% as.character(unique(first.reactivated.trial$date))) %>%
#   mutate(exp='learning') %>%
#   dplyr::select(-signif.si) %>%
#   left_join(first.reactivated.trial) %>%
#   filter(day_ordinal_name == 'first') 

compared.early.late.pc.df = bind_rows(compared.early.late.df.habit, compared.early.late.df.trials) %>%
  filter(fst.reactivated.trial >= 4) %>%
  mutate(reactivated = fst.reactivated.trial < 2 * half.minute,
         spatial.info.corrected = spatial.information - si.shuffle.mean) %>%
  #filter(signif.si) %>%
  filter(!is.na(reactivated)) %>% # filter rows on last and first day of learning
  filter(active > 0)

compared.early.late.pc.df = compared.early.late.pc.df %>%
  dplyr::group_by(exp, animal, date, day_desc, day_ordinal_name, trials_group)  %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist)

compared.early.late.pc.wide = pivot_wider(
      compared.early.late.pc.df, 
      id_cols=c('animal', 'exp', 'date', 'day_desc', 'day_ordinal_name', 'cell_id', 'active', 'reactivated', 'early.late.cor'),
      names_from=trials_group,
      values_from=c('field.max', 'spatial.info.corrected', 'trace.mean', 'signif.si','field.max.x', 'field.max.y', 'min.rew.dist')) %>%
      mutate(field.max.diff = field.max_late - field.max_early,
             field.max.ratio = field.max_late / field.max_early,
             spatial.info.corrected.diff = spatial.info.corrected_late - spatial.info.corrected_early,
             min.rew.dist.diff = min.rew.dist_late - min.rew.dist_early,
             trace.mean.ratio = trace.mean_late / trace.mean_early,
             field.shift.distance.cm = perc2dist * norm2(field.max.x_late - field.max.x_early, 
                                                         field.max.y_late - field.max.y_early))
```


Cumulative cells reactivated by trial
```{r}
fst.reactivated.trial_index_nos = c(1:7, Inf)
first.reactivated.trial %>%
  mutate(first.reactivated.trial_index = match(fst.reactivated.trial, fst.reactivated.trial_index_nos)) %>%
  filter(day_ordinal_name == 'first') %>%
  ggplot(aes(first.reactivated.trial_index)) +
  stat_ecdf(color='#333333') +
  xlab('First trial when reactivated') +
  ylab('Cumulative % of\nreactivated cells') +
  scale_x_continuous(breaks=1:8+0.5, labels=c(1:7, 'Never'), limits = c(0.5, 8.5)) +
  scale_y_continuous(labels=scales::percent) +
  gtheme
  #geom_histogram()
ggsave('~/tmp/tanjas/ecdf_reactivations.svg', width=5.2, height=4.5, units='cm')
```


```{r}
# Problem: check if less activity can be explained by slower mobility in later foraging?
g1 = compared.early.late.pc.wide %>%
  # filter(min.rew.dist_early > goal.cell.max.dist) %>%
  ggplot(aes(x=reactivated, 
             y=field.max.ratio,
             color=reactivated
             )) +
  geom_hline(yintercept = 1.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  scale_y_log10() +
  facet_grid(. ~ exp) +
  ylab('Field peaks ratio') +
  theme(legend.position = 'none')
g1

g6 = compared.early.late.pc.wide %>%
  ggplot(aes(x=reactivated, y=spatial.info.corrected.diff, color=reactivated)) +
    geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylim(c(-0.4, 0.4)) +
  ylab('Spatial info change') +
  theme(legend.position = 'none')

compared.early.late.pc.wide %>%
  ggplot(aes(x=reactivated, y=spatial.info.corrected_late, color=reactivated)) +
    geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylim(c(-0.4, 0.4)) +
  ylab('Spatial info') +
  theme(legend.position = 'none')

g2 = compared.early.late.pc.wide %>%
  ggplot(aes(x=reactivated, 
             #y=field.max.diff
             #y=trace.mean.ratio
             #y=early.late.cor
             y=field.shift.distance.cm,
             color=reactivated
             )) +
  #geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylab('Field peak shift (cm)') +
  theme(legend.position = 'none')

compared.early.late.pc.wide %>%
  ggplot(aes(x=reactivated,  y=early.late.cor, color=reactivated)) +
  #geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylab('Early late correlation') +
  theme(legend.position = 'none')

g3 = compared.early.late.pc.wide %>% 
  ggplot(aes(x=reactivated, y=min.rew.dist_early * perc2dist, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  ylab('Reward distance in early trials (cm)') +
  facet_grid(. ~ exp) +
  theme(legend.position = 'none')

g4 = compared.early.late.pc.wide %>% 
  ggplot(aes(x=reactivated, y=min.rew.dist_late * perc2dist, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  ylab('Reward distance in late trials (cm)') +
  facet_grid(. ~ exp) +
  theme(legend.position = 'none')

g5 = compared.early.late.pc.wide %>% 
  ggplot(aes(x=reactivated, y=min.rew.dist.diff * perc2dist, color=reactivated)) +
  geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  scale_color_manual(values=reactiv.colours) +
  ylab('Reward distance change (cm)') +
  facet_grid(. ~ exp) +
  theme(legend.position = 'none')

cowplot::plot_grid(g1, g2, g4, g5, g6, ncol=6)
ggsave('~/tmp/tanjas/pc_stats.svg', width=22.2, height=6.5, units='cm')
```

```{r}
compared.early.late.pc.wide$exp = as.factor(compared.early.late.pc.wide$exp)
compared.early.late.pc.wide$reactivated = as.factor(compared.early.late.pc.wide$reactivated)
m.field = lmer.test.print(compared.early.late.pc.wide %>%
                  mutate(val=log(field.max.ratio)),
                  #filter(!is.na(spatial.info.corrected.diff)) %>%
                  #mutate(val=spatial.info.corrected.diff),
                var=val,
                fixed.effects = reactivated * exp,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)

lsmeansLT(m.field,pairwise = TRUE)

m.field.shift = lmer.test.print(compared.early.late.pc.wide %>%
                                  filter(exp=='learning') %>%
                  mutate(val=log(1 + field.shift.distance.cm)),
                var=val,
                fixed.effects = reactivated ,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)


m.si = lmer.test.print(compared.early.late.pc.wide %>%
                         #filter(exp=='learning') %>%
                  mutate(val=spatial.info.corrected.diff),
                var=val,
                fixed.effects = reactivated * exp,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)

m.rew.dist = lmer.test.print(compared.early.late.pc.wide %>%
                         filter(exp=='learning') %>%
                  mutate(val=log(10 + min.rew.dist_late)),
                   # filter(!is.na(val)),
                var=val,
                fixed.effects = reactivated,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
lsmeansLT(m.rew.dist, pairwise = TRUE)

m.rew.dist.change = lmer.test.print(compared.early.late.pc.wide %>%
                         filter(exp=='learning') %>%
                  mutate(val=min.rew.dist.diff),
                   # filter(!is.na(val)),
                var=val,
                #fixed.effects = reactivated,
                fixed.effects = 1,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)

#lsmeansLT(m.field,pairwise = TRUE)
```

Check how closer of the peaks moved closer toward the reward
```{r}
new.locations.df$current_loc = TRUE
new.locations.df = as.data.table(new.locations.df)
early.peaks.at.rew = create.peaks.df.at.locs(early.fields, 
                                             new.locations.df, 
                                             test.days.df.joined %>% filter(day_ordinal_name == 'first'))
late.peaks.at.rew = create.peaks.df.at.locs(late.fields, 
                                            new.locations.df, 
                                            test.days.df.joined %>% filter(day_ordinal_name == 'first'))
```

```{r}
compared.early.late.df.trials.peaks = left_join(
  compared.early.late.df.trials, 
  bind_rows(
    early.peaks.at.rew %>% mutate(trials_group = 'early') %>% dplyr::select(animal, date, cell_id, trials_group, day_desc, min.rew.dist),
    late.peaks.at.rew %>% mutate(trials_group = 'late')  %>% dplyr::select(animal, date, cell_id, trials_group, day_desc, min.rew.dist) 
  )) %>%
  dplyr::mutate(reactivated = fst.reactivated.trial < Inf) %>%
  filter(signif.si)

compared.early.late.df.trials.peaks.wide = pivot_wider(
      compared.early.late.df.trials.peaks, 
      id_cols=c('animal', 'exp', 'date', 'day_desc', 'day_ordinal_name', 'cell_id', 'active', 'signif.si', 'reactivated', 'fst.reactivated.trial'),
      names_from=trials_group,
      values_from=c('min.rew.dist', 'field.max')) %>% 
      mutate(min.rew.dist.diff = min.rew.dist_late - min.rew.dist_early)


compared.early.late.df.trials.peaks.wide %>%
  ggplot(aes(x=reactivated, y=min.rew.dist_early * perc2dist, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  #geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylab('Distance to reward late (cm)') +
  theme(legend.position = 'none')  

compared.early.late.df.trials.peaks.wide %>%
  ggplot(aes(x=reactivated, y=min.rew.dist.diff * perc2dist, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylab('Distance to reward change (cm)') +
  theme(legend.position = 'none')
ggsave('~/tmp/tanjas/dist_to_rew.svg', width=4.0, height=6.5, units='cm')
```

```{r}
m.peaks.dist = lmer.test.print(compared.early.late.df.trials.peaks %>%
                  mutate(val=log(1+ min.rew.dist)),
                var=val,
                fixed.effects = reactivated,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```

Change in pct of cells within goal
```{r}
compared.early.late.df.trials.pct.at.goal = compared.early.late.df.trials.peaks  %>%
  mutate(is.goal.cell = min.rew.dist <= goal.cell.max.dist) %>%
  dplyr::group_by(date, animal, trials_group, exp, day_desc, day_ordinal_name, reactivated) %>%
  dplyr::summarise(pct.at.goal=mean(is.goal.cell), ncells=n()) %>%
  dplyr::mutate(animal_date = paste(animal, day_desc, sep='-')) 
  #dplyr::filter(ncells > 5) %>%
compared.early.late.df.trials.pct.at.goal %>%
  ggplot(aes(x=trials_group, y=pct.at.goal, group=animal_date)) +
  geom_line() +
  facet_grid(. ~ exp + reactivated) +
  ylim(c(0, 1.0))

lmer.test.print(compared.early.late.df.trials.pct.at.goal,
                var=pct.at.goal,
                fixed.effects = reactivated * trials_group,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```
```{r}
compared.early.late.df.trials.peaks.wide %>%
  ggplot(aes(y=min.rew.dist_late  * perc2dist, x=min.rew.dist_early * perc2dist, color=reactivated)) +
  geom_point(shape=1, size=0.4, alpha=0.6) +
  scale_color_manual(values=reactiv.colours) +
  ylab('Reward distance in late trials (cm)') +
  xlab('Reward distance in early trials (cm)') +
  stat_smooth(method = 'lm') +
  facet_grid(. ~ reactivated) +
  theme(legend.position = 'none')
  #xlim(c(0,80)) + ylim(c(0,80))

lmer.test.print(compared.early.late.df.trials.peaks.wide,
                var=log(1+min.rew.dist_late),
                fixed.effects = reactivated + log(1+min.rew.dist_early),
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)
```

Reactivated cells seem to be closer to the reward already during foraging! Could be because they have a
higher number of peaks: should only consider the highest peak.
```{r}
beforetest.peaks.at.rew = create.peaks.df.at.locs(beforetest.fields, 
                                                  new.locations.df, 
                                                  test.days.df.joined %>% filter(day_ordinal_name == 'first'))
```

```{r}
compared.beforetest.late.df.trials.peaks = left_join(
  compared.early.late.df.trials %>% filter(trials_group == 'late'),
  late.peaks.at.rew %>% 
    mutate(trials_group = 'late')  %>% 
    dplyr::select(animal, date, cell_id, trials_group, day_desc, min.rew.dist, npeaks, npeaks.at.rew)) %>%
  dplyr::mutate(reactivated = fst.reactivated.trial < Inf) %>%
  filter(signif.si)

compared.beforetest.late.df.trials.peaks.wide = beforetest.peaks.at.rew %>% 
  mutate(min.rew.dist.beforetest = min.rew.dist) %>% 
  dplyr::select(animal, date, cell_id, day_desc, min.rew.dist.beforetest) %>%
  left_join(compared.beforetest.late.df.trials.peaks) %>%
  mutate(min.rew.dist.diff = min.rew.dist - min.rew.dist.beforetest) %>%
  filter(signif.si) 

compared.beforetest.late.df.trials.peaks.wide %>%
  ggplot(aes(x=reactivated, y=min.rew.dist.diff * perc2dist, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  #geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  scale_color_manual(values=pc.two.colours) +
  facet_grid(. ~ exp) +
  ylab('Distance to reward location:\n foraging session before learning (cm)') +
  theme(legend.position = 'none')  
```

```{r}
compared.beforetest.late.df.trials.peaks %>%
  ggplot(aes(x=reactivated, y=npeaks, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0.2, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5, adjust=2) +
  scale_color_manual(values=reactiv.colours) +
  facet_grid(. ~ exp) +
  ylab('Distance to reward location:\n foraging session before learning (cm)') +
  theme(legend.position = 'none')  
```

Change in the distance of the the highest peak
```{r}
pc.test.df.new = pc.test.df %>%
  dplyr::select(-c(is.goal.cell, closest.location.ordinal, closer.rew.angle, min.rew.dist)) %>%
  dplyr::group_by(date, day_desc, animal) %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(new.locations.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist)

pc.late.df.new = compared.early.late.df.trials %>% filter(trials_group == 'late') %>%
   dplyr::group_by(date, day_desc, animal) %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(new.locations.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist)

pc.late.df.change = pc.test.df.new %>%
  mutate(min.rew.dist.beforetest = min.rew.dist) %>% 
  dplyr::select(animal, date, cell_id, day_desc, min.rew.dist.beforetest) %>%
  left_join(pc.late.df.new) %>%
  mutate(min.rew.dist.diff = min.rew.dist.beforetest - min.rew.dist) %>%
  dplyr::mutate(reactivated = fst.reactivated.trial < Inf) %>%
  filter(!is.na(reactivated), !is.na(min.rew.dist.diff)) %>%
  filter(signif.si)

pc.late.df.change %>%
  ggplot(aes(x=reactivated, y=min.rew.dist.diff * perc2dist, color=reactivated)) +
  geom_jitter(shape=1, size=0.1, alpha=0.4, height=0, width=0.2) +
  geom_violin( fill='transparent', colour='#333333', draw_quantiles=0.5) +
  #geom_hline(yintercept = 0.0, linetype='dashed', color='#444444') +
  scale_color_manual(values=pc.two.colours) +
  ylab('Place field shift\ntowards reward (cm)') +
  theme(legend.position = 'none')  

ggsave('~/tmp/tanjas/shift_to_rew.svg', width=5.0, height=6.5, units='cm')

lmer.test.print(pc.late.df.change,
                var=min.rew.dist.diff,
                fixed.effects = reactivated,
                randef.str = '(1 + day_desc | animal)',
                diagnostics.groupvar = animal)

```

