---
title: "R Notebook"
output: html_notebook
---


```{r setup}
library(dplyr)
library(plyr)
library(pracma)
library(readr)
library(tidyr)
library(stringr)
library(DT)
library(data.table)
library(tictoc)
library(datatrace)
library(foreach)
library(doSNOW)

setwd("~/mnt_code/cheeseboard_analysis/R")

# Plotting
library(ggplot2)
library(cowplot)

summarise = dplyr::summarise
summarize = dplyr::summarize

source('distances.R')
source('fixed_effects.R')
source('locations.R')
source('plotting_params.R')
source('utils.R')
source('traces_input.R')
```

```{r}
timebin.dur.msec = 100

mouse.meta.df = read.mouse.meta(rootdirs)
trials.meta.df = read.trials.meta(rootdirs)
test.locations.df = map_dfr(rootdirs, read_locations) %>%
  filter(exp_title == 'beforetest')
test.days.df = dplyr::select(test.locations.df, animal, date) %>%
  filter(animal != 'A-BL') %>%
  dplyr::distinct()

test_caimg_dirs = map2(test.days.df$animal, test.days.df$date, ~ find.caimg.dir(caimg_result_dirs, .x, .y))

habit3.days.df = filter(trials.meta.df, day_desc == 'habituation day#3') %>% 
  dplyr::select(date, animal) %>%
  dplyr::distinct() %>% 
  mutate(caimg_dir = map2(animal, date, ~ find.caimg.dir(caimg_result_dirs, .x, .y)))
```
```{r}
prepare.timebinned.run.traces = function(data.traces, timebin.dur.msec) {
  data.traces = data.traces[exp_title != 'homecage',]
  detect.events(data.traces, deconv.threshold=0.2)
  
  setorder(data.traces, trial_id, cell_id, timestamp)
  running.index = isRunning(data.traces, 2, 4, 500)
  timebinned.run = timebin.traces(data.traces[which(running.index) & x >= 0 & y >= 0, ], 
                                  timebin.dur.msec = timebin.dur.msec)
  return(timebinned.run)
}


stimbin.traces.xy = function(traces, nbins) {
  binned.traces = traces %>% stimbin.traces(x, nbins) %>% stimbin.traces(y, nbins) %>% 
    as.data.table()
  binned.traces[, bin.xy := to_1dim(bin.x, bin.y, nbins)]
  binned.traces
}
```


pseudo code:
draw timestamps count to match occupancy
```{r}
nbins = 30
ndownsample_shuffles = 10
habit3.days.df = as.data.table(habit3.days.df)
down.test.si = data.frame()
down.habit.si = data.frame()

# Returns DFs with one row per each timestamp, specyfing its spatial bin and count of timestamps 
# that matches occupancy in that bin between the two traces. Returns one DF per the 
# input trace.
timestamps.per.bin = function(fst.trace, snd.trace, down_nbins=10) {
  binned.fst.trace = stimbin.traces.xy(fst.trace[cell_id == fst.trace$cell_id[1]], down_nbins)
  fst.mfr = with(binned.fst.trace, create_mfr_model(bin.x, bin.y, 
                                                    nbins_x=down_nbins, 
                                                    nbins_y=down_nbins, 
                                                    trace=trace, 
                                                    minOccupancy=1))
  binned.snd.trace = stimbin.traces.xy(snd.trace[cell_id == snd.trace$cell_id[1]], down_nbins)
  snd.mfr = with(binned.snd.trace, create_mfr_model(bin.x, bin.y, 
                                                    nbins_x=down_nbins, 
                                                    nbins_y=down_nbins, 
                                                    trace=trace, 
                                                    minOccupancy=1))
  matching.occupancyMap = pmin(fst.mfr$occupancyMap, snd.mfr$occupancyMap)
  
  fst.timestamps.per.bin = binned.fst.trace[, .(timestamp, bin.xy, bin.x, bin.y)]
  fst.timestamps.per.bin[, down.ntimestamp := map2_int(bin.x, bin.y, ~ as.integer(matching.occupancyMap[.x, .y]))]
  
  snd.timestamps.per.bin = binned.snd.trace[, .(timestamp, bin.xy, bin.x, bin.y)]
  snd.timestamps.per.bin[, down.ntimestamp := map2_int(bin.x, bin.y, ~ as.integer(matching.occupancyMap[.x, .y]))]
  
  return(list(df1 = fst.timestamps.per.bin, df2 = snd.timestamps.per.bin, occupancyMap=matching.occupancyMap))
}

# Shuffles the timestamps and returns next batch of downsampled timestamps per each bin
next.down.timestamps = function(shuffle.timestamps) {
  shuffle.timestamps = shuffle.timestamps[sample(nrow(shuffle.timestamps)),]
  shuffle.timestamps[, timestamp_id := rowid(bin.xy)]
  down.timestamps = shuffle.timestamps[timestamp_id <= down.ntimestamp, timestamp]
  return(down.timestamps)
}

for (caimg_result_dir in test_caimg_dirs) {
  data.traces = read.data.trace(caimg_result_dir)
  
  # Beforetest trace
  max_test_trial_dur_msec = 240 * 1000
  test.traces = data.traces[exp_title == 'beforetest' & timestamp <= max_test_trial_dur_msec]
  timebinned.test.traces.run = prepare.timebinned.run.traces(test.traces, timebin.dur.msec)

  # Habit trace
  animal_name = data.traces$animal[1]
  date_str = data.traces$date[1]
  habit_caimg_dir = habit3.days.df[animal == animal_name, caimg_dir][[1]]
  habit.data.traces = read.data.trace(habit_caimg_dir)
  timebinned.habit.traces.run = prepare.timebinned.run.traces(habit.data.traces, timebin.dur.msec)
  
  # Group timestamps by spatial bin
  timestamps.per.bin.res = timestamps.per.bin(timebinned.test.traces.run, timebinned.habit.traces.run)
  shuffle.test.timestamps = timestamps.per.bin.res$df1
  shuffle.habit.timestamps = timestamps.per.bin.res$df2

  get.bin.thresholds.fun = get.quantiles.fun(c(0.95, 1.0))
  binned.habit.traces.run = stimbin.traces.xy(timebinned.habit.traces.run, nbins)
  binned.habit.traces.run = bin.responses(binned.habit.traces.run, get.bin.thresholds.fun, binned.var='trace')
  setkey(binned.habit.traces.run, timestamp, cell_id)
  
  binned.test.traces.run = stimbin.traces.xy(timebinned.test.traces.run, nbins)
  binned.test.traces.run = bin.responses(binned.test.traces.run, get.bin.thresholds.fun, binned.var='trace')
  setkey(binned.test.traces.run, timestamp, cell_id)
  
  sample.spatial.info = function(timestamps.df, binned.traces, shuffle_i, nshuffles=100) {
    down.timestamps = next.down.timestamps(timestamps.df)
    down.binned.traces = binned.traces[timestamp %in% down.timestamps,]
    spatial.res = calc.spatial.info(down.binned.traces, nshuffles=nshuffles)
    spatial.res$df$shuffle_i = shuffle_i
    return(spatial.res$df)
  }
  
  habit.trials.si = map_dfr(1:ndownsample_shuffles, 
                            ~ sample.spatial.info(shuffle.habit.timestamps, binned.habit.traces.run, .x))
  habit.trials.si$date = binned.habit.traces.run$date[1]
  habit.trials.si$animal = animal_name
  habit.trials.si$date.test = test.traces$date[1]
  down.habit.si = bind_rows(down.habit.si, habit.trials.si)
  
  test.trials.si =  map_dfr(1:ndownsample_shuffles, 
                            ~ sample.spatial.info(shuffle.test.timestamps, binned.test.traces.run, .x))
  test.trials.si$date = test.traces$date[1]
  test.trials.si$animal = animal_name
  down.test.si = bind_rows(down.test.si, test.trials.si)
}
```




```{r}
beforetest.rewards.df = map_dfr(rootdirs, read_locations) %>%
  filter(is_test, exp_title == 'beforetest') %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(dplyr::select(trials.meta.df, -location_set), by=c('date', 'animal'))
beforetest.rewards.df = data.table(beforetest.rewards.df)
```

Calculate distance to closer reward
```{r}
down.test.rewdist = down.test.si %>%
  filter(signif.si) %>%
  dplyr::group_by(date, animal) %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist,
        closest.location.ordinal=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date[1], animal[1]),
                                                   field.max.x, field.max.y)$location.ordinal)

down.habit.rewdist = down.habit.si %>%
  filter(signif.si) %>%
  dplyr::group_by(date, date.test, animal) %>%
  dplyr::mutate(
        min.rew.dist=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date.test[1], animal[1]),
                                       field.max.x, field.max.y)$rew.dist,
        closest.location.ordinal=calc.min.rew.dist(filter.rews.df(beforetest.rewards.df, date.test[1], animal[1]),
                                                   field.max.x, field.max.y)$location.ordinal)

down.rewdist = bind_rows(
  mutate(down.habit.rewdist, exp_title = '1_habituation')  %>% dplyr::select(-date) %>% dplyr::rename(date=date.test),
  mutate(down.test.rewdist, exp_title = '2_test')
) %>%
  left_join(trials.meta.df) %>%
  left_join(mouse.meta.df) %>%
  filter(animal != 'L-TL') # remove animal with few cells during test
```

Plot distribution of distance to reward 
```{r}
ggplot() +
  geom_density(data=down.rewdist, aes(x=min.rew.dist, linetype=exp_title)) +
  facet_grid(implant ~ day_desc) +
  #facet_grid(. ~ implant) +
  geom_vline(xintercept = 15, linetype='dotted') +
  coord_flip() +
  scale_linetype_manual(values=c("dashed", "solid"))+
  gtheme +
  xlim(c(0,100)) +
  xlab('Place field distance from closer reward (%)') + ylab('Density') +
  ggtitle('Downsampled trials')
```


```{r}
summarize.downrew.pc.pct = function(df, dist.var=min.rew.dist, dist.threshold=goal.cell.max.dist) {
  dist.var = enquo(dist.var)
  df %>%
    group_by(date, day_desc, animal, implant, exp_title, shuffle_i) %>%
    dplyr::summarise(at.reward=sum(!!dist.var <= dist.threshold),
                     ncells = n(),
                     pct.reward=at.reward / ncells * 100)
}

summary.df = summarize.downrew.pc.pct(down.rewdist, dist.threshold= 15)
dca1.rew.pc.pct = subset(summary.df, implant == 'dCA1')
vca1.rew.pc.pct = subset(summary.df, implant == 'vCA1')
fem.dca1 = lmerTest::lmer(pct.reward ~  exp_title + (1 + exp_title | animal), data=dca1.rew.pc.pct)
print('Fraction of dCA1 place cells at reward increased')
summary(fem.dca1)
plot.model.diagnostics(fem.dca1, dca1.rew.pc.pct$animal, dca1.rew.pc.pct$exp_title)

fem.vca1 = lmerTest::lmer(pct.reward ~  exp_title + (1 + exp_title | animal), data=vca1.rew.pc.pct)
print('Fraction of vCA1 place cells did not increase')
summary(fem.vca1)
plot.model.diagnostics(fem.vca1, vca1.rew.pc.pct$animal, vca1.rew.pc.pct$exp_title)

plot.val.change.between.groups(create.animal.summary(summary.df, pct.reward, exp_title, shuffle_i), 
                               pct.reward, exp_title) +
  ylab('Place cells at reward (%)') +
  ggtitle('Fraction of place cells at reward increased at test trial')
```




