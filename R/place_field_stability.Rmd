  ---
title: "Analysis of place field stability across days and sessions"
output: html_notebook
---


```{r}
library(dplyr)
library(plyr)
library(pracma)
library(readr)
library(tidyr)
library(tibble)
library(stringr)
library(DT)
library(data.table)
library(permute)
#library(doParallel)
#library(foreach)
library(tictoc)

library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() +
  theme(text = element_text(size=18), axis.text = element_text(size=15))

summarise = dplyr::summarise
summarize = dplyr::summarize

source('locations.R')
Rcpp::sourceCpp('place_field.cpp')

```


```{r}
root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2019-08/'

list.subdir = function(subdir) {
  learning_datestr = list.files(subdir)
  sapply(learning_datestr, FUN=function(x) {paste(subdir, x, sep='/')}) %>% unname
}

get.subject.result.dirs = function(root_dir, subject) {
  dated_dirs = c(list.subdir(paste(root_dir, 'habituation', sep='/')),
                 list.subdir(paste(root_dir, 'learning', sep='/')))
  sapply(dated_dirs, FUN=function(x) {paste0(x, '/caiman/', subject, '/filtered/')})
}

caimg_result_dirs = c(
  get.subject.result.dirs(root_dir, 'E-BL'),
  get.subject.result.dirs(root_dir, 'E-TR'),
  get.subject.result.dirs(root_dir, 'F-BL'),
  get.subject.result.dirs(root_dir, 'F-TL')
)


caimg_result_dirs = Filter(
  function(ca_img_dir) {file.exists(paste(ca_img_dir, 'traces_and_positions.csv', sep='/'))},
  caimg_result_dirs)

gen_imgs_dir = '/tmp/pf_stability/'
```

Create shuffles
```{r}
shuffle.trace = function(trace, timestamps, min.shuffle=10 * 20) {
  trial.ends = c(which(diff(timestamps) < 0), length(timestamps))
  trial.starts = c(1, 1 + which(diff(timestamps) < 0))
  
  shifted.trace = c()
  for (i in 1:length(trial.starts)) {
    trial.trace = trace[trial.starts[i]:trial.ends[i]]
    shifted.trace = c(shifted.trace, shuffle(trial.trace))
  }
  
  return(shifted.trace)
}
```


```{r}
source('place_field.R')

calc.spatial.info = function(data.traces, plot.dir='/tmp/pf_stability/', 
                             generate.plots=FALSE, nshuffles=0) {
  frame.hz = 20
  data.traces = data.table(data.traces)
  cells = unique(data.traces$cell_id) %>% sort
  pci.df = data.frame()
  fields = list()
  occupancies = list()
  #cl = makeCluster(3)
  #registerDoParallel(cl)
  #foreach::getDoParRegistered()
  #foreach (cell_name = cells, .packages = "Rcpp",.noexport = "getCppPlaceField") %dopar% {
  for (cell_name in cells) {
    #Rcpp::sourceCpp('place_field.cpp')
    cell.df = data.traces[cell_id == cell_name & smooth_trans_x >= 0 & smooth_trans_y >= 0,]
    cell.events = cell.df[nevents > 0,]
    trace.col = 'deconv_trace'
 
    pf = with(cell.df, getCppPlaceField(smooth_trans_x, smooth_trans_y, deconv_trace, nshuffles, frame.hz/2))
    
    #spatial.infos = rep(0, nshuffles)
    #if (nshuffles > 0) {
    #  for (shuffle_i in 1:nshuffles) {
    #    shuffled.trace = shuffle.trace(cell.df$deconv_trace, cell.df$timestamp)
    #    shuffled.pf = with(cell.df, getCppPlaceField(smooth_trans_x, smooth_trans_y, shuffled.trace))
    #    spatial.infos[shuffle_i] = shuffled.pf$spatial.information
    #  }
    #}
    signif.thresh = quantile(pf$shuffle.si, 0.95)[[1]]
    si.signif = pf$spatial.information >= signif.thresh

    fields[[format(cell_name)]] = pf$field
    occupancies[[format(cell_name)]] = pf$occupancy

    pci.df = bind_rows(pci.df, data.frame(cell_id=cell_name,
                                          spatial.information=pf$spatial.information,
                                          signif.thresh=signif.thresh,
                                          signif.si=si.signif,
                                          field.centre.x=pf$field.centre[1],
                                          field.centre.y=pf$field.centre[2],
                                          field.size=pf$field.size,
                                          spatial.information.perspike=pf$spatial.information.perspike,
                                          mfr=pf$mfr,
                                          field.max=pf$field.max,
                                          #entropy=pf$entropy,
                                          nevents=nrow(cell.events)))

    if (generate.plots) {
      cell_event_rate = nrow(cell.events) / nrow(cell.df) * frame.hz
      trace.quantiles = quantile(cell.df[, ..trace.col][[1]], probs=c(0.2, 0.9))
      pf.df = create.pf.df(pf$field, pf$occupancy, min.zscore=trace.quantiles[[1]], max.zscore=trace.quantiles[[2]])
      g.placefield = plot.pf(pf.df, min.zscore=trace.quantiles[[1]], max.zscore=trace.quantiles[[2]]) +
        labs(title=paste0('Cell ', cell_name, ' MER = ', format(cell_event_rate, digits=2), ' Hz',
                          '\nSI = ', format(pf$spatial.information, digits=2),
                          ifelse(si.signif, '*', ''),
                          ' SI per spike = ', format(pf$spatial.information.perspike, digits=2)),
             fill='Deconv trace') +
        theme(text = element_text(size=4),
              plot.title = element_text(size=4))
  
      dir.create(plot.dir, recursive=TRUE)
      ggsave(paste0(plot.dir, 'place_field_cell_', cell_name, '.jpg'), g.placefield,
             width=3.5, height=3.0, units='cm', dpi=300)
    }
    
  }

  #stopCluster(cl)
  #stopImplicitCluster()
  return(list(df=pci.df, field=fields, occupancy=occupancies))
}
```


```{r}
source('trace_utils.R')

#caimg_result_dirs = caimg_result_dirs[1:5]
run.threshold = 2
  
all.trials.si = data.frame()
run.trials.si = data.frame()
odd.trials.si = data.frame()
even.trials.si = data.frame()
early.trials.si = data.frame()
late.trials.si = data.frame()

all.fields = list()
all.occupancies = list()
run.fields = list()
run.occupancies = list()
odd.fields = list()
odd.occupancies = list()
even.fields = list()
even.occupancies = list()
early.fields = list()
early.occupancies = list()
late.fields = list()
late.occupancies = list()

add.meta.cols = function(df, animal, date) {
  df$animal = as.factor(rep(animal, nrow(df)))
  df$date = as.factor(rep(date, nrow(df)))
  return(df)
}

for (ca_img_result_dir in caimg_result_dirs) {
  print(paste('Processing dir: ', ca_img_result_dir))
  cellmapping_file = paste0(ca_img_result_dir, 'cell_mapping.csv')
  cellmapping.df = read.csv(cellmapping_file)
  traces_file = paste0(ca_img_result_dir, 'traces_and_positions.csv')
  data = fread(traces_file)
  data = data[exp_title == 'trial',]
  data.traces = melt.traces(data)
  data.traces = left_join(data.traces, cellmapping.df, by=c('cell'='cell_no'))
  dir_parts = str_split(ca_img_result_dir, '/')
  animal = dir_parts[[1]][length(dir_parts[[1]]) - 2]
  data.traces$animal = rep(animal, nrow(data.traces))
  date = data.traces$date[1]
  data.traces = data.table(data.traces)
  data.traces.run = data.traces[velocity >= run.threshold,]
  
  print('Analysing spatial information')
  plot.dir.prefix = paste(gen_imgs_dir, animal, format(date), sep='/')
  
  tic("spatial info on all trials")
  all.spatial = calc.spatial.info(data.traces,
                                  plot.dir=paste0(plot.dir.prefix, '/all/'),
                                  generate.plots=TRUE,
                                  nshuffles=100)
  all.trials.si = bind_rows(all.trials.si, add.meta.cols(all.spatial$df, animal, date))
  all.fields[[animal]][[format(date)]] = all.spatial$field
  all.occupancies[[animal]][[format(date)]] = all.spatial$occupancy
  toc()
  
  tic("spatial info on all trials running")
  run.spatial = calc.spatial.info(data.traces.run,
                                  plot.dir=paste0(plot.dir.prefix, '/run/'),
                                  generate.plots=TRUE,
                                  nshuffles=100)
  run.trials.si = bind_rows(run.trials.si, add.meta.cols(run.spatial$df, animal, date))
  run.fields[[animal]][[format(date)]] = run.spatial$field
  run.occupancies[[animal]][[format(date)]] = run.spatial$occupancy
  toc()

  # Odd vs Even
  tic("spatial info on odd trials")
  odd.spatial = calc.spatial.info(data.traces.run[trial %% 2 == 1,],
                                  paste0(plot.dir.prefix, '/odd/'))
  odd.trials.si = bind_rows(odd.trials.si, add.meta.cols(odd.spatial$df, animal, date))
  odd.fields[[animal]][[format(date)]] = odd.spatial$field
  odd.occupancies[[animal]][[format(date)]] = odd.spatial$occupancy
  toc()

  tic("spatial info on even trials")
  even.spatial = calc.spatial.info(data.traces.run[trial %% 2 == 0,],
                                   paste0(plot.dir.prefix, '/even/'))
  even.trials.si = bind_rows(even.trials.si, add.meta.cols(even.spatial$df, animal, date))
  even.fields[[animal]][[format(date)]] = even.spatial$field
  even.occupancies[[animal]][[format(date)]] = even.spatial$occupancy
  toc()

  # Early vs late
  half.trial = ceiling(max(data.traces$trial) / 2)
  tic("spatial info on early trials")
  early.spatial = calc.spatial.info(data.traces.run[trial <= half.trial,],
                                    paste0(plot.dir.prefix, '/early/'))
  early.trials.si = bind_rows(early.trials.si, add.meta.cols(early.spatial$df, animal, date))
  early.fields[[animal]][[format(date)]] = early.spatial$field
  early.occupancies[[animal]][[format(date)]] = early.spatial$occupancy
  toc()

  tic("spatial info on late trials")
  late.spatial = calc.spatial.info(data.traces.run[trial > half.trial, ],
                                   paste0(plot.dir.prefix, '/late/'))
  late.trials.si = bind_rows(late.trials.si, add.meta.cols(late.spatial$df, animal, date))
  late.fields[[animal]][[format(date)]] = late.spatial$field
  late.occupancies[[animal]][[format(date)]] = late.spatial$occupancy
  toc()
}

```
# Find place cells

How many place cells per day per mouse
```{r}
si.thresh = 0.0
field.size.thresh = 100
field.max.thresh = 0.0

run.trials.si = run.trials.si %>%
  mutate(is.place.cell = signif.si & 
          spatial.information >= si.thresh &
          field.size <= field.size.thresh,
          field.max >= field.max.thresh) 

place.cell.db = run.trials.si %>%
  select(date, animal, cell_id, is.place.cell)
```

```{r}
run.trials.si %>%
  ggplot() +
  geom_histogram(aes(x=spatial.information, fill=is.place.cell)) +
  facet_grid(. ~ animal) +
  xlab('Spatial information')
```


```{r}
run.trials.si %>%
  group_by(date, animal) %>%
  dplyr::summarise(pc.pct = sum(is.place.cell) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=date, y=pc.pct, group=animal, color=animal)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('Date') + 
  ylab('Place cells (%)')
```


Dist of spatial information in deconv traces
```{r}
ggplot(run.trials.si) +
  geom_histogram(aes(x=spatial.information)) +
  xlab('Spatial information (bits/s)') + 
  facet_grid(. ~ date) +
  gtheme
```

Odd vs even
```{r}
bind_rows(odd.trials.si, even.trials.si) %>%
  group_by(date, animal, cell_id) %>%
  dplyr::summarise(si.change=diff(spatial.information)) -> pf.diff.df

pf.diff.df %>%
  left_join(place.cell.db, by=c('date', 'animal')) %>%
  ggplot() +
  geom_violin(aes(x=date, y=si.change)) +
  geom_hline(aes(yintercept=0), linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Spatial information diff (bits/s)')
```
First half vs second half
```{r}
bind_rows(early.trials.si, late.trials.si) %>%
  group_by(date, animal, cell_id) %>%
  dplyr::summarise(si.change=diff(spatial.information)) -> pf.diff.df

pf.diff.df %>%
  left_join(place.cell.db, by=c('date', 'animal')) %>%
  ggplot() +
  geom_violin(aes(x=date, y=si.change, color=is.place.cell)) +
  geom_hline(aes(yintercept=0), linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Spatial information diff (bits/s)')
```
# Within day comparison of place fields

Utility functions
```{r}
pairdiff = function(x, empty.val=0) {
  if (length(x) == 0) {
    return(0)
  }
  if (length(x) == 1) {
    x=c(x, empty.val)
  }
  diff(x)[[1]]
}

pairequal = function(x) {
  if (length(x) < 2) {
    return(TRUE)
  }
  # make two NAs return TRUE
  x[is.na(x)] = -1
  return(x[[1]] == x[[2]])
}

```

Calculate stats for changes between odd and even trials
```{r}

all.days = unique(run.trials.si$date) %>% as.Date

compare.day.trials = function(day.trials.comparison, fields1, fields2, occupancies1, occupancies2) {
  pc.change.df = data.frame()
  for (i in 1:length(all.days)) {
    day = all.days[i]
    for (animal_name in unique(day.trials.comparison$animal)) {
      day.trials = filter(day.trials.comparison, animal_name == animal, date == day) %>%
          arrange(animal, cell_id, group)
      day.trials %>%
        group_by(animal, cell_id) %>% 
        dplyr::summarise(spatial.info.diff = pairdiff(spatial.information),
                         field.centre.x.diff = pairdiff(field.centre.x, 100),
                         field.centre.y.diff = pairdiff(field.centre.y, 100),
                         field.size.diff = pairdiff(field.size, 100),
                         field.max.diff = pairdiff(field.max, 0),
                         date=day,
                         n=n()) %>%
        mutate(field.xy.dist = norm2(field.centre.x.diff, field.centre.y.diff)) %>%
        select(-field.centre.x.diff, -field.centre.y.diff)-> pc.change
      
      pc.change = data.table(pc.change)
      setkey(pc.change, date, animal, cell_id)
      cells = unique(day.trials$cell_id)
      pc.change$field.cor = rep(0, length(cells))
      for (cell_name in cells) {
        m1 = fields1[[animal_name]][[format(day)]][[paste(cell_name)]]
        m2 = fields2[[animal_name]][[format(day)]][[paste(cell_name)]]
        o1 = occupancies1[[animal_name]][[format(day)]][[paste(cell_name)]]
        o2 = occupancies2[[animal_name]][[format(day)]][[paste(cell_name)]]
        
        max.zscore = max(max(m1), max(m2))
        
        cor.res = field.cor(create.pf.df(m1, o1, max.zscore=max.zscore), 
                            create.pf.df(m2, o2, max.zscore=max.zscore))
        pc.change[date==day & animal==animal_name & cell_id==cell_name,]$field.cor = cor.res$cor
      }
      
      pc.change.df = bind_rows(pc.change.df, pc.change)
    }
  }
  pc.change.df$date = as.character(pc.change.df$date)
  return(pc.change.df)
}


odd.trials.si$group = 'odd'
even.trials.si$group = 'even'
odd.even.trials = bind_rows(odd.trials.si, even.trials.si)
odd.even.comparison = compare.day.trials(odd.even.trials, odd.fields, even.fields, odd.occupancies, even.occupancies) %>%
  left_join(place.cell.db, by=c('date', 'animal', 'cell_id'))

early.trials.si$group = 'early'
late.trials.si$group = 'late'
early.late.trials = bind_rows(early.trials.si, late.trials.si)
early.late.comparison = compare.day.trials(early.late.trials, early.fields, late.fields, early.occupancies, late.occupancies) %>%
  left_join(place.cell.db, by=c('date', 'animal', 'cell_id'))
```

Shift in place cells field centre between odd and even trials
```{r}
odd.even.comparison %>%
  filter(is.place.cell) %>%
  ggplot() +
  geom_violin(aes(x=date, y=field.xy.dist, color=is.place.cell))
```
Place maps correlations
```{r}
odd.even.comparison %>%
  #filter(is.place.cell) %>%
  ggplot() +
  geom_violin(aes(x=is.place.cell, y=field.cor))
```
Correlation between field correlations and spatial information diff
```{r}
odd.even.comparison$group = 'oddeven'
early.late.comparison$group = 'earlylate'
day.comparison.mean = bind_rows(odd.even.comparison, early.late.comparison) %>%
  group_by(animal, date, cell_id) %>%
  dplyr::summarise(m.field.cor=mean(field.cor),
                   m.spatial.info.diff=mean(spatial.info.diff))

ggplot(day.comparison.mean) +
  geom_point(aes(x=m.field.cor, y=m.spatial.info.diff), alpha=0.1)
```

Correlation betwen field correlations and spatial information
```{r}
day.comparison.mean %>%
  left_join(run.trials.si, by=c('animal', 'date', 'cell_id')) %>%
  ggplot() +
  geom_point(aes(x=spatial.information, y=m.field.cor, color=is.place.cell), alpha=0.2)
```


# Change of place fields and statistics across days

Load reward locations
```{r}
locations.rootdir = "/mnt/DATA/Prez/cheeseboard/2019-08/"
rewards.df = read_locations(locations.rootdir) %>%
  filter(!is_test) %>%
  dplyr::rename(animal=Animal)
  
locations.df = rewards.df %>%
  select(date, animal, location_set) %>%
  dplyr::distinct()

locations.df = data.table(locations.df)
setkey(locations.df, date, animal)
```

Calculate stats for changes between day combinations.
```{r}

all.days = unique(run.trials.si$date) %>% as.Date
day.comb = combn(1:length(all.days), 2)
merged.run.trials.si = left_join(run.trials.si, locations.df, by=c('animal', 'date'))
pc.change.df = data.frame()
for (i in 1:ncol(day.comb)) {
  days_i = day.comb[,i]
  days = all.days[days_i]
  for (animal_name in unique(run.trials.si$animal)) {
    # run.trials.si[animal_name == animal & (date == days[1] | date == days[2]),
    #                .(animal, cell_id,
    #                  spatial.info.diff = pairdiff(spatial.information),
    #                  field.centre.x.diff = pairdiff(field.centre.x, 100),
    #                  field.centre.y.diff = pairdiff(field.centre.y, 100),
    #                  field.size.diff = pairdiff(field.size, 100),
    #                  field.max.diff = pairdiff(field.max, 0),
    #                  max.signif = max(signif.si, FALSE),
    #                  signif.si.changed = pairdiff(signif.si, FALSE) != 0,
    #                  days.diff = days_i[2] - days_i[1],
    #                  date.fst = days[1],
    #                  date.snd = days[2],
    #                  n=.N),
    #               by=.(animal, cell_id)] -> cell.fields
    # cell.fields$date.diff = paste(format(days[2]), ' - ', format(days[1]))
    # setkey(cell.fields, date.fst, date.snd, animal, cell_id, is.place.cell)
    # merge(locations.df, cell.fields)
    filter(merged.run.trials.si, animal_name == animal, date == days[1] | date == days[2]) %>%
      arrange(animal, cell_id, desc(date)) %>%
      group_by(animal, cell_id) %>% 
      dplyr::summarise(spatial.info.diff = pairdiff(spatial.information),
                       field.centre.x.diff = pairdiff(field.centre.x, 100),
                       field.centre.y.diff = pairdiff(field.centre.y, 100),
                       field.size.diff = pairdiff(field.size, 100),
                       field.max.diff = pairdiff(field.max, 0),
                       max.signif = max(signif.si, FALSE),
                       signif.si.changed = !pairequal(signif.si),
                       same_rew_loc = pairequal(location_set),
                       days.diff = days_i[2] - days_i[1],
                       date.diff=paste(format(days[2]), ' - ', format(days[1])),
                       date.fst = days[1],
                       date.snd = days[2],
                       n=n()) %>%
      mutate(field.xy.dist = norm2(field.centre.x.diff, field.centre.y.diff)) %>%
      select(-field.centre.x.diff, -field.centre.y.diff)-> pc.change
    
      pc.change = data.table(pc.change)
      setkey(pc.change, date.fst, date.snd, animal, cell_id)
      cells = unique(pc.change$cell_id)
      pc.change$field.cor = rep(0, length(cells))
      for (cell_name in cells) {
        m1 = run.fields[[animal_name]][[format(days[1])]][[paste(cell_name)]]
        m2 = run.fields[[animal_name]][[format(days[2])]][[paste(cell_name)]]
        if (!is.null(m1) && !is.null(m2)) {  # check the cell present on both days
          pc.change[date.fst==days[1] & date.snd==days[2] & animal==animal_name & cell_id==cell_name,]$field.cor = cor(as.vector(m1), as.vector(m2))
        }
      }
    
    pc.change.df = bind_rows(pc.change.df, pc.change)
  }
}
```

How many place cells remained place cells
```{r}
pc.change.df %>%
  filter(max.signif == 1) %>%
  filter(n>1) %>%
  filter(same_rew_loc) %>%
  filter(days.diff <= 4) %>%
  mutate(pc.unchanged = (!signif.si.changed)) -> x

DT::datatable(x)

x %>%
  group_by(animal, days.diff) %>%
  dplyr::summarise(pct.unchanged=sum(pc.unchanged) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=days.diff, y=pct.unchanged, color=animal, group=animal))
```

How many place cells kept their field
```{r}
max.moved.dist = 10

pc.change.df2 = filter(pc.change.df, days.diff <= 4)
pc.change.df2$days.diff = as.factor(pc.change.df2$days.diff)
pc.change.df2 %>%
  filter(n > 1) %>%
  filter(max.signif == 1) %>%
  filter(same_rew_loc) %>%
  filter(!signif.si.changed) %>%
  ggplot() +
  geom_violin(aes(x=days.diff, y=field.xy.dist, color=animal))
```

Place maps correlations
```{r}
pc.change.df %>%
  filter(is.place.cell) %>%
  ggplot() +
  geom_point(aes(x=days.diff, y=field.cor, color=animal))
```

# Distance of place fields to goal


```{r}

```

