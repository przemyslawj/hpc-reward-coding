  ---
title: "Analysis of place field stability across days and sessions"
output: html_notebook
---


```{r}
library(dplyr)
library(plyr)
library(pracma)
library(readr)
library(tidyr)
library(tibble)
library(stringr)
library(DT)
library(data.table)
library(permute)
#library(doParallel)
#library(foreach)
library(tictoc)

library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() +
  theme(text = element_text(size=18), axis.text = element_text(size=15))

summarise = dplyr::summarise
summarize = dplyr::summarize

source('locations.R')
source('place_field.R')
source('trace_utils.R')
Rcpp::sourceCpp('place_field.cpp')

```


```{r}
root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2019-08/'

list.subdir = function(subdir) {
  learning_datestr = list.files(subdir)
  sapply(learning_datestr, FUN=function(x) {paste(subdir, x, sep='/')}) %>% unname
}

get.subject.result.dirs = function(root_dir, subject) {
  dated_dirs = c(list.subdir(paste(root_dir, 'habituation', sep='/')),
                 list.subdir(paste(root_dir, 'learning', sep='/')))
  sapply(dated_dirs, FUN=function(x) {paste0(x, '/caiman/', subject, '/filtered/')})
}

caimg_result_dirs = c(
  get.subject.result.dirs(root_dir, 'E-BL'),
  get.subject.result.dirs(root_dir, 'E-TR'),
  get.subject.result.dirs(root_dir, 'F-BL'),
  get.subject.result.dirs(root_dir, 'F-TL')
)


caimg_result_dirs = Filter(
  function(ca_img_dir) {file.exists(paste(ca_img_dir, 'traces_and_positions.csv', sep='/'))},
  caimg_result_dirs)

gen_imgs_dir = '/mnt/DATA/Prez/pf_stability/'
```

```{r}
cell.spatial.info = function(cell.df, generate.plots=FALSE, nshuffles=0,
                             trace.col='deconv_trace',
                             timebin.size=1) {
  cell.events = cell.df[nevents > 0,]
  trace.vals = cell.df[[trace.col]]
  trace.vals = trace.vals - min(trace.vals)

  trial_ends = c(which(diff(cell.df$timestamp) < 0), nrow(cell.df))
  trace.quantiles = quantile(trace.vals, c(0.85, 0.95, 1.0), na.rm=TRUE) %>% unname + 0.01
  pf = with(cell.df, getCppPlaceField(smooth_trans_x, smooth_trans_y, trace.vals, 
                                      trace.quantiles, trial_ends, nshuffles, 
                                      frame.hz/2,
                                      timebin.size))
  
  si.signif.thresh = quantile(pf$shuffle.si, 0.95, na.rm=TRUE)[[1]]
  si.signif = pf$spatial.information >= si.signif.thresh
  mi.signif.thresh = quantile(pf$shuffle.mi, 0.95, na.rm=TRUE)[[1]]
  mi.signif = pf$spatial.information >= mi.signif.thresh
  trace2090.quantiles = quantile(trace.vals, probs=c(0.2, 0.9), na.rm=TRUE)

  cell_info = list(cell_id=cell_name,
                   spatial.information=pf$spatial.information,
                   si.signif.thresh=si.signif.thresh,
                   signif.si=si.signif,
                   mi.signif.thresh=mi.signif.thresh,
                   signif.mi=mi.signif,
                   field.centre.x=pf$field.centre[1],
                   field.centre.y=pf$field.centre[2],
                   field.max.x=pf$field.max.xy[1],
                   field.max.y=pf$field.max.xy[2],
                   field.size=pf$field.size,
                   spatial.information.perspike=pf$spatial.information.perspike,
                   mfr=pf$mfr,
                   mutual.info=pf$mutual.info,
                   mutual.info.bias=pf$mutual.info.bias,
                   field.max=pf$field.max,
                   quantile20=trace2090.quantiles[[1]],
                   quantile90=trace2090.quantiles[[2]],
                   #entropy=pf$entropy,
                   nevents=nrow(cell.events))

  g.placefield=NA
  if (generate.plots) {
    cell_event_rate = nrow(cell.events) / nrow(cell.df) * frame.hz
    
    pf.df = create.pf.df(pf$field, pf$occupancy, min.zscore=trace2090.quantiles[[1]], max.zscore=trace2090.quantiles[[2]],
                         max.xy=getNBinsXY())
    g.placefield = plot.pf(pf.df, max.xy=getNBinsXY()) +
      labs(title=paste0('Cell ', cell_name, ' MER = ', format(cell_event_rate, digits=2), ' Hz',
                        '\nSI = ', format(pf$spatial.information, digits=2),
                        ifelse(si.signif, '*', ''),
                        ' SI per spike = ', format(pf$spatial.information.perspike, digits=2),
                        '\nMI - bias = ', format(pf$mutual.info - pf$mutual.info.bias, digits=3),
                        ifelse(mi.signif, '*', '')),
           fill='Deconv trace') +
      theme(text = element_text(size=4),
            plot.title = element_text(size=4))


  }

  return(list(cell_info=cell_info,
             field=pf$field,
             occupancy=pf$occupancy,
             g=g.placefield))
}
```


```{r}
calc.spatial.info = function(data.traces, plot.dir='/tmp/pf_stability/', 
                             generate.plots=FALSE, nshuffles=0) {
  frame.hz = 20
  data.traces = data.table(data.traces)
  cells = unique(data.traces$cell_id) %>% sort
  pci.df = data.frame()
  fields = list()
  occupancies = list()

  #cl = makeCluster(3)
  #registerDoParallel(cl)
  #foreach::getDoParRegistered()
  #foreach (cell_name = cells, .packages = "Rcpp",.noexport = "getCppPlaceField") %dopar% {
  for (cell_name in cells) {
    cell.df = data.traces[cell_id == cell_name & smooth_trans_x >= 0 & smooth_trans_y >= 0,]
    pf = cell.spatial.info(cell.df, generate.plots, nshuffles)
    
    fields[[format(cell_name)]] = pf$field
    occupancies[[format(cell_name)]] = pf$occupancy
    pci.df = bind_rows(pci.df, pf$cell_info)
    
    if (!is.na(plot.dir)) {
      dir.create(plot.dir, recursive=TRUE)
      ggsave(paste0(plot.dir, 'place_field_cell_', cell_name, '.jpg'), pf$g,
             width=3.5, height=3.0, units='cm', dpi=300)
    }
  }

  #stopCluster(cl)
  #stopImplicitCluster()
  return(list(df=pci.df, field=fields, occupancy=occupancies))
}
```


```{r}
#caimg_result_dirs = caimg_result_dirs[1:5]
run.threshold = 2
  
all.trials.si = data.frame()
run.trials.si = data.frame()
odd.trials.si = data.frame()
even.trials.si = data.frame()
early.trials.si = data.frame()
late.trials.si = data.frame()

all.fields = list()
all.occupancies = list()
run.fields = list()
run.occupancies = list()
odd.fields = list()
odd.occupancies = list()
even.fields = list()
even.occupancies = list()
early.fields = list()
early.occupancies = list()
late.fields = list()
late.occupancies = list()

add.meta.cols = function(df, animal, date) {
  df$animal = as.factor(rep(animal, nrow(df)))
  df$date = as.factor(rep(date, nrow(df)))
  return(df)
}

for (ca_img_result_dir in caimg_result_dirs) {
  print(paste('Processing dir: ', ca_img_result_dir))
  cellmapping_file = file.path(ca_img_result_dir, 'cell_mapping.csv')
  cellmapping.df = read.csv(cellmapping_file)
  traces_file = file.path(ca_img_result_dir, 'traces_and_positions.csv')
  data = fread(traces_file)
  data = data[exp_title == 'trial',]
  data.traces = melt.traces(data)
  data.traces = left_join(data.traces, cellmapping.df, by=c('cell'='cell_no'))
  dir_parts = str_split(ca_img_result_dir, '/')
  animal = dir_parts[[1]][length(dir_parts[[1]]) - 2]
  data.traces$animal = rep(animal, nrow(data.traces))
  date = data.traces$date[1]
  data.traces = data.table(data.traces)
  data.traces.run = data.traces[velocity >= run.threshold,]
  
  print('Analysing spatial information')
  plot.dir.prefix = paste(gen_imgs_dir, animal, format(date), sep='/')
  
  tic("spatial info on all trials")
  all.spatial = calc.spatial.info(data.traces,
                                  plot.dir=paste0(plot.dir.prefix, '/all/'),
                                  generate.plots=TRUE,
                                  nshuffles=100)
  all.trials.si = bind_rows(all.trials.si, add.meta.cols(all.spatial$df, animal, date))
  all.fields[[animal]][[format(date)]] = all.spatial$field
  all.occupancies[[animal]][[format(date)]] = all.spatial$occupancy
  toc()
  
  tic("spatial info on all trials running")
  run.spatial = calc.spatial.info(data.traces.run,
                                  plot.dir=paste0(plot.dir.prefix, '/run/'),
                                  generate.plots=TRUE,
                                  nshuffles=100)
  run.trials.si = bind_rows(run.trials.si, add.meta.cols(run.spatial$df, animal, date))
  run.fields[[animal]][[format(date)]] = run.spatial$field
  run.occupancies[[animal]][[format(date)]] = run.spatial$occupancy
  toc()

  # Odd vs Even
  tic("spatial info on odd trials")
  odd.spatial = calc.spatial.info(data.traces.run[trial %% 2 == 1,],
                                  paste0(plot.dir.prefix, '/odd/'),
                                  nshuffles=100)
  odd.trials.si = bind_rows(odd.trials.si, add.meta.cols(odd.spatial$df, animal, date))
  odd.fields[[animal]][[format(date)]] = odd.spatial$field
  odd.occupancies[[animal]][[format(date)]] = odd.spatial$occupancy
  toc()

  tic("spatial info on even trials")
  even.spatial = calc.spatial.info(data.traces.run[trial %% 2 == 0,],
                                   paste0(plot.dir.prefix, '/even/'),
                                   nshuffles=100)
  even.trials.si = bind_rows(even.trials.si, add.meta.cols(even.spatial$df, animal, date))
  even.fields[[animal]][[format(date)]] = even.spatial$field
  even.occupancies[[animal]][[format(date)]] = even.spatial$occupancy
  toc()

  # Early vs late
  half.trial = ceiling(max(data.traces$trial) / 2)
  tic("spatial info on early trials")
  early.spatial = calc.spatial.info(data.traces.run[trial <= half.trial,],
                                    paste0(plot.dir.prefix, '/early/'),
                                    nshuffles=100)
  early.trials.si = bind_rows(early.trials.si, add.meta.cols(early.spatial$df, animal, date))
  early.fields[[animal]][[format(date)]] = early.spatial$field
  early.occupancies[[animal]][[format(date)]] = early.spatial$occupancy
  toc()

  tic("spatial info on late trials")
  late.spatial = calc.spatial.info(data.traces.run[trial > half.trial, ],
                                   paste0(plot.dir.prefix, '/late/'),
                                   nshuffles=100)
  late.trials.si = bind_rows(late.trials.si, add.meta.cols(late.spatial$df, animal, date))
  late.fields[[animal]][[format(date)]] = late.spatial$field
  late.occupancies[[animal]][[format(date)]] = late.spatial$occupancy
  toc()
}

```
# Assess place information metrics and stability

```{r}
run.trials.si %>%
  ggplot() +
  geom_histogram(aes(x=spatial.information, color=signif.si)) +
  facet_grid(. ~ animal) +
  xlab('Spatial information')
```


Dist of spatial information in deconv traces
```{r}
ggplot(run.trials.si) +
  geom_histogram(aes(x=spatial.information)) +
  xlab('Spatial information (bits/s)') + 
  facet_grid(. ~ date) +
  gtheme
```

Odd vs even
```{r}
bind_rows(odd.trials.si, even.trials.si) %>%
  group_by(date, animal, cell_id) %>%
  dplyr::summarise(si.change=diff(spatial.information)) -> pf.diff.df

pf.diff.df %>%
  ggplot() +
  geom_violin(aes(x=date, y=si.change)) +
  geom_hline(aes(yintercept=0), linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Spatial information diff (bits/s)')
```
First half vs second half
```{r}
bind_rows(early.trials.si, late.trials.si) %>%
  group_by(date, animal, cell_id, signif.si) %>%
  dplyr::summarise(si.change=diff(spatial.information)) -> pf.diff.df

pf.diff.df %>%
  ggplot() +
  geom_violin(aes(x=date, y=si.change)) +
  geom_hline(aes(yintercept=0), linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Spatial information diff (bits/s)')
```
# Within day comparison of place fields

Utility functions
```{r}
pairdiff = function(x, empty.val=0) {
  if (length(x) == 0) {
    return(0)
  }
  if (length(x) == 1) {
    x=c(x, empty.val)
  }
  diff(x)[[1]]
}

pairequal = function(x) {
  if (length(x) < 2) {
    return(TRUE)
  }
  # make two NAs return TRUE
  x[is.na(x)] = -1
  return(x[[1]] == x[[2]])
}

```

Calculate stats for changes between odd and even trials
```{r}

all.days = unique(run.trials.si$date) %>% as.Date

compare.day.trials = function(day.trials.comparison, fields1, fields2, occupancies1, occupancies2) {
  pc.change.df = data.frame()
  for (i in 1:length(all.days)) {
    day = all.days[i]
    for (animal_name in unique(day.trials.comparison$animal)) {
      day.trials = filter(day.trials.comparison, animal_name == animal, date == day) %>%
          arrange(animal, cell_id, group)
      day.trials %>%
        group_by(animal, cell_id) %>% 
        dplyr::summarise(spatial.info.mean = mean(spatial.information),
                         spatial.info.min = min(spatial.information),
                         spatial.info.diff = pairdiff(spatial.information),
                         field.centre.x.diff = pairdiff(field.centre.x, 100),
                         field.centre.y.diff = pairdiff(field.centre.y, 100),
                         field.size.diff = pairdiff(field.size, 100),
                         field.size.mean = mean(field.size),
                         field.size.max = max(field.size),
                         field.max.diff = pairdiff(field.max, 0),
                         field.max.mean = mean(field.max),
                         signif.si.mean = mean(signif.si),
                         date=day,
                         n=n()) %>%
        mutate(field.xy.dist = norm2(field.centre.x.diff, field.centre.y.diff)) %>%
        select(-field.centre.x.diff, -field.centre.y.diff)-> pc.change
      
      pc.change = data.table(pc.change)
      setkey(pc.change, date, animal, cell_id)
      cells = unique(day.trials$cell_id)
      pc.change$field.cor = rep(0, length(cells))
      for (cell_name in cells) {
        m1 = fields1[[animal_name]][[format(day)]][[paste(cell_name)]]
        m2 = fields2[[animal_name]][[format(day)]][[paste(cell_name)]]
        o1 = occupancies1[[animal_name]][[format(day)]][[paste(cell_name)]]
        o2 = occupancies2[[animal_name]][[format(day)]][[paste(cell_name)]]
        
        max.zscore = max(max(m1), max(m2))
        
        cor.res = field.cor(create.pf.df(m1, o1, max.zscore=max.zscore), 
                            create.pf.df(m2, o2, max.zscore=max.zscore))
        pc.change[date==day & animal==animal_name & cell_id==cell_name,]$field.cor = cor.res$cor
      }
      
      pc.change.df = bind_rows(pc.change.df, pc.change)
    }
  }
  pc.change.df$date = as.character(pc.change.df$date)
  return(pc.change.df)
}


odd.trials.si$group = 'odd'
even.trials.si$group = 'even'
odd.even.trials = bind_rows(odd.trials.si, even.trials.si)
odd.even.comparison = compare.day.trials(odd.even.trials, odd.fields, even.fields, odd.occupancies, even.occupancies) 

early.trials.si$group = 'early'
late.trials.si$group = 'late'
early.late.trials = bind_rows(early.trials.si, late.trials.si)
early.late.comparison = compare.day.trials(early.late.trials, early.fields, late.fields, early.occupancies, late.occupancies) 

odd.even.comparison$group = 'odd vs even'
early.late.comparison$group = 'early vs late'
```
Do cells with signif spatial information retain their field from early to late trials?
```{r}
day.comparison = bind_rows(odd.even.comparison, early.late.comparison)
day.comparison$signif.si.factor = as.factor(day.comparison$signif.si.mean)
g.day.stability = day.comparison %>%
  filter(signif.si.mean > 0) %>% 
  filter(field.size.max < 5) %>%
  filter(date=='2019-08-29' | date == '2019-09-02') %>%
  mutate(is.signif = signif.si.mean  == 1,
         is.nearby = field.xy.dist < 10) %>%
  #ggplot(aes(x=spatial.info.mean, y=field.cor, color=is.signif)) +
  ggplot(aes(x=spatial.info.min, y=field.xy.dist, color=signif.si.factor)) +
  geom_point(alpha=0.3, size=1) +
  geom_rug(aes(color=signif.si.factor), alpha=0.3) +
  #geom_vline(xintercept=si.thresh, linetype='dashed') +
  #geom_hline(yintercept=field.min.cor, linetype='dashed') +
  #geom_hline(yintercept=10, linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = -90, hjust = 1)) +
  facet_grid(date ~ group) +
  xlab('Min spatial information (bits/s)') +
  ylab('Shift of the place field peak  (%)') +
  labs(color='Day-stable\nplace cell', title='Early vs Late, Odd vs Even')
g.day.stability
ggsave(file.path(gen_imgs_dir, 'pc_stability-even_odd.jpg'), g.day.stability,
       width = 14, height = 10, units = 'cm')
```


```{r}

day.comparison.mean = bind_rows(odd.even.comparison, early.late.comparison) %>%
  group_by(date, animal, cell_id) %>%
  dplyr::summarise(m.field.cor=mean(field.cor),
                   m.field.size.diff=mean(field.size.diff),
                   m.field.size=mean(field.size.mean),
                   m.field.max=mean(field.max.mean),
                   m.field.xy.dist=mean(field.xy.dist),
                   m.spatial.info.diff=mean(spatial.info.diff),
                   m.spatial.info=mean(spatial.info.mean),
                   m.signif.si=mean(signif.si.mean))
```


Classify place cells

```{r}
si.thresh = 0.2
field.size.thresh = 10
field.peak.thresh = 0.1
field.min.cor = 0.2

# Classification of place cells based on SI on each subset of day sessions
day.comparison.mean = day.comparison.mean %>%
  mutate(is.day.pc = m.signif.si > 0.5 & 
           m.spatial.info >= si.thresh &
           m.field.xy.dist <= 20 &
           m.field.size <= field.size.thresh &
           m.field.max >= field.peak.thresh,
           #m.field.cor >= field.min.cor) 
         is.halfday.pc = m.signif.si >= 0.5 &
           m.spatial.info >= si.thresh &
           m.field.size <= field.size.thresh &
           m.field.max >= field.peak.thresh)

place.cell.db = day.comparison.mean %>%
  select(date, animal, cell_id, is.day.pc, is.halfday.pc) %>%
  ungroup()

run.trials.si.field = day.comparison.mean %>%
  left_join(run.trials.si, by=c('animal', 'date', 'cell_id'))


# Classification of sells based on SI for all day
# run.trials.pc = run.trials.si.field %>%
#   mutate(is.place.cell = signif.si & 
#            spatial.information >= si.thresh &
#            field.size <= field.size.thresh &
#            field.max >= field.max.thresh &
#            m.field.cor >= field.min.cor) 
# 
# place.cell.db = run.trials.pc %>%
#   select(date, animal, cell_id, is.place.cell)

run.trials.pc = run.trials.si.field
```


Correlation betwen field correlations and spatial information during the day
```{r}

#run.trials.pc  %>%
#  ggplot(aes(x=spatial.information, y=m.field.cor, color=is.place.cell)) +
day.comparison.mean  %>%
  mutate(si.signif = m.signif.si > 0.5) %>%
  ggplot(aes(x=m.spatial.info, y=m.field.cor, color=is.day.pc)) +
  geom_point(alpha=0.2, size=1) +
  geom_rug(col=rgb(.5,0,0,alpha=.009)) +
  #geom_vline(xintercept=si.thresh, linetype='dashed') +
  geom_hline(yintercept=field.min.cor, linetype='dashed') +
  gtheme +
  facet_grid(. ~ si.signif) +
  xlab('Mean spatial information (bits/s)') +
  ylab('Correlation of place field\nbetween trials') +
  labs(color='Place cell', title='Significant SI')

ggsave(file.path(gen_imgs_dir, 'pc_choice.jpg'),
       width = 14, height = 10, units = 'cm')
```



## How many place cells per day
```{r}
run.trials.si.field %>%
  group_by(date, animal) %>%
  dplyr::summarise(pc.pct = sum(is.day.pc) / n() * 100, 
                   half.pc.pct = sum(is.halfday.pc) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=date, y=pc.pct, group=animal, color='black')) +
  geom_line(aes(x=date, y=half.pc.pct, group=animal, color='red')) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_discrete(name='Place cell stability', labels = c('Full day', 'Half day')) +
  xlab('Date') + 
  ylab('Place cells (%)')

ggsave(file.path(gen_imgs_dir, 'pc_count.jpg'),
       width = 14, height = 10, units = 'cm')
```


# Change of place fields and statistics across days

Load reward locations
```{r}
locations.rootdir = "/mnt/DATA/Prez/cheeseboard/2019-08/"
rewards.df = read_locations(locations.rootdir) %>%
  filter(!is_test) %>%
  dplyr::rename(animal=Animal)
  
locations.df = rewards.df %>%
  select(date, animal, location_set) %>%
  dplyr::distinct()

locations.df = data.table(locations.df)
setkey(locations.df, date, animal)
```

Calculate stats for changes between day combinations.
```{r}

all.days = unique(run.trials.pc$date) %>% as.Date
day.comb = combn(1:length(all.days), 2)
merged.run.trials.pc = left_join(run.trials.pc, locations.df, by=c('animal', 'date'))
pc.change.df = data.frame()
for (i in 1:ncol(day.comb)) {
  days_i = day.comb[,i]
  days = all.days[days_i]
  for (animal_name in unique(run.trials.pc$animal)) {
    # run.trials.si[animal_name == animal & (date == days[1] | date == days[2]),
    #                .(animal, cell_id,
    #                  spatial.info.diff = pairdiff(spatial.information),
    #                  field.centre.x.diff = pairdiff(field.centre.x, 100),
    #                  field.centre.y.diff = pairdiff(field.centre.y, 100),
    #                  field.size.diff = pairdiff(field.size, 100),
    #                  field.max.diff = pairdiff(field.max, 0),
    #                  max.signif = max(signif.si, FALSE),
    #                  signif.si.changed = pairdiff(signif.si, FALSE) != 0,
    #                  days.diff = days_i[2] - days_i[1],
    #                  date.fst = days[1],
    #                  date.snd = days[2],
    #                  n=.N),
    #               by=.(animal, cell_id)] -> cell.fields
    # cell.fields$date.diff = paste(format(days[2]), ' - ', format(days[1]))
    # setkey(cell.fields, date.fst, date.snd, animal, cell_id, is.place.cell)
    # merge(locations.df, cell.fields)
    filter(merged.run.trials.pc, animal_name == animal, date == days[1] | date == days[2]) %>%
      arrange(animal, cell_id, desc(date)) %>%
      group_by(animal, cell_id) %>% 
      dplyr::summarise(spatial.info.diff = pairdiff(spatial.information),
                       m.field.cor.diff = pairdiff(m.field.cor, 0),
                       field.centre.x.diff = pairdiff(field.centre.x, 100),
                       field.centre.y.diff = pairdiff(field.centre.y, 100),
                       field.size.diff = pairdiff(field.size, 100),
                       field.max.diff = pairdiff(field.max, 0),
                       max.signif = max(signif.si, FALSE),
                       signif.si.changed = !pairequal(signif.si),
                       max.day.pc = max(is.day.pc, FALSE),
                       is.day.pc.changed = !pairequal(is.day.pc),
                       is.halfday.pc.changed = !pairequal(is.halfday.pc),
                       same_rew_loc = pairequal(location_set),
                       days.diff = days_i[2] - days_i[1],
                       date.diff=paste(format(days[2]), ' - ', format(days[1])),
                       date.fst = days[1],
                       date.snd = days[2],
                       n=n()) %>%
      mutate(field.xy.dist = norm2(field.centre.x.diff, field.centre.y.diff)) %>%
      select(-field.centre.x.diff, -field.centre.y.diff)-> pc.change
    
      pc.change = data.table(pc.change)
      setkey(pc.change, date.fst, date.snd, animal, cell_id)
      cells = unique(pc.change$cell_id)
      pc.change$field.cor = rep(0, length(cells))
      for (cell_name in cells) {
        m1 = run.fields[[animal_name]][[format(days[1])]][[paste(cell_name)]]
        m2 = run.fields[[animal_name]][[format(days[2])]][[paste(cell_name)]]
        if (!is.null(m1) && !is.null(m2)) {  # check the cell present on both days
          o1 = run.occupancies[[animal_name]][[format(days[1])]][[paste(cell_name)]]
          o2 = run.occupancies[[animal_name]][[format(days[2])]][[paste(cell_name)]]
          
          max.zscore = max(max(m1), max(m2))
          
          cor.res = field.cor(create.pf.df(m1, o1, max.zscore=max.zscore), 
                              create.pf.df(m2, o2, max.zscore=max.zscore))
          pc.change[date==day & animal==animal_name & cell_id==cell_name,]$field.cor = cor.res$cor
        }
      }
    
    pc.change.df = bind_rows(pc.change.df, pc.change)
  }
}
```

How many place cells remained place cells
```{r}
pc.change.df %>%
  filter(max.day.pc > 0) %>%
  filter(n>1) %>%
  filter(same_rew_loc) %>%
  filter(days.diff <= 4) %>%
  mutate(pc.unchanged = (!is.day.pc.changed)) -> x

DT::datatable(x)

x %>%
  group_by(animal, days.diff) %>%
  dplyr::summarise(pct.unchanged=sum(pc.unchanged) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=days.diff, y=pct.unchanged, color=animal, group=animal))
```

How many place cells kept their field
```{r}
max.moved.dist = 10

pc.change.df2 = filter(pc.change.df, days.diff <= 4)
pc.change.df2$days.diff = as.factor(pc.change.df2$days.diff)
pc.change.df2 %>%
  filter(n > 1) %>%
  filter(max.day.pc > 0) %>%
  filter(same_rew_loc) %>%
  filter(!is.day.pc.changed) %>%
  ggplot() +
  geom_violin(aes(x=days.diff, y=field.xy.dist, color=animal))
```


# Distance of place fields to goal
```{r}

rewards.df = data.table(rewards.df)
calc.min.rew.dist = function(day, animal_name, field.x, field.y) {
  rews = rewards.df[date==day & animal == animal_name, ]
  dist1 = norm2(rews$trans_x[1] - field.x, rews$trans_y[1] - field.y)
  dist2 = norm2(rews$trans_x[2] - field.x, rews$trans_y[2] - field.y)
  return(min(dist1, dist2))
}

pc.rew.dist.df = merged.run.trials.pc %>%
  filter(!is.na(location_set), is.day.pc) %>%
  ddply(.(date, animal, cell_id), mutate, 
        #min.rew.dist=calc.min.rew.dist(date[1], animal[1], field.centre.x[1], field.centre.y[1]))
        min.rew.dist=calc.min.rew.dist(date[1], animal[1], field.max.x[1], field.max.y[1]))

ggplot(pc.rew.dist.df) +
  geom_violin(aes(x=date, y=min.rew.dist)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('') + ylab('Field dist from reward')
  
```
Pct of place cells within goal - to be infromative should compare with early trials or with habituation?
```{r}
pc.rew.dist.df %>%
  mutate(is.goal.cell = min.rew.dist < 15) %>%
  group_by(date, animal) %>%
  dplyr::summarise(pct.goal = sum(is.goal.cell) / n() * 100) -> goal.cells.df

mean(goal.cells.df$pct.goal)
sem(goal.cells.df$pct.goal)

goal.cells.df %>%
  ggplot() +
  geom_point(aes(x=date, y=pct.goal)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab('') + ylab('Goal cells (% of place cells)')
```

