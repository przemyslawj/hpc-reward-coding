  ---
title: "Analysis of place field stability within sessions on the same day"
output: html_notebook
---


```{r}
library(dplyr)
library(plyr)
library(pracma)
library(readr)
library(tidyr)
library(tibble)
library(stringr)
library(DT)
library(data.table)
library(permute)
#library(doParallel)
#library(foreach)
library(tictoc)

library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() +
  theme(text = element_text(size=18), axis.text = element_text(size=15))

summarise = dplyr::summarise
summarize = dplyr::summarize

source('locations.R')
source('place_field.R')
source('trace_utils.R')

```


# Assess place information metrics and stability

```{r}
run.trials.si %>%
  ggplot() +
  geom_histogram(aes(x=spatial.information, color=signif.mi)) +
  facet_grid(. ~ animal) +
  xlab('Spatial information')
```


Odd vs even
```{r}
bind_rows(odd.trials.si, even.trials.si) %>%
  group_by(date, animal, cell_id) %>%
  dplyr::summarise(si.change=diff(mutual.info - mutual.info.bias)) -> pf.diff.df

pf.diff.df %>%
  ggplot() +
  geom_violin(aes(x=date, y=si.change)) +
  geom_hline(aes(yintercept=0), linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Mutual information diff (bits/s)')
```

# Within day comparison of place fields

First half vs second half
```{r}
bind_rows(early.trials.si, late.trials.si) %>%
  group_by(date, animal, cell_id, signif.si) %>%
  dplyr::summarise(si.change=pairdiff(spatial.information)) -> pf.diff.df

pf.diff.df %>%
  ggplot() +
  geom_violin(aes(x=date, y=si.change)) +
  geom_hline(aes(yintercept=0), linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Spatial information diff (bits/s)')
```

Calculate stats for changes between odd and even trials
```{r}
max.xy = getNBinsXY()
all.days = unique(run.trials.si$date) %>% as.Date

compare.day.trials = function(day.trials.comparison, fields1, fields2, occupancies1, occupancies2) {
  pc.change.df = data.frame()
  day.trials.comparison = data.table(day.trials.comparison)
  for (i in 1:length(all.days)) {
    day = all.days[i]
    df = day.trials.comparison[date==format(day),]
    for (animal_name in unique(df$animal)) {
      day.trials = df[animal == animal_name, ] %>%
          arrange(animal, cell_id, group)
      day.trials %>%
        group_by(animal, cell_id) %>% 
        dplyr::summarise(spatial.info.mean = mean(spatial.information),
                         spatial.info.min = min(spatial.information),
                         spatial.info.diff = pairdiff(spatial.information),
                         field.centre.x.diff = pairdiff(field.centre.x, 100),
                         field.centre.y.diff = pairdiff(field.centre.y, 100),
                         field.size.diff = pairdiff(field.size.50, 100),
                         field.size.mean = mean(field.size.50),
                         field.size.max = max(field.size.50),
                         field.max.diff = pairdiff(field.max, 0),
                         field.max.mean = mean(field.max),
                         signif.si.mean = mean(signif.si),
                         mutual.info.mean = mean(mutual.info),
                         mutual.info.min = min(mutual.info),
                         mutual.info.diff = pairdiff(mutual.info),
                         mutual.info.wo.bias.mean = mean(mutual.info - mutual.info.bias),
                         mutual.info.wo.bias.min = min(mutual.info - mutual.info.bias),
                         mutual.info.wo.bias.diff = pairdiff(mutual.info - mutual.info.bias),
                         signif.mi.mean = mean(signif.mi),
                         date=day,
                         n=n()) %>%
        mutate(field.xy.dist = norm2(field.centre.x.diff, field.centre.y.diff)) %>%
        select(-field.centre.x.diff, -field.centre.y.diff)-> pc.change
      
      pc.change = data.table(pc.change)
      setkey(pc.change, date, animal, cell_id)
      cells = unique(day.trials$cell_id)
      pc.change$field.cor = rep(0, length(cells))
      for (cell_name in cells) {
        m1 = fields1[[animal_name]][[format(day)]][[paste(cell_name)]]
        m2 = fields2[[animal_name]][[format(day)]][[paste(cell_name)]]
        o1 = occupancies1[[animal_name]][[format(day)]][[paste(cell_name)]]
        o2 = occupancies2[[animal_name]][[format(day)]][[paste(cell_name)]]
        
        max.zscore = max(max(m1), max(m2))
        
        cor.res = field.cor(create.pf.df(m1, o1, max.xy=max.xy), 
                            create.pf.df(m2, o2, max.xy=max.xy),
                            max.xy=max.xy)
        pc.change[date==day & animal==animal_name & cell_id==cell_name,]$field.cor = cor.res$cor
      }
      
      pc.change.df = bind_rows(pc.change.df, pc.change)
    }
  }
  pc.change.df$date = as.character(pc.change.df$date)
  return(pc.change.df)
}


odd.trials.si$group = 'odd'
even.trials.si$group = 'even'
odd.even.trials = bind_rows(odd.trials.si, even.trials.si)
odd.even.comparison = compare.day.trials(odd.even.trials, odd.fields, even.fields, odd.occupancies, even.occupancies) 

early.trials.si$group = 'early'
late.trials.si$group = 'late'
early.late.trials = bind_rows(early.trials.si, late.trials.si)
early.late.comparison = compare.day.trials(early.late.trials, early.fields, late.fields, early.occupancies, late.occupancies) 

odd.even.comparison$group = 'odd vs even'
early.late.comparison$group = 'early vs late'
```

Do cells with signif spatial information retain their field from early to late trials?
```{r}
day.comparison = bind_rows(odd.even.comparison, early.late.comparison)
day.comparison$signif.si.factor = as.factor(day.comparison$signif.si.mean)
day.comparison$signif.mi.factor = as.factor(day.comparison$signif.mi.mean)
g.day.stability = day.comparison %>%
  filter(signif.mi.mean > 0) %>% 
  filter(field.size.max < 5) %>%
  filter(date=='2019-08-27' | date == '2019-09-02') %>%
  mutate(is.signif = signif.mi.mean  == 1,
         is.nearby = field.xy.dist < 10) %>%
  #ggplot(aes(x=spatial.info.min, y=field.xy.dist, color=signif.si.factor)) +
  ggplot(aes(x=mutual.info.wo.bias.min, y=field.xy.dist, color=signif.mi.factor)) +
  geom_point(alpha=0.3, size=1) +
  geom_rug(aes(color=signif.mi.factor), alpha=0.3) +
  #geom_vline(xintercept=si.thresh, linetype='dashed') +
  #geom_hline(yintercept=field.min.cor, linetype='dashed') +
  #geom_hline(yintercept=10, linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = -90, hjust = 1)) +
  facet_grid(date ~ group) +
  xlab('Min mutual information (bits/s)') +
  ylab('Shift of the place field peak  (%)') +
  labs(color='Day-stable\nplace cell', title='Early vs Late, Odd vs Even')
g.day.stability
ggsave(file.path(gen_imgs_dir, 'pc_stability-even_odd.jpg'), g.day.stability,
       width = 14, height = 10, units = 'cm')
```


```{r}

day.comparison.mean = bind_rows(odd.even.comparison, early.late.comparison) %>%
  group_by(date, animal, cell_id) %>%
  dplyr::summarise(m.field.cor=mean(field.cor),
                   m.field.size.diff=mean(field.size.diff),
                   m.field.size=mean(field.size.mean),
                   m.field.max=mean(field.max.mean),
                   m.field.xy.dist=mean(field.xy.dist),
                   m.spatial.info.diff=mean(spatial.info.diff),
                   m.spatial.info=mean(spatial.info.mean),
                   m.signif.si=mean(signif.si.mean),
                   m.mutual.info=mean(mutual.info.mean),
                   m.mutual.info.wo.bias=mean(mutual.info.wo.bias.mean),
                   m.signif.mi=mean(signif.mi.mean))
```


Classify place cells based on stability between odd vs even, early vs late sessions.

```{r}
si.thresh = 0.2
mi.thresh = 0.2
field.size.thresh = 10
field.peak.thresh = 0.1
field.min.cor = 0.2

# Classification of place cells based on SI on each subset of day sessions
day.comparison.mean = day.comparison.mean %>%
  mutate(is.day.pc = m.signif.mi > 0.5 & 
           m.mutual.info.wo.bias >= mi.thresh &
           m.field.xy.dist <= 20 &
           m.field.size <= field.size.thresh &
           m.field.max >= field.peak.thresh,
           #m.field.cor >= field.min.cor) 
         is.halfday.pc = m.signif.mi >= 0.5 &
           m.mutual.info.wo.bias >= mi.thresh &
           m.field.size <= field.size.thresh &
           m.field.max >= field.peak.thresh)

place.cell.db = day.comparison.mean %>%
  select(date, animal, cell_id, is.day.pc, is.halfday.pc) %>%
  ungroup()

run.trials.si.field = day.comparison.mean %>%
  left_join(run.trials.si, by=c('animal', 'date', 'cell_id'))


# Classification of sells based on SI for all day
# run.trials.pc = run.trials.si.field %>%
#   mutate(is.place.cell = signif.si & 
#            spatial.information >= si.thresh &
#            field.size <= field.size.thresh &
#            field.max >= field.max.thresh &
#            m.field.cor >= field.min.cor) 
# 
# place.cell.db = run.trials.pc %>%
#   select(date, animal, cell_id, is.place.cell)

run.trials.pc = run.trials.si.field
```


Correlation betwen field correlations and spatial information during the day
```{r}

#run.trials.pc  %>%
#  ggplot(aes(x=spatial.information, y=m.field.cor, color=is.place.cell)) +
day.comparison.mean  %>%
  #mutate(si.signif = m.signif.si > 0.5) %>%
  mutate(mi.signif = m.signif.mi > 0.5) %>%
  ggplot(aes(x=m.mutual.info.wo.bias, y=m.field.cor, color=is.day.pc)) +
  geom_point(alpha=0.2, size=1) +
  geom_rug(col=rgb(.5,0,0,alpha=.009)) +
  #geom_vline(xintercept=si.thresh, linetype='dashed') +
  geom_hline(yintercept=field.min.cor, linetype='dashed') +
  gtheme +
  facet_grid(. ~ mi.signif) +
  xlab('Mean spatial information (bits/s)') +
  ylab('Correlation of place field\nbetween trials') +
  labs(color='Place cell', title='Significant MI')

ggsave(file.path(gen_imgs_dir, 'pc_choice.jpg'),
       width = 14, height = 10, units = 'cm')
```



## How many place cells per day
```{r}
run.trials.si.field %>%
  group_by(date, animal) %>%
  dplyr::summarise(pc.pct = sum(is.day.pc) / n() * 100, 
                   half.pc.pct = sum(is.halfday.pc) / n() * 100) %>%
  ggplot() +
  geom_line(aes(x=date, y=pc.pct, group=animal, color='black')) +
  geom_line(aes(x=date, y=half.pc.pct, group=animal, color='red')) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_discrete(name='Place cell stability', labels = c('Full day', 'Half day')) +
  xlab('Date') + 
  ylab('Place cells (%)')

ggsave(file.path(gen_imgs_dir, 'pc_count.jpg'),
       width = 14, height = 10, units = 'cm')
```


# Change of place fields and statistics across days

Load reward locations
```{r}
locations.rootdir = "/mnt/DATA/Prez/cheeseboard/2019-08/"
rewards.df = read_locations(locations.rootdir) %>%
  filter(!is_test) %>%
  dplyr::rename(animal=Animal)
  
locations.df = rewards.df %>%
  select(date, animal, location_set) %>%
  dplyr::distinct()

locations.df = data.table(locations.df)
setkey(locations.df, date, animal)
```



