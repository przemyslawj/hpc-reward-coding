---
title: "R Notebook"
output: html_notebook
---

```{r}
library(dplyr)
library(data.table)
library(datatrace)
library(permute)

source('distances.R')
source('traces_input.R')
source('locations.R')
source('plotting_params.R')
source('fixed_effects.R')
source('utils.R')

```

```{r}
#subset.caimg_result_dirs = caimg_result_dirs[shuffle(caimg_result_dirs)[1:3]]
subset.caimg_result_dirs = caimg_result_dirs

mouse.meta.df = read.mouse.meta(rootdirs)
trials.meta.df = read.trials.meta(rootdirs)
all.locations.df = map_dfr(rootdirs, read_locations)
rewards.df =  all.locations.df %>%
  filter(!is_test) %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('date', 'animal', 'location_set'))
```



```{r}
xybins = 20
nbins = 20
cheeseboard.bin.cm = 120 / xybins

get.max.thr  = function(max.fraction=0.25) {
  function(vals) {  
    max.val = max(c(vals), na.rm = TRUE)
    c( max.val* max.fraction, max.val+1) 
  }
}

get.nvenent.thr = function(min.nevents=0.1) {
  function(vals) { c(min.nevents, max(vals) + 1)}
}

prepare.traces = function(data.traces,
                          binned.var='nevents',
                          get.bin.thresholds.fun,
                          filter.running=TRUE,
                          timebin.dur.msec=200) {
  data.traces$date = rep(char2date(data.traces$date[1]), nrow(data.traces))
  setorder(data.traces, exp_title, trial_id, cell_id, timestamp)
  detect.events(data.traces, deconv.threshold=0.2)
  # running speed avg > 4 cm/s in 0.5 s window
  data.traces = add.running.col(data.traces, 3.3, 10)
  data.traces = gauss.smooth.df.var(data.traces, filter.len=20, sigma=5.0)
  data.traces[, `:=` (zscored_deconv_trace = zscore(deconv_trace), 
                      zscored_trace = zscore(trace),
                      zscored_smooth_deconv_trace = zscore(smoothed_deconv_trace)),
              by=.(exp_title, cell_id)]
  
  if (filter.running) {
    running.index = isRunning(data.traces, 2, 4, 500) 
    data.traces.filtered = data.traces[ x > 0 & y > 0 & is_running, ]
  } else {
    data.traces.filtered = data.traces[x > 0 & y > 0,]
  }
  
  date_str = format(data.traces$date[1])
  animal_name = data.traces$animal[1]

  binned.traces = bin.time.space(data.traces.filtered,
                                 nbins.x = xybins,
                                 nbins.y = xybins,
                                 #get.bin.thresholds.fun = get.quantiles.fun(c(0.9, 1.0)),
                                 #get.bin.thresholds.fun = get.quantiles.fun(c(quantile.fractions)),
                                 #get.bin.thresholds.fun = get.max.thr(0.15),
                                 get.bin.thresholds.fun = get.bin.thresholds.fun,
                                 binned.var=binned.var,
                                 timebin.dur.msec=timebin.dur.msec)
  return(binned.traces)
}

many.cells.animals = c('E-BL', 'E-TR', 'F-BL', 'F-TL', 'C-1R', 'D-BR', 'G-BR', 'K-BR')

discrete.bayes.spatial.decoder = list(
  stim.var=quo(bin.xy),
  value.var=quo(response_bin),
  nstim.bins=xybins^2,
  train.fun = create.discrete.bayes,
  predict.fun = bayesmax,
  error.fun=bin.distance.error(xybins, xybins)
)

mfr.bayes.spatial.decoder = list(
  stim.var=quo(bin.xy),
  value.var=quo(smoothed_deconv_trace),
  nstim.bins=xybins^2,
  train.fun = create.mfr.bayes,
  predict.fun = bayesmax_mfr,
  error.fun=bin.distance.error(xybins, xybins)
)
```

```{r}
eval.decoder.same.day = function(caimg_result_dir, 
                                 decoder.config, 
                                 prepare.vars.fun=NULL,
                                 filter.test.traces.fun=NULL,
                                 min.samples=10,
                                 ncells=30, # If ncells == 0, take all cells
                                 nshuffles=20,
                                 exp_title='trial') {
  
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = exp_title)
  binned.traces = prepare.traces(data.traces, 
                                 binned.var='zscored_trace',
                                 get.bin.thresholds.fun = get.quantiles.fun(c(0.9, 1.0)),
                                 timebin.dur.msec = 200)
  if (nrow(binned.traces) == 0) {
    return(data.frame())
  } 
  
  print('Started evaluating the model')
  if (!is.null(prepare.vars.fun)) {
    binned.traces = prepare.vars.fun(binned.traces)
  }
  cell_ids = binned.traces$cell_id %>% unique
  
  all.shuffles.eval.res = map_dfr(1:nshuffles, function(j) {
    subset.traces = binned.traces
    if (ncells > 0) {
      cell_ids = cell_ids[shuffle(cell_ids)]
      subset.traces = binned.traces[cell_id %in% cell_ids[1:min(ncells, length(cell_ids))],]
    }
    
    eval.df = eval.decoder(subset.traces,
                           nstim.bins=decoder.config$nstim.bins,
                           stim.var=!!decoder.config$stim.var,
                           error.fun=decoder.config$error.fun,
                           train.fun=decoder.config$train.fun,
                           predict.fun=decoder.config$predict.fun,
                           value.var=!!decoder.config$value.var,
                           cv=TRUE,
                           min.samples=min.samples,
                           filter.test.traces.fun=filter.test.traces.fun)

    if (nrow(eval.df) > 0) {
      eval.df$animal = binned.traces$animal[1]
      eval.df$date = binned.traces$date[1]
      eval.df$shuffle = j
    }
    eval.df
  })
  
  return(all.shuffles.eval.res)
}


scale.bins2cm = function(decoding.df) {
  decoding.df$error = decoding.df$error * cheeseboard.bin.cm
  if ('random_error' %in% names(decoding.df)) {
    decoding.df$random_error = decoding.df$random_error * cheeseboard.bin.cm
  }
  return(decoding.df)
}

join.meta.dfs = function(df) {
  df = left_join(df, mouse.meta.df, by='animal') %>%
    left_join(trials.meta.df, by=c("animal", "date"))
  df$day_desc = as.factor(df$day_desc)
  return(df)
}

```


# Spatial decoder evaluation
#Evaluate same day on learning and habituation 
```{r}
eval.parts = list()
for (caimg_result_dir in subset.caimg_result_dirs) {
  eval.parts[[caimg_result_dir]] = eval.decoder.same.day(
    caimg_result_dir, 
    decoder.config=discrete.bayes.spatial.decoder,
    min.samples=10,
    ncells=30,
    nshuffles=20)
}

spatial.error.df = do.call('rbind', eval.parts)
spatial.error.df = scale.bins2cm(spatial.error.df) %>% join.meta.dfs()
```

Utility functions for summarising and plotting the errors
```{r}
create.error.summary = function(df, ...) {
  grouping.vars = enquos(...)
  df %>%
    group_by(!!!grouping.vars) %>%
    dplyr::summarise(median.error=median(error),
                     sem.error=sem(error),
                     median.random.error=median(random_error),
                     mean(random_error),
                     sem.random.error=sem(random_error)) %>%
    dplyr::mutate(error.fraction = median.error / median.random.error)
}

group.error.summary = function(df, ...) {
  grouping.vars = enquos(...)
  df %>%
    group_by(!!!grouping.vars) %>%
    dplyr::summarise(mean(median.error),
                     sem(median.error),
                     mean(median.random.error),
                     sem(median.random.error))
}

g.eval.animal.summary = function(error.summary) {
  ggplot(error.summary, aes(x=day_desc, y=median.error, group=animal, color=implant)) +
    geom_errorbar(aes(ymin=median.error-sem.error, ymax=median.error+sem.error), width=0.2) +
    gtheme +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab('Median error (cm)') + xlab('')
}
```

```{r spatial_error}
spatial.error.summary = create.error.summary(spatial.error.df, implant, animal, day_desc) 

group.error.summary(
  spatial.error.summary,
  implant)

spatial.error.summary %>%
  g.eval.animal.summary()
```

## Eval the spatial decoder excluding places at the reward
```{r}
bin.size = 100 / nbins
min.rew.dist.thresh = 15
spatial.error.df = spatial.error.df %>%
  group_by(implant, animal, date) %>%
  dplyr::mutate(actual.binx=from_1dim(actual.bin.xy, nbins)$x,
                actual.biny=from_1dim(actual.bin.xy, nbins)$y,
                min.rew.dist=calc.min.rew.dist(filter.rews.df(rewards.df, date[1], animal[1]),
                                               # translate bins to 0-100 coordinates, centre in the middle of the bin
                                               (actual.binx + 0.5) * bin.size,
                                               (actual.biny + 0.5) * bin.size)$rew.dist,
                is.close2rew = min.rew.dist <= min.rew.dist.thresh)
```

```{r}
spatial.error.rewdiff.summary = filter(spatial.error.df, !is.na(is.close2rew)) %>%
  #create.eval.summary(implant, animal, day_desc, is.close2rew) %>%
  create.error.summary(implant, animal, day_desc, is.close2rew) %>%
  dplyr::mutate(close2rew.errorname = ifelse(is.close2rew, 'close2rew.error', 'far2rew.error')) %>%
  reshape2::dcast(implant + animal + day_desc ~ close2rew.errorname, value.var='median.error') %>% 
  dplyr::mutate(median.error.diff = close2rew.error - far2rew.error )
```

Decoding error is lower at reward than further away, but also sampling is lower there, so it's a natural weaker spot of the decoder.
```{r}
ggplot(spatial.error.rewdiff.summary, aes(x=day_desc, y=median.error.diff, group=implant, color=implant)) +
  geom_point(position=position_dodge(width=0.5)) +
  gtheme +
  geom_hline(yintercept = 0, linetype='dashed') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Median error at reward - away from reward (cm)') + xlab('')
```
Is the decoding out of reward constant over days? No, seems a bit better with time.
```{r}
filter(spatial.error.df, !is.close2rew) %>%
  create.error.summary(implant, animal, day_desc) %>%
  g.eval.animal.summary()
```

## Eval beforetest trials
```{r}
eval.parts = list()
for (caimg_result_dir in test_caimg_dirs) {
  eval.parts[[caimg_result_dir]] = eval.decoder.same.day(
    caimg_result_dir, 
    decoder.config=discrete.bayes.spatial.decoder,
    min.samples=5,
    ncells=ncells,
    nshuffles=nshuffles,
    exp_title='beforetest')
}

beforetest.spatial.error.df = do.call('rbind', eval.parts)
beforetest.spatial.error.df = beforetest.spatial.error.df %>% 
  scale.bins2cm %>%
  join.meta.dfs()
```

```{r}
beforetest.error.summary = create.error.summary(beforetest.spatial.error.df, implant, animal, day_desc)

compare.decoding.error = function(error.summary) {
  error.model = lmerTest::lmer(error.fraction ~ implant + (1 | animal), 
                               #median.error ~ implant + (1 | animal), 
                               data=error.summary,
                               REML=TRUE)
  print(summary(error.model))
  print(anova(error.model, refit=FALSE, ddf='Satterthwaite'))
  g = plot.model.diagnostics(error.model, error.summary$animal, error.summary$implant)
  print(g)
  print(lsmeansLT(error.model))
  return(error.model)
}
habit.error.summary = filter(spatial.error.summary, str_starts(day_desc, 'habituation'))
print('Compare spatial decoder for habituation')
compare.decoding.error(habit.error.summary)

learning.error.summary = filter(spatial.error.summary, str_starts(day_desc, 'learning'))
print('Compare spatial decoder for learning')
compare.decoding.error(learning.error.summary)

print('Compare spatial decoder for beforetest')
compare.decoding.error(beforetest.error.summary)

group.error.summary(
   beforetest.error.summary,
     implant)
```


## Eval on the next day
```{r}
# Evaluates the decoders against the test data in caimg_result_dir, create and append a model for the current dir
eval.decoder.other.day = function(caimg_result_dir, 
                                  decoder.config,
                                  trials.meta.df,
                                  models,
                                  prepare.vars.fun=NULL,
                                  filter.training.trace.fun=NULL,
                                  exp_title='trial',
                                  max.days.diff=2,
                                  binned.varname='zscored_trace') {
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = exp_title)
  date_str = format(char2date(data.traces$date[1]))
  animal_name = data.traces$animal[1]
  
  eval.dfs = data.frame()
  binned.traces = prepare.traces(data.traces,
                                 filter.running=TRUE,
                                 timebin.dur.msec = 200,
                                 #get.bin.thresholds.fun = get.nvenent.thr(0.1),
                                 get.bin.thresholds.fun = get.quantiles.fun(c(0.9, 1.0)),
                                 binned.var=binned.varname)
  
  if (!is.null(prepare.vars.fun)) {
    binned.traces = prepare.vars.fun(binned.traces)
  }
  
  for (model_date in names(models[[animal_name]])) {
    model.date.ordinal = filter(trials.meta.df, animal==animal_name, date==model_date) %>% pull(exp_day_ordinal)
    test.date.ordinal = filter(trials.meta.df, animal==animal_name, date==date_str) %>% pull(exp_day_ordinal)
    exp.days.diff = test.date.ordinal - model.date.ordinal
    if (exp.days.diff <= max.days.diff) {
      tested_model = models[[animal_name]][[model_date]]
      model.visited = which(tested_model$prior > 0)
      binned.traces.filtered = binned.traces[get(quo_name(decoder.config$stim.var)) %in% model.visited,]
      system.time(eval.res <- eval.testdata2(binned.traces.filtered, 
                                             tested_model, 
                                             predict.fun=decoder.config$predict.fun,
                                             error.fun=decoder.config$error.fun,
                                             stim.var=!!decoder.config$stim.var,
                                             nstim.bins=decoder.config$nstim.bins,
                                             value.var=!!decoder.config$value.var))
      if (nrow(eval.res$df) > 0) {
        random.classifier.res <- eval.testdata2(binned.traces.filtered, 
                                                tested_model, 
                                                predict.fun=random.prior.classifier,
                                                error.fun=decoder.config$error.fun,
                                                stim.var=!!decoder.config$stim.var,
                                                nstim.bins=decoder.config$nstim.bins,
                                                value.var=!!decoder.config$value.var)

        eval.res$df$random_error = random.classifier.res$df$error
        eval.res$df$test_date = as.Date(date_str)
        eval.res$df$model_date = as.Date(model_date)
        eval.res$df$animal = animal_name
        eval.res$df$exp_days_diff = exp.days.diff
        eval.dfs = bind_rows(eval.dfs, eval.res$df)
      }
    }
  }
  
  filtered.dfs = filter.sampled(binned.traces, binned.traces[1,], min.samples=10)
  if (!is.null(filter.training.trace.fun)) {
    filtered.dfs$train = filter.training.trace.fun(filtered.dfs$train)  
  }
  if (nrow(filtered.dfs$train) > 0) {
    models[[animal_name]][[format(date_str)]] = decoder.config$train.fun(
          filtered.dfs$train, 
          nstim.bins=decoder.config$nstim.bins,
          value.var=!!decoder.config$value.var,
          stim.var=!!decoder.config$stim.var)
  }
  return(list(df=eval.dfs, models=models))
}
```

```{r}
otherday.decoding.df = data.frame()
models = list()
#sample.caimg_result_dirs = c(caimg_result_dirs[1:5], caimg_result_dirs[50:55])

for (caimg_result_dir in caimg_result_dirs) {
  eval.res = eval.decoder.other.day(caimg_result_dir, 
                                    discrete.bayes.spatial.decoder,
                                    trials.meta.df,
                                    models,
                                    binned.varname = 'zscored_trace')
  models = eval.res$models
  otherday.decoding.df = bind_rows(otherday.decoding.df, eval.res$df)
}

otherday.decoding.df = scale.bins2cm(otherday.decoding.df) %>% 
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('animal', 'test_date'='date'), suffix=c('', '.test')) %>%
  left_join(trials.meta.df, by=c('animal', 'model_date'='date'), suffix=c('', '.model'))
```

```{r}
otherday.decoding.df = data.table(otherday.decoding.df)

data.table(otherday.decoding.df)[exp_days_diff==1,
                                 .(med.error=median(error), med.random.error=median(random_error), .N), 
                                 by=c('implant','animal', 'day_desc.model')][,
                                   .(median(med.error), sem(med.error), median(med.random.error)), by=c('implant', 'day_desc.model')]

data.table(otherday.decoding.df)[exp_days_diff==1,
                                 .(med.error=median(error), med.random.error=median(random_error), .N), 
                                 by=c('implant','animal', 'day_desc.model')][,
                                   .(median(med.error), sem(med.error), median(med.random.error)), by=c('implant')]

```

Plot of decoding summary
```{r}
otherday.eval.summary = otherday.decoding.df %>%
  filter(exp_days_diff==1) %>%
  group_by(implant, day_desc.model, animal) %>%
  dplyr::summarise(mean.error=mean(error),
                   median.error=median(error),
                   sd.error=sd(error),
                   sem.error=sem(error),
                   median.random.error=median(random_error))

ggplot(otherday.eval.summary, aes(x=day_desc.model, y=median.error, group=animal, color=implant)) +
  #geom_point() +
  geom_errorbar(aes(ymin=median.error-sem.error, ymax=median.error+sem.error), width=0.2) +
  geom_point(aes(y=median.random.error), color='black') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Median error (cm)') + xlab('Trained day')
```

### Beforetest spatial decoding
```{r}
beforetest.otherday.spatial.decoding.df = data.frame()
models = list()
for (caimg_result_dir in test_caimg_dirs) {
  eval.res = eval.decoder.other.day(caimg_result_dir, 
                                    bayes.spatial.decoder.config,
                                    trials.meta.df,
                                    models,
                                    #filter.training.trace.fun = filter.beforetest.pcs,
                                    max.days.diff = 6,
                                    binned.varname = 'zscored_smooth_deconv_trace')
  models = eval.res$models
  beforetest.otherday.spatial.decoding.df = bind_rows(beforetest.otherday.spatial.decoding.df, eval.res$df)
}

beforetest.otherday.spatial.decoding.df = beforetest.otherday.spatial.decoding.df %>%
  scale.bins2cm() %>% 
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('animal', 'test_date'='date'), suffix=c('', '.test')) %>%
  left_join(trials.meta.df, by=c('animal', 'model_date'='date'), suffix=c('', '.model'))
```

```{r}
create.error.summary(beforetest.otherday.spatial.decoding.df, implant)
```




Is prediction worse after translocated the reward?
```{r}
tapply(otherday.eval.summary$median.error, otherday.eval.summary$implant, summary)

learning15.eval.sum = subset(otherday.eval.summary, day_desc.model=='learning1 day#5')
tapply(learning15.eval.sum$median.error, learning15.eval.sum$implant, summary)

learning21.eval.sum = subset(otherday.eval.summary, day_desc.model=='learning2 day#1')
tapply(learning21.eval.sum$median.error, learning21.eval.sum$implant, summary)
```


## Prediction error at reward
```{r}
rewards.df = data.table(rewards.df)
setkey(rewards.df, date, animal)

min.rew.dist = function(day, animal_name, bin.xy) {
  rews = rewards.df[date==day & animal == animal_name, ]
  if (nrow(rews)==0) {
    return(list(location.ordinal=0, rew.dist=NA))
  }
  trans.xy = from_1dim(bin.xy, nbins)
  bin.size = 100 / nbins
  trans.xy$x = trans.xy$x * bin.size
  trans.xy$y = trans.xy$y * bin.size
  
  dist1 = norm2(rews$trans_x[1] - trans.xy$x, rews$trans_y[1] - trans.xy$y)
  dist2 = norm2(rews$trans_x[2] - trans.xy$x, rews$trans_y[2] - trans.xy$y)
  min.i = as.integer(dist2 < dist1) + 1
  return(list(location.ordinal=rews$location_ordinal[min.i],
              rew.dist=ifelse(min.i==1, dist1, dist2)))
}

short.decoding.df = spatial.error.df %>%
  group_by(date, day_desc, implant, animal) %>%
  dplyr::mutate(actual.rew.dist=min.rew.dist(date[1], animal[1], actual.bin.xy)$rew.dist,
                actual.rew.ordinal=min.rew.dist(date[1], animal[1], actual.bin.xy)$location.ordinal,
                pred.rew.dist=min.rew.dist(date[1], animal[1], bin.xy)$rew.dist,
                pred.rew.ordinal=min.rew.dist(date[1], animal[1], bin.xy)$location.ordinal)
```
Higer error at the reward- maybe doesn't disambiguate
```{r}
short.decoding.df %>%
  filter(actual.rew.dist <= 15) %>%
  ggplot() +
  #geom_point(aes(x=actual.rew.dist / 5, y=error), alpha=0.1) +
  geom_violin(aes(x=day_desc, y=error)) +
  facet_grid(. ~ implant) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='', y='Decoding error (cm)')
```

For the locations at reward, how many were predicted to be at the other reward?
vCA1 encoding 50 % times incorrect on learning1 day#4 and day#5

```{r}
short.decoding.df %>%
  filter(actual.rew.dist <= 15) %>%
  left_join(trials.meta.df) %>%
  left_join(mouse.meta.df) %>%
  dplyr::mutate(wrong.rew.loc = (actual.rew.ordinal != pred.rew.ordinal) & (pred.rew.dist <= 25),
                correct.rew.loc = actual.rew.ordinal == pred.rew.ordinal) %>%
  group_by(implant, animal, day_desc) %>%
  dplyr::summarise(pct.wrong.rew=sum(wrong.rew.loc)/n(),
                   pct.correct.rew=sum(correct.rew.loc)/n()) %>%
  ggplot() +
  geom_point(aes(x=day_desc, y=pct.wrong.rew, color='incorrect rew')) +
  geom_point(aes(x=day_desc, y=pct.correct.rew, color='correct rew')) +
  facet_grid(. ~ implant) +
  geom_hline(yintercept=0.5, linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Decoding accuracy')
```

# At reward Decoder

## Eval for same day learning and habituation
```{r}
nshuffles=20
ncells=30
min.rew.dist.thresh = 15
vca1.animals = subset(mouse.meta.df, implant=='vCA1')$animal %>% as.character()

bayes.atreward.decoder.config = list(
  stim.var = quo(close2rew),
  value.var = quo(response_bin),
  nstim.bins = 2,
  train.fun = create.discrete.bayes,
  predict.fun = bayesmax,
  error.fun = function(x,y) {abs(x-y)}
)

add.close2rew.var = function(data.trace) {
  data.trace[, close2rew := as.integer((dist_reward0 <= min.rew.dist.thresh | dist_reward1 <= min.rew.dist.thresh)) + 1]  
}

eval.parts = lapply(subset.caimg_result_dirs, eval.decoder.same.day, 
                    decoder.config=bayes.atreward.decoder.config,
                    prepare.vars.fun=add.close2rew.var,
                    min.samples=10,
                    ncells=ncells,
                    nshuffles=nshuffles)

close2rew.decoding.df = do.call('rbind', eval.parts) %>%
  join.meta.dfs()
```

```{r}
data.table(close2rew.decoding.df)[,.(incorrect.pct=mean(error), baseline.pct=mean(random_error)), by=c('animal','day_desc', 'implant')][,.(incorrect.pct=median(incorrect.pct), random.error.pct=median(baseline.pct)), by=c('implant', 'day_desc')]
data.table(close2rew.decoding.df)[day_desc=='learning1 day#5',.(incorrect.pct=mean(error), baseline.pct=mean(random_error)), by=c('implant','animal', 'day_desc')][,.(incorrect=median(incorrect.pct), em=sem(incorrect.pct), random=median(baseline.pct)), by='implant']
```

```{r}
eval.summary = close2rew.decoding.df %>%
  group_by(date, implant, day_desc, animal) %>%
  dplyr::summarise(incorrect.pct=mean(error),
                   random.pct=mean(random_error))

ggplot(eval.summary, aes(x=day_desc, group=implant, color=implant)) +
  geom_point(aes(y=(1-incorrect.pct) * 100), position = position_dodge(width = 0.5)) +
  #geom_point(aes(y=(1-random.pct) * 100), position = position_dodge(width = 0.5), shape=23) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Decoding accuracy') + xlab('')
```

## Eval beforetest trials
```{r}

mfr.bayes.atreward.decoder.config = list(
  stim.var = quo(close2rew),
  value.var = quo(smoothed_deconv_trace),
  nstim.bins = 2,
  train.fun = create.mfr.bayes,
  predict.fun = bayesmax_mfr,
  error.fun = function(x,y) {abs(x-y)}
)

eval.parts = list()
for (caimg_result_dir in test_caimg_dirs) {
  eval.parts[[caimg_result_dir]] = eval.decoder.same.day(
    caimg_result_dir, 
    decoder.config=mfr.bayes.atreward.decoder.config,
    prepare.vars.fun=add.close2rew.var,
    min.samples=5,
    ncells=ncells,
    nshuffles=nshuffles,
    exp_title='beforetest')
}

beforetest.close2rew.df = do.call('rbind', eval.parts)
beforetest.close2rew.df = beforetest.close2rew.df %>% 
  join.meta.dfs()
```

```{r}
beforetest.close2rew.df %>%
  group_by(implant) %>%
  dplyr::summarise(mean(error), sem(error), mean(random_error))

data.table(beforetest.close2rew.df)[,.(incorrect.pct=mean(error), baseline.pct=mean(random_error)), by=c('animal','day_desc', 'implant')][,.(incorrect.pct=median(incorrect.pct), random.error.pct=median(baseline.pct)), by=c('implant', 'day_desc')]
```


## Eval reward decoder on another day for beforetest trials
```{r}
beforetest.peaks.at.current.rew = as.data.table(beforetest.peaks.at.current.rew)
filter.beforetest.pcs = function(binned.trace) {
  beforetest_date = binned.trace$date[1]
  place_cell_ids = beforetest.peaks.at.current.rew[date == beforetest_date & 
                                                     animal == binned.trace$animal[1] & 
                                                     signif.si,
                                                   (cell_id)]
  binned.trace[cell_id %in% place_cell_ids, ]
}

otherday.rew.decoding.df = data.frame()
models = list()
for (caimg_result_dir in test_caimg_dirs) {
  eval.res = eval.decoder.other.day(caimg_result_dir, 
                                    bayes.atreward.decoder.config,
                                    trials.meta.df,
                                    models,
                                    prepare.vars.fun=add.close2rew.var, 
                                    filter.training.trace.fun = filter.beforetest.pcs,
                                    max.days.diff = 6,
                                    binned.varname = 'zscored_smooth_deconv_trace')
  models = eval.res$models
  otherday.rew.decoding.df = bind_rows(otherday.rew.decoding.df, eval.res$df)
}
otherday.rew.decoding.df = otherday.rew.decoding.df %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('animal'='animal', 'model_date'='date'), suffix=c('', '.model')) %>%
  left_join(trials.meta.df, by=c('animal'='animal', 'test_date'='date'), suffix=c('', '.test'))
```


```{r}
otherday.rew.decoding.summary = otherday.rew.decoding.df %>%
  group_by(animal, implant, day_desc.test, day_desc) %>%
  dplyr::summarise(incorrect.pct=mean(error),
                   random.pct=mean(random_error),
                   incorrect.random.diff = random.pct-incorrect.pct) 

otherday.rew.decoding.summary %>%
  group_by(implant) %>%
  dplyr::summarise(mean(incorrect.pct), 
                   sem(incorrect.pct),
                   mean(random.pct),
                   sem(random.pct),
                   n=n()) %>%
  dplyr::mutate_if(is.double, scales::percent, 1)

```
Is perforamnce better with learning?
```{r}
otherday.rew.summary15 = subset(otherday.rew.decoding.summary, day_desc=='learning1 day#5')
otherday.rew.summary21 = subset(otherday.rew.decoding.summary, day_desc=='learning2 day#1')

tapply(otherday.rew.summary15$incorrect.pct, otherday.rew.summary15$implant, summary)
tapply(otherday.rew.summary21$incorrect.pct, otherday.rew.summary21$implant, summary)

tapply(otherday.rew.summary15$incorrect.random.diff, otherday.rew.summary15$implant, summary)
tapply(otherday.rew.summary21$incorrect.random.diff, otherday.rew.summary21$implant, summary)
```


```{r}
otherday.rew.decoding.df %>%
  group_by(animal, implant, test_date, day_desc) %>%
  dplyr::summarise(incorrect.pct=mean(error)) %>%
  ggplot() +
  geom_point(aes(x=day_desc, y=(1-incorrect.pct) * 100, color=implant, group=implant), position=position_dodge(width=0.5)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Decoding accuracy') + xlab('Decoding day')
```



