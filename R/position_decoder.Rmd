---
title: "R Notebook"
output: html_notebook
---

```{r}
Rcpp::sourceCpp('trace_utils.cpp')

source('bayesian_decoder.R')
source('utils.R')

#timebinned.traces = timebin.traces(data.traces)
#binned.traces = bin.responses(timebinned.traces)
#eval.df = eval.decoder(binned.traces, cv=TRUE)
```



```{r}
xybins = 20
run.threshold = 2

prepare.traces = function(data.traces) {
  setorder(data.traces, trial_id, cell_id, timestamp)
  detect.events(data.traces, deconv.threshold=0.1)
  
  running.index = isRunning(data.traces, 2, 3, 500) 
  data.traces.run = data.traces[which(running.index), ]

  date_str = data.traces$date[1]
  animal_name = data.traces$animal[1]
  ## Keep only place cells or daystable cells
  #pc.cells = subset(place.cell.db, animal==animal_name & date==date_str & is.pc)$cell_id
  #stable.cells = subset(stable.cell.db, animal==animal_name & date==date_str & is.stable)$cell_id
  #data.traces.filtered = data.traces.run[cell_id %in% stable.cells, ]
  data.traces.filtered = data.traces.run
  
  timebinned.traces = timebin.traces(data.traces.filtered, timebin.dur.msec=200, xybins=20, trace.var=trace)
  quantile.fractions = c(0.95, 1.0)
  binned.traces = bin.responses(timebinned.traces, quantile.fractions)
  binned.traces = data.table(binned.traces)
  binned.traces[,bin.xy := to_1dim(bin.x, bin.y)]
  setorder(binned.traces, time_bin, cell_id)
  setkey(binned.traces, time_bin, cell_id)
  
  return(binned.traces)
}

eval.parts = lapply(caimg_result_dirs, function(caimg_result_dir) {
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = 'trial')
  binned.traces = prepare.traces(data.traces)
  if (nrow(data.traces.filtered) == 0) {
    return(data.frame())
  } else {
    print('Started evaluating the model')
    tic("Built and evaluated the model")
    eval.df = eval.decoder(binned.traces, length(quantile.fractions), cv=TRUE)
    if (nrow(eval.df) > 0) {
      eval.df$animal = binned.traces$animal[1]
      eval.df$date = binned.traces$date[1]
    }
    toc()
    
    eval.df
  }
})

decoding.df = do.call('rbind', eval.parts)
summary(decoding.df$error)
summary(decoding.df$random_error)
```

```{r}
eval.summary = decoding.df %>%
  group_by(date, animal) %>%
  dplyr::summarise(mean.error=mean(error),
                   median.error=median(error),
                   sd.error=sd(error),
                   sem.error=sem(error))

ggplot(eval.summary, aes(x=date,y=mean.error, group=animal, color=animal)) +
  #geom_point() +
  #geom_errorbar(aes(x=date, ymin=mean.error-sem.error, ymax=mean.error+sem.error), width=0.2)
  geom_errorbar(aes(x=date, ymin=median.error-sem.error, ymax=median.error+sem.error), width=0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Eval on the next day
```{r}
otherday.decoding.df = data.frame()

models = list()
dates = rep('', length(caimg_result_dirs))
animal_names = rep('', length(caimg_result_dirs))
for (i in 1:length(caimg_result_dirs)) {
  caimg_result_dir = caimg_result_dirs[i]
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = 'trial')
  dates[i] = data.traces$date[i]
  animal_names[i] = data.traces$animal[i]
  binned.traces = prepare.traces(data.traces)
  if (i > 1 && animal_names[i] == animal_names[i-1]) {
    model.visited = which(models[[i-1]]$prior > 0)
    binned.traces.filtered = binned.traces[bin.xy %in% model.visited,]
    system.time(eval.res <- eval.testdata2(binned.traces.filtered, models[[i-1]], bayesmax))
    eval.res$df$test_date = dates[i]
    eval.res$df$model_date = dates[i-1]
    eval.res$df$animal = animal_names[i]
    otherday.decoding.df = bind_rows(otherday.decoding.df, eval.res$df)
  }
  filtered.dfs = filter.sampled(binned.traces, binned.traces[1,])
  models[[i]] = create.model2(filtered.dfs$train, nresponse.bins=nresponse.bins)
}
```

```{r}
otherday.decoding.df = data.table(otherday.decoding.df)
otherday.decoding.df[, median(error),by=c('model_date')]
```



Mean error per bin
```{r}
decoding.df %>%
  group_by(date, animal, bin.xy) %>%
  dplyr::summarise(mean.error=mean(error),
                   median.error=median(error),
                   sem.error=sem(error),
                   ntests=n(),
                   prior=prior[1]) -> mean.error.df
mean.error.df %>%  
  DT::datatable() %>%
  DT::formatRound(columns=c('mean.error', 'median.error', 'sem.error', 'prior'), digits = 3)

ggplot(mean.error.df)  + geom_point(aes(x=prior, y=mean.error), alpha=0.1) +
  xlim(c(0,0.07))
```


# TEST
Distribution of cell's calcium trace at a given location
```{r}
timebinned.traces %>%
  filter(cell_id==0) %>%
  mutate(bin.xy = to_1dim(bin.x, bin.y)) %>%
  #filter(bin.xy == 97) %>%
  group_by(bin.xy) %>%
  ggplot() +
  geom_histogram(aes(x=bin.trace)) +
  facet_wrap(. ~ bin.xy, ncol=2, scales = 'free')
```


```{r}
timebinned.traces %>%
  filter(cell_id==0) %>%
  mutate(bin.xy = to_1dim(bin.x, bin.y)) %>%
  select(bin.trace, bin.xy, bin.x, bin.y, time_bin) %>%
  filter(bin.xy==97) %>%
  arrange(desc(bin.trace)) %>% DT::datatable()
```

