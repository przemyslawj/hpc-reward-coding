---
title: "R Notebook"
output: html_notebook
---

```{r}
library(permute)

source('utils.R')
```

```{r}
subset.caimg_result_dirs = caimg_result_dirs[shuffle(caimg_result_dirs)[1:20]]

learning_caimg_result_dirs = Filter(
  function(caimg_result_dir) { 
    trial.meta = get.trial.meta.from.path(caimg_result_dir)
    nrow(rewards.df[animal==trial.meta$animal & date==trial.meta$date, ]) > 0
  }, 
  caimg_result_dirs)

mouse.meta.df = read.mouse.meta(rootdirs)
trials.meta.df = read.trials.meta(rootdirs)
```



```{r}
xybins = 20
cheeseboard.bin.cm = 120 / xybins

get.max.thr  = function(max.fraction=0.25) {
  function(vals) {  
    max.val = max(c(vals), na.rm = TRUE)
    c( max.val* max.fraction, max.val+1) 
  }
}

get.nvenent.thr = function(min.nevents=0.1) {
  function(vals) { c(min.nevents, max(vals) + 1)}
}

prepare.traces = function(data.traces,
                          binned.var='nevents',
                          get.bin.thresholds.fun,
                          filter.running=TRUE,
                          timebin.dur.msec=200) {
  setorder(data.traces, trial_id, cell_id, timestamp)
  detect.events(data.traces, deconv.threshold=0.3)
  
  if (filter.running) {
    running.index = isRunning(data.traces, 2, 4, 500) 
    data.traces.filtered = data.traces[which(running.index), ]
  } else {
    data.traces.filtered = data.traces
  }
  
  date_str = data.traces$date[1]
  animal_name = data.traces$animal[1]

  binned.traces = bin.time.space(data.traces.filtered,
                                 nbins.x = xybins,
                                 nbins.y = xybins,
                                 #get.bin.thresholds.fun = get.quantiles.fun(c(0.9, 1.0)),
                                 #get.bin.thresholds.fun = get.quantiles.fun(c(quantile.fractions)),
                                 #get.bin.thresholds.fun = get.max.thr(0.15),
                                 get.bin.thresholds.fun = get.bin.thresholds.fun,
                                 binned.var=binned.var,
                                 timebin.dur.msec=timebin.dur.msec)

  setorder(binned.traces, time_bin, cell_id)
  setkey(binned.traces, time_bin, cell_id)

  return(binned.traces)
}

ncells = 50
nshuffles = 10
ncells = 0
nshuffles = 1

many.cells.animals = c('E-BL', 'E-TR', 'F-BL', 'F-TL', 'C-1R', 'D-BR', 'G-BR', 'K-BR')

bayes.spatial.decoder.config = list(
  stim.var=quo(bin.xy),
  nstim.bins=xybins^2,
  predict.fun = bayesmax,
  error.fun=bin.distance.error(xybins, xybins)
)

# eval.config = list(
#   ncells = 0,
#   nshuffles = 1,
#   filter.eval.traces.fun=NULL
# )

eval.decoder.same.day = function(caimg_result_dir, 
                                 decoder.config, 
                                 prepare.vars.fun=NULL,
                                 filter.test.traces.fun=NULL,
                                 min.samples=10) {
  
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = 'trial')
  binned.traces = prepare.traces(data.traces, 
                                 binned.var='trace',
                                 get.bin.thresholds.fun = get.quantiles.fun(c(0.9, 1.0)),
                                 timebin.dur.msec = 200)
  if (nrow(binned.traces) == 0) {
    return(data.frame())
  } 
  
  print('Started evaluating the model')
  if (!is.null(prepare.vars.fun)) {
    binned.traces = prepare.vars.fun(binned.traces)
  }
  cell_ids = binned.traces$cell_id %>% unique
  
  all.shuffles.eval.res = map_dfr(1:nshuffles, function(j) {
    subset.traces = binned.traces
    if (ncells > 0) {
      cell_ids = cell_ids[shuffle(cell_ids)]
      subset.traces = binned.traces[cell_id %in% cell_ids[1:min(ncells, length(cell_ids))],]
    }
    
    eval.df = eval.decoder(subset.traces,
                           nstim.bins=decoder.config$nstim.bins,
                           stim.var=!!decoder.config$stim.var,
                           error.fun=decoder.config$error.fun,
                           train.fun=create.discrete.bayes,
                           predict.fun=decoder.config$bayesmax,
                           value.var=response_bin,
                           cv=TRUE,
                           min.samples=min.samples,
                           filter.test.traces.fun=filter.test.traces.fun)

    if (nrow(eval.df) > 0) {
      eval.df$animal = binned.traces$animal[1]
      eval.df$date = binned.traces$date[1]
      eval.df$shuffle = j
    }
    eval.df
  })
  
  return(all.shuffles.eval.res)
}

eval.parts = list()
for (caimg_result_dir in caimg_result_dirs) {
  eval.parts[[caimg_result_dir]] = eval.decoder.same.day(
    caimg_result_dir, 
    decoder.config=bayes.spatial.decoder.config,
    min.samples=10)
  
}
spatial.error.df = do.call('rbind', eval.parts)

scale.bins2cm = function(decoding.df) {
  decoding.df$error = decoding.df$error * cheeseboard.bin.cm
  if ('random_error' %in% names(decoding.df)) {
    decoding.df$random_error = decoding.df$random_error * cheeseboard.bin.cm
  }
  return(decoding.df)
}

join.meta.dfs = function(df) {
  df = left_join(df, mouse.meta.df, by='animal') %>%
    left_join(trials.meta.df, by=c("animal", "date"))
  df$day_desc = as.factor(df$day_desc)
  return(df)
}

spatial.error.df = scale.bins2cm(spatial.error.df) %>% join.meta.dfs()
```
Utility functions for summarising and plotting the errors
```{r}
create.error.summary = function(df, ...) {
  grouping.vars = enquos(...)
  df %>%
    group_by(!!!grouping.vars) %>%
    dplyr::summarise(median.error=median(error),
                     sem.error=sem(error),
                     median.random.error=median(random_error),
                     sem.random.error=sem(random_error))
}

group.error.summary = function(df, ...) {
  grouping.vars = enquos(...)
  df %>%
    group_by(!!!grouping.vars) %>%
    dplyr::summarise(mean(median.error),
                     sem(median.error),
                     mean(median.random.error),
                     sem(median.random.error))
}

g.eval.animal.summary = function(error.summary) {
  ggplot(error.summary, aes(x=day_desc, y=median.error, group=animal, color=implant)) +
    geom_errorbar(aes(ymin=median.error-sem.error, ymax=median.error+sem.error), width=0.2) +
    gtheme +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab('Median error (cm)') + xlab('')
}
```

```{r spatial_error}
spatial.error.summary = create.error.summary(spatial.error.df, implant, animal, day_desc) 

group.error.summary(filter(spatial.error.summary, str_starts(day_desc, 'learning')), implant)

spatial.error.summary %>%
  g.eval.animal.summary()
```

## Eval excluding the spatial decoder excluding places at the reward
```{r}
spatial.error.df = spatial.error.df %>%
  group_by(implant, animal, date) %>%
  dplyr::mutate(actual.binx=from_1dim(actual.bin.xy, nbins)$x,
                actual.biny=from_1dim(actual.bin.xy, nbins)$y,
                min.rew.dist=calc.min.rew.dist(rewards.df, 
                                               date[1], 
                                               animal[1], 
                                               # translate bins to 0-100 coordinates, centre in the middle of the bin
                                               (actual.binx + 0.5) * bin.size,
                                               (actual.biny + 0.5) * bin.size)$rew.dist,
                is.close2rew = min.rew.dist <= min.rew.dist.thresh)

add.close2rew.fun = function(binned.traces) {
   date_str = binned.traces$date[1]
   animal_name = binned.traces$animal[1]
   binned.traces[, `:=`(
       closest.location.ordinal=calc.min.rew.dist(rewards.df, date_str, animal_name, x, y)$location.ordinal,
       min.rew.dist=calc.min.rew.dist(rewards.df, date_str, animal_name, x, y)$rew.dist) 
     ][, close2rew := as.integer(min.rew.dist <= min.rew.dist.thresh) + 1]
   binned.traces
 }
# 
# exclude.close2rew.fun = function(binned.traces) {
#   binned.traces[min.rew.dist > min.rew.dist.thresh, ]
# }
# 
# eval.parts = lapply(learning_caimg_result_dirs, eval.decoder.same.day, 
#                     decoder.config=bayes.spatial.decoder.config,
#                     prepare.vars.fun=function(df) exclude.close2rew.fun(add.close2rew.fun(df)),
#                     filter.test.traces.fun=exclude.close2rew.fun)
# spatial.error.rew.excl = do.call('rbind', eval.parts) %>%
#   scale.bins2cm() %>% join.meta.dfs()
```

```{r}
spatial.error.rewdiff.summary = filter(spatial.error.df, !is.na(is.close2rew)) %>%
  create.eval.summary(implant, animal, day_desc, is.close2rew) %>%
  dplyr::mutate(close2rew.errorname = ifelse(is.close2rew, 'close2rew.error', 'far2rew.error')) %>%
  reshape2::dcast(implant + animal + day_desc ~ close2rew.errorname, value.var='median.error') %>% 
  dplyr::mutate(median.error.diff = close2rew.error - far2rew.error )
```

Decoding error is lower at reward than further away, but also sampling is lower there, so it's a natural weaker spot of the decoder.
```{r}
ggplot(spatial.error.rewdiff.summary, aes(x=day_desc, y=median.error.diff, group=implant, color=implant)) +
  geom_point(position=position_dodge(width=0.5)) +
  gtheme +
  geom_hline(yintercept = 0, linetype='dashed') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Median error at reward - away from reward (cm)') + xlab('')
```
Is the decoding out of reward constant over days? No, seems a bit better with time.
```{r}
filter(spatial.error.df, !is.close2rew) %>%
  create.eval.summary(implant, animal, day_desc) %>%
  g.eval.animal.summary()
```


## Eval on the next day
```{r}
otherday.decoding.df = data.frame()

models = list()
dates = rep('', length(caimg_result_dirs))
animal_names = rep('', length(caimg_result_dirs))
place.cell.db = as.data.table(place.cell.db)

eval.decoder.prev.day = function(caimg_result_dir) {
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = 'trial')
  dates[i] = data.traces$date[i]
  animal_names[i] = data.traces$animal[i]

  binned.traces = prepare.traces(data.traces,
                                 filter.running=TRUE,
                                 timebin.dur.msec = 500,
                                 get.bin.thresholds.fun = get.nvenent.thr(0.1),
                                 binned.var = 'nevents')
  
  if (i > 1 && animal_names[i] == animal_names[i-1] && length(models[[i-1]]) > 0) {
    model.visited = which(models[[i-1]]$prior > 0)
    binned.traces.filtered = binned.traces[bin.xy %in% model.visited,]
    system.time(eval.res <- eval.testdata2(binned.traces.filtered, 
                                           models[[i-1]], 
                                           predict.fun=bayes.spatial.decoder.config$predict.fun,
                                           error.fun=bayes.spatial.decoder.config$error.fun,
                                           stim.var=!!bayes.spatial.decoder.config$stim.var,
                                           nstim.bins=bayes.spatial.decoder.config$nstim.bins,
                                           value.var=response_bin))
    eval.res$df$test_date = dates[i]
    eval.res$df$model_date = dates[i-1]
    eval.res$df$animal = animal_names[i]
    otherday.decoding.df = bind_rows(otherday.decoding.df, eval.res$df)
  }
  
  filtered.dfs = filter.sampled(binned.traces, binned.traces[1,], min.samples=10)
  models[[i]] = create.discrete.bayes(filtered.dfs$train, 
                                      nstim.bins=xybins^2,
                                      value.var=response_bin,
                                      stim.var=bin.xy)
}

for (i in 1:length(small.caimg_result_dirs)) {
  caimg_result_dir = small.caimg_result_dirs[i]
  eval
}

otherday.decoding.df = scale.bins2cm(otherday.decoding.df) %>% 
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c("animal", "test_date"="date"))
```

```{r}
otherday.decoding.df = data.table(otherday.decoding.df)

data.table(otherday.decoding.df)[,.(med.error=median(error), .N), by=c('implant','animal', 'day_desc')][,.(median(med.error), sem(med.error)), by=c('implant', 'day_desc')]

data.table(otherday.decoding.df)[,.(med.error=median(error), .N), by=c('implant','animal', 'day_desc')][,.(median(med.error), sem(med.error)), by=c('implant')]

```

Plot of decoding summary
```{r}
otherday.eval.summary = otherday.decoding.df %>%
  group_by(implant, day_desc, animal) %>%
  dplyr::summarise(mean.error=mean(error),
                   median.error=median(error),
                   sd.error=sd(error),
                   sem.error=sem(error))

ggplot(otherday.eval.summary, aes(x=day_desc, y=median.error, group=animal, color=implant)) +
  #geom_point() +
  geom_errorbar(aes(ymin=median.error-sem.error, ymax=median.error+sem.error), width=0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Median error (cm)') + xlab('Prediction day')
```

Is prediction worse after translocated the reward?
```{r}
tapply(otherday.eval.summary$median.error, otherday.eval.summary$implant, summary)

learning15.eval.sum = subset(otherday.eval.summary, day_desc=='learning1 day#5')
tapply(learning15.eval.sum$median.error, learning15.eval.sum$implant, summary)

learning21.eval.sum = subset(otherday.eval.summary, day_desc=='learning2 day#1')
tapply(learning21.eval.sum$median.error, learning21.eval.sum$implant, summary)
```


## Prediction error at reward
```{r}
rewards.df = data.table(rewards.df)
setkey(rewards.df, date, animal)

min.rew.dist = function(day, animal_name, bin.xy) {
  rews = rewards.df[date==day & animal == animal_name, ]
  if (nrow(rews)==0) {
    return(list(location.ordinal=0, rew.dist=NA))
  }
  trans.xy = from_1dim(bin.xy, nbins)
  bin.size = 100 / nbins
  trans.xy$x = trans.xy$x * bin.size
  trans.xy$y = trans.xy$y * bin.size
  
  dist1 = norm2(rews$trans_x[1] - trans.xy$x, rews$trans_y[1] - trans.xy$y)
  dist2 = norm2(rews$trans_x[2] - trans.xy$x, rews$trans_y[2] - trans.xy$y)
  min.i = as.integer(dist2 < dist1) + 1
  return(list(location.ordinal=rews$location_ordinal[min.i],
              rew.dist=ifelse(min.i==1, dist1, dist2)))
}

short.decoding.df = decoding.df %>%
  group_by(date, animal) %>%
  dplyr::mutate(actual.rew.dist=min.rew.dist(date[1], animal[1], actual.bin.xy)$rew.dist,
                actual.rew.ordinal=min.rew.dist(date[1], animal[1], actual.bin.xy)$location.ordinal,
                pred.rew.dist=min.rew.dist(date[1], animal[1], bin.xy)$rew.dist,
                pred.rew.ordinal=min.rew.dist(date[1], animal[1], bin.xy)$location.ordinal)


```
Higer error at the reward- maybe doesn't disambiguate
```{r}
short.decoding.df %>%
  filter(actual.rew.dist <= 15) %>%
  left_join(trials.meta.df) %>%
  left_join(mouse.meta.df) %>%
  ggplot() +
  #geom_point(aes(x=actual.rew.dist / 5, y=error), alpha=0.1) +
  geom_violin(aes(x=day_desc, y=error * cheeseboard.bin.cm)) +
  facet_grid(. ~ implant) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x='', y='Decoding error (cm)')
```

For the locations at reward, how many were predicted to be at the other reward?
vCA1 encoding 50 % times incorrect on learning1 day#4 and day#5

```{r}
short.decoding.df %>%
  filter(actual.rew.dist <= 15) %>%
  left_join(trials.meta.df) %>%
  left_join(mouse.meta.df) %>%
  dplyr::mutate(wrong.rew.loc = (actual.rew.ordinal != pred.rew.ordinal) & (pred.rew.dist <= 25),
                correct.rew.loc = actual.rew.ordinal == pred.rew.ordinal) %>%
  group_by(implant, animal, day_desc) %>%
  dplyr::summarise(pct.wrong.rew=sum(wrong.rew.loc)/n(),
                   pct.correct.rew=sum(correct.rew.loc)/n()) %>%
  ggplot() +
  geom_point(aes(x=day_desc, y=pct.wrong.rew, color='incorrect rew')) +
  geom_point(aes(x=day_desc, y=pct.correct.rew, color='correct rew')) +
  facet_grid(. ~ implant) +
  geom_hline(yintercept=0.5, linetype='dashed') +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Decoding accuracy')
```
# Decoding if the mouse is at reward
```{r}
nshuffles=1
ncells=0
min.rew.dist.thresh = 15
vca1.animals = subset(mouse.meta.df, implant=='vCA1')$animal %>% as.character()

bayes.atreward.decoder.config = list(
  stim.var = quo(close2rew),
  nstim.bins = 2,
  predict.fun = bayesmax,
  error.fun = function(x,y) {abs(x-y)}
)

eval.parts = lapply(learning_caimg_result_dirs, eval.decoder.same.day, 
                    decoder.config=bayes.atreward.decoder.config,
                    prepare.vars.fun=add.close2rew.var)

close2rew.decoding.df = do.call('rbind', eval.parts) %>%
  join.meta.dfs()
```

```{r}
data.table(close2rew.decoding.df)[,.(incorrect.pct=mean(error), baseline.pct=mean(random_error)), by=c('animal','day_desc', 'implant')][,.(incorrect.pct=median(incorrect.pct), random.pct=median(baseline.pct)), by=c('implant', 'day_desc')]
data.table(close2rew.decoding.df)[day_desc=='learning1 day#5',.(incorrect.pct=mean(error), baseline.pct=mean(random_error)), by=c('implant','animal', 'day_desc')][,.(incorrect=median(incorrect.pct), em=sem(incorrect.pct), random=median(baseline.pct)), by='implant']
```

```{r}
eval.summary = close2rew.decoding.df %>%
  group_by(date, implant, day_desc, animal) %>%
  dplyr::summarise(incorrect.pct=mean(error),
                   random.pct=mean(random_error))

ggplot(eval.summary, aes(x=day_desc, group=implant, color=implant)) +
  geom_point(aes(y=(1-incorrect.pct) * 100), position = position_dodge(width = 0.5)) +
  #geom_point(aes(y=(1-random.pct) * 100), position = position_dodge(width = 0.5), shape=23) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Decoding accuracy') + xlab('')
```

Eval reward decoder on the next day
```{r}
otherday.rew.decoding.df = data.frame()

rew.models = list()

dates = rep('', length(learning_caimg_result_dirs))
animal_names = rep('', length(learning_caimg_result_dirs))

for (i in 1:length(learning_caimg_result_dirs)) {
  caimg_result_dir = learning_caimg_result_dirs[i]
  data.traces = read.data.trace(caimg_result_dir, filter_exp_title = 'trial')
  dates[i] = data.traces$date[i]
  animal_names[i] = data.traces$animal[i]
  if (nrow(rewards.df[animal==animal_names[i]& date==dates[i],]) == 0) {
    next
  }
  binned.traces = prepare.traces(data.traces, 
                                 binned.var='nevents', 
                                 get.bin.thresholds.fun = get.nvenent.thr(0.1),
                                 timebin.dur.msec = 200,
                                 filter.running=TRUE)
  binned.traces[, `:=`(
      closest.location.ordinal=calc.min.rew.dist(rewards.df, date[1], animal[1], x, y)$location.ordinal,
      min.rew.dist=calc.min.rew.dist(rewards.df, date[1], animal[1], x, y)$rew.dist) 
    ][, close2rew := as.integer(min.rew.dist <= min.rew.dist.thresh) + 1]
      
  if (i > 1 && animal_names[i] == animal_names[i-1]) {

    system.time(eval.res <- eval.testdata2(binned.traces, 
                                           rew.models[[i-1]],
                                           predict.fun=bayesmax,
                                           error.fun=function(x,y) {abs(x-y)},
                                           stim.var=close2rew,
                                           nstim.bins=2,
                                           value.var=response_bin)
    )
    random.classifier.res <- eval.testdata2(binned.traces, 
                                        rew.models[[i-1]], 
                                        predict.fun=random.prior.classifier,
                                        error.fun=function(x,y) {abs(x-y)},
                                        stim.var=close2rew,
                                        nstim.bins=2,
                                        value.var=response_bin)
    eval.res$df$random_error = random.classifier.res$df$error
    eval.res$df$test_date = dates[i]
    eval.res$df$model_date = dates[i-1]
    eval.res$df$animal = animal_names[i]
    otherday.rew.decoding.df = bind_rows(otherday.rew.decoding.df, eval.res$df)
  }
  filtered.dfs = filter.sampled(binned.traces, binned.traces[1,], min.samples=10)
  rew.models[[i]] = create.discrete.bayes(filtered.dfs$train, 
                                          nstim.bins=2,
                                          value.var=response_bin,
                                          stim.var=close2rew)
}

otherday.rew.decoding.df = otherday.rew.decoding.df %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('animal'='animal', 'test_date'='date'))
  
otherday.decoding.df = as.data.table(otherday.decoding.df)
```

```{r}
otherday.rew.decoding.summary = otherday.rew.decoding.df %>%
  group_by(animal, implant, test_date, day_desc) %>%
  dplyr::summarise(incorrect.pct=mean(error),
                   random.pct=mean(random_error),
                   incorrect.random.diff = random.pct-incorrect.pct) 

otherday.rew.decoding.summary %>%
  group_by(implant) %>%
  filter(day_desc=='learning1 day#5') %>%
  dplyr::summarise(mean(incorrect.pct), 
                   sem(incorrect.pct),
                   mean(random.pct),
                   sem(random.pct),
                   n=n()) %>%
  dplyr::mutate_if(is.double, scales::percent, 1)

```
Is perforamnce better with learning?
```{r}
otherday.rew.summary15 = subset(otherday.rew.decoding.summary, day_desc=='learning1 day#5')
otherday.rew.summary21 = subset(otherday.rew.decoding.summary, day_desc=='learning2 day#1')

tapply(otherday.rew.summary15$incorrect.pct, otherday.rew.summary15$implant, summary)
tapply(otherday.rew.summary21$incorrect.pct, otherday.rew.summary21$implant, summary)

tapply(otherday.rew.summary15$incorrect.random.diff, otherday.rew.summary15$implant, summary)
tapply(otherday.rew.summary21$incorrect.random.diff, otherday.rew.summary21$implant, summary)
```



```{r}
otherday.rew.decoding.df %>%
  group_by(animal, implant, test_date, day_desc) %>%
  dplyr::summarise(incorrect.pct=mean(error)) %>%
  ggplot() +
  geom_point(aes(x=day_desc, y=(1-incorrect.pct) * 100, color=implant, group=implant), position=position_dodge(width=0.5)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab('Decoding accuracy') + xlab('Decoding day')
```


# Test reward decoder a couple of days later
```{r}
model.trials.df = filter(trials.meta.df, day_desc == 'learning1 day#3')
eval.trials.df = filter(trials.meta.df, day_desc == 'learning2 day#2')
eval.trials.df = filter(trials.meta.df, day_desc == 'learning3 day#2')

lastday.rew.decoding.df = data.frame()

for (i in 1:nrow(eval.trials.df)) {
  animal_name = eval.trials.df$animal[i]
  eval_date_str = eval.trials.df$date[i]
  eval_caimg_dir = find.caimg.dir(learning_caimg_result_dirs, animal_name, eval_date_str)
  evaldir.index = which(learning_caimg_result_dirs == eval_caimg_dir)
  if (length(evaldir.index) == 0) {
    next
  }
  
  model_date_str = subset(model.trials.df, animal==animal_name)$date
  model_caimg_dir = find.caimg.dir(learning_caimg_result_dirs, animal_name, model_date_str)
  modeldir.index = which(learning_caimg_result_dirs == model_caimg_dir)
  
  if (length(modeldir.index) == 0) {
    next
  }
  model = rew.models[[modeldir.index]]
  
  data.traces = read.data.trace(eval_caimg_dir, filter_exp_title = 'trial')

  if (nrow(rewards.df[animal==animal_name & date==eval_date_str,]) == 0) {
    next
  }
  binned.traces = prepare.traces(data.traces, 
                                 binned.var='nevents', 
                                 get.bin.thresholds.fun = get.nvenent.thr(0.1),
                                 timebin.dur.msec = 500,
                                 filter.running=TRUE)
  binned.traces[, `:=`(
      closest.location.ordinal=calc.min.rew.dist(rewards.df, date[1], animal[1], x, y)$location.ordinal,
      min.rew.dist=calc.min.rew.dist(rewards.df, date[1], animal[1], x, y)$rew.dist) 
    ][, close2rew := as.integer(min.rew.dist <= min.rew.dist.thresh) + 1]
      
  eval.res <- eval.testdata2(binned.traces, 
                             model,
                             predict.fun=bayesmax,
                             error.fun=function(x,y) {abs(x-y)},
                             stim.var=close2rew,
                             nstim.bins=2,
                             value.var=response_bin)
  
  random.classifier.res <- eval.testdata2(binned.traces, 
                                      model, 
                                      predict.fun=random.prior.classifier,
                                      error.fun=function(x,y) {abs(x-y)},
                                      stim.var=close2rew,
                                      nstim.bins=2,
                                      value.var=response_bin)
  eval.res$df$random_error = random.classifier.res$df$error
  eval.res$df$test_date = eval_date_str
  eval.res$df$model_date = model_date_str
  eval.res$df$animal = animal_name
  lastday.rew.decoding.df = bind_rows(lastday.rew.decoding.df, eval.res$df)
    
}

lastday.rew.decoding.df = lastday.rew.decoding.df %>%
  left_join(mouse.meta.df, by='animal') %>%
  left_join(trials.meta.df, by=c('animal'='animal', 'test_date'='date'))
  
lastday.rew.decoding.df = as.data.table(lastday.rew.decoding.df)
```


```{r}
lastday.rew.decoding.summary = lastday.rew.decoding.df %>%
  group_by(animal, implant, day_desc) %>%
  dplyr::summarise(incorrect.pct=mean(error),
                   random.pct=mean(random_error),
                   incorrect.random.diff = random.pct-incorrect.pct) 

lastday.rew.decoding.summary %>%
  group_by(implant) %>%
  dplyr::summarise(mean(incorrect.pct), 
                   sem(incorrect.pct),
                   mean(random.pct),
                   sem(random.pct),
                   n=n()) %>%
  dplyr::mutate_if(is.double, scales::percent, 1)
```



