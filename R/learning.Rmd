---
title: "Cheeseboard learning analysis"
output:
  html_document:
    df_print: paged
---

Before running the notebook run trial_stats.R.

```{r imports, include=FALSE}
library(dplyr)
library(ggplot2)
library(cowplot)
library(readr)
library(tidyr)
library(purrr)

library(datatrace)

source('crossings.R')
source('distances.R')
source('locations.R')
source('tracking_files.R')
source('tracking_info.R')
source('traces_input.R')
source('plotting_params.R')
```

```{r}
dir = '/mnt/DATA/Prez/cheeseboard'
hab_dirs = map_chr(tracking_rootdirs, ~ paste(.x, 'habituation', sep='/'))
gen_imgs_dir = '~/tmp/cheeseboard/learning/'

df = read_csv(paste0(dir, '/trial_stats.csv'))
locations.df = map_dfr(rootdirs, read_locations)
trials.meta.df = read.trials.meta(rootdirs)
mouse.meta.df = read.mouse.meta(rootdirs)

behav_cam_frame_rate = 24
cheeseboard.len.cm = 120
```


```{r}
df = dplyr::mutate(df, total_trial_n = 8*(learning_day1 - 1) + trial_n) %>%
    filter(!animal %in% c('A-BL', 'C-1R', 'L-TL', 'P-BR'))  # Animals not included

notest.df = filter(df, exp_title == 'trial')
d = notest.df 
d$learning_day1 = as.factor(d$learning_day1)
```


Duration of the trials
```{r}
gdur = d %>%
  filter(time_finished > 0) %>%
  #group_by(animal,learning_day1) %>%
  #summarise(mdur=mean(total_frames/behav_cam_frame_rate)) %>%
  ggplot() +
  geom_boxplot(aes(x=learning_day1, y=time_finished)) +
  #geom_jitter(aes(x=learning_day1, y=mdur, color=animal),height=0, width=0.1, size=1) +
  geom_point(aes(x=learning_day1, y=time_finished, color=animal),height=0, width=0.1, size=1) +
  gtheme +
  geom_vline(xintercept=5.5, linetype='dashed', color='red') +
  geom_vline(xintercept=7.5, linetype='dashed', color='red') +
  geom_vline(xintercept=11.5, linetype='dashed', color='blue') +
  xlab('Training day') +
  ylab('Trial time (sec)') +
  ylim(c(0,200))
gdur
# ggsave(filename='gdist.svg', plot=gdist, width=5)
# ggsave(filename='gdur.svg', plot=gdur, width=5)
```

Total distance travelled per mouse
```{r}
d %>% 
  filter(time_finished > 0) %>%
  group_by(animal, learning_day1) %>%
  dplyr::summarise(mdist=mean(total_dist), sddist=sd(total_dist), mdur=mean(total_frames/behav_cam_frame_rate), sddur=sd(total_frames/behav_cam_frame_rate)) %>%
  ggplot() +
  geom_line(aes(x=learning_day1, y=mdist, group=animal, color=animal)) 
  #geom_ribbon(aes(x=learning_day1, ymin=mdist-sddist, ymax=mdist+sddist, group=animal, fill=animal), alpha=0.1)

```

Difference from optimal path
```{r}
path_len = function(points) {
  len = 0
  xdiff = diff(points$x)
  ydiff = diff(points$y)
  for (i in 1:length(xdiff)) {
    len = len + sqrt(xdiff[i]^2 + ydiff[i]^2)
  }
  return(len)
}

as.percent = function(x, y) {
  return (x - y / y * 100)
}

d2 = d %>% 
  rowwise() %>%
  dplyr::mutate(min_path1=path_len(list(x=c(start_x, rew1_x, rew2_x), y=c(start_y, rew1_y, rew2_y))),
                min_path2=path_len(list(x=c(start_x, rew2_x, rew1_x), y=c(start_y, rew2_y, rew1_y))),
                min_path=ifelse(min_path1<min_path2, min_path1, min_path2),
                norm_dist=total_dist / min_path)
         
d2 %>%
  ggplot(aes(x=learning_day1, y=norm_dist)) +
  geom_violin(fill=single.colour, color=single.colour) +
  geom_jitter(height=0, width=0.1, size=0.5, shape=1, color='#333333') +
  stat_summary(fun.y=median, geom="point", shape=23, size=2, color='white', size=2) +
  #geom_point(aes(x=learning_day1, y=norm_dist)) +
  gtheme +
  xlab('Training day') +
  ylab('Norm. distance') +
  #ylim(c(0,20))+
  scale_y_log10() +
  #geom_hline(yintercept=1, linetype="dashed", color = "black") +
  geom_vline(xintercept=5.5, linetype="dashed", color = "red") +
  geom_vline(xintercept=7.5, linetype="dashed", color = "red") +
  geom_vline(xintercept=11.5, linetype='dashed', color='blue') +
  geom_vline(xintercept=15.5, linetype='dashed', color='red')

```

Trial mean over time
```{r}
alltrial.mean.dist = d2 %>% 
  filter(time_finished > 0 & time_finished <= 180) %>%
  mutate(dist_m = total_dist / cheeseboard.len.cm) %>%
  group_by(total_trial_n) %>%
  dplyr::summarise(mean.total_dist = mean(dist_m),
                   sem.total_dist = sem(dist_m))
ggplot(alltrial.mean.dist, aes(x=as.integer(total_trial_n))) +
  geom_errorbar(aes(ymin=mean.total_dist-sem.total_dist,
                  ymax=mean.total_dist+sem.total_dist,
                  group=1), color='#333333') +
  geom_vline(xintercept=40.5, linetype="dashed", color = "#444444") +
  geom_vline(xintercept=56.5, linetype="dashed", color = "#444444") +
  geom_vline(xintercept=72.5, linetype="dashed", color = "#444444") +
  scale_x_continuous(limits=c(0,72.5), breaks=seq(1, 72, 8)) +
  xlab('Trial') +
  ylab('Distance travelled (m)') +
  gtheme

ggsave('learning_trials_distance.pdf', path='/home/prez/tmp/cheeseboard', 
       device = cairo_pdf, units='cm', width=6.5, height=3.6)
```


Daily mean distance per animal
```{r}
learning.dist.summary = d2 %>%
  filter(time_finished > 0 & time_finished <= 180) %>%
  group_by(learning_day1) %>%
  dplyr::summarise(mean.norm_dist=median(total_dist, na.rm=TRUE),
                   sem.norm_dist = sem(total_dist)) 

animal.summary.learning.dist = d2 %>%
  filter(time_finished > 0 & time_finished <= 180) %>%
  group_by(animal, learning_day1) %>%
  dplyr::summarise(mean.norm_dist=mean(total_dist))

g = ggplot() +
  geom_ribbon(data=learning.dist.summary,
               mapping=aes(x=as.integer(learning_day1), 
                           ymin=mean.norm_dist-sem.norm_dist, 
                           ymax=mean.norm_dist+sem.norm_dist,
                           group=1),
               fill='#bbbbbb') +
  geom_jitter(aes(x=as.integer(learning_day1), y=mean.norm_dist, animal=animal),
            data=animal.summary.learning.dist,
            height=0, width=0.1, size=0.5, shape=1, color='#333333') +
  gtheme +
  xlab('Training day') +
  ylab('Norm. distance') +
  scale_y_log10() +
  #geom_hline(yintercept=1, linetype="dashed", color = "#333333") +
  geom_vline(xintercept=5.5, linetype="dashed", color = "#333333") +
  geom_vline(xintercept=7.5, linetype="dashed", color = "#333333") +
  geom_vline(xintercept=9.5, linetype='dashed', color='#333333') +
  geom_vline(xintercept=15.5, linetype='dashed', color='#333333') +
  xlim(c(1,9)) +
  scale_x_continuous(limits=c(1,9), breaks=1:9)
#ggplotly(g)
g
```


```{r}
d2 %>%
  group_by(learning_day1) %>%
  summarise(m.norm_dist=median(norm_dist), sd.norm_dist=sd(norm_dist))
```

Is running to the closer reward first? Would confirm model-based learning
```{r}
which.rew.df = d %>%
  filter(time_finished > 0) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(dist_rew1=path_len(list(x=c(start_x, rew1_x), y=c(start_y, rew1_y))),
                dist_rew2=path_len(list(x=c(start_x, rew2_x), y=c(start_y, rew2_y))),
                closer_rew=which.min(c(dist_rew1, dist_rew2)),
                run_closer=(closer_rew == which.min(c(passed_rew0, passed_rew1))))

which.rew.df %>%
  group_by(learning_day1, animal) %>%
  summarise(shorter_run_pct = sum(run_closer) / n()) %>%
  ggplot() +
  geom_jitter(aes(x=learning_day1, y=shorter_run_pct, colour=animal), width=0.1, height=0)
         
```


Time at reward
```{r}
d2 %>% 
  group_by(animal, learning_day1) %>%
  summarise(mdist=mean(norm_dist), 
            sddist=sd(norm_dist),
            mrew_dwell_pct=mean(rew_dwell_pct),
            sdrew_dwell_pct=sd(rew_dwell_pct),
            mdur=mean(total_frames/behav_cam_frame_rate), 
            sddur=sd(total_frames/behav_cam_frame_rate)) %>%
  ggplot() +
  geom_line(aes(x=learning_day1, y=mrew_dwell_pct, group=animal, color=animal)) 

gdwell = d2 %>%
  group_by(learning_day1, animal) %>%
  summarise(mrew_dwell_pct=mean(rew_dwell_pct),
            sdrew_dwell_pct=sd(rew_dwell_pct)) %>%
  ggplot() +
  geom_boxplot(aes(x=learning_day1, y=mrew_dwell_pct)) +
  geom_point(aes(x=learning_day1, y=mrew_dwell_pct), size=1) +
  geom_vline(xintercept=5.5, linetype="dashed", color = "blue") +
  geom_vline(xintercept=7.5, linetype="dashed", color = "blue") +
  xlab('Training day') + ylab('Time at reward (%)') +
  gtheme
gdwell
```

```{r}
d2 %>%
  group_by(learning_day1) %>%
  summarise(mrew_dwell_pct=mean(rew_dwell_pct), sdrew_dwell_pct=sd(rew_dwell_pct))
```


Dwell Time in trial tests
```{r}
df %>%
  mutate(learning_day1_f = as.factor(learning_day1)) %>%
  filter(exp_title == 'beforetest') %>%
  ggplot() +
  geom_boxplot(aes(x=learning_day1_f, y=rew_dwell_pct))

df %>%
  filter(exp_title == 'beforetest') %>%
  group_by(learning_day1) %>%
  summarise(mdwell=mean(rew_dwell_pct),sddwell=sd(rew_dwell_pct))
```

# Number of crossings in trial tests
```{r}
test.trial.df = df %>%
  mutate(learning_day1_f = as.factor(learning_day1),
         crossings_0_60s=crossings_0_30s+crossings_30_60s,
         crossings_0_120s=crossings_0_60s+crossings_60_90s+crossings_90_120s,
         crossings_per_min=crossings_n/(total_frames/behav_cam_frame_rate) * 60,
         dist_0_60s = dist_0_30s + dist_30_60s,
         dist_0_120s = dist_0_60s + dist_60_90s + dist_90_120s,
         norm_crossings_30s=crossings_0_30s / (dist_0_30s / cheeseboard.len.cm),
         norm_crossings_60s=crossings_0_60s / (dist_0_60s / cheeseboard.len.cm),
         norm_crossings_120s=crossings_0_120s / (dist_0_120s / cheeseboard.len.cm)) %>%
  filter(exp_title == 'beforetest') 

gcross = test.trial.df %>%
  ggplot() +
  geom_boxplot(aes(x=learning_day1_f, y=crossings_0_60s)) +
  geom_jitter(aes(x=learning_day1_f, y=crossings_0_60s, color=animal), height=0, width=0.1, size=3) +
  xlab('Test day') +
  ylab('# Crossings during 60s') + 
  gtheme +
  theme(legend.position='None') 
gcross
ggsave(filename='gcross.svg', plot=gcross, width=3)

gcross.ratio = test.trial.df %>%
  ggplot() +
  geom_boxplot(aes(x=learning_day1_f, y=crossings_0_60s/(dist_0_60s/20.0/25)), outlier.size=0) +
  geom_jitter(aes(x=learning_day1_f, y=crossings_0_60s/(dist_0_60s/20.0/25), color=animal),height=0, width=0.1, size=3) +
  xlab('Test day') +
  ylab('# Crossings / \n# Crossings per some norm distance') +
  gtheme +
  theme(legend.position='None') 
  
gcross.ratio
ggsave(filename='gcross_ratio.svg', plot=gcross.ratio, width=3)
```


Calculate number of crossings during habituation for each location set
```{r, warning=FALSE}
hab.files = map_dfr(hab_dirs, get_tracking_files) %>%
  filter(exp_title != 'homecage')
animal.locations = locations.df %>%
  dplyr::mutate(rowxcol=paste0(as.character(Well_row), 'x', as.character(Well_col))) %>%
  filter(Valence == 'Positive') %>%
  filter(is_test == FALSE) %>%
  group_by(animal, rowxcol, location_set) %>%
  dplyr::select(animal, rowxcol, Well_row, Well_col, trans_x, trans_y, location_set) %>%
  dplyr::distinct()

hab_loc = full_join(hab.files, animal.locations, by=c("animal"))
hab_loc$crossings = rep(0, nrow(hab_loc))
hab_loc$total_dist = rep(0, nrow(hab_loc))
hab_loc$total_frames = rep(0, nrow(hab_loc))
for (i in 1:nrow(hab_loc)) {
  tracking.df = read_csv(hab_loc$filepath[i], col_types = cols())
  tracking.df.filtered = filter(tracking.df, trans_x > 0, trans_y > 0) %>%
    arrange(timestamp)
  crossings = crossings4positions(
                      tracking.df.filtered$smooth_trans_x, tracking.df.filtered$smooth_trans_y, 
                      hab_loc$trans_x[i], hab_loc$trans_y[i], rew_zone_radius)
  hab_loc$crossings[i] = crossings
  frame_60s = behav_cam_frame_rate * 60
  frame_120s = behav_cam_frame_rate * 120
  hab_loc$crossings_0_60s[i] = crossings4positions(
                      tracking.df.filtered$smooth_trans_x[1:frame_60s], tracking.df.filtered$smooth_trans_y[1:frame_60s], 
                      hab_loc$trans_x[i], hab_loc$trans_y[i], rew_zone_radius)
  hab_loc$crossings_0_120s[i] = crossings4positions(
                      tracking.df.filtered$smooth_trans_x[1:frame_120s], tracking.df.filtered$smooth_trans_y[1:frame_120s], 
                      hab_loc$trans_x[i], hab_loc$trans_y[i], rew_zone_radius)
  distances = vec_dist(tracking.df.filtered$smooth_trans_x, tracking.df.filtered$smooth_trans_y)
  hab_loc$dist_0_60s[i] = sum(distances[1:frame_60s])
  hab_loc$dist_0_120s[i] = sum(distances[1:frame_120s])
  hab_loc$total_dist[i] = sum(distances)
  hab_loc$total_frames[i] = last(tracking.df.filtered$frame) - first(tracking.df.filtered$frame)
}

```
Average across different trials
```{r}
hab.loc.set.crossings = group_by(hab_loc, filepath, filename, date, animal, trial, exp_title, location_set) %>%
  dplyr::summarize(crossings = sum(crossings),
                   crossings_0_60s = sum(crossings_0_60s),
                   crossings_0_120s = sum(crossings_0_120s),
                   dist_0_60s = mean(dist_0_60s),
                   dist_0_120s = mean(dist_0_120s),
                   total_dist = mean(total_dist),
                   total_frames = mean(total_frames)) %>%
  dplyr::mutate(norm_crossings = crossings / (total_dist  / cheeseboard.len.cm))

mhab_loc = hab.loc.set.crossings %>%
  group_by(animal, location_set) %>%
  dplyr::summarise(mnorm_crossings = mean(norm_crossings),
                   mcrossings_0_60s = mean(crossings_0_60s),
                   mcrossings_0_120s = mean(crossings_0_120s)) %>%
  dplyr::rename(norm_crossings=mnorm_crossings, 
                crossings_0_60s=mcrossings_0_60s, 
                crossings_0_120s=mcrossings_0_120s) %>%
  dplyr::mutate(type="habituation")
```

Compare crossings in probe tests vs habituation
```{r}
mhab_loc.filtered = mhab_loc %>% filter(animal %in% unique(test.trial.df$animal))
mhab_loc.perdate = test.trial.df %>%
  dplyr::select(animal, location_set, date) %>%
  left_join(mhab_loc.filtered, by=c('animal', 'location_set'))

mouse.meta.df = read.mouse.meta(rootdirs)
trials.meta.df$date = char2date(trials.meta.df$date)
test.trial.df.joined = test.trial.df %>%
  dplyr::select(animal, location_set, date, norm_crossings_120s, crossings_0_60s, crossings_0_120s) %>%
  dplyr::rename(norm_crossings = norm_crossings_120s) %>%
  dplyr::mutate(type="test")  %>%
  bind_rows(mhab_loc.perdate) %>%
  left_join(dplyr::select(trials.meta.df, -location_set), by=c('animal', 'date')) %>%
  left_join(mouse.meta.df, by=c('animal'))

test.trial.df.joined$type = as.factor(test.trial.df.joined$type)
test.trial.df.joined$location_set = as.factor(test.trial.df.joined$location_set)
```

```{r}
library(plotly)
g = test.trial.df.joined %>%
  ggplot(aes(x=type, y=norm_crossings, group=animal)) +
  geom_line() +
  geom_point(aes(color=animal)) +
  facet_grid(implant ~ day_desc, scales='free') +
  gtheme
ggplotly(g)
```


```{r}
g = test.trial.df.joined %>%
  mutate(animal_day_desc = paste(animal, day_desc, sep='_')) %>%
  ggplot(aes(x=type, y=norm_crossings, group=animal_day_desc)) +
  geom_line(size=0.25, color='#333333') +
  facet_grid(. ~ implant) +
  ylab('Crossings per m') +
  gtheme
#ggplotly(g)
g
ggsave('learning_test_performance.pdf', g,
       path='/home/prez/tmp/cheeseboard', units='cm', device=cairo_pdf,
       width=4.6, height=3.9)
```
LMER
```{r}
source('fixed_effects.R')
m = lmerTest::lmer(norm_crossings ~ type + implant + (1 + day_desc | animal),
                   test.trial.df.joined,
                   REML = FALSE)
summary(m)
anova(m, refit=FALSE, ddf='Satterthwaite')
plot.model.diagnostics(m, test.trial.df.joined$animal, test.trial.df.joined$implant)

dplyr::group_by(test.trial.df.joined, type) %>%
  dplyr::summarise(mean(norm_crossings), sem(norm_crossings))

```


```{r}
test.trial.df.joined = mutate(test.trial.df.joined, 
                              aday=paste(animal, day_desc, sep='_'))
test.trial.df.joined$aday = as.factor(test.trial.df.joined$aday) %>% as.integer() %>% as.factor()
bf.models = create.bayes.lm.pair(test.trial.df.joined,
                                 formula.full = norm_crossings ~ type + implant + aday,
                                 formula.null = norm_crossings ~ type + aday,
                                 whichRandom = c('aday'))
bf.models$full / bf.models$null
print('CI for difference between implants')
calc.pair.95CI(bf.models$full)

bf.models = create.bayes.lm.pair(test.trial.df.joined,
                                 formula.full = norm_crossings ~ type + aday,
                                 formula.null = norm_crossings ~ aday,
                                 whichRandom = c('aday'))
bf.models$full / bf.models$null
print('CI for difference between foraging and test')
calc.pair.95CI(bf.models$full, pair.vars = c('type-habituation', 'type-test'))
```


Animals and trials when mice did not learn
```{r}
library(reshape2)
crossings.change.df = reshape2::dcast(test.trial.df.joined,
                  animal + location_set + date + day_desc + implant ~ type, 
                  value.var = 'norm_crossings') %>% 
    dplyr::mutate(norm_crossings_change = test - habituation) 
  
tests.passed = filter(crossings.change.df, norm_crossings_change >= 0.1) %>%
  dplyr::mutate(animal_beforetest_day = paste(animal, day_desc, sep='_'))

print('Percent test trials with performance test passed')
nrow(tests.passed) / nrow(crossings.change.df) * 100
```


Statistically significant difference
```{r}
wilcox.test(norm_crossings ~ type, data=test.trial.df.joined, subset=location_set==1, paired=TRUE)
animal.ids2 = subset(test.trial.df.joined, type=='test' & location_set==2, select=animal)
df=filter(test.trial.df.joined, location_set==2) %>% filter(animal %in% animal.ids2$animal)
wilcox.test(norm_crossings ~ type, data=df, paired=TRUE)
```

# Example of paths during beforetest 120s

Prepare traces
```{r}
source('utils.R')
root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2020-01/'
animal_name = 'K-BR'
exp_title='learning'
day = '2020-02-06' # learning 2 day1
caimg_result_dir = find.caimg.dir(caimg_result_dirs, animal_name, day)
beforetest.traces = read.data.trace(caimg_result_dir, 'beforetest')
```

```{r}
behav.traces.fragment = filter(beforetest.traces, 
                               cell_id == beforetest.traces$cell_id[1]) %>%
  filter(timestamp <= 120 * 1000) %>%
  arrange(timestamp)
behav.traces.fragment$row_id = 1:nrow(behav.traces.fragment)
behav.traces.fragment %>%
  ggplot() +
  geom_path(aes(x=x, y=100-y), size=0.5, colour='#666666') +
  geom_rewards.current(filter(test.rewards.df, exp_title=='beforetest'), 
               beforetest.traces$animal[1], beforetest.traces$date[1], nbins = 100, 
               rew.size=4, stroke.size=1) +
  geom_reward_zone(filter(test.rewards.df, exp_title=='beforetest'), 
               beforetest.traces$animal[1], beforetest.traces$date[1]) +
  geom_maze_contour(100) +
  scale_color_continuous(low='#b8e2ff', high='#222222') +
  theme_void() +
  theme(legend.position='none')
ggsave('test_trial_path.pdf', path='/home/prez/tmp/cheeseboard', 
       device = cairo_pdf, units='cm', width=3.7, height=3.6)
```

```{r}
# Paired comparisons of crossings counts
gcross.paired.absolute = test.trial.df.joined %>%
  dplyr::select(animal, date, location_set, crossings_0_120s, type) %>%
  spread(type, crossings_0_120s) %>%
  mutate(cross_diff = test-habituation) %>%
  ggplot() +
  #geom_boxplot(aes(x=location_set, y=cross_diff)) +
  geom_dotplot(aes(x=location_set, y=cross_diff, fill=animal), binaxis='y', dotsize=1) +
  xlab('Reward location set') +
  ylab('Increase in #crossings (60s)\nafter learning vs habituation') +
  ylim(c(0,8)) +
  gtheme 

gcross.paired.absolute
```


# Change of reward location

Within day improvement -- early trials on a given day have more crossings of the previous reward location
```{r}
prev.reward.d = filter(d, !is.na(ncross_prev_rew))

ggplot(prev.reward.d)%>% +
  #geom_jitter(aes(x=learning_day1, y=ncross_prev_rew, color=animal), width=0.2)
  #geom_jitter(aes(x=trial_id, y=ncross_prev_rew, color=animal), width = 0, height=0.3, size=2)
  geom_point(aes(x=trial_id, y=ncross_prev_rew, color=animal), size=2)
```


