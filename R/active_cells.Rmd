---
title: "Cells active between days"
output: html_notebook
---

```{r}
library(dplyr)
library(plyr)
library(pracma)
library(readr)
library(tidyr)
library(tibble)
library(stringr)
library(DT)

library(ggplot2)
library(cowplot)
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=18), axis.text = element_text(size=15))

summarise = dplyr::summarise
summarize = dplyr::summarize

```


```{r}
root_dir = '/mnt/DATA/Prez/cheeseboard-down/down_2/2019-08/'

list.subdir = function(subdir) {
  learning_datestr = list.files(subdir)
  sapply(learning_datestr, FUN=function(x) {paste(subdir, x, sep='/')}) %>% unname
}

get.subject.result.dirs = function(root_dir, subject) {
  dated_dirs = c(list.subdir(paste(root_dir, 'habituation', sep='/')),
                 list.subdir(paste(root_dir, 'learning', sep='/')))
  sapply(dated_dirs, FUN=function(x) {paste0(x, '/caiman/', subject, '/filtered/')})
}

caimg_result_dirs = c(
  get.subject.result.dirs(root_dir, 'E-BL')
  #get.subject.result.dirs(root_dir, 'E-TR'),
)


caimg_result_dirs = Filter(
  function(ca_img_dir) {file.exists(paste(ca_img_dir, 'traces_and_positions.csv', sep='/'))}, 
  caimg_result_dirs)

gen_imgs_dir = '/tmp/'
```

```{r}
source('trace_utils.R')

fr=20
cell.trial.activity.df = data.frame()
cell.day.activity.df = data.frame()
for (ca_img_result_dir in caimg_result_dirs) {
  print(paste('Processing dir: ', ca_img_result_dir))
  cellmapping_file = paste0(ca_img_result_dir, 'cell_mapping.csv')
  cellmapping.df = read.csv(cellmapping_file)
  traces_file = paste0(ca_img_result_dir, 'traces_and_positions.csv')
  data = read.csv(traces_file)
  data.traces = gather.traces(data)
  data.traces = left_join(data.traces, cellmapping.df, by=c('cell'='cell_no'))
  dir_parts = str_split(ca_img_result_dir, '/')
  animal = dir_parts[[1]][length(dir_parts[[1]]) - 2]
  data.traces$animal = rep(animal, nrow(data.traces))
  data.traces = mutate(data.traces,
                       trial_name = paste(date, exp_title, num2str(trial, fmt=0)))
  #data.traces = zscore.traces(data.traces)
  trial.activity.df = data.traces %>%
    group_by(animal, date, exp_title, trial_id, trial_name, cell, cell_id) %>%
    summarise(event.rate = sum(nevents) / n() * fr,
              deconv.mean = mean(deconv_trace))
  day.activity.df = data.traces %>%
    group_by(animal, date, exp_title, cell, cell_id) %>%
    summarise(event.rate = sum(nevents) / n() * fr,
              deconv.mean = mean(deconv_trace))
  
  cell.trial.activity.df = bind_rows(cell.trial.activity.df, trial.activity.df)
  cell.day.activity.df = bind_rows(cell.day.activity.df, day.activity.df)
}

```

# Histograms of activity in the detectd cells

Mean deconv values during the day in the detected cells, one datapoint per cell per day
```{r}
cell.day.activity.df %>%
  ggplot() +
  geom_histogram(aes(x=deconv.mean)) +
  facet_grid(animal ~ exp_title)
```
Deconv values in the detected cells, one datapoint per cell per trial
```{r}
cell.trial.activity.df %>%
  ggplot() +
  geom_histogram(aes(x=deconv.mean)) +
  facet_grid(animal ~ exp_title)
```

# Cell activity across days and trials

Show inactive cells as 0
```{r}

expand.cell_ids = function(df, join.cols) {
  animal.cell_ids.df = mutate(df, animal_cell_id = paste(animal, cell_id, sep='_'))
  animal.cell_ids = animal.cell_ids.df$animal_cell_id %>% unique
  
  expanded.cols.list = list()
  for (col in join.cols) {
    expanded.cols.list[[col]] = unique(df[[col]])  
  }
  expanded.cell.day = expand.grid(expanded.cols.list)
  #expanded.cell.day = expand.grid(animal=unique(df$animal),
  #                                date=unique(df$date),
  #                                exp_title=unique(df$exp_title),
  #                                cell_id=unique(df$cell_id))
  
  expanded.cell.day = expanded.cell.day %>%
    mutate(animal_cell_id = paste(animal, cell_id, sep='_')) %>%
    filter(animal_cell_id %in% animal.cell_ids) %>%
    dplyr::mutate(deconv.mean=0)
  
  full.cell.day.activity = 
    left_join(expanded.cell.day, df, by=join.cols, suffix=c('.x', '.y')) %>%
    mutate(deconv.mean = pmax(deconv.mean.x, deconv.mean.y, na.rm=TRUE)) %>%
    select(-deconv.mean.x, -deconv.mean.y)
  return(full.cell.day.activity)
}
```

## Cell activity across days
```{r}

join.cols = c('animal', 'date', 'exp_title', 'cell_id')
full.cell.day.activity = expand.cell_ids(cell.day.activity.df, join.cols)
```
Order cells by correlations with TSNE
```{r}
create.cell_order = function(df.input, grouping.col) {
  cell.order.df = data.frame()
  for (animal_name in unique(df.input$animal)) {
    df.input %>%
      filter(animal == animal_name) %>%
      #mutate(trial_id=paste(animal, trial_name, sep='_')) %>%
      select(grouping.col, cell_id, deconv.mean) -> df
  
    trial.activity.df = spread(df, cell_id, deconv.mean) %>%
      column_to_rownames(var=grouping.col)
      
    cor.data = cor(trial.activity.df)
    
    # deal with standard dev equal 0
    cor.data[is.na(cor.data)] = 0
    
    tsne.vals = tsne::tsne(cor.data, k=1)
    
    cell_ids = rownames(cor.data) 
    tsne.df = data.frame(cell_id=cell_ids, tsne.val=tsne.vals) %>%                
      dplyr::arrange(tsne.val) %>%                                                       
      dplyr::mutate(cell_order = dplyr::row_number(),
                    animal = animal_name)
    cell.order.df = bind_rows(cell.order.df, select(tsne.df, -tsne.val))
  }
  cell.order.df$cell_id = as.integer(cell.order.df$cell_id)
  
  return(cell.order.df)
}
```

```{r}
cell.order.df = full.cell.day.activity %>%
  filter(exp_title=='trial') %>%
  mutate(date_exp = paste(date, exp_title, sep='_')) %>%
  create.cell_order('date_exp')
cell.day.activity.ordered = full.cell.day.activity %>% 
    left_join(cell.order.df, by=c('animal','cell_id')) %>%
    arrange(animal, cell_order, date) 
```

```{r}
cell.day.activity.ordered %>%
#full.cell.day.activity %>%
  filter(exp_title == 'trial') %>%
  ggplot() +
  geom_tile(aes(x=date, y=cell_id, fill=deconv.mean + 1), width=1) +
  facet_grid(animal ~ ., scales = 'free_y') +
  labs(fill='deconv dF/F') +
  #scale_fill_viridis(breaks=c(0, 1)) +
  scale_fill_gradient(low='black', high='white', trans='log') + 
  ylab('Cell') +
  xlab('Session') +
  gtheme +
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

## Cell activity across trials
```{r}
join.cols = c('animal', 'trial_name', 'cell_id')
full.trial.activity.df = expand.cell_ids(
  filter(cell.trial.activity.df, exp_title=='trial'), 
  join.cols)
```

```{r}
cell.order.df = create.cell_order(filter(full.trial.activity.df, exp_title=='trial'), 'trial_name')
data.ordered = full.trial.activity.df %>% 
    left_join(cell.order.df, by=c('animal','cell_id')) %>%
    arrange(animal, cell_order, trial_name) 
```


```{r}
data.ordered %>%
  #filter(exp_title == 'trial') %>%
  ggplot() +
  geom_tile(aes(x=trial_name, y=cell_order, fill=deconv.mean + 1), width=1) +
  facet_grid(animal ~ ., scales='free_y') +
  labs(fill='deconv dF/F') +
  #scale_fill_viridis(breaks=c(0, 1)) +
  scale_fill_gradient(low='black', high='white', trans='log') + 
  ylab('Cell') +
  xlab('Session') + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```


# Count of active cells

## Per Day during the trials

Change in number of active cells
```{r}
cell.active.thr = 0.01
active.day.df = full.cell.day.activity %>%
  filter(exp_title == 'trial') %>%
  mutate(cell.active = deconv.mean >= cell.active.thr) 

active.day.df %>%
  group_by(animal, date) %>%
  dplyr::summarise(nactive = sum(cell.active),
                   ncells = n(),
                   active.pct = nactive / ncells * 100) %>%
  ggplot() +
  geom_line(aes(x=date, y=active.pct, group=animal, color=animal)) +
  gtheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))  +
  ylab('Cells active (%)') +
  xlab('')
  
```


Proportion of the same cells active between days
```{r}

days = unique(active.day.df$date) %>% as.Date
fst.learning.day = as.Date('2019-08-30')
habituation.days = days[which(days < fst.learning.day)]
learning.days = days[which(days >= fst.learning.day)]

day.comb = combn(1:length(learning.days), 2)

cell.overlap.df = data.frame()

for (i in 1:ncol(day.comb)) {
  days = day.comb[,i]
  for (animal_name in unique(active.day.df$animal)) {
      fstday.cells = filter(active.day.df, cell.active, animal_name == animal, 
                            date == learning.days[days[1]])$cell_id
      sndday.cells = filter(active.day.df, cell.active, animal_name == animal, 
                            date == learning.days[days[2]])$cell_id
      new.row = data.frame(
        animal=animal_name,
        day1=learning.days[days[1]],
        day2=learning.days[days[1]],
        days.diff = days[2] - days[1],
        overlap = length(intersect(fstday.cells, sndday.cells)) /
                  length(union(fstday.cells, sndday.cells)) * 100)
      cell.overlap.df = bind_rows(cell.overlap.df, new.row)
  }
}

```
Plot
```{r}
summary.cell.overlap = cell.overlap.df %>%
  group_by(animal, days.diff) %>%
  dplyr::summarise(overlap.mean = mean(overlap),
                   overlap.sem = sem(overlap))

ggplot() +
  geom_line(data=summary.cell.overlap, aes(x=days.diff, y=overlap, group=animal, color=animal)) +
  geom_point(data=cell.overlap.df, aes(x=days.diff, y=overlap)) +
  gtheme +
  ylab('Cell overlap (%)') +
  xlab('Days apart')
```

